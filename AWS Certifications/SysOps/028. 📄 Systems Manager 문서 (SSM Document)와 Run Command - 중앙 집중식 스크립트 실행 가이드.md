
안녕하세요! 이번 강의에서는 AWS Systems Manager의 핵심 기능인 문서(Documents)와 이를 활용한 Run Command에 대해 자세히 알아보겠습니다. SSM 문서는 마치 템플릿처럼 작동하며, Run Command는 이 문서를 기반으로 다수의 인스턴스에 명령을 일괄적으로 실행할 수 있게 해주는 기능입니다.

---

## 📖 Systems Manager 문서(Documents)란?

**SSM 문서**는 Systems Manager가 실행할 명령 또는 작업을 정의하는 JSON 또는 YAML 형식의 파일입니다. 문서에는 파라미터, 단계별 작업(Actions) 등이 포함되어 있어 인스턴스에 적용할 명령을 표준화하고 자동화하는 데 사용됩니다. AWS는 이미 수많은 기본 문서를 제공하며, 사용자는 직접 커스텀 문서를 작성할 수도 있습니다.

### 주요 특징

- **형식**: JSON 또는 YAML
    
- **구성 요소**:
    
    - **파라미터(Parameters)**: 문서 실행 시 입력받을 값을 정의합니다. 이를 통해 문서의 재사용성과 유연성이 높아집니다.
        
    - **단계(Steps)**: 실행할 일련의 작업을 순서대로 정의합니다. 각 단계는 특정 액션(예: `aws:runShellScript`)을 가집니다.
        
- **활용**: Run Command 외에도 State Manager, Patch Manager, Automation 등 다양한 SSM 기능에서 활용됩니다.
    

## 🚀 Run Command: 다수의 인스턴스에 명령 일괄 실행하기

![[Pasted image 20250927190239.png]]

**Run Command**는 SSM 문서에 정의된 명령을 여러 EC2 인스턴스에 동시에 실행하는 기능입니다. 인스턴스에 직접 SSH로 접속할 필요 없이 SSM Agent를 통해 원격으로 명령을 실행하기 때문에 보안 측면에서 매우 효율적입니다.

### Run Command의 장점

- **SSH 불필요**: 인스턴스에 SSH 포트를 열어두지 않아도 명령 실행이 가능해 보안이 강화됩니다.
    
- **대규모 관리**: 수십, 수백 개의 인스턴스에 동일한 명령을 한 번에 적용할 수 있습니다.
    
- **세분화된 제어**:
    
    - **동시성 제어 (Concurrency)**: 한 번에 몇 개의 인스턴스에 명령을 실행할지 지정할 수 있습니다 (예: 한 번에 1개씩, 또는 33%씩).
        
    - **오류 임계치 (Error Threshold)**: 특정 수의 인스턴스에서 오류가 발생하면 전체 명령 실행을 중단하도록 설정할 수 있습니다.
        
- **결과 관리**: 명령의 출력 결과를 콘솔에서 확인하거나, S3 버킷 또는 CloudWatch Logs로 전송할 수 있습니다.
    
- **알림**: 명령 상태(성공, 실패, 진행 중)에 대한 알림을 SNS를 통해 받을 수 있습니다.
    

---

## 👩‍💻 실습: 웹 서버 설치 자동화

이 실습에서는 **Run Command**를 활용하여 이전에 생성한 3개의 EC2 인스턴스에 아파치 웹 서버(`HTTPD`)를 설치하고 간단한 웹페이지를 배포하는 과정을 진행합니다.

### 1. 웹 서버 설치를 위한 SSM 문서 생성하기

먼저, 아파치 서버를 설치하고 실행하는 내용이 담긴 **SSM 문서**를 생성합니다.

1. **Systems Manager** 콘솔에서 **Shared Resources** 아래 **Documents**로 이동합니다.
    
2. **Create command or session document**를 클릭합니다.
    
3. **이름**을 `InstallApache`로 지정합니다.
    
4. **Target type**은 `EC2 instance`를 선택합니다.
    
5. **Document type**은 `Command document`를 선택합니다.
    
6. **Content**에 다음 YAML 코드를 입력합니다.


```YAML
schemaVersion: '2.2'
description: Install and start the Apache web server
parameters:
  message:
    type: String
    description: The welcome message for the web page
    default: 'Hello World'
mainSteps:
- action: aws:runShellScript
  name: InstallApache
  inputs:
    runCommand:
    - 'sudo yum update -y'
    - 'sudo yum install -y httpd'
    - 'sudo systemctl start httpd'
    - 'sudo systemctl enable httpd'
    - 'sudo echo "{{ message }} from $(hostname -I)" > /var/www/html/index.html'
```

- **코드 설명**:
    
    - `message`라는 파라미터를 정의하여 동적으로 웹페이지 내용을 변경할 수 있도록 합니다.
        
    - `aws:runShellScript` 액션을 사용하여 여러 셸 명령어를 실행합니다.
        
    - 명령은 `yum`을 이용해 `httpd`를 설치하고, `systemctl`로 서비스를 시작/활성화하며, 마지막으로 `$message` 변수와 `hostname`을 이용하여 `/var/www/html/index.html` 파일을 생성합니다.
        

7. **Create document**를 클릭하여 문서를 생성합니다.
    

---

### 2. Run Command로 웹 서버 설치 실행하기

이제 방금 만든 `InstallApache` 문서를 사용하여 3개의 EC2 인스턴스에 명령을 실행합니다.

1. **Systems Manager** 콘솔에서 **Actions** 아래 **Run Command**로 이동합니다.
    
2. **Run command**를 클릭합니다.
    
3. **Command document**에서 **Owned by me**를 선택하고 `InstallApache` 문서를 찾아서 선택합니다.
    
4. **Parameters** 섹션에서 `message` 파라미터의 기본값을 `Custom Hello World`로 변경합니다.
    
5. **Targets**에서 **Choose instances manually**를 선택하고, 목록에서 3개의 인스턴스를 모두 선택합니다.
    
6. **Rate control** 섹션에서 **Concurrency**를 `1`로, **Error threshold**를 `1`로 설정합니다. (한 번에 한 인스턴스씩 명령을 실행하며, 오류 발생 시 즉시 중단).
    
7. **Output options**에서 **CloudWatch Logs**를 활성화하고, 로그 그룹 이름을 `runCommandOutput`으로 지정합니다.
    
8. **Run**을 클릭하여 명령을 실행합니다.
    

---

### 3. 결과 확인

1. **Command history**에서 실행 상태를 확인할 수 있습니다.
    
2. `In Progress` 상태였다가 곧 `Success`로 변경됩니다. 각 인스턴스에 대한 출력 로그는 **View outputs**를 클릭하여 확인할 수 있습니다.
    
3. **CloudWatch Logs**로 이동하면 `runCommandOutput` 로그 그룹에 각 인스턴스별 실행 로그가 상세히 기록되어 있는 것을 볼 수 있습니다.
    

### 4. 웹 서버 동작 확인하기

이제 EC2 인스턴스의 퍼블릭 IPv4 주소로 접속해 웹 서버가 정상적으로 작동하는지 확인합니다.

1. 먼저 **보안 그룹**의 **인바운드 규칙**에 **HTTP(포트 80)**를 `0.0.0.0/0` (모든 IP)로 허용하는 규칙을 추가해야 합니다.
    
2. 3개의 인스턴스 각각의 **퍼블릭 IPv4 주소**를 복사하여 웹 브라우저에 붙여넣습니다.
    
3. 아래와 같은 메시지가 화면에 나타나는 것을 확인할 수 있습니다.
    
    ```
    Custom Hello World from <인스턴스 내부 IP>
    ```
    

이것은 **SSH 포트를 열지 않은 상태**에서 SSM Agent를 통해 원격으로 웹 서버를 설치하는 데 성공했음을 의미합니다.

---

## 📚 마무리

SSM 문서와 Run Command를 사용하면 수많은 인스턴스에 스크립트를 안전하고 효율적으로 배포할 수 있습니다. 이는 시스템 관리자의 업무를 획기적으로 줄여주는 강력한 자동화 도구입니다. 이 기능을 활용하여 패치 관리, 애플리케이션 배포 등 다양한 작업을 자동화해보세요! 다음 시간에는 State Manager에 대해 알아보겠습니다.