## 📋 개요

이 가이드는 프로덕션 환경에서 **AMI(Amazon Machine Image)**를 안전하고 효율적으로 관리하는 두 가지 핵심 전략을 소개합니다. 첫 번째는 **IAM 조건 정책**과 **태그**를 조합하여 허가된 AMI만 사용하도록 강제하는 방법이고, 두 번째는 **AWS Config**를 사용하여 정책을 준수하지 않는 EC2 인스턴스를 식별하는 방법입니다.

---

## 🔒 전략 1: IAM 및 태그를 이용한 AMI 사용 강제

프로덕션 환경에서는 보안 및 일관성 유지를 위해 사전 승인된 AMI만 사용하도록 강제하는 것이 중요합니다. 이는 IAM 정책의 **조건(Condition)**을 활용하여 특정 태그가 있는 AMI에 대해서만 EC2 인스턴스 생성을 허용하는 방식으로 구현할 수 있습니다.

### 작동 원리

1. **AMI 태깅**: 승인된 AMI에 `Environment: Prod`와 같이 특정 키-값 쌍의 **태그**를 추가합니다.
    
2. **IAM 정책 적용**: 사용자 또는 역할에 연결된 IAM 정책에 `ec2:RunInstances` 권한을 부여하되, **`ec2:ResourceTag/Environment`** 조건 키를 사용하여 `Prod` 태그가 있는 AMI에 대해서만 인스턴스 생성을 허용하도록 제한합니다.
    
3. **결과**:
    
    - **승인된 AMI**: `Environment: Prod` 태그가 있는 AMI를 사용하는 경우, 사용자는 EC2 인스턴스를 성공적으로 시작할 수 있습니다.
        
    - **비승인된 AMI**: 태그가 없거나 다른 태그가 있는 AMI를 사용하는 경우, 인스턴스 시작 요청은 IAM 정책에 의해 거부됩니다.

### 예시 IAM 정책

```JSON
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "ec2:RunInstances",
            "Resource": [
                "arn:aws:ec2:*:*:instance/*",
                "arn:aws:ec2:*:*:volume/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": "ec2:RunInstances",
            "Resource": "arn:aws:ec2:*:*:image/*",
            "Condition": {
                "StringEquals": {
                    "ec2:ResourceTag/Environment": "Prod"
                }
            }
        }
    ]
}
```

**주의**: 이 정책이 의도대로 작동하려면, AMI에 태그를 추가하는 권한(`ec2:CreateTags`, `ec2:DeleteTags`) 또한 엄격하게 관리해야 합니다.

---

## 🚦 전략 2: AWS Config를 활용한 비준수 인스턴스 탐지

아무리 IAM 정책을 엄격하게 적용하더라도, 간혹 예외적인 경로로 비승인된 AMI가 사용될 수 있습니다. **AWS Config**를 사용하면 이러한 비준수(non-compliant) EC2 인스턴스를 지속적으로 모니터링하고 식별할 수 있습니다.

### 작동 원리

1. **AWS Config 규칙 생성**: AMI 태그를 확인하는 **AWS Config 규칙**을 생성합니다. 이 규칙은 모든 EC2 인스턴스를 스캔하여 인스턴스에 사용된 AMI가 사전 정의된 태그(예: `Environment: Prod`)를 가지고 있는지 검사합니다.
    
2. **규칙 적용**: 규칙은 계정 내의 모든 EC2 인스턴스에 대해 자동으로 적용됩니다.
    
3. **규정 준수 평가**:
    
    - **준수(Compliant)**: 승인된 AMI를 사용하여 시작된 인스턴스는 '준수' 상태로 표시됩니다.
        
    - **비준수(Non-Compliant)**: 승인되지 않은 AMI를 사용하여 시작된 인스턴스는 '비준수' 상태로 플래그가 지정됩니다.
        
4. **자동화된 조치**: AWS Config는 비준수 인스턴스가 감지되었을 때 **자동화된 조치(Remediation Action)**를 취하도록 설정할 수 있습니다. 예를 들어, 해당 인스턴스 소유자에게 알림을 보내거나, 자동으로 인스턴스를 중지 또는 종료하는 스크립트를 실행할 수 있습니다.

### AWS Config 사용 예시

만약 어떤 사용자가 실수로 비승인된 AMI로 인스턴스를 시작하더라도, AWS Config가 이를 즉시 감지하여 보안 팀에 알림을 보내거나 자동으로 해당 인스턴스를 처리할 수 있는 워크플로우를 구축할 수 있습니다. 이는 IAM 정책이 허점을 가질 경우를 대비한 훌륭한 **2차 방어선** 역할을 수행합니다.