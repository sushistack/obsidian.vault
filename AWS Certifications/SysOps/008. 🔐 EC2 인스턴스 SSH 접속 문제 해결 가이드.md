
## 🚀 SSH 접속 문제의 일반적인 원인과 해결책

EC2 인스턴스에 SSH로 접속할 때 발생하는 문제는 크게 세 가지로 분류할 수 있습니다. 각 문제의 원인과 해결 방법을 자세히 살펴보겠습니다.

### 1. 🔑 PEM 파일 권한 문제

가장 흔한 오류 중 하나로, PEM 키 파일의 권한이 올바르게 설정되지 않았을 때 발생합니다. SSH 클라이언트는 보안상의 이유로 **너무 개방적인 권한**을 가진 개인 키 파일의 사용을 허용하지 않습니다.

- **오류 메시지:**
    
```
unprotected private key file
```
    
- **원인:** PEM 파일의 권한이 `600`보다 더 개방적일 경우 (예: `644`).
    
- **해결 방법:** `chmod` 명령어를 사용하여 권한을 **`400`**으로 변경해야 합니다. 이는 소유자만 읽기 권한을 가지도록 설정하는 것입니다.
    
```Bash
chmod 400 your_key.pem
```
    

### 2. 👤 사용자 이름 문제

SSH 접속 시, 인스턴스의 운영체제(OS)에 맞는 **올바른 사용자 이름**을 사용해야 합니다. 잘못된 사용자 이름을 입력하면 인증 실패 오류가 발생합니다.

- **오류 메시지:**
```
Permission denied (publickey).
```

```
Too many authentication failures
```

- **원인:** `ssh` 명령에서 `ec2-user`, `ubuntu` 등과 같은 OS별 기본 사용자 이름을 잘못 입력한 경우.

- **해결 방법:** 사용하는 AMI(Amazon Machine Image)에 따라 올바른 사용자 이름을 확인하고 사용해야 합니다.

|AMI 종류|기본 사용자 이름|
|---|---|
|**Amazon Linux**|`ec2-user`|
|**Ubuntu**|`ubuntu`|
|**CentOS**|`centos`|
|**Red Hat**|`ec2-user` 또는 `root`|

### 3. 🌐 연결 시간 초과 (Connection Timeout)

이 오류는 주로 **네트워크 설정 문제**로 인해 발생합니다. SSH 요청이 인스턴스에 도달하지 못하거나, 인스턴스가 응답을 보내지 못하는 경우입니다.

- **오류 메시지:**
```
Connection timed out
```

- **원인:**
    
    - **보안 그룹(Security Group):** 인스턴스에 연결된 보안 그룹의 **인바운드(Inbound)** 규칙이 **22번 포트(SSH)**에 대한 접근을 허용하지 않는 경우.
        
    - **네트워크 ACL (NACL):** 서브넷의 네트워크 ACL이 SSH 트래픽을 차단하는 경우.
        
    - **퍼블릭 IPv4 주소 부재:** 인스턴스에 퍼블릭 IP가 할당되지 않아 외부에서 접근할 수 없는 경우.
        
    - **인스턴스 과부하:** 인스턴스의 CPU 사용률이 100%에 달하는 등 과부하 상태일 때, 응답이 불가능하여 타임아웃이 발생할 수 있습니다.

- **해결 방법:**
    
    - **보안 그룹 확인:** 22번 포트에 대해 SSH 트래픽을 허용하는 규칙이 있는지 확인합니다. 특정 IP만 허용하도록 규칙을 설정할 수도 있습니다.
        
    - **네트워크 ACL 확인:** 22번 포트에 대한 인바운드 및 아웃바운드 규칙이 모두 허용되어 있는지 확인합니다.
        
    - **인스턴스 상태 확인:** 인스턴스에 퍼블릭 IPv4 주소가 할당되었는지, CPU 사용률이 정상 범위인지 확인합니다.

---

## 🔗 EC2 Instance Connect와 SSH의 차이점

![[Pasted image 20250921163303.png]]

**EC2 Instance Connect**는 SSH 키 관리를 간소화하고 보안을 강화하기 위해 AWS가 제공하는 서비스입니다. 일반 SSH와 동작 방식에 중요한 차이가 있습니다.

### SSH 방식

- 사용자는 **자신의 로컬 키 페어**를 사용하여 인스턴스에 직접 접속합니다.
    
- **보안 그룹**의 인바운드 규칙에 **접속할 로컬 PC의 IP 주소**가 허용되어야 합니다.

### EC2 Instance Connect 방식

- 사용자는 AWS API를 통해 EC2 Instance Connect 서비스에 접속합니다.
    
- EC2 Instance Connect 서비스가 **일회성 SSH 공개 키**를 인스턴스에 푸시(push)합니다. 이 키는 **60초** 동안만 유효합니다.
    
- 사용자는 **AWS의 특정 IP 범위**를 통해 인스턴스에 접속하며, 이때 사용자의 IP는 AWS의 IP로 변환됩니다.
    
- 따라서, 인스턴스의 **보안 그룹**에는 사용자의 로컬 IP가 아닌 **EC2 Instance Connect 서비스의 IP 범위**가 허용되어야 합니다.

### ✅ 실습: EC2 Instance Connect를 위한 보안 그룹 설정

1. **AWS IP 범위 파일 다운로드:** [AWS IP Ranges](https://www.google.com/search?q=https://ip-ranges.amazonaws.com/ip-ranges.json) JSON 파일을 다운로드합니다.
    
2. **EC2 Instance Connect IP 확인:** JSON 파일에서 현재 리전에 해당하는 **`EC2_INSTANCE_CONNECT`** 서비스의 IP 주소 범위를 찾습니다.
    
    - 예: `eu-central-1` 리전의 경우, `ip_prefix` 필드에서 해당하는 IP 범위를 찾습니다.
        
3. **보안 그룹 규칙 추가:**
    
    - 인스턴스의 보안 그룹으로 이동하여 **인바운드 규칙**을 편집합니다.
        
    - **유형**을 `SSH`로 설정하고, **소스**에 찾은 **EC2 Instance Connect IP 범위(CIDR)**를 입력합니다.
        
    - 기존에 있던 SSH 규칙은 삭제해도 됩니다.

이제 사용자의 로컬 IP와 관계없이 AWS 콘솔의 "연결" 버튼을 통해 EC2 Instance Connect로 안전하게 접속할 수 있습니다. 이 방식은 키 파일을 관리할 필요가 없어 보안성을 높일 수 있습니다.