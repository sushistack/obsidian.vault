
## 💡 `cfn-init`의 한계: 성공 여부 알리기

이전 강의에서 `cfn-init`을 사용해 EC2 인스턴스 구성을 자동화하는 방법을 배웠습니다. 하지만 `cfn-init`은 단순히 작업을 수행할 뿐, 작업이 **성공했는지 실패했는지** CloudFormation 스택에 자동으로 보고하지 않습니다. 이 때문에 스택이 성공적으로 생성되었더라도 실제 인스턴스 구성에 오류가 있었는지 알기 어렵다는 한계가 있습니다.

이 문제를 해결하기 위해 **`cfn-signal`** 헬퍼 스크립트가 등장합니다. `cfn-signal`은 인스턴스 내부의 스크립트 실행 결과를 CloudFormation 스택으로 다시 보내는 역할을 합니다.

---

## 📝 `cfn-signal` 핵심: WaitCondition과 CreationPolicy

`cfn-signal`을 사용하려면 CloudFormation 스택이 신호를 받을 준비가 되어 있어야 합니다. 이 역할을 하는 것이 바로 **`AWS::CloudFormation::WaitCondition`** 리소스와 **`CreationPolicy`**입니다.

### `WaitCondition`

`WaitCondition`은 이름 그대로 특정 조건이 충족될 때까지 스택의 생성을 **일시 중지**시키는 리소스입니다. 이 리소스는 `cfn-signal` 스크립트가 보내는 성공 또는 실패 신호를 기다립니다.

### `CreationPolicy`

`CreationPolicy`는 특정 리소스(예: EC2 인스턴스, Auto Scaling Group)에 대한 생성 정책을 정의하며, `ResourceSignal` 속성을 통해 다음을 설정할 수 있습니다.

- `Count`: 몇 개의 성공 신호를 받을지 정의합니다. 기본값은 1입니다. (여러 인스턴스가 성공 신호를 보내야 할 경우 사용)
    
- `Timeout`: 신호를 기다릴 최대 시간입니다. 이 시간 내에 신호가 도착하지 않으면 스택 생성은 실패합니다.

### 동작 방식

1. **스택 생성 시작**: CloudFormation 스택을 생성합니다.
    
2. **`WaitCondition` 대기**: `WaitCondition` 리소스 또는 `CreationPolicy`가 정의된 EC2 인스턴스 리소스가 **`CREATE_IN_PROGRESS`** 상태가 되며, 신호를 기다리기 시작합니다.
    
3. **User Data 실행**: EC2 인스턴스가 부팅되고 User Data 스크립트가 실행됩니다.
    
4. **`cfn-init` 실행**: `cfn-init` 스크립트가 인스턴스 구성을 진행합니다.
    
5. **`cfn-signal` 전송**: `cfn-init` 스크립트 실행이 성공(종료 코드 0)하면, **`cfn-signal`** 스크립트가 CloudFormation으로 성공 신호를 보냅니다.
    
6. **스택 생성 완료**: CloudFormation은 성공 신호를 받고 `WaitCondition` 리소스의 상태를 **`CREATE_COMPLETE`**로 변경하며, 스택 생성을 최종 완료합니다.
    

만약 `cfn-init`이 실패(0이 아닌 종료 코드)하면, `cfn-signal`은 실패 신호를 보내고 CloudFormation 스택은 `ROLLBACK_COMPLETE` 상태로 전환됩니다.

---

## 🛠️ `cfn-signal` 사용 예시: 스택 상태 제어하기

아래는 `cfn-signal`을 사용하여 `cfn-init`의 성공 여부를 스택에 알리는 CloudFormation 템플릿 예시입니다.

```YAML
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  # 1. WaitCondition 리소스 정의
  SampleWaitCondition:
    Type: AWS::CloudFormation::WaitCondition
    Properties:
      Handle: !Ref SampleWaitHandle
      Timeout: '120' # 2분 동안 신호 대기
      Count: '1' # 하나의 성공 신호만 필요

  SampleWaitHandle:
    Type: AWS::CloudFormation::WaitConditionHandle
  
  # 2. EC2 인스턴스 리소스 정의
  MyInstance:
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              httpd: []
          files:
            "/var/www/html/index.html":
              content: "<h1>Hello, cfn-signal!</h1>"
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
    Properties:
      InstanceType: t2.micro
      ImageId: ami-0abcdef1234567890 # 사용자의 AMI ID로 변경
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          yum update -y aws-cfn-bootstrap
          
          # cfn-init 실행 결과를 변수에 저장
          /usr/bin/cfn-init -v --stack ${AWS::StackId} --resource MyInstance --region ${AWS::Region}
          INIT_STATUS=$?
          
          # cfn-init 결과에 따라 cfn-signal 실행
          /usr/bin/cfn-signal --stack ${AWS::StackId} --resource SampleWaitCondition --region ${AWS::Region} --exit-code $INIT_STATUS
```

### 코드 분석

1. **`SampleWaitCondition`**: `AWS::CloudFormation::WaitCondition` 타입의 리소스를 정의합니다. 이 리소스가 EC2 인스턴스의 성공 신호를 기다리게 됩니다.
    
2. **`cfn-init` 결과 저장**: `cfn-init` 명령어 실행 후 **`INIT_STATUS=$?`** 구문을 사용해 이전 명령어의 종료 코드를 `INIT_STATUS` 변수에 저장합니다.
    
    - `0`은 성공, `0`이 아닌 값은 실패를 의미합니다.
        
3. **`cfn-signal` 실행**: `cfn-signal` 스크립트를 실행합니다.
    
    - `--stack`, `--resource`, `--region`: 신호를 보낼 스택, 리소스, 리전 정보를 지정합니다.
        
    - `--exit-code $INIT_STATUS`: `cfn-init` 실행 결과(종료 코드)를 신호와 함께 전달합니다.
        

이 템플릿을 실행하면 CloudFormation은 `MyInstance`와 `SampleWaitCondition` 리소스를 동시에 생성합니다. `WaitCondition`은 EC2 인스턴스로부터 신호를 받을 때까지 `CREATE_IN_PROGRESS` 상태를 유지하며, 신호를 받은 후에만 최종 `CREATE_COMPLETE` 상태로 변경됩니다. 이를 통해 스택 생성 완료 시점에 인스턴스가 의도한 대로 구성되었음을 **확실히 보장**할 수 있습니다.

---

## 🌟 결론: `cfn-init`과 `cfn-signal`의 시너지 효과

**`cfn-init`**과 **`cfn-signal`**을 함께 사용하면 다음과 같은 이점을 얻을 수 있습니다.

| |`cfn-init`|`cfn-signal`|
|---|---|---|
|**역할**|EC2 인스턴스의 구성 작업을 선언적으로 정의하고 실행합니다.|`cfn-init`의 실행 결과를 CloudFormation 스택에 보고합니다.|
|**강점**|복잡한 인스턴스 구성을 가독성 높게 관리할 수 있습니다.|스택의 생성 상태를 인스턴스 내부 구성 성공 여부와 동기화합니다.|


이 두 스크립트를 조합하면 User Data의 한계를 극복하고, 더 강력하고 신뢰할 수 있는 방식으로 CloudFormation 스택을 관리할 수 있습니다. 이는 복잡한 애플리케이션 환경을 자동화하고, 문제 발생 시 빠른 디버깅을 가능하게 하는 핵심적인 기술입니다.