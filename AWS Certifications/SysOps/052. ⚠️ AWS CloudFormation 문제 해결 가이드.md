
## 🛠️ 일반적인 CloudFormation 에러 및 해결책

CloudFormation 스택 관리 중 발생할 수 있는 주요 에러 유형과 그 해결 방법을 정리합니다.

### 1. `DELETE_FAILED` (삭제 실패)

스택 삭제 작업이 실패한 경우입니다. 가장 흔한 원인은 **삭제하려는 리소스가 다른 리소스에 의해 사용 중이거나, 삭제 조건이 충족되지 않은 경우**입니다.

- **S3 버킷이 비어있지 않음**: S3 버킷은 버킷 내의 모든 객체를 먼저 삭제해야만 삭제할 수 있습니다.
    
    - **해결책**: 스택 삭제 전에 수동으로 버킷을 비우거나, **Custom Resource**와 **Lambda 함수**를 사용하여 버킷 비우기 작업을 자동화할 수 있습니다.
        
- **보안 그룹이 사용 중**: 다른 EC2 인스턴스가 해당 보안 그룹을 여전히 사용하고 있을 때 발생합니다.
    
    - **해결책**: 보안 그룹을 사용하는 모든 인스턴스와의 연결을 끊은 후 다시 삭제를 시도해야 합니다.
        
- **`DeletionPolicy: Retain`**: 특정 리소스에 이 정책이 설정되어 있으면, 스택 삭제 시 해당 리소스는 건너뛰고 유지됩니다. 이 속성은 스택 삭제 실패를 막기 위한 임시방편으로 활용될 수 있습니다.

---

### 2. `UPDATE_ROLLBACK_FAILED` (업데이트 롤백 실패)

업데이트가 실패하여 롤백을 시도했으나, 롤백마저 실패한 경우입니다. 이는 스택이 복구할 수 없는 상태(inoperable state)에 빠졌음을 의미하며, 추가 조치가 필요합니다.

- **원인**:
    
    - CloudFormation 외부에서 리소스가 변경된 경우.
        
    - IAM 권한이 부족하여 롤백 작업(예: 특정 리소스 삭제)을 수행하지 못하는 경우.
        
    - Auto Scaling Group이 `cfn-signal`을 받지 못해 대기 상태에 머무르는 경우.
        
- **해결책**:
    
    1. **원인 파악**: CloudFormation 이벤트 로그를 확인하여 롤백 실패의 정확한 원인을 파악합니다.
        
    2. **수동 수정**: AWS 콘솔 등에서 문제를 수동으로 해결합니다. (예: 부족한 IAM 권한 추가, 외부에서 변경된 리소스 상태 복구 등)
        
    3. **`ContinueUpdateRollback` API 호출**: 오류가 해결된 것을 확인한 후, AWS CLI 또는 SDK를 통해 **`ContinueUpdateRollback`** API를 호출하여 중단된 롤백 작업을 재개합니다.
        

---

## 🌎 CloudFormation StackSets 문제 해결

StackSets는 여러 계정과 리전에 걸쳐 스택을 배포하기 때문에 일반 스택보다 디버깅이 더 복잡할 수 있습니다. StackSets 작업이 실패하고 스택 인스턴스 상태가 **`OUTDATED`**로 표시될 때, 다음 원인을 확인해야 합니다.

- **권한 문제**:
    
    - 대상 계정의 **`AWSCloudFormationStackSetExecutionRole`**이 스택 템플릿에 지정된 리소스를 생성할 권한이 없을 수 있습니다.
        
    - 관리자 계정의 **`AWSCloudFormationStackSetAdministrationRole`**과 대상 계정의 실행 역할 간에 신뢰 관계가 올바르게 설정되지 않았을 수 있습니다.
        
- **전역 리소스 이름 충돌**: S3 버킷처럼 전역적으로 고유한 이름(Globally unique name)이 필요한 리소스를 템플릿이 생성할 경우, 다른 계정이나 리전에서 동일한 이름이 이미 사용 중이라면 배포가 실패합니다.
    
    - **해결책**: 템플릿에 `!Sub` 함수 등을 사용하여 스택 이름이나 계정 ID, 리전 등을 조합한 동적이고 고유한 이름을 사용해야 합니다.
        
- **계정별 할당량(Quota) 초과**: 특정 계정에서 EC2 인스턴스, RDS 인스턴스 등 리소스 할당량을 이미 초과하여 스택 인스턴스 생성이 실패할 수 있습니다.
    
    - **해결책**: 할당량을 늘리거나 불필요한 리소스를 삭제해야 합니다.
        
- **지역별 리소스 차이**: 일부 AWS 서비스나 리소스는 특정 리전에서만 사용할 수 있으므로, 템플릿이 지원하지 않는 리전에 배포되면 실패할 수 있습니다.
    

StackSets는 여러 계정과 리전의 복합적인 환경적 요인에 의해 실패할 수 있으므로, 각 대상의 로그를 세심하게 확인하고 권한, 할당량, 리소스 이름 등 여러 측면을 종합적으로 고려하여 문제를 해결해야 합니다.