
## ☁️ 통합 CloudWatch 에이전트(Unified CloudWatch Agent)란?

**통합 CloudWatch 에이전트**는 AWS EC2 인스턴스 및 온프레미스 서버에서 시스템 수준의 상세 지표(메모리, 디스크 공간 등)와 로그를 CloudWatch로 수집하는 필수 도구입니다. 이 에이전트를 사용하면 AWS가 기본으로 제공하지 않는 중요한 모니터링 정보를 얻을 수 있습니다.

이 가이드에서는 웹 서버(HTTPD)를 실행하는 EC2 인스턴스에 에이전트를 설치하여 로그와 메트릭을 CloudWatch로 전송하는 과정을 단계별로 상세히 설명합니다.

---

## 1. ⚙️ IAM 역할 생성 및 EC2 인스턴스에 연결하기

에이전트가 EC2 인스턴스에서 CloudWatch로 데이터를 전송하려면 적절한 IAM 권한이 필요합니다.

### IAM 역할 생성

1. **IAM 콘솔**에서 `역할` > `역할 생성`으로 이동합니다.
    
2. **AWS 서비스**를 선택하고 `EC2`를 사용 사례로 지정합니다.
    
3. **권한 정책** 검색창에 `CloudWatchAgent`를 입력하고, **`CloudWatchAgentServerPolicy`**를 선택합니다. 이 정책은 에이전트가 CloudWatch에 로그와 메트릭을 `Put`하고, SSM 파라미터 스토어에서 설정을 `Get`할 수 있는 최소한의 권한을 제공합니다.
    
4. 역할 이름을 **`AmazonEC2RoleForCloudWatch`**와 같이 지정하고 역할을 생성합니다.

### EC2 인스턴스에 IAM 역할 연결

1. EC2 인스턴스 생성 시, `고급 세부 정보`에서 `IAM 인스턴스 프로필`에 방금 생성한 **`AmazonEC2RoleForCloudWatch`** 역할을 연결합니다.
    
2. (선택) 에이전트 설정을 SSM에 저장하기 위해, 이 역할에 `CloudWatchAgentAdminPolicy`를 추가하여 `SSM 파라미터 스토어`에 `Put` 권한을 부여할 수 있습니다.

---

## 2. 🌐 웹 서버 설치 및 로그 파일 확인

1. **EC2 인스턴스**에 SSH 또는 EC2 Instance Connect로 접속합니다.
    
2. 다음 명령어를 실행하여 웹 서버(Apache HTTPD)를 설치합니다.

```Bash
sudo yum install httpd -y
```
    
3. 기본 웹 페이지를 생성합니다.
    
```Bash
sudo echo "Hello World" > /var/www/html/index.html
```
    
4. 웹 서버를 시작하고 활성화합니다.

```Bash
sudo systemctl start httpd
sudo systemctl enable httpd
```
    
5. 브라우저에서 인스턴스의 퍼블릭 IP로 접속하여 "Hello World" 메시지를 확인합니다.
    
6. 다음 명령어를 통해 웹 서버의 **액세스 로그**와 **에러 로그** 파일을 확인합니다.

```Bash
cat /var/log/httpd/access_log
cat /var/log/httpd/error_log
```

---

## 3. ⚙️ CloudWatch 에이전트 설치 및 설정

### 에이전트 설치

EC2 인스턴스에서 다음 명령어를 실행하여 CloudWatch 에이전트를 설치합니다.

```Bash
sudo yum install amazon-cloudwatch-agent -y
```

### 에이전트 설정(Wizard)

에이전트 설정을 위해 다음 마법사 명령어를 실행합니다.

```Bash
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard
```

마법사는 일련의 질문을 통해 로그 및 메트릭 수집 설정을 도와줍니다. 주요 설정은 다음과 같습니다.

- **OS:** `Linux`
    
- **사용자:** `root`
    
- **호스트 메트릭:** `CPU`, `Memory`, `Disk` 등 필수 지표를 수집하도록 **Yes**를 선택합니다. 이 단계에서 **메모리(RAM) 지표**를 수집하도록 설정할 수 있습니다.
    
- **로그 파일 모니터링:** `Yes`를 선택하고, 앞서 확인한 웹 서버의 로그 파일 경로(`var/log/httpd/access_log`, `var/log/httpd/error_log`)를 입력합니다.
    
- **SSM 파라미터 스토어에 저장:** 설정 완료 후, `Yes`를 선택하여 생성된 설정을 `SSM 파라미터 스토어`에 저장합니다. 이는 여러 인스턴스에 동일한 설정을 적용할 때 매우 유용합니다.

---

## 4. 🚀 CloudWatch 에이전트 실행 및 모니터링 확인

1. 에이전트 설정이 완료되면, SSM에 저장된 설정 파일을 기반으로 에이전트를 시작합니다.
    
```Bash
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c ssm:AmazonCloudWatch-linux
```
    
2. **CloudWatch 콘솔**로 이동하여 `Logs` > `Log groups`를 확인합니다. 설정한 대로 **`access_log`**와 **`error_log`**라는 두 개의 로그 그룹이 생성된 것을 볼 수 있습니다. 로그 그룹 안의 **`Log streams`**에서 실제 로그 데이터를 확인할 수 있습니다.
    
3. **`Metrics`** 메뉴로 이동하여 `CloudWatchAgent` 네임스페이스를 확인합니다. 여기에는 `mem_used_percent`와 같이 에이전트를 통해 수집된 메모리 및 디스크 사용량 지표들이 표시됩니다. .


이러한 과정을 통해 EC2 인스턴스 내부의 로그와 상세 메트릭을 성공적으로 CloudWatch에 통합하여 중앙 집중식으로 관리하고 모니터링할 수 있습니다.