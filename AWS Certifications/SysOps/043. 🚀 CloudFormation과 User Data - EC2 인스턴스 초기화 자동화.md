
안녕하세요! 이번 시간에는 AWS **CloudFormation** 템플릿을 사용하여 EC2 인스턴스에 **사용자 데이터(User Data)**를 전달하는 방법에 대해 알아보겠습니다. 이를 통해 인스턴스가 시작될 때 자동으로 스크립트를 실행하여 초기 설정을 완료할 수 있습니다.

---

## 1. 📝 CloudFormation 템플릿에 User Data 포함시키기

User Data는 EC2 인스턴스 생성 시 한 번 실행되는 스크립트입니다. CloudFormation 템플릿에 이 스크립트를 포함시키려면 `AWS::EC2::Instance` 리소스의 `UserData` 속성을 사용합니다.

### **Base64 인코딩**

스크립트 내용을 템플릿에 안전하게 전달하기 위해서는 `Fn::Base64` 함수로 **Base64 인코딩**해야 합니다. 이는 YAML 또는 JSON 형식의 템플릿 내에서 스크립트의 특수 문자들이 파싱 오류를 일으키지 않도록 방지하는 중요한 단계입니다.

### **멀티라인 스크립트 작성**

YAML에서는 `|` (수직선) 기호를 사용하여 여러 줄의 스크립트를 작성할 수 있습니다. 이는 스크립트의 가독성을 높여줍니다.

### **템플릿 예시**

다음은 CloudFormation 템플릿의 일부로, `UserData`를 사용하여 아파치 웹 서버를 설치하고 간단한 웹페이지를 생성하는 예시입니다.

```YAML
Resources:
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ...
      UserData:
        Fn::Base64: |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "Hello World from user data." > /var/www/html/index.html
```

---

## 2. 👩‍💻 실습: 웹 서버 자동 배포

이 템플릿을 사용하여 스택을 생성하면 다음과 같은 과정이 자동으로 진행됩니다.

1. CloudFormation이 `EC2Instance` 리소스를 생성합니다.
    
2. 인스턴스가 시작될 때, `UserData` 속성에 정의된 셸 스크립트가 실행됩니다.
    
3. 스크립트는 `yum`을 통해 `httpd` 패키지를 설치하고, 서비스를 시작 및 활성화합니다.
    
4. 마지막으로 `index.html` 파일을 생성하여 `Hello World` 메시지를 담습니다.
    

인스턴스 생성 후, 웹 브라우저에서 인스턴스의 퍼블릭 IP 주소로 접속하면 "Hello World from user data." 메시지를 확인할 수 있습니다. 이는 User Data 스크립트가 성공적으로 실행되었음을 의미합니다.

---

## 3. 📜 User Data 스크립트 로그 확인하기

User Data 스크립트의 실행 결과는 인스턴스 내부의 특정 로그 파일에 기록됩니다. 스크립트 실행 중 오류가 발생했거나, 실행 결과를 확인하고 싶을 때 이 파일을 열어볼 수 있습니다.

- **로그 파일 경로**: `/var/log/cloud-init-output.log`

EC2 Instance Connect 등을 사용하여 인스턴스에 접속한 뒤, 다음 명령어를 실행하면 로그 내용을 확인할 수 있습니다.

```Bash
cat /var/log/cloud-init-output.log
```

이 로그 파일에는 스크립트의 각 명령어와 그 결과가 상세히 기록되어 있어, 문제 발생 시 디버깅에 큰 도움이 됩니다.

---

## 4. ⚠️ 주의사항 및 다음 단계

User Data 스크립트가 실패하더라도 **CloudFormation 스택은 기본적으로 성공(CREATE_COMPLETE) 상태를 반환**합니다. 이는 CloudFormation이 스크립트의 성공 여부가 아닌, 인스턴스 생성 자체의 성공 여부를 기준으로 판단하기 때문입니다. 다음 강의에서는 이 문제를 해결하고, User Data 스크립트의 성공 여부를 CloudFormation 스택에 반영하는 방법을 다룰 것입니다.