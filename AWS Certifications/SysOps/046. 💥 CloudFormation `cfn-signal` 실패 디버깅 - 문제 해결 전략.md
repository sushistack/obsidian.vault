
## 🚨 일반적인 실패 원인 및 문제 해결 방법

CloudFormation 스택 생성 중 **WaitCondition**이 **cfn-signal**로부터 신호를 받지 못하거나, 잘못된 신호를 받아 스택 생성이 실패하는 경우는 흔히 발생합니다. 이러한 상황의 주요 원인과 해결책은 다음과 같습니다.

### 원인 및 해결책

|원인|설명|해결 방법|
|---|---|---|
|**헬퍼 스크립트 부재**|EC2 인스턴스에 `cfn-init`, `cfn-signal` 등의 **헬퍼 스크립트**가 설치되어 있지 않습니다. Amazon Linux AMI에는 기본적으로 포함되어 있지만, 다른 OS 이미지에는 없을 수 있습니다.|User Data 스크립트 상단에 `yum install -y aws-cfn-bootstrap` 또는 `apt-get install -y aws-cfn-bootstrap` 명령을 추가하여 헬퍼 스크립트를 설치합니다.|
|**인터넷 연결 문제**|EC2 인스턴스가 CloudFormation 서비스 엔드포인트에 접속할 수 없습니다. 특히 프라이빗 서브넷에 인스턴스를 배포할 때 이 문제가 발생하기 쉽습니다.|`NAT Gateway`, `VPC Endpoint` 또는 `VPC Peering`을 구성하여 인스턴스가 퍼블릭 네트워크 또는 AWS 서비스와 통신할 수 있도록 합니다.|
|**스크립트 오류**|`cfn-init` 또는 User Data 스크립트 자체에 오류가 있어 실행이 중단됩니다.|**Rollback on failure** 옵션을 비활성화한 후 인스턴스에 접속하여 로그 파일(`cfn-init.log`, `cfn-init-cmd.log`)을 확인하고 오류를 수정합니다.|

---

## 📝 `cfn-signal` 실패 시나리오 재현

`cfn-init`이 `cfn-signal`에 전달하는 종료 코드(exit code)가 0이 아닐 경우, 스택은 롤백됩니다. 이 과정을 직접 확인하기 위해 고의로 실패를 유도하는 템플릿을 살펴봅시다.

### 실패를 유발하는 CloudFormation 템플릿

```YAML
# ... (생략: MyInstance 리소스와 UserData 스크립트) ...

  MyInstance:
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Init:
        config:
          # ... (생략: packages, files, services) ...
          commands:
            01_fail_command:
              command: "echo 'This command will fail...'"
              # exit code 1을 반환하여 스크립트 실패 유도
              test: 'exit 1'
    Properties:
      # ... (생략: InstanceType, ImageId 등) ...
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          yum update -y aws-cfn-bootstrap
          
          /usr/bin/cfn-init -v --stack ${AWS::StackId} --resource MyInstance --region ${AWS::Region}
          INIT_STATUS=$? # cfn-init의 실패 종료 코드를 INIT_STATUS에 저장
          
          /usr/bin/cfn-signal --stack ${AWS::StackId} --resource SampleWaitCondition --region ${AWS::Region} --exit-code $INIT_STATUS
```

### 동작 원리

1. **스택 생성 시작**: CloudFormation 스택을 생성합니다.
    
2. **EC2 인스턴스 부팅**: EC2 인스턴스가 부팅되고 User Data 스크립트가 실행됩니다.
    
3. **`cfn-init` 실행**: `cfn-init` 스크립트가 `commands` 블록에 도달하여 `exit 1` 명령을 실행합니다.
    
4. **`cfn-init` 실패**: `exit 1` 때문에 `cfn-init`은 실패하고, `INIT_STATUS` 변수에 `1`이 저장됩니다.
    
5. **`cfn-signal` 전송**: `cfn-signal`은 종료 코드 `1`을 CloudFormation 스택의 **WaitCondition** 리소스로 보냅니다.
    
6. **스택 롤백**: WaitCondition 리소스가 실패 신호를 받자마자 **`CREATE_FAILED`** 상태가 되고, CloudFormation은 스택 전체를 **롤백(Rollback)**하여 모든 리소스를 자동으로 삭제합니다.
    

이러한 자동 롤백 기능은 인프라의 일관성을 유지하는 데 유용하지만, 문제의 원인을 파악하고 디버깅하기에는 불편합니다.

---

## 🔧 디버깅: Rollback 기능 비활성화

디버깅을 위해 스택이 실패하더라도 생성된 리소스를 유지하려면 CloudFormation의 **스택 실패 옵션**을 변경해야 합니다.

### 설정 방법

스택 생성 시 **"스택 실패 옵션(Stack failure options)"** 항목에서 **"롤백하지 않음(Preserve successfully provisioned resources)"**을 선택합니다.

|옵션|설명|
|---|---|
|**Roll back all stack resources (기본값)**|스택 생성 중 하나라도 실패하면, 이전에 성공적으로 생성된 모든 리소스를 자동으로 삭제합니다.|
|**Preserve successfully provisioned resources**|스택 생성 중 실패한 경우, 이미 생성된 리소스는 그대로 유지합니다. 실패 원인 분석을 위해 인스턴스에 접속하거나 로그를 확인할 때 유용합니다.|

### 디버깅 과정

1. **롤백 비활성화**: 위 옵션을 선택하고 스택을 생성합니다.
    
2. **로그 확인**: `WaitCondition`이 실패 상태로 전환되어도 EC2 인스턴스는 유지됩니다.
    
3. **SSH 접속**: 인스턴스에 SSH로 접속하거나, EC2 Instance Connect 기능을 사용하여 접속합니다.
    
4. **로그 파일 분석**: `/var/log/cfn-init.log`와 `/var/log/cfn-init-cmd.log` 파일을 확인하여 어떤 명령어에서 오류가 발생했는지, 그 원인이 무엇인지 파악하고 템플릿을 수정합니다.
    
5. **스택 삭제**: 디버깅이 완료되면 수동으로 스택을 삭제하여 리소스를 정리합니다.
    

이처럼 `cfn-init`과 `cfn-signal`의 실패 원인을 이해하고, 적절한 디버깅 전략을 활용하면 복잡한 CloudFormation 템플릿도 효율적으로 관리할 수 있습니다.