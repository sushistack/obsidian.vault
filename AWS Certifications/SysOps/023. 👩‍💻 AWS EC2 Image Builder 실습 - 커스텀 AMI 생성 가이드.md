## 📋 개요

이 가이드는 AWS EC2 Image Builder를 사용하여 **자동화된 이미지 파이프라인**을 구축하고, **Java 11**과 **AWS CLI v2**가 설치된 **커스텀 AMI**를 생성하는 실습 과정을 상세히 안내합니다. 이를 통해 EC2 Image Builder가 어떻게 작동하는지 직접 경험하고, 실제 운영 환경에 적용할 수 있는 지식을 습득할 수 있습니다.

---

## 🛠️ 실습 환경 설정: 이미지 파이프라인 생성

EC2 Image Builder 콘솔에서 이미지 파이프라인을 생성하는 첫 단계부터 시작합니다.

### 1단계: 파이프라인 및 레시피 정의

1. **파이프라인 생성**: EC2 Image Builder 서비스로 이동하여 **`파이프라인 생성`**을 클릭합니다.
    
2. **파이프라인 이름**: `MyDemoPipeline`으로 이름을 지정합니다.
    
3. **스케줄링**: `수동(Manual)` 실행을 선택하여 직접 파이프라인을 시작하도록 설정합니다.
    
4. **레시피 생성**: **`새 레시피 생성`**을 선택하고, 이미지 유형은 `AMI`로 지정합니다.
    
5. **레시피 이름**: `MyDemoRecipe`로 이름을 지정하고, 버전은 `1.0.0`으로 설정합니다.
    

### 2단계: 소스 이미지 및 컴포넌트 설정

1. **소스 이미지**: **`관리형 이미지`**를 선택하고, **`Amazon Linux 2`**를 선택합니다.
    
2. **아키텍처 선택**: **`x86`** 아키텍처를 선택합니다. ARM64를 선택하면 추후 오류가 발생할 수 있습니다.
    
3. **컴포넌트 추가**:
    
    - **빌드 컴포넌트**: `amazon-corretto-11-headless` (Java 11 설치)와 `aws-cli-version-2-linux` (AWS CLI v2 설치)를 검색하여 추가합니다.
        
    - **순서 변경**: 설치 순서를 원하는 대로 조정할 수 있습니다. 예를 들어, AWS CLI v2를 먼저 설치하고 Java 11을 나중에 설치하도록 순서를 변경할 수 있습니다.
        

|컴포넌트 이름|설치 내용|
|---|---|
|`amazon-corretto-11-headless`|OpenJDK 기반의 Java 11|
|`aws-cli-version-2-linux`|AWS CLI 버전 2|

### 3단계: 인프라 구성 및 IAM 역할 생성

EC2 Image Builder가 이미지를 빌드하고 테스트하는 데 사용할 **IAM 역할**과 **인프라 구성**을 설정합니다.

1. **인프라 구성**: **`새 인프라 구성 생성`**을 선택하고 이름을 `MyDemoInfra`로 지정합니다.
    
2. **IAM 역할 생성**:
    
    - 새 탭에서 IAM 콘솔로 이동하여 `역할 생성`을 클릭합니다.
        
    - **신뢰 엔터티**: `AWS 서비스` > `EC2`를 선택합니다.
        
    - **권한 정책**: 다음의 AWS 관리형 정책 2개를 연결합니다.
        
        - `EC2InstanceProfileForImageBuilder`
            
        - `AmazonSSMManagedInstanceCore`
            
    - **역할 이름**: `EC2InstanceProfileForImageBuilder`로 지정합니다. 이 이름은 서비스 기본값 이름과 일치하여 혼란을 방지하는 데 도움이 됩니다.
        
3. **인프라 구성**: 다시 Image Builder 콘솔로 돌아와 방금 생성한 IAM 역할을 선택합니다.
    
4. **인스턴스 유형**: 비용 절감을 위해 **`t2.micro`**를 선택합니다. 기본값(m5.large)을 사용하면 요금이 발생할 수 있습니다.
    

### 4단계: 배포 및 파이프라인 생성

1. **배포 설정**: 기본값(`서비스 기본값 사용`)을 선택하여 현재 리전에만 AMI를 배포하도록 설정합니다.
    
2. **파이프라인 생성**: 설정을 검토한 후, `파이프라인 생성`을 클릭하여 모든 구성을 완료합니다.
    

---

## 🚀 파이프라인 실행 및 결과 확인

파이프라인이 생성된 후, 수동으로 실행하고 결과를 확인하는 과정입니다.

### 1. 파이프라인 실행

1. **파이프라인 목록**: `MyDemoPipeline`을 선택하고 **`작업(Action)`** > **`파이프라인 실행(Run pipeline)`**을 클릭합니다.
    
2. **진행 상황**: 파이프라인이 **`빌딩(Building)`**, **`테스팅(Testing)`**, **`배포(Distributing)`** 단계를 거치며 진행됩니다.
    
3. **EC2 인스턴스 확인**: 이 과정 동안 EC2 콘솔에 **`빌더 인스턴스`**와 **`테스트 인스턴스`**가 순차적으로 생성되고 종료되는 것을 확인할 수 있습니다.
    

### 2. 커스텀 AMI 확인

1. **AMI 목록**: 파이프라인이 성공적으로 완료되면, EC2 콘솔의 `AMI` 메뉴에서 새로운 AMI를 확인할 수 있습니다.
    
2. **AMI 이름**: 이름은 `MyDemoRecipe`와 생성 타임스탬프를 포함하는 형식으로 지정됩니다.
    
3. **태그 확인**: AMI의 태그를 확인하면 `CreatedBy: EC2 Image Builder`가 지정되어 있음을 볼 수 있습니다.
    

### 3. 최종 검증: 새 인스턴스 시작

1. **인스턴스 시작**: 방금 생성한 **커스텀 AMI**를 사용하여 새로운 EC2 인스턴스를 시작합니다.
    
2. **연결 및 확인**: EC2 Instance Connect를 사용하여 인스턴스에 접속합니다.
    
3. **명령어 실행**: 다음 명령어를 실행하여 Java와 AWS CLI가 올바르게 설치되었는지 확인합니다.


```Bash
aws --version
java -version
```

|명령어|예상 결과|
|---|---|
|`aws --version`|`aws-cli/2.7.0`와 같은 버전 2 정보|
|`java -version`|`openjdk version "11.0.15"`와 같은 Java 11 정보|

---

## 🧹 리소스 정리

실습 완료 후 불필요한 비용 발생을 막기 위해 사용한 리소스를 모두 정리합니다.

- **EC2 인스턴스**: 새로 시작한 테스트 인스턴스를 종료합니다.
    
- **AMI**: EC2 콘솔에서 생성된 AMI를 **등록 해제(Deregister)**합니다.
    
- **스냅샷**: AMI 등록 해제 후, 관련 EBS 스냅샷을 삭제합니다.
    
- **IAM 역할**: 생성한 IAM 역할을 삭제합니다.
    
- **EC2 Image Builder 파이프라인**: `MyDemoPipeline`은 수동 실행이므로 그대로 두어도 추가 비용은 발생하지 않지만, 향후 관리를 위해 삭제할 수 있습니다.