
## 🚀 AWS StackSets를 활용한 인프라 배포 자동화

![[Pasted image 20250928160727.png]]

이 실습에서는 AWS CloudFormation **StackSets**를 사용하여 단일 계정 내의 여러 리전(Region)에 **AWS Config**를 배포하는 방법을 알아봅니다. 이 시나리오는 인프라의 구성을 지속적으로 추적하고 관리해야 하는 일반적인 사용 사례를 반영합니다.

AWS Config는 계정 내 모든 리소스의 구성 변경 사항을 기록하는 관리 서비스입니다. StackSets를 활용하면 모든 리전에 AWS Config를 일관되게 활성화하여 중앙 집중식으로 인프라의 변화를 모니터링할 수 있습니다.

---

## 🛠️ StackSets 배포를 위한 사전 준비: IAM 역할 설정

StackSets를 사용하려면 관리자 계정과 대상 계정 간에 **IAM 역할(IAM Role)**을 통한 권한 설정이 필수적입니다. 이 실습은 단일 AWS 계정에서 진행되므로, 해당 계정은 관리자 계정이자 대상 계정이 됩니다.

### 1. 관리자 역할(Admin Role) 생성

이 역할은 CloudFormation StackSets 서비스가 스택을 배포하기 위해 사용합니다.

- **역할 이름**: `AWSCloudFormationStackSetAdministrationRole`
    
- **신뢰 정책**: CloudFormation 서비스가 이 역할을 맡을 수 있도록 허용합니다.
    
- **권한 정책**: 대상 계정의 `AWSCloudFormationStackSetExecutionRole`을 맡을 수 있는 권한을 부여합니다.

CloudFormation 템플릿을 사용하여 이 역할을 손쉽게 생성할 수 있습니다.

### 2. 실행 역할(Execution Role) 생성

이 역할은 StackSets가 대상 계정에서 실제 리소스를 생성, 업데이트, 삭제하는 데 사용됩니다.

- **역할 이름**: `AWSCloudFormationStackSetExecutionRole`
    
- **신뢰 정책**: 관리자 계정의 ID를 신뢰 관계에 추가하여 관리자 역할이 이 역할을 맡을 수 있도록 허용합니다.
    
- **권한 정책**: 리소스 배포에 필요한 권한(예: AWS Config 활성화에 필요한 권한)을 부여합니다.

이 역할도 CloudFormation 템플릿으로 생성하며, 템플릿 실행 시 **관리자 계정 ID**를 파라미터로 입력해야 합니다.

두 역할이 성공적으로 생성되면, AWS StackSets 콘솔에서 StackSets 배포를 시작할 준비가 된 것입니다.

---

## ⚙️ StackSets 배포: AWS Config 템플릿 활용하기

StackSets를 배포하려면 AWS Config를 활성화하는 CloudFormation 템플릿이 필요합니다. 이 템플릿은 다음과 같은 특징을 가질 수 있습니다.

- **다양한 파라미터**: `AWSConfig` 활성화 시 포함할 리소스 유형, 전역 리소스 포함 여부, 알림 채널 등 다양한 옵션을 파라미터로 설정하여 유연하게 구성할 수 있습니다.
    
- **고급 CloudFormation 기능**:
    
    - **`Conditions`**: 특정 조건에 따라 리소스 생성을 제어합니다. 예를 들어, 알림용 SNS Topic 생성 여부를 파라미터에 따라 결정할 수 있습니다.
        
    - **`Mappings`**: 파라미터의 사용자 친화적인 값을 실제 CloudFormation이 사용하는 값으로 매핑합니다.
        
    - **`DependsOn`**: 리소스 간의 명시적인 생성 순서를 정의합니다.
        
    - **`Fn::If`**: 리소스 속성에 조건부 로직을 적용하여 `AWS::NoValue`와 같은 의사 변수(Pseudo-Variables)를 사용할 수 있습니다.

### StackSets 배포 단계

1. **StackSets 생성**: CloudFormation 콘솔에서 "StackSets" 메뉴로 이동하여 새 StackSet을 생성합니다.
    
2. **템플릿 업로드**: AWS Config 템플릿 파일을 업로드합니다.
    
3. **파라미터 설정**: 템플릿의 파라미터 값을 설정합니다. 이 실습에서는 기본값으로 설정하고 진행합니다.
    
4. **권한 설정**: 미리 생성해둔 **관리자 역할 ARN**과 **실행 역할 이름**을 지정합니다.
    
5. **배포 대상 지정**:
    
    - **계정 번호**: 스택을 배포할 계정 ID를 입력합니다.
        
    - **리전**: 스택을 배포할 리전을 선택합니다. 이 실습에서는 유럽(EU)의 두 리전(프랑크푸르트, 아일랜드)을 선택합니다.

6. **배포 옵션**:
    
    - **동시 배포 계정 수**: 한 번에 몇 개의 계정에 배포할지 지정합니다.
        
    - **실패 허용치**: 전체 배포가 실패하기 전에 허용할 스택 인스턴스의 실패 횟수를 지정합니다.
        
    - **리전 동시 배포**: 리전별로 순차적으로 배포할지, 병렬로 배포할지 선택합니다. 병렬 배포를 선택하여 시간을 단축합니다.

7. **배포 시작**: 모든 설정을 확인한 후 배포를 시작합니다.

배포가 시작되면 StackSets 콘솔에서 각 리전의 스택 인스턴스 생성 상태를 모니터링할 수 있습니다. 잠시 후, 선택한 두 리전에 AWS Config 스택이 성공적으로 배포되는 것을 확인할 수 있습니다.

---

## ✅ 결과 확인 및 정리

- **스택 인스턴스 확인**: 선택한 리전에서 AWS Config 스택이 성공적으로 생성되었는지 확인합니다.
    
- **스택 삭제**: 실습 후 불필요한 비용이 발생하지 않도록 StackSets를 삭제하여 배포된 스택 인스턴스를 일괄적으로 삭제합니다.
    

이 실습은 StackSets의 강력한 기능을 통해 대규모 환경에서 반복적이고 복잡한 배포 작업을 얼마나 효율적으로 자동화할 수 있는지 보여줍니다. 이는 거버넌스, 컴플라이언스, 그리고 운영 효율성 측면에서 매우 중요한 기술입니다.