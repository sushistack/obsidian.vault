
## 🏗️ 중첩 스택(Nested Stacks)이란?

![[Pasted image 20250928160258.png]]

**중첩 스택**은 다른 CloudFormation 스택 내부에 포함된 스택입니다. 이를 통해 재사용 가능한 구성 요소나 반복되는 패턴을 별도의 스택으로 분리하여 관리할 수 있습니다. 예를 들어, 웹 애플리케이션에 필요한 웹 서버, 데이터베이스, 로드 밸런서 등의 구성을 각각의 중첩 스택으로 나누어 모듈화할 수 있습니다.

### 중첩 스택과 교차 스택(Cross-Stack)의 차이점

![[Pasted image 20250928160311.png]]

|특징|중첩 스택(Nested Stacks)|교차 스택(Cross-Stack)|
|---|---|---|
|**목적**|**컴포넌트 재사용** 및 템플릿 모듈화. 하나의 상위 스택이 여러 하위 스택을 관리합니다.|**다른 라이프사이클**을 가진 스택 간에 데이터(출력 값)를 공유합니다. 예를 들어, VPC 스택과 애플리케이션 스택이 독립적으로 관리될 때 사용합니다.|
|**관계**|**부모-자식 관계**. 부모 스택이 자식(중첩) 스택의 라이프사이클을 완전히 제어합니다.|**느슨한 결합(Loose Coupling)**. 한 스택의 출력 값을 다른 스택이 가져와 사용하는 관계입니다.|
|**관리**|부모 스택을 업데이트하거나 삭제하면 중첩 스택도 함께 업데이트/삭제됩니다.|각 스택은 독립적으로 관리되며, 한 스택을 삭제하려면 의존성을 먼저 제거해야 합니다.|
|**함수**|`AWS::CloudFormation::Stack` 리소스와 `TemplateURL` 속성을 사용합니다.|`Fn::ImportValue` 함수를 사용하고 `Export` 속성으로 값을 외부에 공개합니다.|
|**활용 예시**|LAMP 스택, AWS Elastic Beanstalk 환경 등 여러 컴포넌트가 함께 배포되는 단일 애플리케이션.|회사 전체가 사용하는 중앙 VPC와, 각 팀이 사용하는 개별 애플리케이션 스택.|

---

## 📖 중첩 스택 템플릿 구조 및 동작 원리

중첩 스택은 `AWS::CloudFormation::Stack` 리소스를 사용하여 정의합니다. 이 리소스는 **`TemplateURL`** 속성으로 중첩 스택의 템플릿 파일 위치를 지정하며, **`Parameters`** 속성으로 하위 스택에 필요한 값을 전달할 수 있습니다.

### 예시 템플릿 (`parent-stack.yaml`)

```YAML
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  MyKeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: my-key-pair
      
  MyNestedStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: "https://s3.amazonaws.com/your-bucket/nested-stack-template.yaml"
      Parameters:
        KeyName: !Ref MyKeyPair
        DBUser: "admin"
        DBPassword: "MySuperSecretPassword"
```

### 동작 원리

1. **상위 스택 생성**: CloudFormation이 부모 템플릿(`parent-stack.yaml`)을 처리하기 시작합니다.
    
2. **`AWS::CloudFormation::Stack` 리소스 감지**: `MyNestedStack` 리소스를 발견하고 `TemplateURL`을 통해 하위 템플릿(`nested-stack-template.yaml`)을 가져옵니다.
    
3. **파라미터 전달**: 상위 스택에서 정의된 `Parameters`를 하위 스택으로 전달합니다. 예를 들어, `!Ref MyKeyPair`로 생성된 키페어 이름을 `KeyName` 파라미터로 전달합니다.
    
4. **하위 스택 생성**: 하위 템플릿에 정의된 리소스(예: EC2 인스턴스, 보안 그룹)가 순차적으로 생성됩니다. 이 과정은 별도의 중첩 스택 이벤트로 표시되어 디버깅이 용이합니다.
    
5. **신호 대기**: 하위 스택에 `CreationPolicy`가 있다면 `cfn-signal`을 기다렸다가 성공 신호를 받으면 스택 생성을 완료합니다.
    
6. **전체 스택 완료**: 모든 중첩 스택이 성공적으로 생성되면, 부모 스택도 `CREATE_COMPLETE` 상태로 전환됩니다.
    

---

## 🛡️ 중첩 스택과 `Capabilities`

중첩 스택을 사용하는 템플릿을 생성할 때, CloudFormation은 템플릿 내에 **`AWS::CloudFormation::Stack`** 리소스가 있음을 감지하고 **`CAPABILITY_AUTO_EXPAND`** 권한을 요구합니다. 또한, 만약 중첩 스택 템플릿에 IAM 리소스가 포함되어 있다면 **`CAPABILITY_IAM`** 또는 **`CAPABILITY_NAMED_IAM`** 권한도 필요합니다.

- `CAPABILITY_AUTO_EXPAND`: CloudFormation이 중첩 스택의 내용을 "자동 확장"하여 모든 리소스를 확인하고 처리할 수 있도록 허용하는 권한입니다. 이는 중첩 스택이 포함하는 모든 리소스(특히 IAM 리소스)에 대한 위험을 사용자가 인지하고 있음을 확인하는 과정입니다.
    

---

## 🔄 중첩 스택 업데이트 및 삭제

중첩 스택은 부모 스택에 의해 라이프사이클이 관리되므로, 직접 업데이트하거나 삭제하지 않습니다.

- **업데이트**: 중첩 스택을 수정하려면 **부모 스택의 템플릿을 업데이트**하면 됩니다. CloudFormation은 부모 템플릿의 변경 사항을 감지하고 필요한 경우 중첩 스택을 업데이트합니다.
    
- **삭제**: 중첩 스택을 삭제하려면 **부모 스택을 삭제**하면 됩니다. 부모 스택이 삭제되면 그 아래에 있는 모든 중첩 스택과 해당 리소스도 함께 삭제됩니다.
    

중첩 스택은 복잡한 인프라를 논리적인 단위로 분리하고, 코드 재사용성을 높여 CloudFormation 템플릿을 보다 효과적으로 관리할 수 있는 모범 사례입니다.