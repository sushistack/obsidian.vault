
이번 강의에서는 서비스의 가용성을 극대화하기 위한 <mark class="hltr-red">장애 조치 라우팅 정책(Failover Routing Policy)</mark>에 대해 알아봅니다. 이 정책은 헬스 체크와 연동하여 자동으로 장애를 감지하고, 백업 리소스로 트래픽을 전환하는 데 사용됩니다.

---

### 1. 장애 조치 라우팅 정책이란? 🤔

![[Pasted image 20250726223128.png]]

- **개념**: 주 리소스(Primary)와 보조 리소스(Secondary)를 설정하여, <mark class="hltr-red">주 리소스가 비정상(unhealthy) 상태일 경우 자동으로 보조 리소스로 트래픽을 전환하는 정책</mark>입니다.
- **작동 방식**:
    - 주 레코드(Primary Record)에는 <mark class="hltr-red">헬스 체크를 반드시 연결</mark>해야 합니다.
    - Route 53은 헬스 체크를 통해 주 레코드의 상태를 지속적으로 모니터링합니다.
    - **정상 상황**: 주 레코드가 정상(`Healthy`)일 경우, 모든 DNS 쿼리에 대해 주 레코드의 IP 주소를 응답으로 반환합니다.
    - **장애 상황**: 주 레코드의 헬스 체크가 비정상(`Unhealthy`) 상태로 변경되면, Route 53은 자동으로 보조 레코드의 IP 주소를 응답으로 반환하기 시작합니다.
- **주요 특징**:
    - **Active-Passive 구성**: 주 리소스는 항상 트래픽을 받고, 보조 리소스는 주 리소스가 실패할 때만 사용되는 **Active-Passive** 장애 조치 구성입니다.
    - **필수적인 헬스 체크**: 주 레코드에는 헬스 체크를 반드시 연결해야 합니다. 보조 레코드는 선택 사항입니다.
    - **복구**: 주 리소스가 다시 정상 상태로 돌아오면, Route 53은 자동으로 주 리소스로 트래픽을 복귀시킵니다.

### 2. 장애 조치 라우팅 실습 🧪

이전에 생성한 헬스 체크를 활용하여, 장애 조치 라우팅 정책을 구성하고 실제 장애 상황에서 트래픽이 전환되는 것을 확인해 보겠습니다.

#### 2.1 장애 조치 레코드 세트 생성

1. **Route 53 콘솔 접속**: 이전에 등록한 도메인(`yourchosendomain.com`)의 호스트 존으로 이동합니다.
2. **레코드 생성**: `레코드 생성(Create record)` 클릭.
3. **첫 번째 레코드 (주 - Primary)**:
    - **레코드 이름**: `failover` (FQDN: `failover.yourchosendomain.com`)
    - **레코드 유형**: `A`
    - **값**: 프랑크푸르트(`eu-central-1`) EC2 인스턴스의 IP 주소를 입력합니다.
    - **라우팅 정책**: `장애 조치(Failover)` 선택.
    - **장애 조치 레코드 유형**: `주(Primary)` 선택.
    - **헬스 체크 연동**: `헬스 체크 ID`에서 이전에 생성한 `EU Central 1` 헬스 체크를 선택합니다.
    - **레코드 ID**: `EU Central`
    - **다른 레코드 추가(Add another record)** 클릭.
4. **두 번째 레코드 (보조 - Secondary)**:
    - **레코드 이름**: `failover` (주 레코드와 동일)
    - **레코드 유형**: `A`
    - **값**: 버지니아 북부(`us-east-1`) EC2 인스턴스의 IP 주소를 입력합니다.
    - **라우팅 정책**: `장애 조치(Failover)`
    - **장애 조치 레코드 유형**: `보조(Secondary)` 선택.
    - **레코드 ID**: `US East`
5. **레코드 생성**: 설정이 완료되면 `레코드 생성(Create records)`을 클릭합니다.

#### 2.2 장애 조치 작동 확인

1. **정상 상황 확인**:
    - 웹 브라우저에서 `http://failover.yourchosendomain.com`에 접속합니다.
    - 주 레코드인 프랑크푸르트(`eu-central-1c`)의 "Hello World" 메시지가 표시되는 것을 확인합니다.
2. **의도적인 장애 발생**:
    - 프랑크푸르트(`eu-central-1`) 리전으로 이동하여 해당 EC2 인스턴스의 **보안 그룹 인바운드 규칙**에서 `HTTP (80 포트)` 허용 규칙을 삭제합니다.
    - 이렇게 하면 헬스 체커들이 해당 인스턴스에 접근할 수 없게 되어, 헬스 체크 상태가 `Unhealthy`로 변경됩니다.
3. **상태 변화 대기**:
    - Route 53의 헬스 체크 목록에서 `EU Central 1` 헬스 체크가 "비정상(Unhealthy)" 상태로 변경될 때까지 기다립니다.
    - `모니터링(Monitoring)` 탭에서 상태 변화를 실시간으로 확인할 수 있습니다.
4. **장애 조치 확인**:
    - `EU Central 1` 헬스 체크가 비정상으로 표시되면, 웹 브라우저에서 `http://failover.yourchosendomain.com` 페이지를 **새로고침**합니다.
    - 이제 주 레코드인 프랑크푸르트 대신 보조 레코드인 버지니아 북부(`us-east-1a`)의 "Hello World" 메시지가 표시되는 것을 확인할 수 있습니다.

5. **복구**:
    - 장애를 복구하려면, 프랑크푸르트 EC2 인스턴스의 보안 그룹에 `HTTP (80 포트)` 규칙을 다시 추가합니다.
    - 헬스 체크가 다시 정상(`Healthy`) 상태로 돌아오면, Route 53은 자동으로 프랑크푸르트로 트래픽을 복귀시킵니다.

### 3. 결론 💡

**장애 조치 라우팅 정책**은 서비스의 가용성을 보장하는 데 필수적인 기능입니다. 헬스 체크를 통해 리소스의 상태를 지속적으로 모니터링하고, 장애 발생 시 자동으로 백업 리소스로 트래픽을 전환함으로써 다운타임을 최소화하고, 재해 복구(Disaster Recovery) 전략을 효과적으로 구현할 수 있습니다.
