
이번 가이드는 AWS CodeDeploy를 사용하여 EC2 인스턴스에 애플리케이션을 배포하는 과정을 상세하게 다룹니다. IAM 역할 설정부터 EC2 인스턴스 준비, 그리고 실제 배포에 이르기까지 모든 단계를 따라가며 CodeDeploy의 작동 방식을 이해해 보세요.

---

## 🔒 1. IAM 역할 생성

CodeDeploy가 EC2 인스턴스와 S3 버킷에 접근할 수 있도록 두 가지 IAM 역할을 생성해야 합니다.

### **CodeDeploy 서비스 역할**

- **역할 유형:** AWS 서비스용 역할 (`AWS Service`)
    
- **서비스 선택:** `CodeDeploy`
    
- **사용 사례:** `CodeDeploy` (EC2)
    
- **역할 이름:** `CodeDeployServiceRoleForEC2`
    
- **설명:** 이 역할은 CodeDeploy 서비스가 배포를 관리하고 EC2 인스턴스를 제어할 수 있는 권한을 부여합니다.
    

### **EC2 인스턴스 역할**

- **역할 유형:** AWS 서비스용 역할 (`AWS Service`)
    
- **서비스 선택:** `EC2`
    
- **권한:** `AmazonS3ReadOnlyAccess` 정책을 연결합니다. 이 정책은 EC2 인스턴스가 배포 파일을 다운로드하기 위해 S3 버킷의 객체를 읽을 수 있는 권한을 부여합니다.
    
- **역할 이름:** `EC2RoleForCodeDeploy`
    

---

## 💻 2. EC2 인스턴스 준비

배포 대상이 될 EC2 인스턴스를 생성하고, CodeDeploy 에이전트를 설치하여 배포를 받을 준비를 합니다.

### **EC2 인스턴스 생성**

- **이름:** `DemoWebServer`
    
- **AMI:** `Amazon Linux`
    
- **인스턴스 유형:** `t2.micro`
    
- **보안 그룹:** SSH(포트 22)와 HTTP(포트 80) 트래픽을 허용하는 규칙을 추가합니다.
    
- **IAM 역할 연결:** **인스턴스 생성 후**, 인스턴스 설정에서 IAM 역할을 `EC2RoleForCodeDeploy`로 변경하여 연결합니다. (생성 시점에 연결하지 않았을 경우)
    
- **태그:** `Environment`=`Development` 태그를 추가합니다. 이 태그는 CodeDeploy가 배포 대상을 식별하는 데 사용됩니다.
    

### **CodeDeploy 에이전트 설치**

EC2 인스턴스에 SSH로 접속하여 CodeDeploy 에이전트를 수동으로 설치합니다.

```Bash
# 1. 시스템 업데이트
sudo yum update -y

# 2. Ruby 설치 (에이전트가 Ruby로 작성됨)
sudo yum install ruby -y

# 3. 에이전트 다운로드
wget https://aws-codedeploy-us-west-2.s3.us-west-2.amazonaws.com/latest/install

# 4. 실행 권한 부여
chmod +x ./install

# 5. 에이전트 설치 및 시작
sudo ./install auto

# 6. 에이전트 상태 확인
sudo service codedeploy-agent status
```

**💡 참고:** AWS Systems Manager를 사용하면 에이전트 설치를 자동화할 수 있지만, 여기서는 수동 설치 과정을 따릅니다.

---

## 📦 3. S3 버킷에 애플리케이션 업로드

배포할 애플리케이션 코드를 ZIP 파일로 압축하여 S3 버킷에 저장합니다.

1. **S3 버킷 생성:**
    
    - **이름:** `[사용자명]-code-deploy-demo`와 같이 고유한 이름을 사용합니다.
        
    - **리전:** CodeDeploy 및 EC2 인스턴스와 동일한 리전을 선택합니다.
        
2. **애플리케이션 파일 준비:**
    
    - **`index.html`:** 웹 서버에 표시될 HTML 파일입니다.
        
    - **`appspec.yml`:** CodeDeploy의 배포 지침을 정의하는 핵심 파일입니다.
        
    - **스크립트 파일:** `appspec.yml`에서 참조하는 배포 스크립트(예: `stop_server.sh`, `install_dependencies.sh`, `start_server.sh`)입니다.
        
3. **파일 압축 및 업로드:** 위 파일들을 `SampleApp_linux.zip`으로 압축하여 S3 버킷에 업로드합니다.
    

### **`appspec.yml` 파일 구조**

```YAML
version: 0.0
os: linux
files:
  - source: /
    destination: /var/www/html/
hooks:
  BeforeInstall:
    - location: install_dependencies.sh
      timeout: 300
      runas: root
  ApplicationStart:
    - location: start_server.sh
      timeout: 300
      runas: root
  ApplicationStop:
    - location: stop_server.sh
      timeout: 300
      runas: root
```

- **`files`**: `source` 경로의 파일을 `destination` 경로로 복사합니다.
    
- **`hooks`**: 배포 라이프사이클의 각 단계에서 실행될 스크립트를 정의합니다.
    

---

## 🚀 4. CodeDeploy 애플리케이션 및 배포 그룹 생성

IAM 역할과 EC2 인스턴스가 준비되었다면, CodeDeploy에서 애플리케이션과 배포 그룹을 설정합니다.

### **CodeDeploy 애플리케이션 생성**

- **애플리케이션 이름:** `DemoApplication`
    
- **컴퓨팅 플랫폼:** `EC2/온프레미스`
    

### **배포 그룹 생성**

- **배포 그룹 이름:** `DevelopmentGroup`
    
- **서비스 역할:** 이전에 생성한 `CodeDeployServiceRoleForEC2`를 선택합니다.
    
- **배포 유형:** `In-place`를 선택합니다.
    
- **환경 구성:**
    
    - **`Amazon EC2 인스턴스`**를 선택합니다.
        
    - **태그:** `Environment`와 `Development`를 입력하면, `1 unique matched instances`가 나타나며 EC2 인스턴스가 인식됩니다.
        
- **배포 설정:** `CodeDeployDefault.AllAtOnce`를 선택합니다.
    
- **로드 밸런서:** `로드 밸런싱 활성화` 옵션은 비활성화합니다.
    

---

## 🚚 5. 첫 배포 실행 및 확인

이제 모든 준비가 끝났습니다. CodeDeploy에서 배포를 실행합니다.

1. **'배포 생성'**을 클릭합니다.
    
2. **배포 그룹:** `DevelopmentGroup`을 선택합니다.
    
3. **리비전 유형:** `My application is stored in Amazon S3`를 선택합니다.
    
4. **리비전 위치:** S3 버킷에 업로드한 `SampleApp_linux.zip` 파일의 **S3 URI**를 복사하여 붙여넣습니다.
    
5. **'배포 생성'**을 클릭하여 배포를 시작합니다.
    

### **배포 실패 및 해결 (IAM 역할 문제)**

만약 배포가 실패한다면, EC2 인스턴스에 IAM 역할(`EC2RoleForCodeDeploy`)이 올바르게 연결되었는지 다시 확인하세요. 이 역할이 없으면 CodeDeploy 에이전트가 S3에서 파일을 다운로드할 수 없어 실패합니다.

### **배포 성공 확인**

- **CodeDeploy 콘솔:** 배포 상태가 **`성공(Succeeded)`**으로 표시됩니다.
    
- **EC2 인스턴스:** 웹 브라우저에서 EC2 인스턴스의 퍼블릭 IP 주소로 접속하면, **"Congratulations. This application was deployed using AWS CodeDeploy."**라는 메시지를 확인할 수 있습니다.