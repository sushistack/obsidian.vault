
이번 실습에서는 S3 버킷에 **MFA 삭제(MFA Delete)** 기능을 활성화하고, 이 기능이 객체 버전의 영구 삭제를 어떻게 보호하는지 확인해 보겠습니다. MFA 삭제는 AWS 콘솔 UI에서 설정할 수 없으므로, **AWS CLI**를 사용하여 이 작업을 수행해야 합니다.

---

### 1단계: 버킷 생성 및 사전 준비 🛠️

1. **버킷 생성:** `demo-stephane-MFA-delete-2020`와 같이 고유한 이름의 버킷을 생성합니다.

2. `버전 관리(Versioning)`를 **활성화**합니다.

3. **루트 계정 준비:** MFA 삭제는 루트 계정으로만 활성화할 수 있으므로, IAM에서 루트 계정에 대한 MFA 디바이스를 설정하고, 루트 계정의 접근 키를 생성해 둡니다.


> **경고:** 루트 계정의 접근 키는 매우 강력한 권한을 가지므로, 실습 후 반드시 삭제해야 합니다.

### 2단계: AWS CLI 프로파일 설정 💻

루트 계정의 접근 키를 사용하여 AWS CLI 프로파일을 설정합니다.

```Bash
# 새로운 프로파일 'root-MFA-delete-demo' 설정
aws configure --profile root-MFA-delete-demo
```

- **AWS Access Key ID:** 루트 계정의 접근 키 ID를 입력합니다.

- **AWS Secret Access Key:** 루트 계정의 시크릿 접근 키를 입력합니다.

- **Default region name:** 버킷이 생성된 리전(예: `eu-west-1`)을 입력합니다.

### 3단계: MFA 삭제 활성화 (CLI) 🚀

이제 CLI를 사용하여 버킷의 MFA 삭제를 활성화합니다. 이 작업에는 루트 계정의 MFA 코드가 필요합니다.

```Bash
aws s3api put-bucket-versioning \
--bucket <버킷 이름> \
--versioning-configuration '{"Status": "Enabled", "MFADelete": "Enabled"}' \
--mfa '<MFA 디바이스 ARN> <MFA 코드>' \
--profile root-MFA-delete-demo
```

- `--bucket`: 버킷 이름을 입력합니다.
- `--versioning-configuration`: `Status`와 `MFADelete`를 모두 `"Enabled"`로 설정합니다.
- `--mfa`: `MFA 디바이스 ARN`과 현재 인증 앱에 표시된 `MFA 코드`를 공백으로 구분하여 입력합니다.

**결과 확인:**

- S3 콘솔에서 버킷의 `속성(Properties)` 탭으로 이동합니다.
- `버킷 버전 관리(Bucket versioning)` 섹션을 보면, **"다단계 인증(MFA) 삭제가 활성화됨"**으로 표시되는 것을 확인할 수 있습니다.

### 4단계: MFA 삭제 기능 테스트 🧪

MFA 삭제가 활성화된 상태에서, 객체 버전의 영구 삭제를 시도해 봅니다.

1. **객체 업로드:** `coffee.jpg` 파일을 버킷에 업로드합니다.
2. **객체 삭제:** 업로드한 `coffee.jpg` 파일을 콘솔에서 삭제합니다. (버전 관리가 활성화되어 있으므로 실제로는 **삭제 마커(Delete Marker)**가 생성됩니다.)
3. `버전 표시(Show versions)`를 활성화하여 객체의 버전과 삭제 마커를 확인합니다.
4. **객체 버전 영구 삭제 시도:** 특정 객체 버전(예: `coffee.jpg`의 첫 번째 버전)을 선택하고 **`영구 삭제(Permanently delete)`**를 시도합니다.
5. **결과:** "이 버킷에 대해 MFA 삭제가 활성화되어 있으므로 객체를 삭제할 수 없습니다"라는 오류 메시지가 표시됩니다.

---

### 5단계: MFA 삭제 비활성화 및 정리 🧹

실습 후에는 MFA 삭제 기능을 비활성화하고, 보안을 위해 루트 계정의 접근 키를 삭제해야 합니다.

1. **MFA 삭제 비활성화:**
    
```Bash
aws s3api put-bucket-versioning \
--bucket <버킷 이름> \
--versioning-configuration '{"Status": "Enabled", "MFADelete": "Disabled"}' \
--mfa '<MFA 디바이스 ARN> <MFA 코드>' \
--profile root-MFA-delete-demo
```

2. **루트 접근 키 삭제:** IAM 콘솔로 돌아가서 루트 계정의 `보안 자격 증명(Security credentials)` > `액세스 키(Access keys)`에서 생성했던 접근 키를 **비활성화(Deactivate)**한 후 **삭제(Delete)**합니다.


이 실습을 통해 MFA 삭제 기능이 객체 버전의 영구 삭제와 같은 파괴적인 작업을 어떻게 효과적으로 보호하는지 확인했으며, AWS CLI를 통해 이 기능을 제어하는 방법을 익혔습니다.