
Amazon DynamoDB는 높은 성능을 제공하는 동시에 데이터의 일관성과 무결성을 보장하는 다양한 기능을 제공합니다. 그중 **조건부 쓰기(Conditional Writes)**는 데이터베이스에 쓰기 작업을 수행하기 전에 특정 조건을 검사하여, 조건이 충족될 때만 작업을 허용하는 강력한 기능입니다. 이 아티클에서는 DynamoDB의 조건부 쓰기 개념을 자세히 살펴보고, 다양한 활용 사례를 통해 그 중요성을 알아보겠습니다.

---

## 💡 조건부 쓰기(Conditional Writes)란?

조건부 쓰기는 **`PutItem`**, **`UpdateItem`**, **`DeleteItem`**, **`BatchWriteItem`**과 같은 쓰기 작업에 **조건식(Condition Expression)**을 추가하는 기능입니다. 이 조건식은 작업이 실행되기 전에 DynamoDB가 평가하며, 결과가 `true`일 때만 쓰기 작업이 성공하고, `false`일 때는 실패(거부)됩니다.

### **✅ 필터 식(Filter Expression)과의 차이점**

많은 사용자가 조건식과 필터 식을 혼동하지만, 이 둘은 명확한 차이가 있습니다.

- **조건식(Condition Expression)**: 쓰기 작업(Write Operations)에 사용되며, **작업의 성공/실패 여부**를 결정합니다.
    
- **필터 식(Filter Expression)**: 읽기 작업(Read Operations)에 사용되며, **반환되는 결과에 추가적인 필터링**을 적용합니다. 필터링은 읽기 작업이 완료된 후 수행되므로, 읽기 용량 단위(RCU) 소모량에 영향을 주지 않습니다.

|구분|용도|적용 대상|결과|
|---|---|---|---|
|**조건식**|데이터 수정/삭제 전 조건 검사|쓰기 작업 (`PutItem`, `UpdateItem`, `DeleteItem`)|조건 충족 시 작업 실행, 불충족 시 작업 거부|
|**필터 식**|검색 결과 필터링|읽기 작업 (`Query`, `Scan`)|반환되는 데이터의 양을 줄임|

---

## 🔧 다양한 조건식 예제

DynamoDB는 데이터 타입, 존재 여부, 값 비교 등 다양한 조건식을 지원합니다.

### 1. `attribute_exists` / `attribute_not_exists`

특정 속성이 존재하거나 존재하지 않을 때만 작업을 수행하도록 합니다. 이 기능은 동시성 문제를 해결하는 데 매우 유용합니다.

- **새 항목 생성 시 덮어쓰기 방지**: `attribute_not_exists(partition_key)` 조건을 사용하면, 동일한 파티션 키를 가진 항목이 이미 존재할 경우 새로운 `PutItem` 작업이 실패하여 기존 데이터를 실수로 덮어쓰는 것을 방지할 수 있습니다.
    
- **특정 속성이 있는 항목만 삭제**: `DeleteItem` 작업 시 `attribute_exists(price)` 조건을 사용하면, `price` 속성이 있는 항목만 삭제하여 데이터 정리 작업을 수행할 수 있습니다. 예를 들어, 가격이 설정되지 않은 항목은 삭제하지 않습니다.
    

### 2. 값 비교 조건

특정 값의 범위를 확인하거나 다른 값과 비교하여 작업을 수행합니다.

- **예제 1: `UpdateItem` with Price Condition**:
    
    - 상품 가격을 업데이트할 때, 가격이 특정 한도 이상일 경우에만 할인을 적용하도록 조건을 설정할 수 있습니다.
        
    - **조건식**: `price > :limit`
        
    - **설명**: 현재 상품의 가격(`price`)이 `:limit` 값(예: `500`)보다 클 때만 가격을 업데이트합니다. 이 조건을 통해 가격이 `500` 이하로 떨어지는 것을 방지할 수 있습니다.

```JSON
{
  "UpdateExpression": "SET price = price - :discount",
  "ConditionExpression": "price > :limit",
  "ExpressionAttributeValues": {
    ":discount": 150,
    ":limit": 500
  }
}
```

- **예제 2: `DeleteItem` with Price and Category Condition**:
    
    - 특정 카테고리에 속하고 가격이 특정 범위 안에 있는 상품만 삭제합니다.
        
    - **조건식**: `product_category IN (:category1, :category2) AND price BETWEEN :low AND :high`
        
    - **설명**: 상품의 카테고리가 '스포츠 용품'이고 가격이 `500`과 `600` 사이인 경우에만 항목을 삭제합니다. 만약 가격이 `650`이라면, 카테고리 조건이 충족되더라도 전체 조건은 `false`가 되어 삭제 작업이 실패합니다.

### 3. 문자열 비교 조건

`begins_with` 또는 `contains`와 같은 함수를 사용하여 문자열 속성을 기반으로 조건을 설정할 수 있습니다.

- **예제: `DeleteItem` with `begins_with`**:
    
    - 이미지 URL이 'http'로 시작하는(즉, 보안되지 않은) 항목을 삭제합니다.
        
    - **조건식**: `begins_with(image_url, 'http://')`
        
    - **설명**: 이 조건은 URL이 `https://`로 시작하는 항목에는 영향을 주지 않고, `http://`로 시작하는 항목만 삭제합니다.

---

## 🎯 조건부 쓰기의 중요성

조건부 쓰기는 단순히 데이터를 검증하는 것을 넘어, DynamoDB 애플리케이션의 **견고성(robustness)**과 **데이터 무결성(data integrity)**을 보장하는 핵심 기능입니다.

- **동시성 제어**: 여러 사용자가 동시에 같은 항목에 접근하여 업데이트를 시도할 때, 조건부 쓰기를 사용하면 원자성(Atomic)을 보장하여 예상치 못한 데이터 충돌을 방지할 수 있습니다. 예를 들어, 재고를 업데이트할 때 재고 수량이 0보다 클 때만 업데이트를 허용하는 방식입니다.
    
- **오류 방지**: 잘못된 데이터나 조건에 맞지 않는 데이터가 테이블에 쓰여지는 것을 원천적으로 차단합니다. 이는 애플리케이션 레벨에서 복잡한 로직을 구현하지 않고도 데이터 유효성 검사를 수행할 수 있게 해줍니다.
    

**결론적으로, 조건식은 DynamoDB 쓰기 작업을 위한 강력한 '안전장치' 역할을 합니다. DynamoDB를 사용하는 애플리케이션을 개발할 때는 반드시 조건부 쓰기를 활용하여 데이터의 정확성과 신뢰성을 확보해야 합니다.**