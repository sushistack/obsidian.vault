
**CloudFormation 롤백**은 스택 생성 또는 업데이트가 실패했을 때, 원래의 안정적인 상태로 되돌리는 자동 복구 기능입니다. 롤백은 인프라의 일관성을 유지하고, 불완전하거나 오류가 있는 리소스가 남는 것을 방지하는 데 필수적입니다.

#### 1. 스택 생성 실패 시 롤백

- **기본 동작**: 스택 생성 중 오류가 발생하면, CloudFormation은 기본적으로 **모든 스택 리소스**를 삭제하고 롤백합니다. 이 경우 사용자는 실패 원인을 파악하기 위해 로그를 확인해야 합니다. 생성된 리소스는 롤백되므로 콘솔에서 볼 수 없습니다.
    
- **롤백 비활성화 옵션**: 오류 발생 시 **`Preserve successfully provisioned resources`** 옵션을 선택하여 롤백을 비활성화할 수 있습니다.
    
    - **효과**: 스택 생성은 실패하지만, 오류가 발생하기 전까지 성공적으로 생성된 리소스는 그대로 남게 됩니다. 이를 통해 사용자는 리소스를 직접 확인하며 실패 원인을 파악할 수 있습니다.

    - **주의**: 이 옵션은 불완전한 스택을 남기므로, 문제 해결 후에는 수동으로 스택을 삭제해야 합니다.

#### 2. 스택 업데이트 실패 시 롤백

- **기본 동작**: 스택 업데이트 중 오류가 발생하면, CloudFormation은 자동으로 **마지막으로 알려진 안정적인 상태(last known stable state)**로 롤백합니다. 새로 생성되거나 변경된 리소스는 모두 삭제됩니다.

- **롤백 비활성화**: 업데이트 시에도 롤백을 비활성화하여 실패한 리소스를 보존할 수 있습니다.

#### 3. 롤백 실패 시 (`ContinueUpdateRollback`)

롤백이 실패하는 드문 경우가 발생할 수 있습니다. 이는 주로 사용자가 스택 리소스를 수동으로 변경하여 CloudFormation이 롤백을 완료할 수 없는 경우에 발생합니다.

- **해결 방법**:
    
    1. 문제가 된 리소스를 수동으로 수정하여 CloudFormation의 템플릿 상태와 일치시킵니다.

    2. `ContinueUpdateRollback` 명령을 사용하여 CloudFormation에게 롤백 프로세스를 다시 시도하도록 지시합니다. 이 기능은 AWS 콘솔, API 또는 CLI를 통해 사용할 수 있습니다.


### 💻 실습 예시

|실습 시나리오|템플릿 파일|결과|
|---|---|---|
|**스택 생성 실패 (기본 롤백)**|`trigger-failure.yaml` (존재하지 않는 AMI ID 포함)|EC2 인스턴스 생성 실패 -> 스택 롤백 -> 보안 그룹 포함 모든 리소스 삭제|
|**스택 생성 실패 (롤백 비활성화)**|`trigger-failure.yaml`|`Stack failure options`에서 `Preserve successfully provisioned resources` 선택 -> EC2 인스턴스 생성 실패 -> 보안 그룹은 남음 -> 스택은 `CREATE_FAILED` 상태|
|**스택 업데이트 실패 (기본 롤백)**|`just-ec2.yaml`로 스택 생성 후, `trigger-failure.yaml`로 업데이트|EC2 인스턴스 업데이트 실패 -> 스택 롤백 -> 새로운 보안 그룹 삭제 -> 스택이 원래의 `just-ec2.yaml` 상태로 되돌아감|

이러한 롤백 메커니즘을 이해하면 CloudFormation 스택 관리 시 오류를 효과적으로 처리하고 복구할 수 있습니다.