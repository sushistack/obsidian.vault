
AWS CLI(명령줄 인터페이스)나 SDK에서 MFA(다단계 인증)를 사용해야 할 때가 있습니다. 이 경우, 영구적인 IAM 자격 증명 대신 **임시 세션 토큰**을 발급받아 사용해야 합니다. 이 작업을 위해 사용되는 핵심 API는 **`STS GetSessionToken`**입니다.

이 가이드에서는 `STS GetSessionToken` API를 사용하여 MFA 기반의 임시 자격 증명을 얻고, 이를 AWS CLI 프로파일에 설정하는 방법을 실습해 보겠습니다.

---

### 1. IAM 사용자에게 MFA 디바이스 할당하기 📱

`STS GetSessionToken`을 사용하려면 먼저 IAM 사용자에게 MFA 디바이스가 할당되어 있어야 합니다.

1. IAM 콘솔에서 사용자(User)를 선택합니다.
2. `보안 자격 증명(Security credentials)` 탭으로 이동합니다.
3. `MFA 디바이스 할당(Assign MFA device)`을 클릭하고 **가상 MFA 디바이스**를 선택합니다.
4. 인증 앱(예: Google Authenticator, Authy)을 사용하여 QR 코드를 스캔하고, 연속으로 두 개의 MFA 코드를 입력하여 디바이스를 등록합니다.
5. 등록이 완료되면, MFA 디바이스의 **ARN(Amazon Resource Name)**을 복사해 둡니다. 이는 다음 단계에서 `serial-number`로 사용됩니다.

---

### 2. `STS GetSessionToken`으로 임시 자격 증명 발급받기 🔐

MFA 디바이스가 등록된 후, AWS CLI에서 `get-session-token` 명령어를 실행하여 임시 자격 증명을 얻습니다.

**명령어:**

```Bash
aws sts get-session-token --serial-number <MFA_디바이스_ARN> --token-code <MFA_코드>
```

**설명:**

- `--serial-number`: IAM 콘솔에서 복사한 MFA 디바이스의 ARN을 입력합니다.
- `--token-code`: 인증 앱에서 현재 표시되는 6자리 MFA 코드를 입력합니다.
- **추가 옵션:** `--duration-seconds` 옵션으로 토큰의 유효 기간을 지정할 수 있습니다. (기본값은 1시간)

**결과:** 명령어를 실행하면, 다음과 같은 JSON 형식의 결과가 반환됩니다.

```JSON
{
    "Credentials": {
        "AccessKeyId": "...",
        "SecretAccessKey": "...",
        "SessionToken": "...",
        "Expiration": "2025-08-03T23:51:01Z"
    }
}
```

이 자격 증명은 `AccessKeyId`, `SecretAccessKey`, `SessionToken`으로 구성된 **임시 자격 증명**입니다.

---

### 3. 임시 자격 증명으로 CLI 프로파일 설정하기 👨‍💻

발급받은 임시 자격 증명을 사용하여 새로운 CLI 프로파일을 설정하면, 해당 프로파일을 통해 MFA 인증이 필요한 작업을 수행할 수 있습니다.

1. **새 프로파일 설정:** `aws configure --profile <프로파일_이름>` 명령어를 사용하여 새로운 프로파일을 생성합니다.

```Bash
aws configure --profile mfa-session
```

2. `AccessKeyId`와 `SecretAccessKey`를 방금 얻은 값으로 입력합니다.
3. **`aws_session_token` 추가:**
    - `~/.aws/credentials` 파일을 텍스트 편집기로 엽니다.
    - 생성된 `[mfa-session]` 프로파일 섹션에 `aws_session_token` 항목을 추가하고, `SessionToken` 값을 복사하여 붙여넣습니다.

```TOML
[mfa-session]
aws_access_key_id = <발급받은 AccessKeyId>
aws_secret_access_key = <발급받은 SecretAccessKey>
aws_session_token = <발급받은 SessionToken>

```

4. **CLI 명령어 실행:**
    - `--profile` 옵션과 함께 새로 설정한 프로파일을 사용하여 명령어를 실행합니다.

```Bash
aws s3 ls --profile mfa-session
```

- 이 명령은 MFA로 생성된 임시 자격 증명을 사용하여 S3 버킷 목록을 조회합니다.

**핵심 요약:**

- MFA를 CLI에서 사용하려면 **`STS GetSessionToken`** API를 호출해야 합니다.
- 이 API는 `AccessKeyId`, `SecretAccessKey`, 그리고 필수적인 **`SessionToken`**을 포함하는 임시 자격 증명을 반환합니다.
- 이 자격 증명들을 CLI 프로파일에 설정하여 MFA가 필요한 AWS 작업을 수행할 수 있습니다.