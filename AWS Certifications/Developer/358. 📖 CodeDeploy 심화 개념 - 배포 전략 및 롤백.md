
이번 가이드에서는 CodeDeploy의 핵심 배포 개념인 EC2/ASG(Auto Scaling Group) 배포 전략과 롤백 메커니즘에 대해 더 깊이 있게 살펴보겠습니다.

---

## 🏗️ 1. EC2/온프레미스 배포 전략

![[Pasted image 20250909203919.png]]

CodeDeploy는 `appspec.yml` 파일을 사용하여 배포 방식을 정의합니다. 이 파일은 코드의 루트 디렉터리에 위치하며, 배포 단계(hooks)를 통해 특정 시점에 실행할 스크립트를 지정할 수 있습니다.

### **인플레이스(In-place) 배포**

- **정의:** 기존 EC2 인스턴스 그룹의 애플리케이션을 직접 업데이트하는 방식입니다.
    
- **특징:**
    
    - **단계별 업데이트:** `HalfAtATime` 같은 설정을 통해 한 번에 절반씩 업데이트하는 등, 점진적인 배포가 가능합니다.
        
    - **ASG와의 연동:** 오토 스케일링 그룹(ASG)에 새로운 인스턴스가 추가되면, CodeDeploy가 자동으로 최신 애플리케이션 버전을 배포합니다. 이 기능은 ASG 환경에서 인플레이스 배포의 강력한 이점입니다.
        
- **작동 방식:**
    
    1. `HalfAtATime` 설정 시, 인스턴스의 절반이 트래픽을 중단하고 업데이트를 시작합니다.
        
    2. 업데이트가 완료되면, 나머지 절반이 동일한 과정을 거칩니다.
        

---

## 🟢🔵 2. 블루/그린(Blue/Green) 배포

블루/그린 배포는 EC2/ASG, 람다, ECS 등 다양한 플랫폼에서 지원하는 무중단 배포 전략입니다.

### **정의**

- **블루(Blue):** 현재 운영 중인 애플리케이션 버전(`v1`)이 실행 중인 환경입니다.
    
- **그린(Green):** 새로운 애플리케이션 버전(`v2`)을 위한 새로운 환경입니다.
    

### **ASG에서의 블루/그린 배포 과정**

1. **새로운 ASG 생성:** CodeDeploy가 `v2` 론치 템플릿(Launch Template)을 사용하여 **새로운 오토 스케일링 그룹(그린 환경)**을 생성합니다.
    
2. **애플리케이션 배포:** CodeDeploy는 새로운 EC2 인스턴스에 `v2` 애플리케이션을 배포합니다.
    
3. **트래픽 전환:** 로드 밸런서(ELB)가 트래픽을 점진적 또는 즉시적으로 `블루` 환경에서 `그린` 환경으로 전환합니다.
    
    - 일부 트래픽을 `v2`로 전환하고, 헬스 체크를 통해 문제가 없는지 확인하는 **카나리(Canary)** 방식도 사용될 수 있습니다.
        
4. **기존 ASG 정리:** 트래픽 전환이 완료되면 기존 **`v1` ASG(블루 환경)**는 제거됩니다.
    

### **블루/그린 배포의 장점**

- **무중단(Zero Downtime):** 사용자는 배포 과정 중에도 서비스 중단을 경험하지 않습니다.
    
- **쉬운 롤백:** 문제가 발생할 경우, 로드 밸런서의 트래픽을 즉시 `블루` 환경으로 되돌려 롤백할 수 있습니다.
    

---

## ⏪ 3. 롤백(Rollback) 메커니즘

롤백은 이전에 성공적으로 배포된 애플리케이션 버전으로 되돌아가는 과정입니다. CodeDeploy는 롤백을 자동으로 또는 수동으로 수행할 수 있습니다.

### **자동 롤백 조건**

- **배포 실패:** 배포 과정 중 오류가 발생하여 실패한 경우.
    
- **CloudWatch 알람:** 배포 후 CloudWatch 알람이 트리거되어 애플리케이션의 상태가 비정상임을 알리는 경우.
    

### **롤백의 작동 방식**

CodeDeploy는 단순한 복원(restore)이 아닌, **새로운 배포를 수행**하여 롤백을 구현합니다.

- CodeDeploy는 마지막으로 성공했던 **"known-good"** 애플리케이션 리비전을 새로운 배포로 간주하고 실행합니다.
    
- 이 과정은 **`재배포(redeployment)`**이며, 단순히 이전 상태로 돌아가는 것이 아니라 새로운 배포 이력을 남깁니다.
    

|특징|설명|
|---|---|
|**자동 롤백**|배포 실패 또는 CloudWatch 알람에 의해 자동 트리거됩니다.|
|**수동 롤백**|사용자가 수동으로 롤백을 시작할 수 있습니다.|
|**롤백 비활성화**|배포 시 롤백 기능을 비활성화할 수 있습니다.|
|**롤백 메커니즘**|**이전 상태로 복원하는 것이 아니라, 마지막 성공 리비전으로 `새로운 배포`를 실행합니다.**|