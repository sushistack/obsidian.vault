
μ΄λ² κ°€μ΄λ“μ—μ„λ” Amazon API Gatewayμ **μ¤ν…μ΄μ§€ λ³€μ(Stage Variables)**λ¥Ό ν™μ©ν•μ—¬ μ—¬λ¬ Lambda ν•¨μ λ²„μ „ λ° λ³„μΉ­(Alias)μ„ λ™μ μΌλ΅ μ—°κ²°ν•λ” λ°©λ²•μ„ μƒμ„Έν μ•μ•„λ³΄κ² μµλ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ APIλ¥Ό μ¬λ°°ν¬ν•μ§€ μ•κ³ λ„ ν™κ²½λ³„λ΅ λ‹¤λ¥Έ λ°±μ—”λ“ μ„λΉ„μ¤λ¥Ό νΈμ¶ν•λ” μ μ—°ν• μ•„ν‚¤ν…μ²λ¥Ό κµ¬μ¶•ν•  μ μμµλ‹λ‹¤.

---

## π’» 1λ‹¨κ³„: μ—¬λ¬ Lambda ν•¨μ λ²„μ „ λ° λ³„μΉ­ μƒμ„±ν•κΈ°

λ¨Όμ €, API Gatewayμ™€ μ—°λ™ν•  Lambda ν•¨μλ¥Ό λ§λ“¤κ³ , μ—¬λ¬ λ²„μ „μ— λ€ν• λ³„μΉ­μ„ μƒμ„±ν•©λ‹λ‹¤.

1. **ν•¨μ μƒμ„±**: `api-gateway-stage-variables-get`λΌλ” μ΄λ¦„μΌλ΅ Lambda ν•¨μλ¥Ό μƒμ„±ν•©λ‹λ‹¤.
    
2. **λ²„μ „ 1 μ½”λ“**: λ‹¤μ μ½”λ“λ¥Ό λ¶™μ—¬λ„£κ³  **λ°°ν¬**ν• λ’¤, **μƒ λ²„μ „ κ²μ‹(Publish new version)**λ¥Ό ν΄λ¦­ν•μ—¬ **λ²„μ „ 1**μ„ μƒμ„±ν•©λ‹λ‹¤.

```Python
import json

def lambda_handler(event, context):
    return {
        'statusCode': 200,
        'headers': {'Content-Type': 'application/json'},
        'body': json.dumps('Hello from Lambda v1')
    }
```

3. **λ²„μ „ 2 μ½”λ“**: ν•¨μ μ½”λ“λ¥Ό `'Hello from Lambda v2'`λ΅ μμ •ν•κ³  **λ°°ν¬**ν• λ’¤, **μƒ λ²„μ „ κ²μ‹**λ¥Ό ν΄λ¦­ν•μ—¬ **λ²„μ „ 2**λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
    
4. **μµμ‹  λ²„μ „ μ½”λ“**: μ½”λ“λ¥Ό `'Hello from Lambda in DEV'`λ΅ λ‹¤μ‹ μμ •ν•κ³  **λ°°ν¬**λ§ ν•κ³  λ²„μ „μ„ κ²μ‹ν•μ§€ μ•μµλ‹λ‹¤. μ΄ μ½”λ“λ” `$LATEST` λ²„μ „μΌλ΅ λ‚¨κ²¨λ‘΅λ‹λ‹¤.
    

---

### β¨ Lambda λ³„μΉ­ μƒμ„±ν•κΈ°

μ΄μ  κ° Lambda λ²„μ „λ“¤μ„ κ°€λ¦¬ν‚¤λ” **λ³„μΉ­(Alias)**μ„ μƒμ„±ν•©λ‹λ‹¤. λ³„μΉ­μ„ μ‚¬μ©ν•λ©΄ νΉμ • Lambda λ²„μ „μ— λ€ν• ν¬μΈν„° μ—­ν• μ„ ν•μ—¬, API Gatewayλ” λ³„μΉ­λ§ νΈμ¶ν•κ³  λ³„μΉ­μ΄ μ‹¤μ  λ²„μ „μ„ κ°€λ¦¬ν‚¤λ„λ΅ μ„¤μ •ν•  μ μμµλ‹λ‹¤.

|λ³„μΉ­ μ΄λ¦„|μ„¤λ…|
|---|---|
|**`PROD`**|κ°€μ¥ μ•μ •μ μΈ **λ²„μ „ 1**μ„ κ°€λ¦¬ν‚µλ‹λ‹¤.|
|**`TEST`**|ν…μ¤νΈ μ¤‘μΈ **λ²„μ „ 2**λ¥Ό κ°€λ¦¬ν‚µλ‹λ‹¤.|
|**`DEV`**|κ°λ° μ¤‘μΈ **`$LATEST`** λ²„μ „μ„ κ°€λ¦¬ν‚µλ‹λ‹¤.|

---

## π”— 2λ‹¨κ³„: API Gatewayμ™€ Lambda λ³„μΉ­ λ™μ  μ—°κ²°ν•κΈ°

μ΄μ  API Gatewayμ—μ„ μ¤ν…μ΄μ§€ λ³€μλ¥Ό μ‚¬μ©ν•μ—¬ μ„μ—μ„ μƒμ„±ν• Lambda λ³„μΉ­μ„ λ™μ μΌλ΅ νΈμ¶ν•λ„λ΅ μ„¤μ •ν•©λ‹λ‹¤.

1. **μƒ λ¦¬μ†μ¤ μƒμ„±**: API Gateway μ½μ†”μ—μ„ `/` λ¦¬μ†μ¤ μ•„λμ— `stage-variables`λΌλ” μ΄λ¦„μ λ¦¬μ†μ¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
    
2. **GET λ©”μ„λ“ μƒμ„±**: `/stage-variables` λ¦¬μ†μ¤μ— **GET** λ©”μ„λ“λ¥Ό μ¶”κ°€ν•©λ‹λ‹¤.
    
3. **Lambda ν•¨μ ARN μ…λ ¥**:
    
    - **ν†µν•© μ ν•**: Lambda ν•¨μ
        
    - **ν”„λ΅μ‹ ν†µν•© μ‚¬μ©**: μ²΄ν¬
        
    - **Lambda ν•¨μ**: Lambda ν•¨μμ ARNμ„ μ…λ ¥ν•λ, λμ— `:dev` λ€μ‹  μ¤ν…μ΄μ§€ λ³€μλ¥Ό μ‚¬μ©ν•©λ‹λ‹¤.
        
    - **Lambda ARN ν•μ‹**: `arn:aws:lambda:REGION:ACCOUNT_ID:function:FUNCTION_NAME:${stageVariables.lambdaAlias}`
        

### π“ IAM κ¶ν• λ¶€μ—¬ν•κΈ°

μ΄ μ„¤μ •μ€ API Gatewayκ°€ `dev`, `test`, `prod`μ™€ κ°™μ΄ λ™μ μΌλ΅ λ³€ν•λ” Lambda λ³„μΉ­μ„ νΈμ¶ν•λ„λ΅ ν•©λ‹λ‹¤. λ”°λΌμ„ κ° λ³„μΉ­μ— λ€ν•΄ API Gateway νΈμ¶ κ¶ν•μ„ λ…μ‹μ μΌλ΅ λ¶€μ—¬ν•΄μ•Ό ν•©λ‹λ‹¤. λ‹¤μ λ…λ Ήμ–΄λ¥Ό AWS CloudShellμ—μ„ μ‹¤ν–‰ν•©λ‹λ‹¤.

```Bash
aws lambda add-permission \
--function-name arn:aws:lambda:REGION:ACCOUNT_ID:function:FUNCTION_NAME:PROD \
--statement-id "AllowAPIGatewayInvokePROD" \
--action lambda:InvokeFunction \
--principal apigateway.amazonaws.com \
--source-arn "arn:aws:execute-api:REGION:ACCOUNT_ID:API_ID/*/GET/stage-variables"

aws lambda add-permission \
--function-name arn:aws:lambda:REGION:ACCOUNT_ID:function:FUNCTION_NAME:TEST \
--statement-id "AllowAPIGatewayInvokeTEST" \
--action lambda:InvokeFunction \
--principal apigateway.amazonaws.com \
--source-arn "arn:aws:execute-api:REGION:ACCOUNT_ID:API_ID/*/GET/stage-variables"

aws lambda add-permission \
--function-name arn:aws:lambda:REGION:ACCOUNT_ID:function:FUNCTION_NAME:DEV \
--statement-id "AllowAPIGatewayInvokeDEV" \
--action lambda:InvokeFunction \
--principal apigateway.amazonaws.com \
--source-arn "arn:aws:execute-api:REGION:ACCOUNT_ID:API_ID/*/GET/stage-variables"
```

---

## β… 3λ‹¨κ³„: μ¤ν…μ΄μ§€ λ³€μ μ„¤μ • λ° API λ°°ν¬ν•κΈ°

μ΄μ  κ° μ¤ν…μ΄μ§€μ— λ§λ” `lambdaAlias` μ¤ν…μ΄μ§€ λ³€μλ¥Ό μ„¤μ •ν•κ³  APIλ¥Ό λ°°ν¬ν•©λ‹λ‹¤.

1. **API λ°°ν¬**: **API λ°°ν¬(Deploy API)**λ¥Ό ν΄λ¦­ν•κ³ , `dev`λΌλ” μƒλ΅μ΄ μ¤ν…μ΄μ§€λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
    
2. **μ¤ν…μ΄μ§€ λ³€μ μ„¤μ •**: `dev` μ¤ν…μ΄μ§€λ΅ μ΄λ™ν•μ—¬ **μ¤ν…μ΄μ§€ λ³€μ(Stage Variables)** νƒ­μ„ ν΄λ¦­ν•©λ‹λ‹¤.
    
    - **μ΄λ¦„**: `lambdaAlias`
        
    - **κ°’**: `DEV`
        
3. **λ‹¤λ¥Έ μ¤ν…μ΄μ§€ λ°°ν¬**: λ™μΌν• λ°©μ‹μΌλ΅ `TEST`μ™€ `PROD` μ¤ν…μ΄μ§€λ¥Ό μ¶”κ°€λ΅ μƒμ„±ν•κ³  κ°κ°μ `lambdaAlias` λ³€μ κ°’μ„ `TEST`μ™€ `PROD`λ΅ μ„¤μ •ν•©λ‹λ‹¤.

|μ¤ν…μ΄μ§€|μ¤ν…μ΄μ§€ λ³€μ μ΄λ¦„|μ¤ν…μ΄μ§€ λ³€μ κ°’|
|---|---|---|
|`dev`|`lambdaAlias`|`DEV`|
|`test`|`lambdaAlias`|`TEST`|
|`prod`|`lambdaAlias`|`PROD`|

---

## π 4λ‹¨κ³„: μµμΆ… κ²°κ³Ό ν™•μΈν•κΈ°

λ§μ§€λ§‰μΌλ΅, λ°°ν¬λ APIμ URLμ„ μ‚¬μ©ν•μ—¬ κ° μ¤ν…μ΄μ§€λ¥Ό νΈμ¶ν•κ³  μ¤ν…μ΄μ§€ λ³€μκ°€ μ •μƒμ μΌλ΅ μ‘λ™ν•λ”μ§€ ν™•μΈν•©λ‹λ‹¤.

- **PROD ν™κ²½ ν…μ¤νΈ**:
    
    - URL: `https://your-api-id.execute-api.region.amazonaws.com/prod/stage-variables`
        
    - κ²°κ³Ό: `"Hello from Lambda v1"`
        
- **TEST ν™κ²½ ν…μ¤νΈ**:
    
    - URL: `https://your-api-id.execute-api.region.amazonaws.com/test/stage-variables`
        
    - κ²°κ³Ό: `"Hello from Lambda v2"`
        
- **DEV ν™κ²½ ν…μ¤νΈ**:
    
    - URL: `https://your-api-id.execute-api.region.amazonaws.com/dev/stage-variables`
        
    - κ²°κ³Ό: `"Hello from Lambda in DEV"`


μ΄μ²λΌ μ¤ν…μ΄μ§€ λ³€μλ¥Ό μ‚¬μ©ν•λ©΄ λ‹¨ ν•λ‚μ API Gateway λ©”μ„λ“ μ„¤μ •λ§μΌλ΅λ„ URLμ— λ”°λΌ λ‹¤λ¥Έ Lambda λ³„μΉ­μ„ νΈμ¶ν•  μ μμµλ‹λ‹¤. μ΄λ” **ν™κ²½λ³„λ΅ λ‹¤λ¥Έ λ°±μ—”λ“ λ΅μ§μ„ λ¶„λ¦¬**ν•κ³  **λ°°ν¬λ¥Ό μ μ—°ν•κ² κ΄€λ¦¬**ν•λ” λ° μμ–΄ λ§¤μ° κ°•λ ¥ν• ν¨ν„΄μ…λ‹λ‹¤.