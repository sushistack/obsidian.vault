
이번 아티클에서는 **AWS Lambda 함수를 비동기식으로 호출하는 방법**을 직접 실습해 보고, 호출 실패 시 **데드 레터 큐(DLQ)**를 이용한 이벤트 처리 과정을 살펴보겠습니다.

### 1. ⚙️ Lambda 함수 코드 수정 및 비동기 호출

먼저, 비동기식 호출의 특징을 확인하기 위해 의도적으로 실패를 일으키는 Lambda 함수 코드를 사용합니다.

```Python
import json

def lambda_handler(event, context):
    print("Received event:", event)
    
    # 이 부분을 주석 해제하여 함수가 의도적으로 실패하도록 만듭니다.
    # raise Exception("Something went wrong!")
    
    return {
        'statusCode': 200,
        'body': json.dumps('Hello from Lambda!')
    }
```

함수 코드를 위와 같이 수정한 후 **배포(Deploy)**합니다.

콘솔을 통한 비동기 호출은 불가능하므로, **AWS CloudShell**을 사용하여 CLI로 함수를 호출합니다. `invoke` 명령어에 `--invocation-type`을 `Event`로 지정하면 비동기 호출이 됩니다.

```Bash
aws lambda invoke \
    --function-name demo-lambda \
    --invocation-type Event \
    --cli-binary-format raw-in-base64-out \
    --payload '{"key1": "value1"}' \
    response.json
```

명령어를 실행하면, 함수 실행 결과와 관계없이 **`202` 상태 코드**가 즉시 반환됩니다. 이는 Lambda 서비스가 이벤트를 성공적으로 수신했음을 의미하며, 함수가 실제로 성공했는지 실패했는지에 대한 정보는 포함되지 않습니다.

### 2. ⚠️ CloudWatch 로그를 통한 실패 확인

비동기 호출의 성공/실패 여부를 확인하려면 **CloudWatch Logs**를 확인해야 합니다.

1. Lambda 함수 콘솔의 '모니터링(Monitor)' 탭으로 이동합니다.
    
2. `CloudWatch Logs` 섹션에서 로그 그룹으로 이동합니다.
    
3. 가장 최근의 로그 스트림을 열어보면, 함수 실행이 실패했음을 나타내는 **오류 메시지**를 확인할 수 있습니다.

이처럼 비동기 호출은 즉각적인 결과를 반환하지 않으므로, 함수 실행의 성공 여부는 CloudWatch Logs를 통해 사후적으로 확인해야 합니다.

---

### 3. 📦 데드 레터 큐(DLQ) 설정

비동기 호출이 실패했을 때 이벤트를 안전하게 처리하기 위해 **DLQ**를 설정합니다.

#### 3.1 SQS 큐 생성

1. AWS SQS 콘솔로 이동하여 **표준(Standard) 큐**를 생성합니다.
    
2. 큐 이름은 `lambda-DLQ`로 지정합니다.
    

#### 3.2 Lambda 함수에 DLQ 연결 및 IAM 권한 부여

1. Lambda 함수 콘솔의 '구성(Configuration)' 탭으로 이동합니다.
    
2. **비동기 호출(Asynchronous invocation)** 섹션에서 '편집(Edit)'을 클릭합니다.
    
3. **재시도 횟수(Retry attempts)**를 `2`로 설정합니다.
    
4. **DLQ 대상**으로 `SQS`를 선택하고, 생성한 `lambda-DLQ`를 지정합니다.
    
5. 이때, Lambda 함수에 SQS에 메시지를 보낼 권한이 없다는 에러가 발생할 수 있습니다. 이를 해결하려면 Lambda의 실행 역할(Execution Role)에 SQS 메시지 전송 권한을 추가해야 합니다.
    
6. '권한(Permissions)' 탭에서 실행 역할을 클릭하여 IAM 콘솔로 이동합니다.
    
7. '권한 추가(Add permissions)' -> '정책 연결(Attach policies)'을 클릭합니다.
    
8. `AmazonSQSFullAccess` 정책을 연결하여 SQS에 대한 모든 접근 권한을 부여합니다. 실습 목적상 `FullAccess`를 사용하지만, 프로덕션 환경에서는 최소한의 권한(예: `sqs:SendMessage`)만 부여해야 합니다.
    
9. 다시 Lambda 콘솔로 돌아와 DLQ 설정을 **저장**합니다.
    

---

### 4. 📊 DLQ 작동 확인

이제 DLQ가 제대로 작동하는지 확인하기 위해, 의도적으로 실패하도록 만든 Lambda 함수를 다시 비동기 호출합니다.

```Bash
aws lambda invoke \
    --function-name demo-lambda \
    --invocation-type Event \
    --cli-binary-format raw-in-base64-out \
    --payload '{"key1": "value1"}' \
    response.json
```

1. 함수가 즉시 실패합니다.
    
2. Lambda는 설정된 재시도 횟수(`2회`)에 따라 재시도를 수행합니다. CloudWatch Logs를 확인하면 동일한 요청 ID(`requestID`)에 대한 여러 실패 로그를 볼 수 있습니다.
    
3. 마지막 재시도까지 실패하면, Lambda는 이벤트를 `lambda-DLQ`로 보냅니다.
    
4. SQS 콘솔로 이동하여 `lambda-DLQ`를 선택하고 **'메시지 전송 및 수신(Send and receive messages)'** 탭에서 **'메시지 폴링(Poll for messages)'**을 클릭합니다.
    
5. 잠시 후, 실패한 이벤트가 메시지로 도착한 것을 확인할 수 있습니다.
    
6. 메시지를 클릭하면 이벤트의 페이로드와 함께 `Lambda-Error-Cause`와 같은 속성을 통해 실패 원인(`200 Something went wrong`) 및 Lambda 요청 ID를 확인할 수 있습니다.

이 실습을 통해 Lambda의 비동기 호출 실패 시 재시도 메커니즘과 DLQ를 통한 견고한 이벤트 처리 방식이 어떻게 작동하는지 이해할 수 있습니다.