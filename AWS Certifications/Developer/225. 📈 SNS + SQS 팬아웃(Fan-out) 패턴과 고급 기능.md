
## 🔁 팬아웃(Fan-out) 패턴이란?

![[Pasted image 20250817205405.png]]

**팬아웃(Fan-out)** 패턴은 하나의 메시지를 여러 SQS 큐에 동시에 보내는 아키텍처입니다. 생산자가 각 큐에 메시지를 개별적으로 보내는 대신, **SNS 토픽**에 한 번만 메시지를 발행하고, 여러 **SQS 큐를 해당 토픽의 구독자**로 설정합니다. 이렇게 하면 SNS가 메시지를 모든 구독자에게 자동으로 전달해줍니다.

### 주요 이점

- **느슨한 결합:** 생산자가 특정 큐를 직접 알 필요가 없어 시스템의 결합도가 낮아집니다.
- **확장성:** 새로운 큐를 추가하거나 제거할 때 생산자 코드를 수정할 필요 없이 SNS 토픽에 구독만 추가/제거하면 됩니다.
- **데이터 영속성:** SQS 큐가 메시지를 지속적으로 보관하므로 메시지 유실을 방지하고 재시도 처리가 가능합니다.

### 크로스-리전(Cross-Region) 전송

- SNS 토픽은 다른 AWS 리전의 SQS 큐로 메시지를 전송할 수 있어, 지리적으로 분산된 애플리케이션을 구축하는 데 유용합니다.

### S3 이벤트 알림에 활용

![[Pasted image 20250817205501.png]]

- S3 버킷의 이벤트 규칙은 특정 이벤트 유형에 대해 하나의 알림 대상(SNS 토픽 또는 SQS 큐)만 지정할 수 있습니다.
- 여러 큐로 같은 S3 이벤트 알림을 보내려면, **S3 이벤트를 SNS 토픽으로 보내고** 여러 SQS 큐가 해당 토픽을 구독하는 팬아웃 패턴을 사용해야 합니다.

---

## ⚙️ SNS와 SQS FIFO 큐의 결합

![[Pasted image 20250817205553.png]]

**SNS FIFO 토픽**은 메시지 순서와 중복 제거를 보장하는 SNS의 기능입니다. SNS FIFO 토픽을 SQS FIFO 큐와 결합하여 팬아웃 패턴을 구현할 수 있습니다.

### 특징

- **순서 보장:** `MessageGroupId`를 사용하여 메시지 그룹 내 순서를 보장합니다.
- **중복 제거:** `MessageDeduplicationId` 또는 콘텐츠 기반 중복 제거를 통해 메시지가 한 번만 처리되도록 합니다.
- **구독자:** 현재 SNS FIFO 토픽은 **SQS FIFO 큐만 구독자**로 지원합니다.

### 활용 사례

![[Pasted image 20250817205609.png]]

- **순서 보장이 필요한 팬아웃:** 주문 처리와 같이 여러 서비스에 동일한 메시지를 보내되, 순서가 중요한 경우 사용됩니다. 생산자는 SNS FIFO 토픽에 메시지를 보내고, 이를 구독하는 여러 SQS FIFO 큐가 순서가 보장된 메시지를 받습니다.

---

## 🎯 메시지 필터링(Message Filtering)

![[Pasted image 20250817205630.png]]

**메시지 필터링**은 SNS 구독에 JSON 정책을 적용하여, **특정 조건에 맞는 메시지만** 구독자에게 전달되도록 하는 기능입니다.

### 동작 원리

- **기본 동작:** 필터 정책이 없으면 구독자는 토픽에 발행된 모든 메시지를 받습니다.
- **필터 적용:** 메시지에 속성(Attribute)이 포함되어 있을 때, 구독자의 필터 정책과 일치하는 속성이 있는 메시지만 해당 구독자에게 전달됩니다.

### 활용 예시

- 온라인 상점의 거래 이벤트를 예로 들어보겠습니다. 모든 주문(`Placed`, `Canceled`, `Declined`)이 SNS 토픽에 발행됩니다.
- **주문 완료(`Placed`) 큐:** `State` 속성이 `Placed`인 메시지만 필터링하여 수신합니다.
- **주문 취소(`Canceled`) 큐:** `State` 속성이 `Canceled`인 메시지만 필터링하여 수신합니다.
- **모든 주문 큐:** 필터 정책 없이 모든 메시지를 수신합니다.

이 기능을 통해 하나의 토픽을 사용하면서도 각 큐의 목적에 맞게 메시지를 선별적으로 전달할 수 있어, 아키텍처의 유연성과 효율성을 크게 높일 수 있습니다.