
이번 강의에서는 Amazon Route 53의 **가중치 기반 라우팅 정책(Weighted Routing Policy)**에 대해 알아봅니다. 이 정책은 DNS 쿼리에 대한 응답 비율을 정교하게 제어할 수 있는 강력한 기능입니다.

---

### 1. 가중치 기반 라우팅 정책이란? 🤔

![[Pasted image 20250726221805.png]]

- **개념**: 여러 리소스(엔드포인트)에 **상대적인 가중치(Relative Weight)**를 할당하여, DNS 쿼리 트래픽을 각 리소스에 지정된 비율로 분산시키는 정책입니다.
    
- **작동 방식**:
    - 각 레코드에 **0부터 255 사이의 정수 값**을 가중치로 할당합니다.
    - Route 53은 전체 가중치의 합에서 각 레코드의 가중치가 차지하는 비율만큼 해당 레코드를 응답으로 반환합니다.
    - **예시**: 가중치가 70, 20, 10인 세 개의 레코드가 있다면, 전체 합은 100이 됩니다. Route 53은 70%의 쿼리에 첫 번째 레코드를, 20%에 두 번째 레코드를, 10%에 세 번째 레코드를 응답으로 반환합니다.
- **주요 특징**:
    - **동일한 레코드 이름과 유형**: 가중치 기반 라우팅을 적용하려면, 모든 레코드는 동일한 이름과 유형을 가져야 합니다.
    - **헬스 체크 연동 가능**: (추후 강의에서 자세히 다룰 예정이지만) 가중치 기반 라우팅은 헬스 체크와 연동하여, 비정상적인 엔드포인트에는 트래픽을 보내지 않도록 할 수 있습니다.
    - **가중치 0**: 특정 레코드의 가중치를 0으로 설정하면 해당 리소스로 트래픽이 보내지지 않습니다.
    - **모든 가중치가 0**: 모든 레코드의 가중치가 0인 경우, 모든 레코드가 동일한 비율로 응답됩니다.

### 2. 가중치 기반 라우팅 정책의 활용 사례 💡

- **다중 리전 부하 분산(Multi-Region Load Balancing)**: 여러 AWS 리전에 배포된 애플리케이션으로 트래픽을 분산할 때 사용합니다.
    
- **카나리 배포(Canary Deployments)**: 새로운 버전의 애플리케이션에 트래픽의 아주 작은 비율(예: 1~5%)만 먼저 보내고, 문제가 없으면 점진적으로 트래픽 비율을 늘려가는 배포 전략에 유용합니다.
    
- **A/B 테스트(A/B Testing)**: 다른 버전의 웹 페이지를 사용자에게 제공하고, 각 버전의 효과를 측정할 때 사용합니다.

### 3. 가중치 기반 라우팅 정책 실습 🧪

이전에 생성한 여러 리전의 EC2 인스턴스를 대상으로 가중치를 다르게 할당하여 트래픽이 어떻게 분산되는지 확인해 보겠습니다.

#### 3.1 가중치 기반 레코드 세트 생성

1. **Route 53 콘솔 접속**: 이전에 등록한 도메인(`yourchosendomain.com`)의 호스트 존으로 이동합니다.
2. **레코드 생성**: `레코드 생성(Create record)`을 클릭합니다.
3. **레코드 이름**: `weighted` (FQDN: `weighted.yourchosendomain.com`)
4. **레코드 유형**: `A`
5. **라우팅 정책**: `가중치 기반(Weighted)` 선택.
6. **첫 번째 레코드 (가중치 10)**:
    - **값**: 싱가포르(`ap-southeast-1`) EC2 인스턴스의 IPv4 주소 입력.
    - **가중치(Weight)**: `10`
    - **레코드 ID**: `ap-southeast-1`
    - **TTL**: 짧은 시간(예: `3`초)으로 설정합니다.
    - **다른 레코드 추가(Add another record)** 클릭.
7. **두 번째 레코드 (가중치 70)**:
    - **값**: 버지니아 북부(`us-east-1`) EC2 인스턴스의 IPv4 주소 입력.
    - **가중치(Weight)**: `70`
    - **레코드 ID**: `us-east-1`
    - **TTL**: `3`초
    - **다른 레코드 추가(Add another record)** 클릭.
8. **세 번째 레코드 (가중치 20)**:
    - **값**: 프랑크푸르트(`eu-central-1`) EC2 인스턴스의 IPv4 주소 입력.
    - **가중치(Weight)**: `20`
    - **레코드 ID**: `eu-central-1`
    - **TTL**: `3`초
9. **레코드 생성**: 설정이 완료되면 `레코드 생성(Create records)`을 클릭합니다.

#### 3.2 작동 확인 (웹 브라우저 및 Cloud Shell)

1. **웹 브라우저**: `http://weighted.yourchosendomain.com`으로 접속하여 페이지를 여러 번 새로고침합니다.
    - 전체 트래픽의 70%는 버지니아 북부(`us-east-1a`) 인스턴스로, 20%는 프랑크푸르트(`eu-central-1c`) 인스턴스로, 10%는 싱가포르(`ap-southeast-1b`) 인스턴스로 라우팅될 것입니다.
    - 새로고침 시 대부분의 경우 버지니아 북부의 "Hello World" 메시지가 표시될 것이고, 간혹 프랑크푸르트나 싱가포르의 메시지를 보게 될 것입니다.
2. **Cloud Shell**: `dig weighted.yourchosendomain.com` 명령어를 여러 번 실행해 봅니다.
    - `ANSWER SECTION`에 매번 **하나의 IP 주소만 응답**으로 반환되는 것을 확인할 수 있습니다.
    - 이 IP 주소는 각 가중치 비율에 따라 무작위로 선택된 결과입니다. `us-east-1`의 IP가 가장 많이 반환되고, `ap-southeast-1`의 IP는 가장 드물게 반환될 것입니다.

### 4. 결론 💡

**가중치 기반 라우팅 정책**은 트래픽을 각 엔드포인트에 정해진 비율로 정교하게 분산시키는 매우 유용한 기능입니다. 이를 통해 여러 리전에 걸친 부하 분산, 새로운 기능의 점진적 배포(카나리 배포), 그리고 A/B 테스트와 같은 다양한 고급 시나리오를 구현할 수 있습니다.
