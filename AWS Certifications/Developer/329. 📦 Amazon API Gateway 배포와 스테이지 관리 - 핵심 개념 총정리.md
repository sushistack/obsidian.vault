
이번 아티클에서는 Amazon API Gateway의 **배포(Deployment)**와 **스테이지(Stage)** 개념을 깊이 있게 다룹니다. API 변경 사항을 적용하고, 여러 버전을 동시에 운영하며, 환경별 설정을 유연하게 관리하는 방법을 상세히 알아보겠습니다.

---

## 🚀 1단계: 배포(Deployment)의 이해

API Gateway에서 API 설정을 변경한 후에는 반드시 **배포(Deployment)** 과정을 거쳐야만 그 변경 사항이 실제 API에 반영됩니다. 이는 많은 사용자들이 혼동하는 부분 중 하나입니다. 콘솔에서 메서드나 리소스 설정을 바꾸더라도, **'API 배포'**를 클릭하여 특정 **스테이지**에 배포해야만 최종적으로 클라이언트가 접근할 수 있는 API에 적용됩니다.

- **핵심**: 변경사항을 **'활성화'**하려면 반드시 배포해야 합니다.
    
- **히스토리 관리**: API Gateway는 배포 이력을 모두 저장하므로, 문제가 발생했을 때 특정 시점의 배포 상태로 **손쉽게 롤백**할 수 있습니다.

---

## 🌳 2단계: 스테이지(Stage)의 활용

![[Pasted image 20250907193244.png]]

**스테이지**는 API의 특정 배포 버전을 가리키는 논리적인 참조점입니다. 개발, 테스트, 운영 등 다양한 환경을 분리하여 관리하는 데 유용하게 사용됩니다.

### 📊 스테이지의 주요 기능

- **환경 분리**: `dev`, `test`, `prod`와 같이 명확한 이름의 스테이지를 생성하여 각기 다른 환경의 API를 독립적으로 운영할 수 있습니다.
    
- **버전 관리**: `v1`, `v2`, `v3` 등 API 버전을 스테이지로 관리하여, **이전 버전과의 호환성을 유지**하면서 새로운 기능을 점진적으로 출시할 수 있습니다. 예를 들어, `v1` 스테이지를 통해 기존 클라이언트의 API 요청을 처리하면서, 새로운 `v2` 스테이지를 만들어 신규 클라이언트를 대상으로 서비스를 제공할 수 있습니다.
    
- **고유한 URL**: 각 스테이지는 `https://api.example.com/v1` 또는 `https://api.example.com/v2`와 같이 고유한 호출 URL을 가집니다. 이를 통해 클라이언트는 자신이 원하는 버전의 API에 직접 접근할 수 있습니다.
    

|스테이지|용도|URL 예시|
|---|---|---|
|**`dev`**|개발 환경|`https://.../dev`|
|**`test`**|테스트 환경|`https://.../test`|
|**`prod`**|운영 환경|`https://.../prod`|
|**`v1`**|API 버전 1|`https://.../v1`|
|**`v2`**|API 버전 2|`https://.../v2`|

---

## 🔧 3단계: 스테이지 변수(Stage Variables)의 활용

**스테이지 변수**는 API Gateway 스테이지에 할당된 **환경 변수**와 같습니다. API를 재배포하지 않고도 스테이지별로 동적으로 설정을 변경할 수 있는 매우 강력한 기능입니다.

### 💡 스테이지 변수의 사용 예시

- **Lambda 함수 ARN 동적 지정**: `dev` 스테이지에서는 `dev` 환경의 Lambda 함수를, `prod` 스테이지에서는 `prod` 환경의 Lambda 함수를 호출하도록 설정할 수 있습니다.
    
- **HTTP 엔드포인트 변경**: 개발 환경에서는 테스트용 서버를, 운영 환경에서는 실제 프로덕션 서버를 가리키도록 설정할 수 있습니다.
    
- **매핑 템플릿에 값 전달**: 스테이지 변수의 값을 매핑 템플릿을 통해 Lambda 함수로 전달할 수 있습니다.
    

스테이지 변수는 `$stageVariables.variableName` 형식으로 API Gateway 내에서 참조됩니다.

### 🤝 Lambda Alias와 스테이지 변수 연동: 고급 패턴

![[Pasted image 20250907193310.png]]

스테이지 변수를 활용하는 가장 일반적이고 효율적인 패턴 중 하나는 **Lambda 함수 Alias**와 연동하는 것입니다.

이 패턴을 사용하면 API Gateway는 항상 특정 **별칭(Alias)**을 호출하고, 이 별칭이 실제 트래픽을 어떤 버전의 Lambda 함수로 보낼지 결정합니다.

|스테이지|스테이지 변수 (`lambdaAlias`)|연결된 Lambda Alias|트래픽 라우팅|
|---|---|---|---|
|**`dev`**|`dev`|`dev`|100% 최신 버전|
|**`test`**|`test`|`test`|v2 버전 100%|
|**`prod`**|`prod`|`prod`|v1 95%, v2 5% (카나리 배포)|

이 방식을 사용하면 Lambda 함수의 버전을 변경하거나 카나리 배포를 할 때 API Gateway를 재배포할 필요가 없습니다. 단지 Lambda 별칭의 설정을 변경하는 것만으로 트래픽을 제어할 수 있어, API 관리가 훨씬 유연하고 효율적이게 됩니다.