
애플리케이션을 지속적으로 개선하고 업데이트하는 과정에서 EC2 인스턴스의 구성을 변경해야 할 때가 많습니다. 예를 들어, 보안 패치가 적용된 새로운 AMI를 사용하거나, 최적화된 사용자 데이터를 적용하고 싶을 수 있습니다. 이때 ASG의 **인스턴스 새로 고침(Instance Refresh)** 기능은 현재 실행 중인 모든 인스턴스를 새롭게 업데이트된 구성으로 교체하는 매우 편리하고 안전한 방법을 제공합니다.

---

### 1. 인스턴스 새로 고침(Instance Refresh)이란 무엇인가요?

![[Pasted image 20250706131742.png]]

**인스턴스 새로 고침**은 ASG 내의 모든 EC2 인스턴스를 새롭게 지정된 **시작 템플릿(Launch Template)** 또는 **시작 구성(Launch Configuration)**의 최신 버전으로 교체하는 기능입니다. 이 기능은 인스턴스를 하나씩 종료하고 새로운 구성으로 다시 시작하는 과정을 자동으로 관리하여, 수동으로 인스턴스를 교체할 때 발생할 수 있는 서비스 중단 위험을 최소화합니다.

#### 1.1. 인스턴스 새로 고침의 필요성

- **AMI 업데이트:** 보안 패치가 적용되거나 최적화된 새로운 AMI를 적용해야 할 때.
- **사용자 데이터 변경:** 인스턴스 시작 시 실행되는 스크립트(예: 소프트웨어 설치, 구성 변경)를 업데이트해야 할 때.
- **인스턴스 유형 변경:** 더 나은 성능이나 비용 효율성을 위해 인스턴스 유형을 변경하고 싶을 때.
- **운영 체제 업데이트:** EC2 인스턴스의 운영 체제 버전을 업그레이드해야 할 때.

#### 1.2. 작동 방식

인스턴스 새로 고침은 ASG 내의 인스턴스를 점진적으로 교체합니다.

1. **새로운 시작 템플릿 생성:** 먼저 업데이트된 AMI, 사용자 데이터 등 새로운 구성을 포함하는 **새로운 시작 템플릿 버전**을 생성하거나 ASG의 기본 시작 템플릿을 변경합니다.
2. **인스턴스 새로 고침 시작:** ASG에서 `Start Instance Refresh` API 호출을 실행하거나 콘솔에서 인스턴스 새로 고침을 시작합니다.
3. **최소 정상 백분율(Minimum Healthy Percentage) 설정:** 새로 고침 과정에서 동시에 종료될 수 있는 인스턴스의 최대 비율을 정의합니다. (예: 60% 설정 시, 항상 ASG 인스턴스 중 최소 60%는 정상 상태를 유지해야 함)
    
4. **인스턴스 교체:**
    - ASG는 오래된 구성을 가진 일부 인스턴스를 **종료(terminate)**합니다.
    - 종료된 인스턴스 수만큼 **새로운 시작 템플릿**을 기반으로 새 인스턴스를 **시작(launch)**합니다.
    - 새 인스턴스가 시작되고 헬스 체크를 통과하면, 다음 오래된 인스턴스 그룹을 종료하고 새 인스턴스를 시작하는 과정을 반복합니다.

5. **전체 인스턴스 교체:** 이 과정이 반복되어 ASG의 모든 인스턴스가 새로운 시작 템플릿으로 교체될 때까지 진행됩니다.

---

### 2. 인스턴스 새로 고침 설정 옵션

인스턴스 새로 고침의 동작을 세밀하게 제어할 수 있는 몇 가지 중요한 설정이 있습니다.

#### 2.1. 최소 정상 백분율 (Minimum Healthy Percentage)

|설정 항목|설명|영향|
|---|---|---|
|**최소 정상 백분율**|인스턴스 새로 고침 과정 중 ASG 내에서 항상 정상(Healthy) 상태를 유지해야 하는 인스턴스의 **최소 비율**입니다.|이 값이 낮을수록 동시에 더 많은 인스턴스를 교체할 수 있지만, 서비스 중단 위험이 커질 수 있습니다.   <br>이 값이 높을수록 동시 교체 수가 적어 안전하지만, 새로 고침 시간이 오래 걸립니다.|
|**예시:**`60%`|ASG에 인스턴스가 10개 있다면, 새로 고침 중에도 최소 6개(60%)의 인스턴스는 항상 정상 상태여야 합니다.|이는 동시에 최대 4개(40%)의 인스턴스만 종료될 수 있음을 의미합니다.|

#### 2.2. 워밍업 시간 (Warm-up Time)

|설정 항목|설명|영향|
|---|---|---|
|**워밍업 시간**|새로 시작된 EC2 인스턴스가 트래픽을 처리할 준비가 되었다고 ASG가 간주할 때까지 기다리는 시간입니다.|새로운 인스턴스가 충분히 초기화되고 애플리케이션이 완전히 로드될 시간을 제공합니다.   <br>이 시간 동안 인스턴스의 지표는 스케일링 정책에 영향을 미치지 않으므로, ASG가 조급하게 다른 스케일링 결정을 내리는 것을 방지합니다.|
|**활용:**|애플리케이션 시작 시간, DB 연결, 캐시 로딩 등 초기화에 시간이 필요한 경우 이 시간을 충분히 설정해야 합니다.|헬스 체크를 통과한 후에도 추가적인 워밍업이 필요한 경우 유용합니다.|

---

### 3. 인스턴스 새로 고침의 이점

- **자동화:** ASG가 인스턴스 교체 프로세스를 자동으로 관리하므로 수동 작업의 부담과 오류 가능성을 줄여줍니다.
- **고가용성 유지:** `최소 정상 백분율` 설정을 통해 새로 고침 중에도 서비스 가용성을 유지하면서 점진적으로 인스턴스를 교체합니다.
- **롤백 기능:** 새로 고침 중 문제가 발생하면 원래 상태로 롤백할 수 있는 옵션도 제공합니다.
- **지표 안정화:** `워밍업 시간`을 통해 새 인스턴스가 안정화될 시간을 확보하여 스케일링 지표의 급변동을 방지합니다.

---

### 4. 인스턴스 새로 고침 사용 예시 (개념적)

다음은 ASG에서 인스턴스 새로 고침을 시작하는 일반적인 과정입니다.

1. **새로운 시작 템플릿 버전 생성 또는 업데이트:**
    - EC2 콘솔 -> "Launch Templates" -> 기존 템플릿 선택 -> "Actions" -> "Create new version".
    - 이 새 버전에서 AMI, 사용자 데이터 등 변경할 내용을 적용하고 저장합니다.
    
2. **ASG에 새로운 시작 템플릿 버전 연결:**
    - Auto Scaling Groups 콘솔 -> 해당 ASG 선택 -> "Actions" -> "Edit".
    - "Launch template" 섹션에서 새로 생성한 버전을 선택하고 저장합니다.
    
3. **인스턴스 새로 고침 시작:**
    - Auto Scaling Groups 콘솔 -> 해당 ASG 선택 -> "Actions" -> "Instance refresh" -> "Start instance refresh".
    - 여기서 **"Minimum healthy percentage"**와 **"Warm-up time"**을 설정하고 새로 고침을 시작합니다.

---

인스턴스 새로 고침은 ASG를 활용하는 애플리케이션의 지속적인 업데이트와 유지보수를 훨씬 효율적이고 안전하게 만들어주는 강력한 기능입니다. 이를 통해 서비스 중단 없이 최신 구성을 모든 인스턴스에 적용할 수 있습니다.