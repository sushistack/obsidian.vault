
이번 문서에서는 Elastic Load Balancer (ELB)의 중요한 기능 중 하나인 **스티키 세션(Sticky Sessions)**, 또는 **세션 선호도(Session Affinity)**에 대해 자세히 알아보겠습니다. 이 기능은 특정 클라이언트의 요청이 항상 동일한 백엔드 인스턴스로 전달되도록 보장합니다.

---
### 스티키 세션이란 무엇인가?

![[Pasted image 20250627154251.png]]

일반적으로 로드 밸런서는 들어오는 모든 요청을 여러 백엔드 인스턴스에 균등하게 분산시킵니다. 그러나 스티키 세션이 활성화되면, **동일한 클라이언트로부터 오는 연속적인 요청은 항상 동일한 백엔드 인스턴스로 전달**됩니다.

**작동 예시:**

애플리케이션 로드 밸런서(ALB) 뒤에 2개의 EC2 인스턴스가 있고 3명의 클라이언트가 있다고 가정해 봅시다.

| **클라이언트** | **첫 번째 요청 대상** | **두 번째 이후 요청 대상** |
| --------- | -------------- | ----------------- |
| 클라이언트 1   | EC2 인스턴스 1     | EC2 인스턴스 1        |
| 클라이언트 2   | EC2 인스턴스 2     | EC2 인스턴스 2        |
| 클라이언트 3   | EC2 인스턴스 1     | EC2 인스턴스 1        |

클라이언트 1이 첫 요청을 EC2 인스턴스 1로 보냈다면, 이후의 모든 요청도 EC2 인스턴스 1로 전달됩니다. 이는 로드 밸런서가 모든 요청을 분산하는 일반적인 동작과는 다릅니다.

**적용 가능한 로드 밸런서:**

스티키 세션은 Classic Load Balancer (CLB), Application Load Balancer (ALB), Network Load Balancer (NLB) 모두에서 활성화할 수 있습니다.

---

### 스티키 세션의 작동 원리 (쿠키 사용)

스티키 세션은 주로 **쿠키(Cookie)**를 사용하여 구현됩니다.

1. **쿠키 생성 및 전송:** 클라이언트가 로드 밸런서에 첫 요청을 보내면, 로드 밸런서(또는 백엔드 애플리케이션)는 해당 클라이언트를 특정 백엔드 인스턴스에 매핑하는 정보를 담은 쿠키를 생성하여 클라이언트에게 응답과 함께 보냅니다.

2. **쿠키 저장:** 클라이언트(웹 브라우저)는 이 쿠키를 저장합니다.

3. **후속 요청 시 쿠키 포함:** 클라이언트가 동일한 로드 밸런서에 두 번째 이후 요청을 보낼 때, 저장된 쿠키를 요청 헤더에 포함하여 보냅니다.

4. **동일 인스턴스로 라우팅:** 로드 밸런서는 요청에 포함된 쿠키를 읽고, 그 쿠키 정보에 따라 해당 클라이언트의 요청을 이전에 연결되었던 동일한 백엔드 인스턴스로 전달합니다.

5. **만료일:** 쿠키에는 만료일이 설정되어 있으며, 만료되면 클라이언트는 다른 인스턴스로 리디렉션될 수 있습니다.

---

### 스티키 세션의 사용 사례 및 고려 사항

#### 사용 사례 (Use Case):

가장 일반적인 사용 사례는 **사용자 세션 데이터의 손실 방지**입니다. 예를 들어, 사용자의 로그인 정보, 장바구니 내용, 세션 상태 등의 중요한 데이터가 특정 백엔드 인스턴스의 메모리에 저장되어 있는 경우 (세션 불일치), 스티키 세션이 없으면 사용자의 다음 요청이 다른 인스턴스로 전달되어 해당 데이터가 유실될 수 있습니다. 스티키 세션은 이러한 문제를 방지하여 원활한 사용자 경험을 제공합니다.

#### 고려 사항: 부하 불균형 (Load Imbalance)

스티키 세션을 활성화하면 **백엔드 인스턴스 간의 부하 불균형**이 발생할 수 있습니다. 예를 들어, 특정 '스티키' 사용자(많은 요청을 보내는 사용자)가 특정 인스턴스에 고정되면, 해당 인스턴스에만 부하가 집중될 수 있습니다. 이는 로드 밸런싱의 원래 목적인 부하 분산에 역행할 수 있으므로, 사용 시 신중하게 고려해야 합니다.

---

### 스티키 세션 쿠키의 종류

스티키 세션에는 두 가지 주요 쿠키 유형이 있습니다.

#### 1. 애플리케이션 기반 쿠키 (Application-based Cookie)

- **생성 주체:** **대상(Target)**, 즉 백엔드 애플리케이션 자체에서 생성하는 사용자 정의 쿠키입니다.
- **특징:**
    - 애플리케이션이 요구하는 사용자 정의 속성을 포함할 수 있습니다.
    - 쿠키 이름은 각 대상 그룹마다 개별적으로 지정해야 합니다.
    - `AWSALB`, `AWSALBAPPOR`, `AWSALBTG`와 같이 ELB 자체에서 사용하는 예약된 쿠키 이름은 사용할 수 없습니다.
    - ALB에서 이 유형의 애플리케이션 쿠키를 사용하는 경우, 로드 밸런서 자체에서 쿠키를 생성하며, 이 쿠키의 이름은 `AWSALBAPP`이 됩니다. (설명에 약간의 모호성이 있을 수 있으나, 보통은 애플리케이션이 생성한 쿠키를 로드 밸런서가 인식하는 방식, 또는 로드 밸런서가 애플리케이션을 위해 생성하는 방식 두 가지로 볼 수 있습니다.)
- **만료:** 애플리케이션 자체에서 쿠키의 만료 기간을 지정할 수 있습니다.

#### 2. 기간 기반 쿠키 (Duration-based Cookie)

- **생성 주체:** **로드 밸런서 자체**에서 생성하는 쿠키입니다.
- **쿠키 이름:**
    - ALB의 경우 `AWSALB`
    - CLB의 경우 `AWSELB`
- **만료:** 로드 밸런서 설정에서 지정한 특정 기간(예: 1초에서 7일)에 따라 만료됩니다.

---

### 스티키 세션 활성화 및 동작 확인 (ALB 예시)

ALB에서 스티키 세션을 활성화하는 과정은 대상 그룹(Target Group) 수준에서 이루어집니다.

1. **대상 그룹 선택:** AWS 콘솔에서 해당 대상 그룹을 선택합니다.
2. **속성 편집:** "작업(Actions)" 메뉴에서 "속성 편집(Edit attributes)"을 선택합니다.
3. **스티키니스 설정:** "Stickiness" 섹션에서 기능을 활성화하고 다음 중 하나를 선택합니다.
    - **로드 밸런서 생성 쿠키 (Load balancer generated cookie):** 기간 기반 쿠키를 사용하며, 만료 기간(예: 1일)을 설정합니다.
    - **애플리케이션 기반 쿠키 (Application-based cookie):** 애플리케이션에서 생성하는 쿠키를 사용하며, 해당 쿠키의 이름을 지정합니다 (예: `MYCUSTOMCOOKIEAPP`).
4. **변경 사항 저장:** 설정을 저장합니다.

**브라우저 개발자 도구를 통한 동작 확인:**

스티키 세션이 활성화된 후 웹 브라우저의 개발자 도구(Web Developer Tools)를 열고 네트워크 탭에서 요청/응답을 확인하면 다음과 같은 쿠키를 볼 수 있습니다.

- **응답 쿠키 (Response Cookie):** 로드 밸런서가 클라이언트에게 보내는 응답 헤더에 `Set-Cookie` 필드를 통해 스티키 세션 쿠키(`AWSALB` 또는 사용자 정의 쿠키)가 포함됩니다. 여기에는 만료일, 경로, 값이 명시됩니다.
- **요청 쿠키 (Request Cookie):** 클라이언트가 후속 요청을 보낼 때, 브라우저가 저장된 쿠키를 `Cookie` 헤더에 포함하여 로드 밸런서로 다시 전송합니다. 로드 밸런서는 이 쿠키를 기반으로 트래픽을 동일한 인스턴스로 라우팅합니다.

이러한 쿠키의 주고받음을 통해 스티키 세션이 실제로 어떻게 작동하는지 확인할 수 있습니다.

---

**참고:** 쿠키 이름이나 세부 사항을 모두 암기할 필요는 없지만, **애플리케이션 기반 쿠키**와 **기간 기반 쿠키**라는 두 가지 유형이 있으며, 클라이언트 세션의 연속성을 보장하기 위해 사용된다는 점을 이해하는 것이 중요합니다. 이 개념은 CloudFront와 같은 다른 AWS 서비스에서도 유사하게 적용될 수 있습니다.

---