
안녕하세요! 이번 아티클에서는 **AWS Lambda 함수를 Application Load Balancer(ALB)와 통합하는 방법**에 대해 자세히 알아보겠습니다. 특히, ALB가 HTTP 요청을 Lambda 함수가 이해할 수 있는 형식으로 변환하고, 그 반대 과정도 어떻게 이루어지는지 집중적으로 다룹니다.

### 📜 Lambda와 ALB를 왜 통합해야 할까요?

Lambda 함수는 기본적으로 CLI나 SDK를 통해 호출되지만, 인터넷을 통해 HTTP 또는 HTTPS 엔드포인트로 노출해야 할 필요가 있습니다. 이때, **Application Load Balancer(ALB)** 또는 **API Gateway**를 사용해 Lambda를 외부에 공개할 수 있습니다. 이 글에서는 ALB를 활용하는 방법을 중점적으로 설명합니다.

ALB와 Lambda를 통합하면, 클라이언트의 HTTP/S 요청은 ALB를 거쳐 Lambda 함수로 전달됩니다. 이 과정에서 ALB는 **동기식**으로 Lambda 함수를 호출하며, Lambda의 응답을 받아 다시 클라이언트에게 반환합니다.

---

### 🔄 HTTP 요청 페이로드 변환 과정

ALB는 들어오는 HTTP 요청을 Lambda 함수가 처리할 수 있는 **JSON 형식의 페이로드**로 변환합니다. 이 JSON 문서는 HTTP 요청에 담긴 모든 정보를 포함하며, Lambda 함수는 이 페이로드를 입력으로 받아 처리합니다.

#### 1. JSON 페이로드 구성 요소

ALB가 변환하는 JSON 페이로드에는 다음과 같은 정보가 포함됩니다.

|JSON 키|설명|
|---|---|
|`requestContext.elb`|요청을 받은 ELB 및 대상 그룹(Target Group) 정보|
|`httpMethod`|HTTP 메서드 (예: `GET`, `POST`)|
|`path`|요청 경로 (예: `/lambda`)|
|`queryStringParameters`|URL 쿼리 스트링 매개변수 (Key-Value 형식)|
|`headers`|HTTP 헤더 정보 (Key-Value 형식)|
|`body`|HTTP 요청 본문 (POST, PUT 요청의 경우)|
|`isBase64Encoded`|본문이 Base64로 인코딩되었는지 여부|

**📝 예시 페이로드**

```JSON
{
  "requestContext": {
    "elb": {
      "targetGroupArn": "arn:aws:elasticloadbalancing:us-east-1:123456789012:targetgroup/my-target-group/5d0d347c7c34538e"
    }
  },
  "httpMethod": "GET",
  "path": "/lambda",
  "queryStringParameters": {
    "name": "foo"
  },
  "headers": {
    "Accept": "text/html,application/xhtml+xml",
    "Accept-Language": "en-US,en;q=0.9",
    "Host": "my-alb-123456789.us-east-1.elb.amazonaws.com",
    "User-Agent": "Mozilla/5.0"
  },
  "body": null,
  "isBase64Encoded": false
}
```

이처럼 Lambda 함수는 HTTP 요청의 모든 정보를 JSON 객체로 받아 손쉽게 처리할 수 있습니다.

---

### 🚀 Lambda 응답의 HTTP 변환 과정

Lambda 함수는 처리를 완료한 후, ALB가 다시 HTTP 응답으로 변환할 수 있는 **특정 형식의 JSON 객체**를 반환해야 합니다.

#### 1. Lambda 응답 형식

Lambda 함수가 ALB에게 반환해야 하는 JSON 응답은 다음과 같은 구조를 가집니다.

|JSON 키|설명|
|---|---|
|`statusCode`|HTTP 상태 코드 (예: `200`, `404`)|
|`statusDescription`|상태 코드에 대한 설명 (예: `OK`, `Not Found`)|
|`headers`|응답 헤더 (Key-Value 형식)|
|`body`|응답 본문|
|`isBase64Encoded`|본문이 Base64로 인코딩되었는지 여부|

**📝 예시 응답**

```JSON
{
  "statusCode": 200,
  "statusDescription": "200 OK",
  "headers": {
    "Content-Type": "application/json"
  },
  "body": "{\"message\": \"Hello from Lambda!\"}",
  "isBase64Encoded": false
}
```

ALB는 Lambda의 이 JSON 응답을 받아 `statusCode`, `headers`, `body`를 기반으로 최종 HTTP 응답을 생성하여 클라이언트에게 전달합니다.

---

### 💡 ALB Multi-Value Headers 활성화

ALB에는 `Multi-Value Headers`라는 유용한 기능이 있습니다. 이 설정은 동일한 키에 여러 값이 포함된 HTTP 헤더나 쿼리 스트링을 처리할 때 유용합니다.

**✅ 작동 방식**

일반적으로 동일한 키가 여러 번 반복되면 ALB는 첫 번째 값만 선택할 수 있습니다. 하지만 `Multi-Value Headers`를 활성화하면 모든 값을 유지하여 Lambda 함수에 배열 형태로 전달합니다.

📝 예시 URL:

http://my-alb.com/path?name=foo&name=bar

**📝 `Multi-Value Headers` 비활성화 시 페이로드:**

```JSON
{
  "queryStringParameters": {
    "name": "foo"
  }
}
```

**📝 `Multi-Value Headers` 활성화 시 페이로드:**

```JSON
{
  "multiValueQueryStringParameters": {
    "name": [
      "foo",
      "bar"
    ]
  }
}
```

이 기능은 복수의 값을 하나의 키에 담아 전송하는 경우에 데이터 손실을 막아주며, HTTP 헤더와 쿼리 스트링에 모두 적용됩니다.

이것으로 ALB와 Lambda 함수 통합의 핵심 원리에 대해 알아보았습니다. Lambda 함수 개발 시 HTTP 요청 및 응답 형식을 잘 이해하면 ALB와의 연동을 효율적으로 구성할 수 있습니다.