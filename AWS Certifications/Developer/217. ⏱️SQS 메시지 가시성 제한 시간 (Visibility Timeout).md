
## 💡 메시지 가시성 제한 시간이란?

**메시지 가시성 제한 시간(Message Visibility Timeout)**은 SQS의 핵심 개념으로, **컨슈머가 큐에서 메시지를 가져간 후 다른 컨슈머에게 해당 메시지를 숨기는 기간**을 의미합니다.

- **기본값:** 30초
- **설정 가능 범위:** 0초 ~ 12시간

### 동작 원리

![[Pasted image 20250817203515.png]]

1. **메시지 수신:** 컨슈머가 `ReceiveMessage` API를 호출하여 메시지를 가져갑니다.

2. **가시성 제한 시간 시작:** 메시지를 가져간 순간부터 가시성 제한 시간이 시작되며, 이 시간 동안 해당 메시지는 다른 컨슈머에게 보이지 않습니다.

3. **메시지 처리 및 삭제:** 컨슈머는 이 시간 내에 메시지 처리를 완료하고 `DeleteMessage` API를 호출하여 큐에서 메시지를 완전히 삭제해야 합니다.

4. **타임아웃 발생:** 만약 컨슈머가 시간 내에 메시지 처리를 완료하지 못하거나 삭제하지 않으면, 가시성 제한 시간이 만료된 후 메시지는 다시 큐에 나타나 다른 컨슈머가 가져갈 수 있게 됩니다.

이 과정은 메시지가 실수로 중복 처리되는 것을 방지하기 위해 중요합니다. 만약 컨슈머가 메시지를 가져가자마자 다른 컨슈머가 동일한 메시지를 가져갈 수 있다면, 메시지 하나가 여러 번 처리되어 시스템에 문제를 일으킬 수 있습니다.

---

## ⚠️ 가시성 제한 시간 설정의 중요성

가시성 제한 시간을 어떻게 설정하느냐에 따라 시스템의 안정성과 효율성이 크게 달라질 수 있습니다.

|설정 값|장점|단점|
|---|---|---|
|**높게 설정 (예: 수 시간)**|메시지 처리 시간이 긴 작업에 적합합니다.|컨슈머가 메시지 처리 중 충돌(Crash)하면, 해당 메시지가 큐에 다시 나타날 때까지 오랜 시간이 걸려 메시지 처리 지연이 발생합니다.|
|**낮게 설정 (예: 수 초)**|컨슈머 충돌 시 메시지가 빠르게 큐에 돌아와 다른 컨슈머가 처리할 수 있습니다.|컨슈머의 메시지 처리 시간이 길어지면, 가시성 시간이 만료되어 메시지가 여러 번 읽히는 **중복 처리(Duplicate Processing)** 문제가 발생할 수 있습니다.|

이상적인 설정은 **애플리케이션의 메시지 처리 시간**을 고려하여 적절한 값을 정하는 것입니다.

---

## ⚙️ 메시지 가시성 제어 API

### `ChangeMessageVisibility` API

컨슈머가 메시지 처리에 더 많은 시간이 필요하다고 판단될 경우, **`ChangeMessageVisibility`** API를 호출하여 해당 메시지의 가시성 제한 시간을 연장할 수 있습니다. 이는 메시지가 다른 컨슈머에게 노출되어 중복 처리되는 것을 방지합니다.

**실제 동작 예시:**

1. 컨슈머가 메시지를 수신합니다. 가시성 제한 시간 30초가 시작됩니다.

2. 컨슈머는 메시지 처리를 시작합니다. 15초가 경과한 시점에, 남은 시간(15초)으로는 메시지 처리를 완료하기 어렵다고 판단합니다.

3. 컨슈머는 **`ChangeMessageVisibility`**를 호출하여 가시성 제한 시간을 60초로 연장합니다.

4. 이제 컨슈머에게는 메시지 처리를 완료할 충분한 시간(60초)이 확보됩니다.


### SQS 콘솔을 통한 실습

두 개의 SQS `Send and receive messages` 창을 열어 가시성 제한 시간의 동작을 직접 확인할 수 있습니다.

1. **첫 번째 창:** `hello world` 메시지를 큐에 전송합니다. 큐의 기본 가시성 제한 시간은 30초입니다.

2. **첫 번째 창:** 메시지를 **`Poll for messages`**로 가져옵니다. 메시지가 나타나고 가시성 제한 시간이 시작됩니다.

3. **두 번째 창:** 즉시 **`Poll for messages`**를 실행하면, 첫 번째 창이 메시지를 가져갔기 때문에 메시지가 보이지 않습니다.

4. **30초 경과:** 첫 번째 창이 메시지를 삭제하지 않은 상태로 30초가 지나면, 메시지는 다시 큐에 나타납니다.

5. **두 번째 창:** **`Poll for messages`**를 실행하면 메시지가 나타나고, **`Received Count`**가 **2**로 표시됩니다. 이는 메시지가 두 번 수신되었음을 의미합니다.

이 실습은 **메시지 삭제의 중요성**과 가시성 제한 시간이 만료될 경우 **메시지가 중복 수신될 수 있음**을 명확하게 보여줍니다. 시험에서도 이러한 시나리오를 바탕으로 올바른 솔루션을 선택하는 문제가 출제될 수 있으므로, 이 개념을 정확히 이해하는 것이 중요합니다.