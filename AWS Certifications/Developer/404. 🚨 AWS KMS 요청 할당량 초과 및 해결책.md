
AWS KMS는 매우 중요한 서비스이지만, 모든 AWS 서비스와 마찬가지로 **요청 할당량(Request Quotas)**이 존재합니다. KMS 암호화 및 복호화 API를 과도하게 호출할 경우 `ThrottlingException` 오류가 발생할 수 있습니다. 이 가이드에서는 KMS 할당량의 특징과 함께, 요청을 효율적으로 관리하고 할당량 초과 문제를 해결하는 방안을 알아봅니다.

---

## ⚡️ ThrottlingException과 KMS 요청 할당량

### 1. `ThrottlingException` 발생 원인

KMS는 보안을 위해 **초당 API 호출 횟수**에 제한을 둡니다. 이 할당량을 초과하면 `ThrottlingException` 오류를 받게 됩니다. 이 오류는 다음과 같이 나타날 수 있습니다.

```JSON
{
  "status_code": 400,
  "error_code": "ThrottlingException",
  "message": "You are exceeding the rate at which you can call KMS."
}
```

### 2. KMS 할당량의 특징

KMS의 할당량은 다른 서비스와 달리 특별한 특징을 가집니다.

- **계정 및 리전 공유**: KMS 할당량은 **특정 리전 내의 전체 계정**에서 공유됩니다. 즉, 한 리전의 여러 서비스나 애플리케이션이 동시에 KMS API를 호출하면 모두 동일한 할당량을 사용합니다.
    
- **작업 유형 공유**: `Encrypt`, `Decrypt`, `GenerateDataKey`, `GenerateRandom` 등 **모든 암호화 관련 작업**이 하나의 할당량을 공유합니다. S3와 같은 다른 AWS 서비스가 SSE-KMS(Server-Side Encryption with KMS)를 통해 KMS를 호출하는 경우도 이 할당량에 포함됩니다.
    
- **할당량 값**: 리전마다 할당량 값은 다릅니다. 예를 들어, 일부 리전에서는 초당 5,500회 또는 10,000회, 심지어 30,000회까지 허용됩니다.
    

---

## ✅ KMS 요청 할당량 초과 해결 방법

`ThrottlingException`을 해결하기 위한 세 가지 주요 방법이 있습니다.

### 1. 지수 백오프 (Exponential Backoff)

가장 기본적인 방법으로, 일시적인 스로틀링(throttling)에 대응하기 위해 사용됩니다. API 호출에 실패할 경우, 다음 재시도까지 기다리는 시간을 기하급수적으로 늘려 호출 빈도를 줄입니다.

```Python
# 예시: 지수 백오프를 이용한 재시도 로직
import time

max_retries = 5
base_delay = 0.5  # 초

for i in range(max_retries):
    try:
        # KMS API 호출
        kms_client.decrypt(...)
        break
    except ThrottlingException as e:
        delay = base_delay * (2 ** i)
        print(f"Throttling, retrying in {delay} seconds...")
        time.sleep(delay)
```

### 2. Envelope Encryption 및 데이터 키 캐싱 활용

KMS 요청 횟수를 근본적으로 줄이는 방법입니다. `GenerateDataKey` API를 사용하여 **데이터 키(DEK)**를 생성하고, 이 DEK를 클라이언트 측에서 캐싱하여 재사용합니다.

- **Envelop Encryption**: 대용량 파일 암호화 시 `Encrypt` API 대신 `GenerateDataKey` API를 사용하여 키만 KMS에서 받고, 실제 암호화 작업은 클라이언트 측에서 수행합니다. 이 방식은 KMS에 전송하는 데이터 양을 최소화하여 비용과 네트워크 지연을 줄입니다.
    
- **데이터 키 캐싱**: AWS Encryption SDK의 기능으로, 한 번 생성한 데이터 키(DEK)를 일정 기간 동안 로컬에 캐싱하여 여러 파일 암호화에 재사용합니다. 이를 통해 KMS에 대한 `GenerateDataKey` 호출 횟수를 획기적으로 줄일 수 있습니다.
    

### 3. 할당량 증량 요청 (Request Quota Increase)

지수 백오프나 DEK 캐싱으로도 해결되지 않는 구조적인 문제(예: 대규모 트랜잭션 처리)의 경우, AWS에 직접 할당량 증량을 요청할 수 있습니다.

- **방법**: AWS Support Center를 통해 서비스 한도(Service Limit) 증량을 요청하는 티켓을 생성하거나, API를 통해 요청할 수 있습니다.
    
- **주의**: 할당량 증가는 KMS 사용량에 대한 비용 증가로 이어질 수 있으므로, 신중하게 결정해야 합니다.
    

|해결 방안|설명|장점|단점|
|---|---|---|---|
|**지수 백오프**|일시적인 오류에 대한 자동 재시도|구현이 간단하고, 일시적인 스로틀링에 효과적|근본적인 할당량 문제를 해결하지 못함|
|**DEK 캐싱**|`GenerateDataKey`로 받은 DEK 재사용|KMS API 호출 횟수 감소, 비용 절감|보안상의 트레이드오프 발생 가능성|
|**할당량 증량**|AWS에 할당량 증량 요청|근본적인 한계 해결, 대규모 트래픽 처리 가능|요청 및 승인 과정 필요, 추가 비용 발생|

---

## 💡 결론

KMS `ThrottlingException`은 단순한 오류가 아니라, KMS 요청 할당량의 특성을 이해하고 있음을 묻는 중요한 신호입니다. `지수 백오프`를 기본으로 적용하고, **대규모 데이터 처리 시 `Envelope Encryption`과 `DEK 캐싱`**을 활용하여 KMS API 호출 횟수를 최소화하는 것이 가장 효과적인 해결책입니다. 그럼에도 불구하고 할당량이 부족하다면, AWS에 공식적으로 증량을 요청해야 합니다.