
이번 실습에서는 **CloudShell**을 활용하여 람다 함수를 패키징하고 배포하는 과정을 체험합니다. 이 과정은 외부 종속성을 포함하는 람다 함수를 AWS CLI로 생성하고, IAM 권한을 설정하며, X-Ray를 통해 실행 흐름을 추적하는 포괄적인 워크플로우를 다룹니다.

---

## 1. 사전 준비: CloudShell 환경 설정

1. **CloudShell 시작:** AWS 관리 콘솔에서 CloudShell을 실행합니다.
    
2. **작업 디렉토리 생성:** `mkdir lambda` 명령어로 `lambda` 폴더를 생성하고 `cd lambda`로 이동합니다.
    
3. **코드 파일 추가:** `nano index.js` 명령어를 사용하여 `index.js` 파일을 생성하고, 아래의 코드를 복사하여 붙여넣습니다. 이 코드는 **`aws-xray-sdk-core`** 라이브러리와 **S3 `ListBuckets`** API를 사용합니다.

```JavaScript
const AWS = require('aws-sdk');
const s3 = new AWS.S3();

exports.handler = async (event) => {
    try {
        const data = await s3.listBuckets().promise();
        console.log("Success", data.Buckets);
        return {
            statusCode: 200,
            body: JSON.stringify(data.Buckets.map(b => b.Name)),
        };
    } catch (err) {
        console.log("Error", err);
        return {
            statusCode: 500,
            body: JSON.stringify(err),
        };
    }
};
```

---

## 2. 종속성 설치 및 패키징 📦

1. **종속성 설치:** 람다 함수 코드에서 사용하는 외부 라이브러리(`aws-xray-sdk-core`)를 `npm install` 명령어로 설치합니다.

```Bash
npm install aws-xray-sdk-core
```
    
    이 명령어를 실행하면 `node_modules` 폴더가 생성되고 필요한 파일들이 로컬에 설치됩니다.
    
2. **권한 설정 및 압축:** 함수 파일의 권한을 설정한 후, 모든 파일(`index.js`, `node_modules`, `package-lock.json`)을 `functions.zip`으로 압축합니다.

```Bash
chmod -R 755 .
zip -r functions.zip .
```

---

## 3. IAM 역할 생성 및 람다 함수 배포 🔑

함수가 S3에 접근하고 X-Ray에 데이터를 전송하려면 적절한 IAM 권한이 필요합니다.

1. **IAM 역할 생성:**
    
    - IAM 콘솔에서 `lambda-with-dependencies-role`과 같은 이름의 새로운 역할을 생성합니다.
    
    - **`AWS service`**로 **`Lambda`**를 선택하고, **`AWSLambdaBasicExecutionRole`**을 연결합니다.

2. **람다 함수 배포:** CloudShell에서 `aws lambda create-function` 명령어를 사용하여 `functions.zip` 파일을 직접 업로드하고 람다 함수를 생성합니다. 이때 위에서 생성한 IAM 역할의 ARN을 포함시켜야 합니다.
    
```Bash
aws lambda create-function --function-name lambda-xray-with-dependencies \
--zip-file fileb://functions.zip --handler index.handler \
--runtime nodejs18.x --role arn:aws:iam::[your-account-id]:role/lambda-with-dependencies-role
```
    
3. **추가 권한 부여:**
    
    - **`S3 접근 권한`**: 람다 함수가 S3 버킷 목록을 가져올 수 있도록 IAM 역할에 `AmazonS3ReadOnlyAccess` 정책을 추가합니다.
        
    - **`X-Ray 권한`**: 람다 함수의 **`Configuration`** 탭에서 X-Ray 활성 추적을 활성화합니다. 이렇게 하면 `AWSXRayDaemonWriteAccess` 정책이 자동으로 역할에 추가됩니다.

---

## 4. 함수 실행 및 X-Ray 추적 확인 ✅

이제 람다 함수를 테스트하여 모든 설정이 올바르게 작동하는지 확인합니다.

1. **함수 테스트:** 람다 콘솔에서 함수를 테스트하면, IAM 권한이 즉시 반영되지 않아 처음에는 `Access Denied` 오류가 발생할 수 있습니다. 몇 번 재시도하면 `success`가 반환되며 계정의 S3 버킷 목록이 표시됩니다.
    
2. **X-Ray 서비스 맵:** 테스트가 완료된 후 **X-Ray 콘솔**로 이동하여 **`Service map`**을 확인합니다.
    
    - **성공/실패 추적:** 클라이언트(사용자)가 람다 함수를 호출하고, 람다 함수가 S3를 호출하는 흐름이 시각화됩니다.
        
    - **디버깅:** 실패한 호출의 트레이스를 분석하면 `403` 오류와 `Access Denied` 예외 메시지를 통해 권한 부족이 문제의 원인이었음을 명확히 확인할 수 있습니다.
        

이 실습을 통해 함수 패키징, IAM 권한 관리, 그리고 X-Ray를 활용한 디버깅의 중요성을 종합적으로 이해할 수 있습니다.