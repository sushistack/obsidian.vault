
μ΄λ² μ‹¤μµμ—μ„λ” **CloudShell**μ„ ν™μ©ν•μ—¬ λλ‹¤ ν•¨μλ¥Ό ν¨ν‚¤μ§•ν•κ³  λ°°ν¬ν•λ” κ³Όμ •μ„ μ²΄ν—ν•©λ‹λ‹¤. μ΄ κ³Όμ •μ€ μ™Έλ¶€ μΆ…μ†μ„±μ„ ν¬ν•¨ν•λ” λλ‹¤ ν•¨μλ¥Ό AWS CLIλ΅ μƒμ„±ν•κ³ , IAM κ¶ν•μ„ μ„¤μ •ν•λ©°, X-Rayλ¥Ό ν†µν•΄ μ‹¤ν–‰ νλ¦„μ„ μ¶”μ ν•λ” ν¬κ΄„μ μΈ μ›ν¬ν”λ΅μ°λ¥Ό λ‹¤λ£Ήλ‹λ‹¤.

---

## 1. μ‚¬μ „ μ¤€λΉ„: CloudShell ν™κ²½ μ„¤μ •

1. **CloudShell μ‹μ‘:** AWS κ΄€λ¦¬ μ½μ†”μ—μ„ CloudShellμ„ μ‹¤ν–‰ν•©λ‹λ‹¤.
    
2. **μ‘μ—… λ””λ ‰ν† λ¦¬ μƒμ„±:** `mkdir lambda` λ…λ Ήμ–΄λ΅ `lambda` ν΄λ”λ¥Ό μƒμ„±ν•κ³  `cd lambda`λ΅ μ΄λ™ν•©λ‹λ‹¤.
    
3. **μ½”λ“ νμΌ μ¶”κ°€:** `nano index.js` λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•μ—¬ `index.js` νμΌμ„ μƒμ„±ν•κ³ , μ•„λμ μ½”λ“λ¥Ό λ³µμ‚¬ν•μ—¬ λ¶™μ—¬λ„£μµλ‹λ‹¤. μ΄ μ½”λ“λ” **`aws-xray-sdk-core`** λΌμ΄λΈλ¬λ¦¬μ™€ **S3 `ListBuckets`** APIλ¥Ό μ‚¬μ©ν•©λ‹λ‹¤.

```JavaScript
const AWS = require('aws-sdk');
const s3 = new AWS.S3();

exports.handler = async (event) => {
    try {
        const data = await s3.listBuckets().promise();
        console.log("Success", data.Buckets);
        return {
            statusCode: 200,
            body: JSON.stringify(data.Buckets.map(b => b.Name)),
        };
    } catch (err) {
        console.log("Error", err);
        return {
            statusCode: 500,
            body: JSON.stringify(err),
        };
    }
};
```

---

## 2. μΆ…μ†μ„± μ„¤μΉ λ° ν¨ν‚¤μ§• π“¦

1. **μΆ…μ†μ„± μ„¤μΉ:** λλ‹¤ ν•¨μ μ½”λ“μ—μ„ μ‚¬μ©ν•λ” μ™Έλ¶€ λΌμ΄λΈλ¬λ¦¬(`aws-xray-sdk-core`)λ¥Ό `npm install` λ…λ Ήμ–΄λ΅ μ„¤μΉν•©λ‹λ‹¤.

```Bash
npm install aws-xray-sdk-core
```
    
    μ΄ λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•λ©΄ `node_modules` ν΄λ”κ°€ μƒμ„±λκ³  ν•„μ”ν• νμΌλ“¤μ΄ λ΅μ»¬μ— μ„¤μΉλ©λ‹λ‹¤.
    
2. **κ¶ν• μ„¤μ • λ° μ••μ¶•:** ν•¨μ νμΌμ κ¶ν•μ„ μ„¤μ •ν• ν›„, λ¨λ“  νμΌ(`index.js`, `node_modules`, `package-lock.json`)μ„ `functions.zip`μΌλ΅ μ••μ¶•ν•©λ‹λ‹¤.

```Bash
chmod -R 755 .
zip -r functions.zip .
```

---

## 3. IAM μ—­ν•  μƒμ„± λ° λλ‹¤ ν•¨μ λ°°ν¬ π”‘

ν•¨μκ°€ S3μ— μ ‘κ·Όν•κ³  X-Rayμ— λ°μ΄ν„°λ¥Ό μ „μ†΅ν•λ ¤λ©΄ μ μ ν• IAM κ¶ν•μ΄ ν•„μ”ν•©λ‹λ‹¤.

1. **IAM μ—­ν•  μƒμ„±:**
    
    - IAM μ½μ†”μ—μ„ `lambda-with-dependencies-role`κ³Ό κ°™μ€ μ΄λ¦„μ μƒλ΅μ΄ μ—­ν• μ„ μƒμ„±ν•©λ‹λ‹¤.
    
    - **`AWS service`**λ΅ **`Lambda`**λ¥Ό μ„ νƒν•κ³ , **`AWSLambdaBasicExecutionRole`**μ„ μ—°κ²°ν•©λ‹λ‹¤.

2. **λλ‹¤ ν•¨μ λ°°ν¬:** CloudShellμ—μ„ `aws lambda create-function` λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•μ—¬ `functions.zip` νμΌμ„ μ§μ ‘ μ—…λ΅λ“ν•κ³  λλ‹¤ ν•¨μλ¥Ό μƒμ„±ν•©λ‹λ‹¤. μ΄λ• μ„μ—μ„ μƒμ„±ν• IAM μ—­ν• μ ARNμ„ ν¬ν•¨μ‹μΌμ•Ό ν•©λ‹λ‹¤.
    
```Bash
aws lambda create-function --function-name lambda-xray-with-dependencies \
--zip-file fileb://functions.zip --handler index.handler \
--runtime nodejs18.x --role arn:aws:iam::[your-account-id]:role/lambda-with-dependencies-role
```
    
3. **μ¶”κ°€ κ¶ν• λ¶€μ—¬:**
    
    - **`S3 μ ‘κ·Ό κ¶ν•`**: λλ‹¤ ν•¨μκ°€ S3 λ²„ν‚· λ©λ΅μ„ κ°€μ Έμ¬ μ μλ„λ΅ IAM μ—­ν• μ— `AmazonS3ReadOnlyAccess` μ •μ±…μ„ μ¶”κ°€ν•©λ‹λ‹¤.
        
    - **`X-Ray κ¶ν•`**: λλ‹¤ ν•¨μμ **`Configuration`** νƒ­μ—μ„ X-Ray ν™μ„± μ¶”μ μ„ ν™μ„±ν™”ν•©λ‹λ‹¤. μ΄λ ‡κ² ν•λ©΄ `AWSXRayDaemonWriteAccess` μ •μ±…μ΄ μλ™μΌλ΅ μ—­ν• μ— μ¶”κ°€λ©λ‹λ‹¤.

---

## 4. ν•¨μ μ‹¤ν–‰ λ° X-Ray μ¶”μ  ν™•μΈ β…

μ΄μ  λλ‹¤ ν•¨μλ¥Ό ν…μ¤νΈν•μ—¬ λ¨λ“  μ„¤μ •μ΄ μ¬λ°”λ¥΄κ² μ‘λ™ν•λ”μ§€ ν™•μΈν•©λ‹λ‹¤.

1. **ν•¨μ ν…μ¤νΈ:** λλ‹¤ μ½μ†”μ—μ„ ν•¨μλ¥Ό ν…μ¤νΈν•λ©΄, IAM κ¶ν•μ΄ μ¦‰μ‹ λ°μλμ§€ μ•μ•„ μ²μμ—λ” `Access Denied` μ¤λ¥κ°€ λ°μƒν•  μ μμµλ‹λ‹¤. λ‡ λ² μ¬μ‹λ„ν•λ©΄ `success`κ°€ λ°ν™λλ©° κ³„μ •μ S3 λ²„ν‚· λ©λ΅μ΄ ν‘μ‹λ©λ‹λ‹¤.
    
2. **X-Ray μ„λΉ„μ¤ λ§µ:** ν…μ¤νΈκ°€ μ™„λ£λ ν›„ **X-Ray μ½μ†”**λ΅ μ΄λ™ν•μ—¬ **`Service map`**μ„ ν™•μΈν•©λ‹λ‹¤.
    
    - **μ„±κ³µ/μ‹¤ν¨ μ¶”μ :** ν΄λΌμ΄μ–ΈνΈ(μ‚¬μ©μ)κ°€ λλ‹¤ ν•¨μλ¥Ό νΈμ¶ν•κ³ , λλ‹¤ ν•¨μκ°€ S3λ¥Ό νΈμ¶ν•λ” νλ¦„μ΄ μ‹κ°ν™”λ©λ‹λ‹¤.
        
    - **λ””λ²„κΉ…:** μ‹¤ν¨ν• νΈμ¶μ νΈλ μ΄μ¤λ¥Ό λ¶„μ„ν•λ©΄ `403` μ¤λ¥μ™€ `Access Denied` μμ™Έ λ©”μ‹μ§€λ¥Ό ν†µν•΄ κ¶ν• λ¶€μ΅±μ΄ λ¬Έμ μ μ›μΈμ΄μ—μμ„ λ…ν™•ν ν™•μΈν•  μ μμµλ‹λ‹¤.
        

μ΄ μ‹¤μµμ„ ν†µν•΄ ν•¨μ ν¨ν‚¤μ§•, IAM κ¶ν• κ΄€λ¦¬, κ·Έλ¦¬κ³  X-Rayλ¥Ό ν™μ©ν• λ””λ²„κΉ…μ μ¤‘μ”μ„±μ„ μΆ…ν•©μ μΌλ΅ μ΄ν•΄ν•  μ μμµλ‹λ‹¤.