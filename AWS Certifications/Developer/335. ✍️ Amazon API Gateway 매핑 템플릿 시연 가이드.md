
이번 가이드에서는 Amazon API Gateway의 **매핑 템플릿(Mapping Templates)**을 직접 설정하고 테스트하는 과정을 상세히 알아보겠습니다. 매핑 템플릿을 사용하면 백엔드 서비스의 코드를 수정하지 않고도 요청과 응답의 데이터를 자유롭게 변형할 수 있습니다.

---

## 💻 1단계: Lambda 함수 생성 및 비프록시 통합 설정

먼저 API Gateway와 연동할 Lambda 함수를 생성합니다. 이번 실습에서는 **프록시 통합**을 사용하지 않고, 오직 Lambda 함수가 반환하는 값만을 API Gateway로 전달할 것입니다.

1. **새 함수 생성**: `api-gateway-mapping-get`라는 이름으로 Lambda 함수를 생성하고, 런타임은 Python 3.11을 선택합니다.
    
2. **함수 코드 작성**: 다음 코드를 붙여넣고 **배포(Deploy)**합니다. 이 함수는 간단한 JSON 객체만 반환합니다.

```Python
import json

def lambda_handler(event, context):
    return {
        "example": "hello world"
    }
```

**참고**: 프록시 통합을 사용하지 않기 때문에, `statusCode`나 `headers`를 명시적으로 반환할 필요가 없습니다. Lambda가 반환하는 JSON 객체가 그대로 API Gateway로 전달됩니다.

---

## 📝 2단계: API Gateway 리소스 및 메서드 생성

이제 API Gateway에서 리소스를 생성하고, 방금 만든 Lambda 함수와 **비프록시(Non-Proxy)** 방식으로 연동합니다.

1. **새 리소스 생성**: API Gateway 콘솔에서 `mapping`이라는 이름의 새로운 리소스를 생성합니다.
    
2. **GET 메서드 추가**: `/mapping` 리소스에 **GET** 메서드를 추가합니다.
    
3. **통합 유형 선택**:
    
    - **통합 유형**: **Lambda 함수**
        
    - **Lambda 프록시 통합 사용(Use Lambda Proxy Integration)**: **반드시 체크 해제**합니다.
        
    - **Lambda 함수**: 생성한 Lambda 함수의 ARN을 입력하거나 함수 이름을 검색하여 선택합니다.

---

## 🎨 3단계: 통합 응답 매핑 템플릿 설정

이 단계가 이번 실습의 핵심입니다. Lambda 함수가 반환하는 값을 클라이언트에게 보내기 전에 변형하기 위한 매핑 템플릿을 설정합니다.

1. **통합 응답(Integration Response)으로 이동**: `/mapping` GET 메서드 설정 페이지에서 **통합 응답(Integration Response)**을 클릭합니다.
    
2. **매핑 템플릿 추가**: **매핑 템플릿(Mapping Templates)** 섹션에서 `application/json` 타입의 템플릿을 추가합니다.
    
3. **템플릿 바디 작성**: 다음 코드를 **템플릿 바디(Template Body)**에 붙여넣습니다. 이 코드는 Velocity Template Language(VTL)로 작성되었습니다.

```JSON
{
  "my key": "my value",
  "renamed key": "$input.json('$.example')"
}
```

- `"my key": "my value"`: 이 부분은 모든 응답에 고정적으로 포함됩니다.
    
- `"$input.json('$.example')"`: **`$input`** 변수는 백엔드(Lambda)로부터 받은 응답을 의미합니다. `json()` 함수는 JSON 경로를 사용하여 응답 바디에서 특정 키의 값을 추출합니다. 여기서는 `$.example` 경로를 통해 "hello world" 값을 가져옵니다.

---

## ✅ 4단계: 결과 확인 및 작동 원리 이해

이제 API Gateway의 테스트 기능을 통해 매핑 템플릿이 제대로 작동하는지 확인합니다.

1. **테스트 실행**: `/mapping` GET 메서드 페이지로 돌아와 **테스트(Test)** 탭을 클릭하고, 별도의 설정 없이 **테스트(Test)** 버튼을 누릅니다.
    
2. **응답 결과**: 응답 바디를 확인하면 다음과 같은 최종 응답을 볼 수 있습니다.

|테스트 전 (Lambda 응답)|테스트 후 (API Gateway 최종 응답)|
|---|---|
|`{"example": "hello world"}`|`{"my key": "my value", "renamed key": "hello world"}`|

### 🔍 작동 원리

1. 클라이언트가 API Gateway의 `/mapping` GET 메서드를 호출합니다.
    
2. API Gateway는 비프록시 통합을 통해 `api-gateway-mapping-get` Lambda 함수를 실행합니다.
    
3. Lambda 함수는 `{"example": "hello world"}`를 반환합니다.
    
4. API Gateway는 이 응답을 받아 미리 설정된 매핑 템플릿을 적용합니다.
    
5. 매핑 템플릿은 VTL 스크립트를 실행하여 응답의 `example` 키 값을 추출하고, 새로운 JSON 구조에 삽입합니다.
    
6. 최종적으로 변형된 JSON 응답이 클라이언트에게 전달됩니다.

이처럼 매핑 템플릿을 사용하면, 백엔드 서비스의 로직을 그대로 유지하면서 API를 호출하는 클라이언트의 요구사항에 맞게 응답 형식을 자유롭게 조작할 수 있습니다. 동일한 방식으로 **통합 요청(Integration Request)**에도 매핑 템플릿을 적용하여, 클라이언트의 요청을 백엔드가 이해하는 형식으로 변환할 수 있습니다.