

AWS Lambda는 서버리스 애플리케이션의 핵심이지만, 코드 내에 민감한 정보(예: 데이터베이스 암호)를 직접 저장하는 것은 보안상 매우 위험합니다. 이 문제를 해결하기 위해 **KMS(Key Management Service)**를 활용하여 Lambda의 환경 변수를 안전하게 암호화하고 관리하는 방법을 상세히 설명하겠습니다.

---

## 1. 🔍 문제점: 민감 정보 관리

Lambda에서 민감한 정보를 다루는 세 가지 방식과 그 문제점은 다음과 같습니다.

### 1. 코드 내에 하드코딩

- **방식**: 코드 내에 `DB_PASSWORD = "supersecret"`와 같이 직접 값을 입력합니다.
    
- **문제점**: 코드가 노출될 경우, 민감 정보가 그대로 유출됩니다. 이는 가장 피해야 할 방식입니다.

### 2. 환경 변수 사용 (암호화 X)

- **방식**: 환경 변수를 사용하면 코드를 깔끔하게 분리할 수 있습니다. `os.environ['DB_PASSWORD']`와 같이 환경 변수를 불러와 사용합니다.
    
- **문제점**: Lambda 콘솔의 환경 변수 섹션에서 누구나 **평문으로 값을 볼 수 있습니다.** 콘솔 접근 권한이 있는 사용자는 쉽게 정보를 탈취할 수 있습니다.
    

### 3. ✅ 해결책: 환경 변수 암호화 (KMS 연동)

Lambda는 환경 변수를 **KMS 키로 암호화하여 저장**하는 기능을 기본으로 제공합니다. 이 기능을 사용하면 민감한 정보가 안전하게 보호됩니다.

---

## 2. 🔐 KMS를 사용한 환경 변수 암호화

Lambda 콘솔에서 환경 변수를 암호화하는 과정은 매우 간단합니다.

1. **환경 변수 생성**: `DB_PASSWORD`라는 환경 변수를 생성하고, 값에 `supersecret`를 입력합니다.
    
2. **암호화 설정**: 환경 변수 섹션 하단의 **"Encryption configuration"**에서 `Enable helpers for encryption in transit`을 활성화합니다.
    
3. **KMS 키 선택**: 드롭다운 메뉴에서 미리 생성해둔 **KMS 고객 관리형 키**를 선택합니다.
    
4. **암호화**: 암호화할 환경 변수 옆의 **`Encrypt`** 버튼을 클릭합니다.
    

이제 `DB_PASSWORD` 값은 암호화된 문자열로 변경되어 콘솔에서도 평문으로 보이지 않습니다.

---

## 3. 🧩 Lambda 코드 수정: 복호화 로직 추가

환경 변수가 암호화되었으므로, Lambda 함수는 이 값을 직접 사용할 수 없습니다. `decrypt` API 호출을 통해 값을 복호화하는 로직이 필요합니다.

```Python
import os
import boto3
import base64
from botocore.exceptions import ClientError

# KMS 클라이언트 생성
kms_client = boto3.client('kms')

def decrypt_secret(encrypted_data):
    """
    KMS를 사용하여 암호화된 환경 변수를 복호화
    """
    try:
        response = kms_client.decrypt(
            CiphertextBlob=base64.b64decode(encrypted_data.encode('utf-8'))
        )
        return response['Plaintext'].decode('utf-8')
    except ClientError as e:
        print(f"Error decrypting secret: {e}")
        return None

def lambda_handler(event, context):
    # 암호화된 환경 변수 값 가져오기
    encrypted_password = os.environ['DB_PASSWORD']
    
    # 환경 변수 복호화
    decrypted_password = decrypt_secret(encrypted_password)

    print(f"Encrypted value: {encrypted_password}")
    print(f"Decrypted value: {decrypted_password}")
    
    if decrypted_password == "supersecret":
        return {
            'statusCode': 200,
            'body': 'Great, decryption successful!'
        }
    else:
        return {
            'statusCode': 400,
            'body': 'Decryption failed!'
        }
```

**[코드 설명]**

- `os.environ['DB_PASSWORD']`: 암호화된 값을 환경 변수에서 불러옵니다.
- `base64.b64decode()`: 환경 변수는 Base64로 인코딩되어 있으므로, 복호화 전에 디코딩합니다.
- `kms_client.decrypt()`: KMS `Decrypt` API를 호출하여 값을 복호화합니다.
- `response['Plaintext'].decode('utf-8')`: 복호화된 결과는 바이트(bytes) 형태이므로, UTF-8로 디코딩하여 평문 문자열로 변환합니다.

---

## 4. ⚙️ 권한 설정: Lambda 실행 역할 수정

Lambda 함수가 KMS를 호출하려면 해당 함수에 연결된 **IAM 실행 역할**에 `kms:Decrypt` 권한이 부여되어야 합니다.

**✅ 권한 추가 과정**

1. **Lambda 함수 역할 찾기**: Lambda 함수 설정의 "Permissions" 탭에서 실행 역할(Execution Role) 링크를 클릭합니다.
    
2. **정책 편집**: 역할 페이지에서 "Add permissions" > "Create inline policy"를 선택합니다.
    
3. **정책 설정**:
    - **서비스**: KMS   
    - **작업(Actions)**: `Decrypt`
    - **리소스(Resources)**: 환경 변수 암호화에 사용된 **KMS 키의 ARN**을 지정합니다.

4. **정책 저장**: 정책 이름을 지정하고 저장합니다.
    

이제 Lambda 함수는 KMS 키를 사용하여 환경 변수를 성공적으로 복호화할 수 있게 됩니다.

---

## 5. ✅ 결과 확인

코드를 배포하고 테스트 이벤트를 실행하면, 로그에서 다음과 같은 결과를 확인할 수 있습니다.

|로그 내용|설명|
|---|---|
|**`Encrypted value: AQ...`**|암호화된 환경 변수 값 (Base64 인코딩된 문자열)|
|**`Decrypted value: supersecret`**|성공적으로 복호화된 평문 값|

이 실습을 통해, Lambda의 환경 변수를 안전하게 관리하고, 함수가 필요할 때만 복호화하여 사용하는 안전한 패턴을 구축할 수 있습니다. 이는 서버리스 아키텍처의 보안을 강화하는 중요한 방법입니다.