

이번 강의에서는 여러 리소스로 트래픽을 분산하면서도 헬스 체크를 통해 정상적인 엔드포인트만 응답에 포함시키는 **다중 값 응답 라우팅 정책(Multi-value Answer Routing Policy)**에 대해 알아봅니다.

---

### 1. 다중 값 응답 라우팅 정책이란? 🤔

- **개념**: 하나의 DNS 쿼리에 대해 최대 8개의 레코드를 응답으로 반환하는 정책입니다. 이 정책은 헬스 체크와 연동하여 정상(Healthy) 상태의 리소스만 응답에 포함시킵니다.
    
- **작동 방식**:
    
    - Route 53은 동일한 레코드 이름에 대해 여러 개의 레코드를 생성할 수 있도록 허용합니다.
    - 각 레코드에는 **헬스 체크를 연결**할 수 있습니다.
    - 클라이언트가 DNS 쿼리를 보내면, Route 53은 연결된 헬스 체크가 `Healthy` 상태인 레코드들을 최대 8개까지 반환합니다.
    - 클라이언트는 반환된 여러 IP 주소 중 하나를 무작위로 선택하여 접속합니다.

- **주요 특징**:
    
    - **클라이언트 측 부하 분산**: 여러 개의 정상적인 IP 주소를 클라이언트에게 제공하여, 클라이언트가 직접 부하 분산을 수행하도록 합니다.
        
    - **헬스 체크 필수**: 이 정책의 핵심은 헬스 체크입니다. 헬스 체크가 비정상(`Unhealthy`)인 리소스는 응답에 포함되지 않으므로, 사용자는 항상 정상적인 엔드포인트에 접속하게 됩니다.
        
    - **Simple 라우팅과의 차이**: Simple 라우팅 정책의 다중 값 응답은 헬스 체크를 지원하지 않습니다. 따라서 Simple 라우팅 정책으로 여러 IP를 반환할 경우, 그중 일부가 비정상일 수 있습니다. 반면 다중 값 응답 라우팅은 **오직 정상적인 리소스만 반환**한다는 점에서 더 안전합니다.
        
    - **ELB의 대체재가 아님**: 다중 값 응답 라우팅은 로드 밸런서(ELB)의 역할을 완전히 대체할 수 없습니다. 이는 단순한 클라이언트 측 부하 분산이며, ELB가 제공하는 세션 유지, SSL 종료 등과 같은 고급 기능은 제공하지 않습니다.


### 2. 다중 값 응답 라우팅 실습 🧪

이전에 생성한 세 개의 EC2 인스턴스에 대한 헬스 체크를 활용하여, 다중 값 응답 라우팅 정책의 작동 방식을 확인해 보겠습니다.

#### 2.1 다중 값 응답 레코드 세트 생성

1. **Route 53 콘솔 접속**: 이전에 등록한 도메인(`yourchosendomain.com`)의 호스팅 존으로 이동합니다.
2. **레코드 생성**: `레코드 생성(Create record)` 클릭.
3. **첫 번째 레코드 (미국 동부)**:
    - **레코드 이름**: `multi` (FQDN: `multi.yourchosendomain.com`)
    - **레코드 유형**: `A`
    - **값**: 버지니아 북부(`us-east-1`) EC2 인스턴스의 IP 주소를 입력.
    - **라우팅 정책**: `다중 값 응답(Multi-value answer)` 선택.
    - **헬스 체크 연동**: `헬스 체크 ID`에서 이전에 생성한 `us-east-1` 헬스 체크를 선택합니다.
    - **레코드 ID**: `US`
    - **다른 레코드 추가(Add another record)** 클릭.

4. **두 번째 레코드 (싱가포르)**:
    - **레코드 이름**: `multi` (주 레코드와 동일)
    - **값**: 싱가포르(`ap-southeast-1`) EC2 인스턴스의 IP 주소를 입력.
    - **라우팅 정책**: `다중 값 응답(Multi-value answer)`
    - **헬스 체크 연동**: `ap-southeast-1` 헬스 체크를 선택합니다.
    - **레코드 ID**: `Asia`
    - **다른 레코드 추가(Add another record)** 클릭.
5. **세 번째 레코드 (프랑크푸르트)**:
    - **레코드 이름**: `multi` (주 레코드와 동일)
    - **값**: 프랑크푸르트(`eu-central-1`) EC2 인스턴스의 IP 주소를 입력.
    - **라우팅 정책**: `다중 값 응답(Multi-value answer)`
    - **헬스 체크 연동**: `eu-central-1` 헬스 체크를 선택합니다.
    - **레코드 ID**: `EU`
6. **레코드 생성**: 설정이 완료되면 `레코드 생성(Create records)`을 클릭합니다.


#### 2.2 장애 상황 시 응답 변화 확인

1. **정상 상황 확인**:
    
    - AWS Cloud Shell에서 `dig multi.yourchosendomain.com` 명령어를 실행합니다.
    - 세 개의 EC2 인스턴스 모두 정상 상태이므로, DNS 응답으로 **세 개의 IP 주소**가 모두 반환되는 것을 확인할 수 있습니다.

2. **의도적인 장애 발생**:
    - 프랑크푸르트(`eu-central-1`) 리전의 EC2 인스턴스를 선택하고, 해당 인스턴스의 보안 그룹에서 `HTTP (80 포트)` 규칙을 삭제하여 외부 접속을 차단합니다.

    - 잠시 후 `EU Central 1` 헬스 체크의 상태가 "비정상(Unhealthy)"으로 변경될 것입니다.
    
    - **참고**: 실습에서는 헬스 체크의 `상태 반전(Invert health check status)` 기능을 사용하여 빠르게 비정상 상태를 시뮬레이션할 수도 있습니다.
        
3. **장애 조치 확인**:
    
    - 헬스 체크 상태가 `Unhealthy`로 변경된 후, 다시 Cloud Shell에서 `dig multi.yourchosendomain.com` 명령어를 실행합니다.
        
    - 이번에는 비정상 상태인 프랑크푸르트 IP를 제외하고, 정상 상태인 **두 개의 IP 주소만** DNS 응답으로 반환되는 것을 확인할 수 있습니다.
        

### 3. 결론 💡

**다중 값 응답 라우팅 정책**은 여러 개의 정상적인 리소스로 트래픽을 분산하면서도, 헬스 체크를 통해 비정상적인 리소스를 자동으로 응답에서 제외시키는 안전한 부하 분산 메커니즘을 제공합니다. 이는 로드 밸런서를 사용하지 않고도 서비스의 가용성을 일정 수준 확보할 수 있게 해주는 유용한 기능입니다.

---

궁금한 점이 있으시면 언제든지 질문해주세요.