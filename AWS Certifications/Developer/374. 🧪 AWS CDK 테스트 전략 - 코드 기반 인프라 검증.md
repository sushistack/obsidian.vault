
이번 아티클에서는 **AWS CDK(Cloud Development Kit)** 애플리케이션의 **테스트 전략**에 대해 알아보겠습니다. CDK는 인프라를 코드로 정의하기 때문에, 소프트웨어 개발에서 사용하는 일반적인 테스트 기법들을 그대로 적용하여 배포 전에 인프라의 유효성을 검증할 수 있습니다.

---

### 1️⃣ CDK 테스트의 중요성

CDK로 작성된 인프라 코드는 `cdk deploy` 명령어를 통해 CloudFormation 템플릿으로 변환된 후 실제 AWS 리소스를 생성합니다. 이 과정에서 **오류가 발생하면 배포 실패, 롤백, 심지어 예기치 않은 비용 발생**으로 이어질 수 있습니다.

CDK는 `jest`(JavaScript)나 `pytest`(Python)와 같은 인기 있는 테스트 프레임워크와 연동하여, 배포 전에 다음과 같은 사항을 확인할 수 있게 해줍니다.

- **올바른 리소스 생성:** 필요한 모든 리소스(Lambda, DynamoDB 등)가 생성되는가?
    
- **정확한 속성 설정:** Lambda 함수의 런타임이나 DynamoDB의 파티션 키가 올바르게 설정되었는가?
    
- **보안 규칙 준수:** IAM 역할에 최소 권한 원칙이 잘 적용되었는가?
    

---

### 2️⃣ CDK 테스트 유형

CDK는 크게 두 가지 유형의 테스트를 지원합니다.

#### **1. 세밀한 검증(Fine-grained Assertion)**

- **가장 일반적인 테스트 유형**으로, 합성된 CloudFormation 템플릿 내의 특정 리소스와 속성들을 개별적으로 검증합니다.
    
- **`@aws-cdk/assertions` 모듈**을 사용하여 `hasResourceProperties`, `hasResource`와 같은 메서드를 활용합니다.
    
- 예를 들어, **Lambda 함수**가 `nodejs14.x` 런타임과 특정 핸들러를 가졌는지, **SNS 구독**이 하나만 생성되었는지 등을 확인합니다.
    
- 이 테스트는 **의도한 대로 인프라가 구성되었는지**를 보장하는 데 중점을 둡니다.

**예시 코드:**

```JavaScript
// 주어진 스택에서 Lambda 함수가 특정 속성을 가졌는지 검증
template.hasResourceProperties('AWS::Lambda::Function', {
  Runtime: 'nodejs14.x',
  Handler: 'index.handler'
});

// 주어진 스택에서 SNS 구독 리소스가 정확히 하나만 생성되었는지 검증
template.resourceCountIs('AWS::SNS::Subscription', 1);
```

#### **2. 스냅샷 테스트(Snapshot Test)**

- **현재 합성된 CloudFormation 템플릿**을 **이전의 '스냅샷'으로 저장된 템플릿**과 비교합니다.
    
- 코드 변경 후 `cdk synth`를 실행하면, 변경된 CloudFormation 템플릿이 기존 스냅샷과 다를 경우 테스트가 실패합니다.
    
- 개발자는 변경 사항을 검토하여 의도된 변경인지 확인하고, 스냅샷을 업데이트할 수 있습니다.
    
- 이 테스트는 **예상치 못한 인프라 변경**이 발생하지 않았는지 확인하는 데 유용합니다. 특히 복잡한 스택의 경우 전체 템플릿의 일관성을 유지하는 데 도움이 됩니다.

---

### 3️⃣ CDK 템플릿 테스트 방법

CDK는 테스트를 위해 두 가지 방법으로 CloudFormation 템플릿을 가져올 수 있습니다. 이는 시험에서도 중요하게 다뤄지는 내용입니다.

|메서드|역할|설명|
|---|---|---|
|**`Template.fromStack(myStack)`**|CDK 스택으로부터 템플릿 가져오기|**CDK 애플리케이션 내부에 정의된 스택**을 직접 참조하여 테스트합니다. CDK 코드가 CloudFormation으로 올바르게 변환되는지 검증하는 가장 일반적인 방법입니다.|
|**`Template.fromString(templateString)`**|외부 템플릿으로부터 템플릿 가져오기|**CDK 외부에 존재하는 CloudFormation 템플릿 파일**의 내용을 문자열로 읽어와 테스트합니다. 이는 CloudFormation으로 작성된 외부 템플릿을 검증하거나, CI/CD 파이프라인에서 이미 합성된 템플릿을 테스트할 때 유용합니다.|

**예시 코드:**

```JavaScript
// CDK 스택을 참조하여 템플릿을 가져옴
const app = new cdk.App();
const myStack = new CdkAppStack(app, 'MyStack');
const template = Template.fromStack(myStack);

// 외부 CloudFormation 파일을 읽어 템플릿을 가져옴
const myExternalTemplate = fs.readFileSync('my-external-cfn-template.json', 'utf8');
const template = Template.fromString(myExternalTemplate);
```

이러한 테스트 기능들을 활용하면, CDK는 단순한 인프라 코드를 넘어 **견고하고 신뢰성 높은 인프라 관리 도구**로 거듭날 수 있습니다.