
AWS KMS(Key Management Service)는 AWS에서 데이터 암호화를 관리하는 핵심 서비스입니다. `AWS 암호화 CLI(Encryption CLI)`를 사용하면, 대용량 파일을 손쉽게 암호화하고 복호화할 수 있습니다. 이 가이드에서는 Python `pip`를 사용하여 CLI를 설치하고, 실제 파일을 암호화 및 복호화하는 과정을 단계별로 상세히 설명합니다.

---

## 🚀 1. AWS 암호화 CLI 설치

AWS 암호화 CLI는 Python 환경에서 `pip`를 통해 간단하게 설치할 수 있습니다.

**✅ 설치 명령어**

```Bash
# Python pip를 사용하여 AWS Encryption SDK CLI 설치
pip install aws-encryption-sdk-cli
```

설치가 완료되면, 다음 명령어로 버전을 확인하여 설치가 제대로 되었는지 검증할 수 있습니다.

```Bash
aws-encryption-cli --version
```

[결과 예시]

aws-encryption-cli/1.3.7 aws-encryption-sdk/1.3.7 Python/3.9.6

---

## 🔑 2. KMS 키 정보 설정

암호화 및 복호화에 사용할 **고객 관리형 키(CMK)**의 ARN(Amazon Resource Name)이 필요합니다. ARN은 AWS Console에서 KMS 키의 상세 정보 페이지에서 확인할 수 있습니다.

**✅ CMK ARN 환경 변수 설정**

```Bash
# KMS 키의 ARN을 환경 변수로 저장
export KEY_ARN=arn:aws:kms:eu-west-2:123456789012:key/your-key-id
```

이 환경 변수는 이후의 암호화 및 복호화 명령에서 키를 쉽게 참조하는 데 사용됩니다.

---

## 📂 3. 암호화할 파일 생성

대용량 암호화의 효과를 시연하기 위해 1MB 이상의 큰 텍스트 파일을 가정합니다. 간단한 예제를 위해 다음 내용을 가진 `hello.txt` 파일을 생성합니다.

```Bash
# hello.txt 파일 생성 및 내용 추가
echo "This is a super secret data that is over one megabyte." > hello.txt
```

실제로 이 파일의 크기는 중요하지 않으며, CLI가 Envelope Encryption 기술을 사용하여 자동으로 처리합니다.

---

## 🔒 4. 파일 암호화

이제 `aws-encryption-cli`의 `encrypt` 명령을 사용하여 `hello.txt` 파일을 암호화합니다.

**✅ 암호화 명령어**

```Bash
# 암호화 명령어 실행
aws-encryption-cli --encrypt \
    --input hello.txt \
    --master-keys key=$KEY_ARN \
    --output ./output \
    --metadata-output ./metadata
```

**[명령어 설명]**

- `--encrypt`: 암호화 작업을 지정합니다.
- `--input hello.txt`: 암호화할 원본 파일의 경로입니다.
- `--master-keys key=$KEY_ARN`: 사용할 KMS 마스터 키(CMK)를 환경 변수 `$KEY_ARN`을 통해 지정합니다.
- `--output ./output`: 암호화된 파일이 저장될 출력 디렉터리입니다.
- `--metadata-output ./metadata`: 암호화 과정에 대한 메타데이터가 저장될 파일 경로입니다. 이 파일은 암호화된 데이터의 정보를 담고 있으며, 디버깅 목적으로 유용합니다.

명령어를 실행하면 `./output` 디렉터리 내에 `hello.txt.encrypted` 파일이 생성됩니다. 이 파일의 내용을 열어보면 알아볼 수 없는 **난수(gibberish)**가 나타나는 것을 확인할 수 있습니다.

---

## 🔓 5. 파일 복호화

암호화된 파일을 원래의 평문으로 되돌리기 위해 `decrypt` 명령어를 사용합니다.

**✅ 복호화 명령어**

```Bash
# 복호화 명령어 실행
aws-encryption-cli --decrypt \
    --input ./output/hello.txt.encrypted \
    --master-keys key=$KEY_ARN \
    --output ./decrypted \
    --metadata-output ./metadata
```

**[명령어 설명]**

- `--decrypt`: 복호화 작업을 지정합니다.
- `--input ./output/hello.txt.encrypted`: 복호화할 암호화된 파일의 경로입니다.
- `--master-keys key=$KEY_ARN`: 복호화에 사용할 마스터 키를 지정합니다. **KMS는 암호화된 데이터에 포함된 키 정보를 자동으로 인식하므로 이 인수는 필수는 아닙니다.** 하지만 명시적으로 지정하면 좋습니다.
- `--output ./decrypted`: 복호화된 파일이 저장될 출력 디렉터리입니다.

명령어를 실행하면 `./decrypted` 디렉터리에 `hello.txt.encrypted.decrypted` 파일이 생성됩니다. 이 파일을 열어보면, 암호화하기 전의 원래 내용인 "This is a super secret data that is over one megabyte."가 복원된 것을 확인할 수 있습니다.

---

## 🌟 결론

`AWS Encryption CLI`는 복잡한 **Envelope Encryption** 기술을 추상화하여, 사용자가 간단한 두 가지 명령어로 대용량 데이터를 안전하게 암호화하고 복호화할 수 있도록 돕습니다. 이 CLI를 사용한 실습을 통해 KMS의 강력한 데이터 보호 기능을 직접 경험할 수 있으며, 실제 애플리케이션 개발에 이 기술을 적용하는 데 자신감을 얻을 수 있습니다.