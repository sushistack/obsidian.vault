
## 🚀 아마존 SQS 개요

**아마존 SQS(Simple Queue Service)**는 클라우드 기반의 메시지 대기열(Message Queue) 서비스입니다. SQS는 **마이크로서비스, 분산 시스템 및 서버리스 애플리케이션** 간의 메시지를 안정적으로 교환할 수 있게 해주는 완전 관리형 서비스로, 애플리케이션 컴포넌트 간의 **결합도(Coupling)**를 낮추어 시스템의 확장성과 안정성을 크게 향상시킵니다. 생산자(Producer)가 메시지를 큐에 보내면, 소비자(Consumer)가 큐에서 메시지를 가져와 처리하는 방식으로 동작합니다.

### SQS의 핵심 역할

- **비동기 처리:** 사용자의 요청을 즉시 처리하지 않고 큐에 넣어두었다가 나중에 처리함으로써, 시스템의 응답 속도를 향상시키고 부하를 분산시킵니다.
    
- **결합도 완화:** 생산자와 소비자가 직접 통신하지 않고 큐를 통해 통신하므로, 각 컴포넌트가 독립적으로 개발, 배포, 확장될 수 있습니다.
    
- **시스템 안정성:** 소비자가 메시지를 처리하지 못하더라도 메시지는 큐에 남아있으므로, 재처리가 가능하며 메시지 유실을 방지합니다.

---

## ⚙️ SQS 큐 생성 및 설정

### 큐 유형 선택

SQS 큐를 생성할 때 두 가지 유형 중에서 선택할 수 있습니다.

|큐 유형|특징|사용 사례|
|---|---|---|
|**Standard Queue**|- 처리량 무제한 (거의 무제한)<br>- **최소 1회 전송 보장** (At-least-once delivery)<br>- 메시지가 전송된 순서대로 처리되지 않을 수 있음 (Best-effort ordering)|대규모 메시지 처리, 메시지 순서가 중요하지 않은 경우|
|**FIFO Queue**|- **정확히 1회 전송 보장** (Exactly-once processing)<br>- **선입선출** (First-In-First-Out) 순서 보장<br>- 초당 300개의 메시지 전송(단, 메시지 그룹 ID 사용 시 3000개)|은행 거래, 결제 처리 등 메시지 순서가 중요한 경우|

이번 실습에서는 `Standard Queue`를 사용하며, 큐 이름은 `Demo Queue`로 설정합니다.

### 큐 구성 설정

큐를 생성할 때 다양한 설정을 구성할 수 있습니다.

- **Visibility Timeout (가시성 제한 시간):** 소비자가 메시지를 가져간 후 다른 소비자가 해당 메시지를 다시 가져가지 못하도록 메시지를 숨기는 시간입니다. 기본값은 30초이며, 0초에서 12시간까지 설정 가능합니다. 이 시간 내에 메시지 처리가 완료되지 않으면 메시지는 다시 큐에 나타나 다른 소비자가 가져갈 수 있게 됩니다.

- **Message Retention Period (메시지 보존 기간):** 메시지가 큐에 보관되는 기간입니다. 최소 1분에서 최대 14일까지 설정할 수 있으며, 실습에서는 4일로 설정합니다.

- **Maximum Message Size (최대 메시지 크기):** 하나의 메시지가 가질 수 있는 최대 크기입니다. 기본값은 256KB이며, SQS에서 허용하는 최대 크기입니다.

- **Receive Message Wait Time (메시지 수신 대기 시간):** 메시지를 가져오기 위해 큐를 폴링(Polling)할 때 대기하는 시간입니다. 0초는 짧은 폴링(Short Polling), 1초 이상은 긴 폴링(Long Polling)을 의미합니다. 긴 폴링은 API 호출 횟수를 줄여 비용을 절감하고, 메시지를 더 빠르게 수신할 수 있게 합니다.

### 큐 암호화 (Encryption)

SQS 메시지는 전송 중 또는 보관 중 모두 암호화될 수 있습니다.

- **SSE-SQS (기본값):** AWS에서 관리하는 SQS 키를 사용하여 서버 측 암호화를 제공합니다. 추가 비용이 발생하지 않습니다.

- **SSE-KMS:** AWS KMS(Key Management Service)를 사용하여 고객이 직접 관리하는 CMK(Customer Master Key)로 암호화를 수행합니다. 이는 보안 요구사항이 더 엄격한 경우에 사용됩니다.


실습에서는 기본값인 **SSE-SQS**를 사용합니다.

### 큐 액세스 정책 (Access Policy)

**액세스 정책(Access Policy)**은 SQS 큐에 대한 접근 권한을 정의하는 JSON 문서입니다. 마치 S3 버킷 정책(Bucket Policy)처럼, 특정 AWS 계정, 사용자, 또는 역할이 큐에 메시지를 보내거나(Send) 받도록(Receive) 권한을 부여할 수 있습니다.

```JSON
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:user/some-user"
      },
      "Action": "SQS:SendMessage",
      "Resource": "arn:aws:sqs:us-east-1:123456789012:DemoQueue"
    },
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:role/some-role"
      },
      "Action": "SQS:ReceiveMessage",
      "Resource": "arn:aws:sqs:us-east-1:123456789012:DemoQueue"
    }
  ]
}
```

이 정책은 `some-user` 사용자는 메시지를 보낼 수 있고, `some-role` 역할을 가진 사용자는 메시지를 받을 수 있도록 허용하는 예시입니다.

---

## 📩 메시지 전송 및 수신

큐가 생성되면 메시지를 보내고 받을 수 있습니다.

### 메시지 전송 (Send Message)

1. SQS 콘솔에서 생성된 `Demo Queue`를 선택합니다.
2. **"Send and receive messages"** 버튼을 클릭합니다.
3. **"Message body"** 입력창에 메시지 내용(`hello world!`)을 입력합니다.
4. **"Send Message"**를 클릭하면 메시지가 큐로 전송됩니다.
5. 큐의 **`Messages available`** 카운트가 1로 증가합니다.

### 메시지 수신 (Receive Message)

1. 메시지를 보낸 후 같은 화면에서 **"Poll for messages"**를 클릭합니다.
2. 큐에 대기 중인 메시지가 나타납니다.
3. 메시지를 클릭하여 **메시지 본문(`hello world!`)**과 **메타데이터(messageId, receive count 등)**를 확인할 수 있습니다.
4. 메시지가 보이지 않는 경우, **가시성 제한 시간(Visibility Timeout)**이 초과되었는지 확인해야 합니다. 만약 소비자가 메시지를 가져간 후 처리하지 않고 시간이 초과되면, 메시지는 다시 큐로 돌아와 다른 소비자가 가져갈 수 있게 됩니다.

### 메시지 삭제 (Delete Message)

소비자가 메시지 처리를 완료하면 큐에서 해당 메시지를 삭제해야 합니다.

1. 수신된 메시지 목록에서 삭제할 메시지를 선택합니다.
2. **"Delete"** 버튼을 클릭합니다.
3. 메시지가 성공적으로 삭제되면 큐의 `Messages available` 카운트가 0이 됩니다.
4. 메시지를 삭제하지 않으면 **가시성 제한 시간**이 만료된 후 메시지가 다시 큐에 나타나 여러 번 처리될 수 있습니다.

### 큐 관리 기능

- **Edit:** 큐의 설정(가시성 제한 시간, 보존 기간 등)을 변경할 수 있습니다.
- **Purge:** 큐에 있는 모든 메시지를 한 번에 삭제합니다. 개발 환경에서 유용하게 사용되지만, 프로덕션 환경에서는 신중하게 사용해야 합니다.
- **Monitoring:** CloudWatch를 통해 메시지 수, 메시지 크기 등 큐의 다양한 지표를 모니터링할 수 있습니다.
- **Dead-Letter Queue (DLQ):** 메시지 처리 실패 횟수가 일정 기준을 초과하면 해당 메시지를 격리하는 큐입니다. DLQ에 메시지를 보냄으로써 실패한 메시지로 인해 큐가 막히는 것을 방지하고, 실패 원인을 분석할 수 있습니다.

---

## 💬 SQS를 통한 프로듀서와 컨슈머의 분리

이 실습을 통해 우리는 메시지를 보내는 **프로듀서(Producer)**와 메시지를 받는 **컨슈머(Consumer)**가 SQS 큐를 매개로 완전히 분리되어 동작하는 것을 확인했습니다. 프로듀서가 아무리 많은 메시지를 보내더라도, 컨슈머는 자신의 처리 속도에 맞춰 큐에서 메시지를 가져와 처리할 수 있습니다. 이는 시스템의 유연성과 확장성을 극대화하는 SQS의 핵심적인 이점입니다.