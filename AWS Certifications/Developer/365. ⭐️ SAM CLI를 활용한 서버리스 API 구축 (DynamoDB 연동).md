
이번 아티클에서는 **AWS SAM(Serverless Application Model) CLI**를 사용하여 DynamoDB 테이블과 연동되는 완전한 서버리스 API를 구축하는 방법에 대해 자세히 알아보겠습니다. 특히 SAM 템플릿 파일(`template.yaml`)의 구조와 주요 리소스, 그리고 로컬 환경에서 애플리케이션을 테스트하는 방법을 중점적으로 다룹니다.

---

### 1️⃣ SAM 프로젝트 초기화 및 파일 구조 분석

먼저, `sam init` 명령어를 사용하여 새로운 SAM 프로젝트를 생성합니다. 이번에는 DynamoDB를 포함하는 API를 만들기 위해 '서버리스 API(Serverless API)' 템플릿을 선택합니다.

```Bash
sam init
```

- **Quick start templates:** `7` (Serverless API) 선택
    
- **Runtime:** `nodejs22.x` 선택
    
- **Project name:** `sam-app-dynamodb`로 지정
    

프로젝트가 생성되면, 다음과 같은 파일 및 폴더 구조를 확인할 수 있습니다. 이전 강의와 유사하지만, API 구현을 위한 몇 가지 소스 파일이 추가된 것을 볼 수 있습니다.

```Bash
# 디렉토리 구조 (예시)
sam-app-dynamodb/
├── events/
│   ├── event-get-all-items.json
│   ├── event-get-by-id.json
│   ├── event-put-item.json
├── README.md
├── src/
│   ├── handlers/
│   │   ├── delete-item.js
│   │   ├── get-all-items.js
│   │   ├── get-by-id.js
│   │   ├── put-item.js
├── template.yaml
```

이 구조에서 가장 중요한 파일은 애플리케이션의 모든 리소스를 정의하는 `template.yaml`입니다.

---

### 2️⃣ `template.yaml` 파일 상세 분석

`template.yaml` 파일은 SAM의 핵심으로, AWS 클라우드에 배포될 모든 리소스를 YAML 형식으로 정의합니다. DynamoDB와 연동되는 API 템플릿은 다음과 같은 주요 섹션으로 구성됩니다.

```YAML
# 일부 내용 발췌
Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    Runtime: nodejs22.x
    MemorySize: 128
    Timeout: 10

Resources:
  GetAllItemsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/get-all-items.getAllItemsHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SampleTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /
            Method: GET

  PutItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/put-item.putItemHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SampleTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /
            Method: POST

  SampleTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: id
        Type: String
      ProvisionedThroughput:
        ReadCapacityUnits: 2
        WriteCapacityUnits: 2
```

#### **주요 리소스 설명**

|리소스 이름|유형|역할 및 속성|
|---|---|---|
|**`Transform`**|`AWS::Serverless-2016-10-31`|**SAM 템플릿임을 명시하는 필수 선언**입니다. 이 선언을 통해 AWS CloudFormation이 SAM의 간소화된 문법을 이해하고, Lambda 함수, API Gateway, IAM 역할 등 여러 CloudFormation 리소스로 변환할 수 있습니다.|
|**`GetAllItemsFunction`**|`AWS::Serverless::Function`|`GET` 요청을 처리하는 Lambda 함수입니다. `src/handlers/get-all-items.js` 파일의 핸들러를 실행하며, `/` 경로에 대한 API Gateway 이벤트를 처리합니다.|
|**`Policies`**|`DynamoDBCrudPolicy`|**SAM의 강력한 기능 중 하나**입니다. `DynamoDBCrudPolicy`는 DynamoDB에 대한 기본적인 CRUD(생성, 읽기, 업데이트, 삭제) 작업을 허용하는 IAM 정책을 자동으로 생성하고 연결해줍니다. `TableName` 속성에 `!Ref SampleTable`을 사용하여, 아래에 정의된 DynamoDB 테이블의 이름을 참조합니다. 이는 원시 CloudFormation 템플릿을 사용하는 것에 비해 훨씬 간편합니다.|
|**`Events`**|`Api`|이 Lambda 함수가 어떤 API 요청에 의해 트리거될지 정의합니다. `Path`와 `Method`를 지정하여 API Gateway를 쉽게 구성할 수 있습니다.|
|**`SampleTable`**|`AWS::Serverless::SimpleTable`|DynamoDB 테이블을 간단하게 정의합니다. SAM은 이 리소스를 `AWS::DynamoDB::Table`로 변환하여 배포합니다. `PrimaryKey`와 `ProvisionedThroughput` 같은 핵심 속성만 지정하면 됩니다.|

이 템플릿은 `GET`, `POST`, `DELETE` 요청을 처리하는 여러 Lambda 함수를 정의하고, 이 함수들이 하나의 DynamoDB 테이블을 공유하도록 설정합니다.

---

### 3️⃣ 로컬 환경에서 애플리케이션 테스트하기

SAM CLI는 코드를 AWS에 배포하지 않고도 로컬에서 테스트할 수 있는 강력한 기능을 제공합니다. 이를 위해 **Docker**가 필요합니다.

#### 1. `sam local invoke` 명령어로 함수 호출하기

`events` 디렉토리에는 각 Lambda 함수를 테스트하기 위한 샘플 이벤트 JSON 파일이 포함되어 있습니다. `sam local invoke` 명령어를 사용하여 특정 함수를 로컬에서 호출하고 테스트할 수 있습니다.

```Bash
# 모든 아이템을 가져오는 함수 호출 예시
sam local invoke GetAllItemsFunction --event-name event-get-all-items

# 새로운 아이템을 추가하는 함수 호출 예시
sam local invoke PutItemFunction --event-name event-put-item
```

- `--event-name`: `events` 디렉토리 내의 샘플 이벤트 파일 이름을 지정합니다.

#### 2. `sam local start-api` 명령어로 로컬 API 게이트웨이 시작하기

`sam local start-api` 명령어를 사용하면 전체 API 게이트웨이를 로컬 환경에서 실행할 수 있습니다. 이를 통해 실제 HTTP 요청을 보내 API의 동작을 테스트할 수 있습니다.

```Bash
sam local start-api
```

명령어를 실행하면, 로컬 PC의 `http://127.0.0.1:3000` 주소에 API 게이트웨이가 시작됩니다. 이제 다른 터미널에서 `curl` 또는 웹 브라우저를 사용하여 API 엔드포인트에 요청을 보낼 수 있습니다.

|엔드포인트|HTTP 메서드|설명|
|---|---|---|
|`http://127.0.0.1:3000/`|`GET`|DynamoDB 테이블의 모든 아이템을 가져옵니다.|
|`http://127.0.0.1:3000/`|`POST`|DynamoDB 테이블에 새로운 아이템을 추가합니다.|

---

### 4️⃣ 애플리케이션 배포 및 삭제

로컬 테스트가 완료되면, `sam deploy` 명령어를 사용하여 AWS에 애플리케이션을 배포할 수 있습니다.

```Bash
sam deploy --guided
```

배포 후, 더 이상 애플리케이션이 필요하지 않다면 `sam delete` 명령어를 사용하여 생성된 모든 리소스를 안전하게 삭제할 수 있습니다.

```Bash
sam delete
```

이 예제를 통해 **SAM CLI가 복잡한 서버리스 애플리케이션을 얼마나 쉽게 구축하고 관리할 수 있게 해주는지** 알 수 있습니다. 특히 `DynamoDBCrudPolicy`와 같은 SAM의 정책 템플릿은 IAM 설정의 복잡성을 크게 줄여줍니다.