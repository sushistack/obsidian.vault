

Amazon ECS 클러스터에서 **EC2 시작 유형**을 사용할 때, ECS는 새 태스크를 실행하거나 기존 태스크를 종료할 위치를 결정해야 합니다. 이 결정을 돕기 위해 **태스크 배치 전략(Task Placement Strategies)**과 **태스크 배치 제약 조건(Task Placement Constraints)**을 사용할 수 있습니다.

> 💡 **참고:** 이 기능은 **EC2 시작 유형**에서만 유효합니다. **Fargate**에서는 AWS가 인프라를 자동으로 관리하므로, 사용자가 배치 전략을 신경 쓸 필요가 없습니다.

---

### 1. 태스크 배치 프로세스

![[Pasted image 20250810195421.png]]

ECS가 태스크를 배치하는 과정은 다음과 같은 순서로 진행됩니다.

1. **자원 요구사항 충족:** 먼저, 태스크 정의에 명시된 CPU, 메모리, 포트 요구사항을 충족하는 모든 EC2 인스턴스를 식별합니다.
2. **배치 제약 조건 적용:** 정의된 배치 제약 조건을 적용하여, 후보 인스턴스 목록을 더 좁힙니다.
3. **배치 전략 적용:** 남은 후보 인스턴스 중에서 가장 적합한 하나를 선택하기 위해 배치 전략을 적용합니다.

---

### 2. 태스크 배치 전략 (Strategies)

배치 전략은 태스크를 어떻게 배치할지에 대한 "희망" 사항을 정의합니다.

#### 1) Binpack (빈팩) 📦

![[Pasted image 20250810195442.png]]

- **목표:** 사용 중인 인스턴스 수를 최소화하여 **비용을 절감**하는 데 중점을 둡니다.
- **작동 방식:** 사용 가능한 CPU 또는 메모리가 가장 적은 인스턴스에 태스크를 배치합니다. 즉, 하나의 인스턴스를 최대한 채운 후 다음 인스턴스로 넘어가는 방식입니다.
- **JSON 예시:**

```JSON
{
    "strategy": [
        {
            "type": "binpack",
            "field": "memory"
        }
    ]
}
```

#### 2) Spread (스프레드) 📊

![[Pasted image 20250810195521.png]]

- **목표:** 태스크를 여러 인스턴스에 고르게 분산하여 **고가용성**을 높입니다.
- **작동 방식:** 특정 값(예: 가용 영역, 인스턴스 ID)을 기준으로 태스크를 가능한 한 균등하게 분산시킵니다.
- **JSON 예시:**

```JSON
{
    "strategy": [
        {
            "type": "spread",
            "field": "instanceId"
        }
    ]
}
```

- **활용:** 여러 가용 영역(AZ)에 태스크를 분산하여 한 AZ에 장애가 발생해도 서비스가 계속될 수 있도록 합니다.

#### 3) Random (랜덤) 🎲

![[Pasted image 20250810195510.png]]

- **목표:** 특별한 전략 없이 태스크를 무작위로 배치합니다.
- **작동 방식:** 무작위로 인스턴스를 선택하여 태스크를 배치합니다. 이는 최적의 전략은 아니지만, 가장 단순한 방식입니다.

---

### 3. 태스크 배치 제약 조건 (Constraints)

배치 제약 조건은 태스크를 배치할 수 있는 인스턴스에 대한 "필수" 요구사항을 정의합니다.

#### 1) `distinctInstance`

- **목표:** 각 태스크가 **다른 EC2 인스턴스**에 배치되도록 합니다.
- **작동 방식:** 하나의 인스턴스에 여러 태스크가 배치되는 것을 방지합니다.
- **JSON 예시:**

```JSON
{
    "constraint": [
        {
            "type": "distinctInstance"
        }
    ]
}
```

#### 2) `memberOf`

- **목표:** 특정 조건(예: 인스턴스 유형, 태그)을 만족하는 인스턴스에만 태스크를 배치합니다.
- **작동 방식:** `클러스터 쿼리 언어(Cluster Query Language)`를 사용하여 조건을 정의합니다.
- **JSON 예시:**

```JSON
{
    "constraint": [
        {
            "type": "memberOf",
            "expression": "instance.ec2instanceType == 't2.micro'"
        }
    ]
}
```

- **활용:** 특정 태스크를 특정 유형의 인스턴스(`t2.micro`)에만 배치하여 리소스를 최적화할 수 있습니다.
