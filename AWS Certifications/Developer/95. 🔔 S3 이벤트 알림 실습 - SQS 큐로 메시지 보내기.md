
이번 실습에서는 S3 이벤트 알림을 설정하여 객체 업로드 시 SQS 큐로 메시지를 전송하는 과정을 직접 해보겠습니다. 이 실습의 핵심은 **권한 설정**입니다. S3 버킷이 SQS 큐에 메시지를 보내기 위해 필요한 권한을 부여하는 방법을 중점적으로 다룹니다.

---

### 1단계: S3 버킷 및 SQS 큐 생성 🛠️

1. **S3 버킷 생성:** `stephane-v3-events-notifications`와 같이 고유한 이름의 버킷을 생성합니다.
2. **SQS 큐 생성:** SQS 콘솔로 이동하여 `DemoS3Notification` 이름의 **표준 큐(Standard Queue)**를 생성합니다. (S3 이벤트 알림은 현재 FIFO 큐를 지원하지 않습니다.)

### 2단계: SQS 큐에 권한 부여하기 🔑

S3 버킷이 SQS 큐에 메시지를 보내려면, SQS 큐의 **액세스 정책(Access Policy)**을 수정하여 S3 서비스의 `sqs:SendMessage` 권한을 허용해야 합니다.

1. SQS 콘솔에서 `DemoS3Notification` 큐를 선택하고 `액세스 정책(Access policy)` 탭으로 이동합니다.
2. `편집(Edit)`을 클릭합니다.
3. `정책 편집기(Policy editor)`에서 아래와 같은 JSON 정책을 추가합니다.
    - `Principal`을 `*`로 설정하거나 `s3.amazonaws.com`으로 설정합니다. (실습에서는 `*`로 설정하여 모든 주체가 메시지를 보낼 수 있도록 허용합니다.)
    - `Action`을 `sqs:SendMessage`로 설정합니다.
    - `Resource`에 SQS 큐의 ARN을 입력합니다.

```JSON
{
  "Version": "2012-10-17",
  "Id": "MyS3Policy",
  "Statement": [
	{
	  "Sid": "MyS3Statement",
	  "Effect": "Allow",
	  "Principal": "*",
	  "Action": "sqs:SendMessage",
	  "Resource": "<SQS_큐_ARN>"
	}
  ]
}
```
    
4. `저장(Save)`을 클릭하여 정책을 적용합니다.

> **에러 해결:** 이 단계를 먼저 수행하지 않으면, S3 버킷에서 이벤트 알림을 설정할 때 "Unable to validate the destination configuration" 오류가 발생합니다.

### 3단계: S3 이벤트 알림 설정 🔔

이제 S3 버킷이 SQS 큐로 메시지를 보낼 수 있도록 이벤트 알림을 설정합니다.

1. S3 버킷의 `속성(Properties)` 탭으로 이동합니다.
2. `이벤트 알림(Event notifications)` 섹션으로 스크롤하여 `이벤트 알림 생성(Create event notification)`을 클릭합니다.
3. **일반 구성:**
    - **이름:** `DemoEventNotification`
    - **접두사/접미사:** 비워둡니다. (모든 객체에 대해 알림을 받습니다.)
4. **이벤트 유형:**
    - `모든 객체 생성 이벤트(All object create events)`를 선택합니다. (파일이 업로드될 때마다 알림이 트리거됩니다.)
5. **대상:**
    - `SQS 큐`를 선택하고, 드롭다운 메뉴에서 `DemoS3Notification` 큐를 선택합니다.
6. `변경 사항 저장(Save changes)`을 클릭합니다. S3는 설정이 완료되면 SQS 큐로 테스트 메시지를 보냅니다.

### 4단계: 이벤트 알림 작동 확인 ✅

1. **테스트 메시지 확인:** SQS 콘솔에서 `DemoS3Notification` 큐를 선택하고 `메시지 송수신(Send and receive messages)`을 클릭합니다. `메시지 폴링(Poll for messages)`을 실행하면 `s3:TestEvent`라는 메시지가 도착한 것을 확인할 수 있습니다.
2. **객체 업로드 후 메시지 확인:**
    - S3 버킷에 `coffee.jpg`와 같은 파일을 업로드합니다.
    - SQS 콘솔로 돌아와 `메시지 폴링`을 다시 실행합니다.
    - 새로운 메시지가 도착했는지 확인합니다. 메시지 본문을 열어보면 `eventName`이 `ObjectCreated:Put`이고, `key`에 `coffee.jpg`가 포함된 것을 확인할 수 있습니다.

이 실습을 통해 S3 이벤트 알림이 성공적으로 SQS 큐에 메시지를 전송하고 있음을 확인했습니다. 이 워크플로우는 객체 업로드 시 자동으로 백엔드 작업을 처리해야 하는 다양한 시나리오에 활용될 수 있습니다.