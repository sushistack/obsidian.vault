
AWS CLI와 SDK는 AWS 서비스에 접근할 때 사용할 자격 증명을 여러 위치에서 찾습니다. 이때 어떤 자격 증명을 우선적으로 사용하는지 정해진 순서가 있는데, 이것을 **자격 증명 우선순위 체인(Credentials Provider Chain)**이라고 합니다. 이 개념은 시험 시나리오 문제에 자주 등장하므로 정확히 이해하는 것이 중요합니다.

---

### 1. 자격 증명 우선순위 체인 (CLI 기준)

AWS CLI는 다음 순서대로 자격 증명을 찾습니다. 우선순위가 높은 항목이 먼저 적용됩니다.

|우선순위|자격 증명 위치|설명|
|---|---|---|
|**1순위**|**명령줄 옵션**|`aws <command> --profile <profile_name>` 또는 `--aws-access-key-id`와 같이 명령어에 직접 입력한 자격 증명.|
|**2순위**|**환경 변수**|`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`와 같은 환경 변수에 설정된 자격 증명.|
|**3순위**|**CLI 자격 증명 파일**|`~/.aws/credentials` 파일에 저장된 프로파일(`[default]`, `[my-profile]`)의 자격 증명.|
|**4순위**|**CLI 설정 파일**|`~/.aws/config` 파일에 정의된 자격 증명.|
|**5순위**|**컨테이너 자격 증명**|ECS(Elastic Container Service) 태스크 역할이 부여한 임시 자격 증명.|
|**6순위**|**EC2 인스턴스 프로파일**|EC2 인스턴스에 할당된 IAM 역할이 제공하는 임시 자격 증명.|

> **핵심:** 명령줄 옵션과 환경 변수가 가장 높은 우선순위를 가지며, IAM 역할(EC2 인스턴스 프로파일)은 가장 낮은 우선순위를 가집니다.

---

### 2. 중요 시나리오: 자격 증명 우선순위 문제 ⚠️

**문제 상황:**

- EC2 인스턴스에 애플리케이션을 배포했습니다.
- 이전에 `IAM 사용자`의 자격 증명을 **환경 변수**로 설정했습니다. 이 사용자는 S3에 대한 `FullAccess` 권한을 가지고 있습니다.
- 모범 사례에 따라, 애플리케이션에 필요한 최소 권한(특정 S3 버킷에 대한 접근 권한)만 가진 `IAM 역할`을 생성하고, 이 역할을 **EC2 인스턴스 프로파일**로 인스턴스에 할당했습니다.
- 그런데도 애플리케이션이 여전히 **모든 S3 버킷에 접근할 수 있습니다.**

**질문:** 왜 EC2 인스턴스 프로파일의 최소 권한이 적용되지 않았나요?

**정답:** 자격 증명 우선순위 체인에 따라, **환경 변수**가 EC2 인스턴스 프로파일보다 더 높은 우선순위를 가지기 때문입니다. 인스턴스는 더 넓은 권한을 가진 환경 변수의 자격 증명을 먼저 사용하여 AWS API를 호출합니다.

**해결책:** 환경 변수에서 IAM 사용자 자격 증명을 **제거**해야 합니다. 그러면 자격 증명 체인에서 더 낮은 우선순위인 EC2 인스턴스 프로파일의 자격 증명을 사용하게 되어, 최소 권한만으로 작동하게 됩니다.

---

### 3. 자격 증명 관리 모범 사례 ✅

- **코드에 자격 증명 하드코딩 금지:** 자격 증명을 애플리케이션 코드에 직접 저장하는 것은 매우 위험한 행동입니다.
- **AWS 내부에서는 IAM 역할 사용:** EC2 인스턴스, ECS 태스크, Lambda 함수 등 AWS 내부에서 실행되는 리소스에는 **IAM 역할**을 할당하여 임시 자격 증명을 사용해야 합니다.
- **AWS 외부에서는 환경 변수 또는 프로파일 사용:** 로컬 개발 환경 등 AWS 외부에서는 `AWS CLI` 프로파일 또는 환경 변수를 사용하여 자격 증명을 관리합니다.
