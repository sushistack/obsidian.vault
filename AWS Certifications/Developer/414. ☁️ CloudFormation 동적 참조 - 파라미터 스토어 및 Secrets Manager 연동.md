
![[Pasted image 20250914193251.png]]

CloudFormation 템플릿에 데이터베이스 비밀번호, API 키와 같은 민감한 정보를 직접 하드코딩하는 것은 보안상 매우 위험합니다. 이를 해결하기 위해 CloudFormation은 **동적 참조(Dynamic References)** 기능을 제공하여, SSM 파라미터 스토어나 Secrets Manager에 저장된 값을 템플릿에 안전하게 삽입할 수 있게 해줍니다.

---

## 1. 🔗 동적 참조의 기본 문법

동적 참조는 템플릿 배포 시 지정된 외부 저장소에서 값을 가져와 리소스 속성에 적용하는 기능입니다.

- **기본 구문**: `{{resolve:서비스:참조 키}}`
    
    - `resolve`: 동적 참조를 사용함을 나타냅니다.
        
    - `서비스`: `ssm`, `ssm-secure`, `secretsmanager` 중 하나를 지정합니다.
        
    - `참조 키`: 파라미터 이름 또는 비밀 정보의 ARN/이름을 지정합니다.

|서비스 이름|설명|예시|
|---|---|---|
|**`ssm`**|SSM 파라미터 스토어에 저장된 **일반 문자열**|`{{resolve:ssm:/my-app/dev/db-url:1}}`|
|**`ssm-secure`**|SSM 파라미터 스토어에 저장된 **암호화된 문자열**|`{{resolve:ssm-secure:/my-app/dev/db-password:1}}`|
|**`secretsmanager`**|Secrets Manager에 저장된 **비밀 정보**|`{{resolve:secretsmanager:prod/my-api-key:SecretString:AWSCURRENT}}`|

---

## 2. 📝 동적 참조 예시

### 1. S3 버킷에 SSM 파라미터 참조하기

S3 버킷의 접근 제어 목록을 SSM 파라미터 스토어에 저장하고, 이를 CloudFormation 템플릿에서 참조할 수 있습니다.

```YAML
Resources:
  MyS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: "{{resolve:ssm:/myapp/s3/access-control:1}}"
```

### 2. IAM 사용자 비밀번호를 SSM에서 가져오기

IAM 사용자 비밀번호와 같이 민감한 정보는 `ssm-secure`를 사용하여 안전하게 참조할 수 있습니다.

```YAML
Resources:
  MyUser:
    Type: AWS::IAM::User
    Properties:
      UserName: "MySecureUser"
      LoginProfile:
        Password: "{{resolve:ssm-secure:/myapp/secure/password:1}}"
        PasswordResetRequired: true
```

### 3. RDS 데이터베이스에 Secrets Manager 참조하기

RDS 데이터베이스의 마스터 사용자명과 비밀번호를 Secrets Manager에서 참조하는 것은 동적 참조의 가장 일반적인 사용 사례 중 하나입니다.

```YAML
Resources:
  MyDBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: "my-db-instance"
      MasterUsername: "{{resolve:secretsmanager:prod/db-credentials:SecretString:username::AWSCURRENT}}"
      MasterUserPassword: "{{resolve:secretsmanager:prod/db-credentials:SecretString:password::AWSCURRENT}}"
```

---

## 3. 🔄 RDS와 Secrets Manager 연동 시 CloudFormation 패턴

RDS 데이터베이스의 마스터 비밀번호를 관리하는 두 가지 CloudFormation 패턴이 있습니다.

### 패턴 1: RDS가 직접 Secrets Manager를 관리

![[Pasted image 20250914193323.png]]

CloudFormation이 RDS 클러스터를 생성하고, RDS 서비스가 Secrets Manager에 비밀 정보를 생성하고 관리하게 합니다.

1. **CloudFormation**: `AWS::RDS::DBCluster` 리소스를 정의하고, `ManageMasterUserPassword: true` 속성을 추가합니다.
    
2. **RDS**: RDS 서비스가 자동으로 Secrets Manager에 비밀 정보를 생성하고, 그 ARN을 관리합니다.
    
3. **결과**: CloudFormation은 비밀 정보를 직접 생성하지 않고, **RDS 서비스가 비밀 정보의 라이프사이클을 전적으로 담당**하게 됩니다. 스택의 `Outputs`를 통해 생성된 비밀 정보의 ARN을 확인할 수 있습니다.

### 패턴 2: CloudFormation이 Secrets Manager와 RDS를 모두 관리

템플릿 내에서 Secrets Manager 비밀 정보와 RDS 데이터베이스를 모두 정의하고, 이 둘을 연결합니다.

1. **Secrets Manager 생성**: `AWS::SecretsManager::Secret` 리소스를 정의합니다. `GenerateStringKey` 속성을 사용하여 비밀번호를 자동으로 생성하도록 설정할 수 있습니다.
    
2. **RDS 생성**: `AWS::RDS::DBInstance` 또는 `AWS::RDS::DBCluster`를 정의하고, `MasterUserPassword` 속성에서 동적 참조를 사용하여 생성된 Secrets Manager 비밀 정보의 값을 가져옵니다.
    
3. **연결**: **`AWS::SecretsManager::SecretTargetAttachment`** 리소스를 추가하여 Secrets Manager 비밀 정보와 RDS 데이터베이스를 연결합니다. 이 연결을 통해 Secrets Manager가 RDS 비밀번호를 자동으로 순환시킬 수 있게 됩니다.


---

## 4. 🌟 결론

CloudFormation의 동적 참조는 **IaC(Infrastructure as Code)**의 보안과 유연성을 크게 향상시킵니다. 민감한 정보를 템플릿에 노출시키지 않고도 SSM 파라미터 스토어나 Secrets Manager의 값을 안전하게 사용할 수 있습니다. 특히 RDS와 Secrets Manager를 연동하는 두 가지 패턴을 이해하면, 데이터베이스 비밀번호 관리를 자동화하고 보안을 강화하는 데 매우 효과적입니다.