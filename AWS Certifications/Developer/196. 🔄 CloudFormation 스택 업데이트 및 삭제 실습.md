
### 📝 스택 업데이트: 새로운 템플릿 적용

첫 번째 실습에서 생성한 EC2 인스턴스 스택을 이제 **업데이트**해 보겠습니다. CloudFormation 콘솔에서 '업데이트' 버튼을 클릭한 후, 새로운 템플릿으로 교체합니다.

이번에 사용할 템플릿은 `1-EC2-with-SG-EIP.yaml` 파일입니다. 이 템플릿은 기존 `0-just-ec2.yaml` 파일에 다음 기능들을 추가했습니다.

- **파라미터 (Parameter)**: 사용자 입력을 받아 템플릿에 적용할 수 있는 변수를 정의합니다.
- **리소스 추가**:
    
    - **Elastic IP (`AWS::EC2::EIP`)**: 고정 IP 주소를 생성하고 EC2 인스턴스에 연결합니다.
    - **보안 그룹 (`AWS::EC2::SecurityGroup`) 2개**:
        - **SSH 보안 그룹**: SSH(22번 포트) 접속을 허용합니다.
        - **서버 보안 그룹**: HTTP(80번 포트) 접속을 허용합니다.
- **EC2 인스턴스 속성 변경**: 인스턴스에 새로운 보안 그룹들을 연결하도록 수정되었습니다.

#### 💻 스택 업데이트 과정

1. **새 템플릿 업로드**: CloudFormation 콘솔에서 `EC2InstanceDemo` 스택을 선택하고 '업데이트'를 클릭합니다. '템플릿 파일 교체'를 선택하고 `1-EC2-with-SG-EIP.yaml` 파일을 업로드합니다.
    
2. **파라미터 입력**: 템플릿에 정의된 `SecurityGroupDescription` 파라미터에 대한 값을 입력하라는 메시지가 나타납니다. 여기에 `"This is a cool security group"`과 같이 원하는 설명을 입력합니다.
    
3. **변경 세트 미리보기 (Change set preview)**: '다음'을 클릭하여 스택 업데이트 요약 페이지로 이동하면 **변경 세트(Change set)**를 확인할 수 있습니다.
    

**변경 세트**는 CloudFormation이 새로운 템플릿을 적용하기 위해 어떤 변경 사항을 수행할지 미리 보여주는 기능입니다.

|리소스|변경 사항|설명|
|---|---|---|
|**MyEIP**|`Add`|Elastic IP 리소스가 **추가**됩니다.|
|**MySSHSecurityGroup**|`Add`|SSH 보안 그룹이 **추가**됩니다.|
|**MyServerSecurityGroup**|`Add`|서버 보안 그룹이 **추가**됩니다.|
|**MyInstance**|`Replace`|기존 EC2 인스턴스가 **교체**됩니다. `Replacement: true`는 기존 리소스가 종료되고 새로운 리소스가 생성됨을 의미합니다.|

`MyInstance`의 `Replacement: true`는 이전 EC2 인스턴스가 삭제되고 새로운 인스턴스가 생성될 것임을 나타냅니다. 이는 인스턴스의 속성이 변경되었기 때문이며, CloudFormation이 자동으로 최적의 변경 방식을 판단하여 결정합니다.

---

### 🚀 업데이트 진행 및 리소스 검증

변경 세트를 확인하고 '제출'을 클릭하면 스택 업데이트가 시작됩니다.

- **`UPDATE_IN_PROGRESS`**: 스택 업데이트 중
- **이벤트 로그**: '이벤트' 탭에서 생성/삭제 과정을 실시간으로 볼 수 있습니다.

#### 🔎 생성된 리소스 확인

업데이트가 완료되면 EC2 콘솔에서 다음 리소스들을 확인할 수 있습니다.

- **EC2 인스턴스**:
    
    - 기존 인스턴스는 종료되고, 새로운 인스턴스가 생성됩니다.
    - 새 인스턴스에 **Elastic IP**가 자동으로 연결되어 고정된 공인 IP를 갖게 됩니다.
    - 두 개의 새로운 **보안 그룹**이 연결됩니다.

- **보안 그룹**:
    
    - **SSH 보안 그룹**: 22번 포트 인바운드 규칙이 있습니다.
    - **서버 보안 그룹**: 80번 포트 인바운드 규칙이 있습니다. 이 보안 그룹의 **설명**은 우리가 파라미터로 입력한 `"This is a cool security group"`으로 설정되어 있습니다.


모든 리소스에는 CloudFormation 스택 ID, 논리적 ID, 스택 이름 등 관련 태그가 자동으로 추가되어 관리가 용이합니다.

---

### 🗑️ 스택 삭제: 모든 리소스 한 번에 정리하기

CloudFormation을 통해 생성된 모든 리소스를 수동으로 하나씩 삭제하는 것은 번거롭고 실수를 유발할 수 있습니다. CloudFormation은 스택 삭제 기능을 통해 이 과정을 간소화합니다.

#### 💻 스택 삭제 과정

1. **스택 선택**: `EC2InstanceDemo` 스택을 선택합니다.
2. **삭제 클릭**: '삭제' 버튼을 클릭합니다.
3. **삭제 확인**: 확인 메시지 창이 뜨면 '삭제'를 클릭합니다.

**CloudFormation의 강점**: 스택 삭제 시 CloudFormation은 **자동으로 리소스 간의 종속성을 파악하여 올바른 순서대로 삭제를 진행합니다.** (예: EC2 인스턴스 -> 보안 그룹). 이 기능은 수동으로 삭제할 때 발생하는 복잡성과 잠재적 오류를 방지해줍니다.

이 과정을 통해 CloudFormation의 강력한 기능을 경험해 보았습니다. 인프라를 코드로 관리하면 생성, 업데이트, 삭제가 모두 자동화되어 일관성과 효율성을 극대화할 수 있습니다.