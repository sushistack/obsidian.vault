
이번 아티클에서는 **AWS SAM(Serverless Application Model)** 프레임워크와 **AWS CodeDeploy**를 연동하여 Lambda 함수를 무중단으로 배포하는 방법에 대해 자세히 알아보겠습니다. 특히 트래픽을 점진적으로 전환하는 **Canary 배포** 방식을 중심으로 설명하며, 배포 과정에서의 자동 롤백 및 후크(hook) 함수 활용법도 다룹니다.

---

### 1️⃣ Lambda & CodeDeploy 연동 개요

Lambda 함수는 새 버전이 배포될 때마다 새롭게 생성됩니다. 이때 기존 버전을 즉시 새 버전으로 교체하면 모든 트래픽이 한 번에 전환되어 예기치 않은 오류가 발생할 경우 사용자에게 직접적인 영향을 줄 수 있습니다.

**CodeDeploy**는 이러한 문제를 해결하기 위해 Lambda 함수 배포 시 트래픽을 점진적으로 전환하는 기능을 제공합니다. SAM은 이 CodeDeploy의 기능을 손쉽게 통합하여 **안전한 배포 프로세스**를 자동화합니다.

![[Pasted image 20250911184934.png]]

#### **배포 흐름 시각화**

1. **배포 시작:** SAM CLI를 통해 새로운 Lambda 함수 코드(`v2`)를 배포합니다.
    
2. **사전 트래픽 후크 (Pre-traffic Hook):** (선택 사항) 새 버전으로 트래픽을 전환하기 전에, 특정 Lambda 함수를 실행하여 유효성 검사를 수행합니다.
    
3. **트래픽 전환 (Traffic Shifting):** CodeDeploy는 설정된 배포 전략(Canary, Linear 등)에 따라 Lambda **별칭(Alias)**을 통해 트래픽을 `v1`에서 `v2`로 점진적으로 전환합니다.
    
4. **CloudWatch 경보 모니터링:** (선택 사항) 배포 중 CloudWatch 경보를 모니터링하여 오류 비율이 임계값을 초과하는 등 문제가 감지되면 **자동으로 롤백**을 수행합니다.
    
5. **사후 트래픽 후크 (Post-traffic Hook):** (선택 사항) 트래픽 전환이 완료된 후, 다른 Lambda 함수를 실행하여 추가적인 테스트를 수행합니다.
    
6. **배포 완료:** 모든 검증이 성공적으로 끝나면, 별칭이 `v2`를 100% 가리키도록 업데이트되고, 이전 버전은 삭제됩니다.
    

---

### 2️⃣ SAM 템플릿 설정 (`template.yaml`)

SAM과 CodeDeploy를 연동하기 위해서는 `template.yaml` 파일에 다음 세 가지 핵심 속성을 추가해야 합니다.

|속성|설명|예시|
|---|---|---|
|**`AutoPublishAlias`**|SAM이 새 버전의 함수를 배포할 때, 지정된 이름의 별칭을 자동으로 생성하고 최신 버전으로 업데이트하도록 지시합니다.|`live`|
|**`DeploymentPreference`**|CodeDeploy의 배포 전략을 정의합니다. **`Type`**, **`Alarms`**, **`Hooks`**를 포함할 수 있습니다.|`Canary`, `Linear`, `AllAtOnce`|
|**`Type`**|트래픽 전환 방식을 결정합니다. <br>🔹 **Canary:** 지정된 비율의 트래픽을 일정 시간 동안 새 버전으로 전환합니다.<br>🔹 **Linear:** 지정된 비율로 일정한 간격마다 트래픽을 전환합니다. <br>🔹 **AllAtOnce:** 모든 트래픽을 즉시 새 버전으로 전환합니다.|`Canary10Percent10Minutes`|
|**`Alarms`**|배포 중 모니터링할 CloudWatch 경보의 목록입니다. 경보가 `ALARM` 상태가 되면 자동으로 롤백이 트리거됩니다.|`MyLambdaErrorsAlarm`|
|**`Hooks`**|배포 전후에 실행할 Lambda 함수의 ARN(Amazon Resource Name)을 정의합니다. `PreTraffic`과 `PostTraffic`이 있습니다.|`PreTrafficHookFunction`|

#### **`template.yaml` 예시 코드**

아래 코드는 `Canary10Percent10Minutes` 배포 전략을 적용하는 예시입니다.


```YAML
Resources:
  HelloWorldFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: hello_world/
      Handler: app.lambda_handler
      Runtime: python3.9
      AutoPublishAlias: live  # 라이브 별칭 자동 생성 및 업데이트
      DeploymentPreference:
        Type: Canary10Percent10Minutes # 10분 동안 10%의 트래픽을 새 버전으로 전환
        Alarms:
          - !Ref HelloWorldErrorsAlarm # CloudWatch 경보 참조
        Hooks:
          PreTraffic: !Ref MyPreTrafficHookFunction # 사전 트래픽 후크 함수 참조
          PostTraffic: !Ref MyPostTrafficHookFunction # 사후 트래픽 후크 함수 참조
```

---

### 3️⃣ 실습: Canary 배포 실행 단계

#### **1단계: 초기 배포 (`v1`)**

1. **SAM 프로젝트 초기화:**

```Bash
sam init
# Python 3.9, Hello World Example 선택
```
    
2. **`template.yaml` 수정:** 위 예시 코드를 참고하여 `HelloWorldFunction` 리소스에 `AutoPublishAlias`와 `DeploymentPreference` 속성을 추가합니다.
    
3. **최초 배포:**
    
```Bash
sam deploy --guided
```

이 명령을 실행하면 `live`라는 이름의 별칭과 함께 `HelloWorldFunction`의 `v1` 버전이 배포됩니다.

#### **2단계: 코드 변경 및 재배포 (`v2`)**

1. **코드 수정:** `app.py` 파일의 반환 메시지를 `"hello world v2"`와 같이 변경합니다.
    
2. **재배포:**

```Bash
sam deploy --guided
```
    
3. **배포 과정 확인:**
    
    - `sam deploy` 명령이 실행되면, SAM은 CodeDeploy를 호출하여 배포를 시작합니다.
        
    - AWS 콘솔의 **CodeDeploy** 서비스로 이동하면, 진행 중인 Lambda 배포를 확인할 수 있습니다.
        
    - 배포가 시작되면 **Lambda 별칭(live)**은 `v1`에 90%, `v2`에 10%의 가중치를 할당하여 트래픽을 분산합니다.
        
    - 10분 동안 CodeDeploy가 배포를 모니터링합니다. 문제가 없으면 트래픽은 100% `v2`로 전환됩니다.

#### **3단계: 배포 완료 및 확인**

- 배포가 성공적으로 완료되면 Lambda 함수 별칭은 완전히 `v2`를 가리키게 됩니다.
    
- AWS Lambda 콘솔에서 **Qualifiers** 탭을 확인하면, `live` 별칭이 `v2` 버전과 연결된 것을 볼 수 있습니다.

이 과정을 통해 우리는 SAM CLI 명령만으로 복잡한 Canary 배포를 자동화하고, CodeDeploy의 강력한 기능을 활용하여 안전한 배포 파이프라인을 구축할 수 있습니다.