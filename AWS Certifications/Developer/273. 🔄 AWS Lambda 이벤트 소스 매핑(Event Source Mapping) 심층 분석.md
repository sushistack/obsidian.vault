
이번 아티클에서는 **Lambda의 이벤트 소스 매핑(Event Source Mapping)**에 대해 자세히 살펴보겠습니다. 이는 Lambda가 Kinesis, SQS, DynamoDB Streams와 같은 서비스로부터 이벤트를 처리하는 방식입니다.

### 📜 이벤트 소스 매핑의 작동 원리

![[Pasted image 20250826215209.png]]

이벤트 소스 매핑은 Lambda가 이벤트를 **폴링(Polling)**하여 가져오는 방식입니다. 비동기 호출과 달리, 이 경우에는 Lambda 서비스 자체가 소스에서 레코드를 주기적으로 확인하고 가져와서 Lambda 함수를 **동기식**으로 호출합니다.

이벤트 소스 매핑은 크게 **스트림(Streams)**과 **큐(Queues)**, 두 가지 범주로 나눌 수 있습니다.

|구분|해당 서비스|처리 방식|
|---|---|---|
|**스트림**|Kinesis Data Streams, DynamoDB Streams|람다가 샤드(Shard)별로 데이터를 폴링하여 배치(Batch)로 처리|
|**큐**|SQS, SQS FIFO|람다가 롱 폴링(Long Polling)을 통해 메시지를 가져와 처리|

---

### 1. 🌊 스트림 기반 이벤트 소스 매핑

스트림 기반 이벤트 소스 매핑은 **Kinesis Data Streams**와 **DynamoDB Streams**에 적용됩니다.

- **폴링 및 처리**: Lambda 서비스는 각 샤드(Shard)에 대한 이터레이터(Iterator)를 생성하고, 배치 단위로 레코드를 가져와서 함수를 동기식으로 호출합니다.
    
- **순서 보장**: 각 샤드 내의 레코드는 순서대로 처리됩니다. 단, `Partition Key`가 다른 레코드는 동시에 처리될 수 있습니다.
    
- **레코드 유지**: Lambda가 레코드를 처리하더라도 스트림에서 레코드가 삭제되지 않습니다. 이는 다른 소비자가 동일한 데이터를 읽을 수 있게 합니다.

#### 📈 처리 속도 및 병렬 처리

![[Pasted image 20250826215247.png]]

- **저속 스트림**: `배치 윈도우(Batch Window)`를 설정하여 여러 레코드를 모아 한 번에 처리함으로써 효율성을 높일 수 있습니다.
    
- **고속 스트림**: `병렬 처리(Parallelization)`를 활성화하여 하나의 샤드에서 동시에 여러 배치를 처리할 수 있습니다.
    
    - **설정**: 샤드당 최대 10개의 병렬 배치를 처리하도록 설정할 수 있습니다.
        
    - **작동**: 각 배치는 순서대로 처리되지만, 여러 배치가 동시에 처리되어 전체 처리량을 높입니다.

#### ⚠️ 오류 처리

함수가 오류를 반환하면, 기본적으로 **전체 배치**가 성공할 때까지 재처리됩니다. 이는 처리 순서를 보장하기 위해 영향을 받는 샤드의 모든 처리를 일시 중단시킵니다.

오류 처리를 개선하기 위한 옵션들은 다음과 같습니다.

- **오래된 이벤트 폐기**: 일정 시간이 지난 레코드는 무시합니다.
    
- **재시도 횟수 제한**: 재시도 횟수를 제한하여 무한 루프를 방지합니다.
    
- **오류 시 배치 분할**: Lambda 함수 타임아웃 오류 발생 시, 배치를 작은 단위로 분할하여 재처리합니다.

---

### 2. 📨 큐 기반 이벤트 소스 매핑

![[Pasted image 20250826215331.png]]

큐 기반 이벤트 소스 매핑은 **SQS(Standard 및 FIFO)**에 적용됩니다.

- **폴링**: Lambda의 이벤트 소스 매핑은 SQS 큐를 **롱 폴링(Long Polling)** 방식으로 효율적으로 폴링합니다.
    
- **배치 처리**: 설정된 배치 크기(1~10개 메시지)만큼 메시지를 가져와 함수를 동기식으로 호출합니다.
    
- **메시지 삭제**: 함수가 배치를 성공적으로 처리하면, Lambda가 큐에서 해당 메시지를 삭제합니다.

#### 📝 SQS 큐 설정 권장 사항

- **가시성 타임아웃**: SQS 큐의 `가시성 타임아웃(Visibility Timeout)`을 Lambda 함수의 타임아웃보다 길게(6배) 설정하는 것이 권장됩니다. 이는 Lambda가 메시지 처리를 완료하기 전에 메시지가 다시 큐에 나타나는 것을 방지합니다.
    
- **DLQ 설정**: SQS 메시지 처리에 실패할 경우, DLQ는 **Lambda가 아닌 SQS 큐 자체에 설정**해야 합니다. Lambda의 DLQ는 비동기 호출에만 작동하기 때문입니다.

#### ⚡️ 스케일링 방식

|큐 유형|스케일링 방식|순서 보장|
|---|---|---|
|**SQS Standard**|초당 최대 1,000개의 배치까지 빠르게 스케일 업(분당 16개 인스턴스씩 추가)|순서 보장 안됨|
|**SQS FIFO**|`메시지 그룹(Message Group ID)`별로 순서를 보장하며, 활성화된 메시지 그룹 수만큼 람다 함수가 스케일 업|순서 보장됨|

SQS Standard 큐를 사용할 경우, 메시지가 중복으로 처리될 수 있으므로 **멱등성(Idempotency)**을 갖도록 함수를 설계해야 합니다.