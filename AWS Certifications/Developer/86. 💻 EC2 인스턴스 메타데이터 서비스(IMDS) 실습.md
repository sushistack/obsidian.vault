
이번 실습에서는 EC2 인스턴스 메타데이터 서비스(IMDS)를 직접 사용해 보고, IMDSv1과 IMDSv2의 차이점, 그리고 IAM 역할의 자격 증명을 가져오는 과정을 확인해 보겠습니다.

---

### 1단계: IMDSv1 접근 시도 (실패)

먼저, Amazon Linux 2023 AMI를 사용하여 EC2 인스턴스를 생성하면 IMDSv2가 기본으로 활성화됩니다. IMDSv1 방식으로 메타데이터에 접근하면 어떻게 되는지 확인해 봅니다.

1. EC2 인스턴스에 접속합니다. (EC2 Instance Connect 사용)
2. IMDSv1의 메타데이터 URL에 `curl` 명령어를 사용하여 직접 요청합니다.
```Bash
curl http://169.254.169.254/latest/meta-data/
```
3. **결과:** `401 Unauthorized` 오류가 발생합니다. 이는 현재 인스턴스가 IMDSv1 접근을 허용하지 않기 때문입니다.

---

### 2단계: IMDSv2를 통한 메타데이터 접근 (성공)

IMDSv2는 보안을 위해 세션 토큰을 먼저 발급받은 후 메타데이터에 접근하는 2단계 방식을 사용합니다.

1. **세션 토큰 발급:** `PUT` 명령을 사용하여 임시 토큰을 발급받아 변수에 저장합니다.
```Bash
TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
```
 `X-aws-ec2-metadata-token-ttl-seconds` 헤더는 토큰의 유효 시간을 초 단위로 지정합니다. (여기서는 6시간)
 
2. **토큰을 사용하여 메타데이터 조회:** 발급받은 토큰을 `X-aws-ec2-metadata-token` 헤더에 포함시켜 메타데이터 URL에 `GET` 요청을 보냅니다.

```Bash
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/
```

3. **결과:** 인스턴스의 다양한 메타데이터 목록(`hostname`, `instance-id`, `local-ipv4` 등)이 출력됩니다. 특정 메타데이터를 보려면 URL 뒤에 원하는 항목을 추가하면 됩니다.

```Bash
# 호스트 이름 조회
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/hostname
```

---
### 3단계: IAM 역할 자격 증명 확인하기

EC2 인스턴스가 IAM 역할을 통해 AWS 서비스에 접근할 때, IMDS를 통해 임시 자격 증명을 얻습니다.

1. **초기 상태 확인:** 인스턴스에 IAM 역할이 연결되지 않은 상태에서 `security-credentials`를 조회하면 아무것도 나타나지 않습니다.
    
```Bash
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/
```
- **결과:** `Not Found` 오류가 발생합니다.

2. **IAM 역할 연결:**
    - AWS 콘솔에서 해당 EC2 인스턴스를 선택합니다.
    - `작업(Actions)` > `보안(Security)` > `IAM 역할 수정(Modify IAM role)`을 선택합니다.
    - 미리 생성해 둔 IAM 역할을 인스턴스에 연결하고 저장합니다.
3. **자격 증명 조회:**
    - 인스턴스에 역할이 연결된 후, 약 30초 정도 기다립니다.
    - `security-credentials`를 다시 조회하면 연결된 역할 이름이 표시됩니다.
    - 역할 이름까지 포함하여 다시 조회하면 임시 자격 증명(Access Key ID, Secret Access Key, Token)이 포함된 JSON 문서가 출력됩니다.

```Bash
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/EC2_INSTANCE_ROLE_NAME/
```

```JSON
{
  "Code": "Success",
  "LastUpdated": "...",
  "Type": "AWS-HMAC",
  "AccessKeyId": "...",
  "SecretAccessKey": "...",
  "Token": "...",
  "Expiration": "..."
}
```

이처럼 EC2 인스턴스는 IMDS를 통해 IAM 역할의 임시 자격 증명을 안전하게 받아 AWS 서비스에 접근할 수 있습니다. 이는 개발자가 수동으로 자격 증명을 관리하는 번거로움을 덜어주고, 보안성을 높이는 중요한 메커니즘입니다.