
**ECS 태스크 정의(Task Definition)**는 Amazon ECS에서 Docker 컨테이너를 실행하는 방법을 정의하는 청사진입니다. JSON 형식으로 작성되지만, AWS 콘솔 UI를 통해 쉽게 생성할 수 있습니다. 태스크 정의에는 컨테이너를 실행하는 데 필요한 모든 구성 정보가 포함됩니다.

---

### 1. 주요 구성 요소 📚

태스크 정의의 핵심 정보는 다음과 같습니다.

- **Docker 이미지:** 실행할 Docker 이미지의 이름(예: `nginxdemos/hello`).
- **포트 매핑(Port Mappings):** 컨테이너 내부 포트와 호스트(EC2) 포트를 연결하는 설정.
- **CPU 및 메모리:** 컨테이너에 할당할 CPU 및 메모리 리소스.
- **환경 변수:** 컨테이너에 주입할 환경 변수.
- **IAM 역할:** 태스크가 AWS 서비스에 접근하는 데 필요한 권한을 정의하는 IAM 역할.
- **로깅 설정:** 컨테이너 로그를 CloudWatch Logs와 같은 서비스로 보내는 설정.


---

### 2. 포트 매핑: EC2 vs. Fargate 🌐


| ![[Pasted image 20250810194858.png]] | ![[Pasted image 20250810194909.png]] |
| ------------------------------------ | ------------------------------------ |
| EC2 Launch Type                      | Fargate                              |

컨테이너의 포트 매핑은 시작 유형(Launch Type)에 따라 다르게 작동합니다.

#### EC2 시작 유형 (EC2 Launch Type)

- **동적 호스트 포트 매핑(Dynamic Host Port Mapping):** 태스크 정의에서 컨테이너 포트만 정의하고 호스트 포트를 `0`으로 설정하면, ECS가 EC2 인스턴스에 임의의 사용 가능한 포트를 동적으로 할당합니다.

- **ALB 연동:** Application Load Balancer(ALB)는 ECS 서비스와 연동되어 이 동적 포트 매핑을 자동으로 인식하고 트래픽을 올바른 컨테이너로 라우팅합니다. 따라서 EC2 인스턴스의 보안 그룹은 ALB로부터의 모든 포트(`0-65535`) 트래픽을 허용해야 합니다.

#### Fargate 시작 유형 (Fargate Launch Type)

- **ENI(Elastic Network Interface):** Fargate에서는 각 태스크에 고유한 프라이빗 IP 주소를 가진 ENI가 할당됩니다.

- **동일 포트 사용:** 호스트가 없으므로 컨테이너 포트와 호스트 포트를 매핑할 필요가 없습니다. 여러 태스크가 동일한 컨테이너 포트를 사용해도 충돌이 발생하지 않습니다.

- **ALB 연동:** ALB는 각 태스크의 프라이빗 IP 주소와 컨테이너 포트를 사용하여 직접 트래픽을 보냅니다.


---

### 3. IAM 역할과 환경 변수 관리 🔑

#### IAM 역할

![[Pasted image 20250810194952.png]]

- **정의 위치:** ECS 태스크를 위한 IAM 역할은 **태스크 정의** 수준에서 정의됩니다.

- **상속:** 이 태스크 정의로 실행되는 모든 ECS 태스크는 해당 IAM 역할을 자동으로 상속받아 AWS 서비스에 접근할 수 있습니다. 태스크마다 다른 권한이 필요하면, 다른 태스크 정의를 생성하여 서로 다른 역할을 할당해야 합니다.


#### 환경 변수

![[Pasted image 20250810195011.png]]

컨테이너에 환경 변수를 주입하는 방법은 여러 가지가 있습니다.

- **하드코딩:** 태스크 정의에 직접 값을 입력합니다. 고정적이고 민감하지 않은 값에 적합합니다.

- **SSM 파라미터 스토어/Secrets Manager:** API 키, 데이터베이스 비밀번호 등 민감한 정보를 안전하게 저장하고, 런타임에 태스크 정의에서 참조하여 주입합니다.

- **S3 버킷:** S3에 저장된 파일에서 환경 변수를 일괄적으로 불러올 수 있습니다.

---

### 4. 컨테이너 간 데이터 공유 💾

![[Pasted image 20250810195028.png]]

하나의 태스크 정의 내에 여러 컨테이너를 실행하는 경우(예: 애플리케이션 컨테이너와 로그 수집용 **사이드카 컨테이너**), 컨테이너 간에 파일을 공유해야 할 때가 있습니다.

- **바인드 마운트(Bind Mount):** 태스크 정의에서 **볼륨(Volume)**을 정의하고, 각 컨테이너에 이 볼륨을 마운트하여 데이터를 공유할 수 있습니다.

- **스토리지의 생명 주기:**
    - **EC2:** 데이터는 EC2 인스턴스의 스토리지에 저장되며, 인스턴스가 종료되면 데이터도 사라집니다.

    - **Fargate:** 데이터는 임시 스토리지(Ephemeral Storage)에 저장되며, 태스크가 종료되면 데이터도 함께 사라집니다.

이러한 태스크 정의의 구성 요소들을 이해하는 것은 ECS 기반 애플리케이션을 효율적으로 설계하고 운영하는 데 매우 중요합니다.