
AWS KMS(Key Management Service)는 데이터 암호화 및 복호화 작업을 수행하는 데 필수적인 서비스입니다. 이 아티클에서는 KMS의 핵심 API인 `Encrypt` 및 `Decrypt`가 어떻게 동작하는지 살펴보고, 4KB 이상의 대용량 데이터를 다루는 **Envelope Encryption** 기술과 관련 API들을 심층적으로 알아보겠습니다.

---

## 🔑 일반적인 암호화 및 복호화 (Encrypt & Decrypt API)

KMS를 사용한 가장 기본적인 암호화 과정은 다음과 같습니다.

**![[Pasted image 20250914191548.png]]**

1. **암호화 (Encrypt)**:
    
    - **사용자**: `Encrypt` API를 호출하여 **4KB 미만**의 데이터를 KMS 서비스로 전송합니다. 사용할 CMK(Customer Master Key)를 지정합니다.
        
    - **KMS**: 사용자의 IAM 권한을 확인한 후, CMK를 사용하여 데이터를 암호화합니다.
        
    - **결과**: KMS는 암호화된 데이터(`CiphertextBlob`)를 사용자에게 반환합니다.
        
2. **복호화 (Decrypt)**:
    
    - **사용자**: `Decrypt` API를 호출하여 암호화된 데이터를 KMS로 전송합니다.
        
    - **KMS**: KMS는 암호화된 데이터에 포함된 키 정보를 자동으로 인식하고, 사용자의 IAM 권한을 확인합니다.
        
    - **결과**: KMS는 데이터를 복호화하여 평문(Plaintext) 상태의 원본 데이터를 사용자에게 반환합니다.
        

이 방식은 간단하지만, **암호화할 수 있는 데이터의 크기가 4KB로 제한**된다는 명확한 한계가 있습니다. 대용량 파일을 다루기 위해서는 다른 접근 방식이 필요합니다.

---

## 💌 Envelope Encryption (봉투 암호화)

Envelope Encryption은 **4KB 이상의 대용량 데이터를 암호화**하기 위한 KMS의 핵심 기술입니다. 이 기법은 암호화 작업을 클라이언트 측에서 수행하고, KMS는 키 관리 역할만 담당하도록 설계되었습니다.

### Envelope Encryption의 동작 원리

![[Pasted image 20250914191614.png]]

1. **데이터 키 생성 (GenerateDataKey API)**:
    
    - **사용자**: `GenerateDataKey` API를 호출하며, 사용할 CMK를 지정합니다.
        
    - **KMS**: 사용자의 IAM 권한을 확인한 후, **데이터 암호화 키(DEK, Data Encryption Key)**를 생성합니다. 이 DEK는 실제 데이터를 암호화하는 데 사용되는 키입니다.
        
    - **결과**: KMS는 두 가지 형태의 DEK를 사용자에게 반환합니다.
        
        - **Plaintext DEK**: 평문 형태의 DEK.
            
        - **Encrypted DEK**: CMK로 암호화된 DEK.
            
2. **클라이언트 측 암호화**:
    
    - **사용자**: KMS로부터 받은 **Plaintext DEK**를 사용하여 클라이언트(사용자 컴퓨터)에서 대용량 파일을 직접 암호화합니다. 이 작업은 KMS 서비스에 데이터를 전송할 필요 없이 로컬에서 고속으로 이루어집니다.
        
    - **결과**: 암호화된 파일이 생성됩니다.
        
3. **암호화된 DEK 저장**:
    
    - **사용자**: 암호화된 파일과 함께, KMS로부터 받은 **Encrypted DEK**를 함께 저장합니다. 이 Encrypted DEK가 마치 파일 전체를 감싸는 '봉투(Envelope)'와 같다고 해서 봉투 암호화라는 이름이 붙었습니다.
        

### Envelope Encryption의 복호화 과정

![[Pasted image 20250914191626.png]]

1. **암호화된 DEK 복호화**:
    
    - **사용자**: 저장된 **Encrypted DEK**(4KB 미만)를 `Decrypt` API를 통해 KMS로 전송합니다.
        
    - **KMS**: 사용자의 IAM 권한을 확인한 후, CMK를 사용하여 Encrypted DEK를 복호화합니다.
        
    - **결과**: KMS는 **Plaintext DEK**를 사용자에게 반환합니다.
        
2. **클라이언트 측 복호화**:
    
    - **사용자**: KMS로부터 받은 **Plaintext DEK**를 사용하여 클라이언트에서 대용량 암호화 파일을 직접 복호화합니다.
        
    - **결과**: 원본 평문 파일이 복원됩니다.
        

이 방식의 핵심은 **KMS가 직접 대용량 데이터를 다루지 않고, 키 생성 및 관리 역할만 수행**한다는 점입니다. 실제 데이터 암호화 및 복호화는 클라이언트 측에서 이루어지므로, KMS의 4KB 한계를 우회하고 네트워크 오버헤드를 줄일 수 있습니다.

---

## 💡 AWS Encryption SDK

Envelope Encryption은 구현이 복잡할 수 있습니다. AWS는 이러한 복잡성을 해결하기 위해 **AWS Encryption SDK**를 제공합니다. 이 SDK는 Envelope Encryption 패턴을 자동으로 구현해주며, 개발자가 직접 이 복잡한 로직을 작성할 필요가 없습니다.

- **SDK 기능**: `Java`, `Python`, `C`, `JavaScript` 등 다양한 언어로 제공됩니다.
    
- **CLI 도구**: CLI로도 설치하여 사용할 수 있습니다.
    
- **데이터 키 캐싱**: SDK는 **데이터 키 캐싱** 기능을 제공합니다. 동일한 CMK를 사용하여 여러 파일을 암호화할 경우, 매번 `GenerateDataKey` API를 호출하는 대신 기존에 생성된 DEK를 재사용할 수 있습니다.
    
    - **장점**: KMS API 호출 횟수를 줄여 **비용을 절감**할 수 있습니다.
        
    - **단점**: 동일한 DEK를 여러 번 사용하므로 **보안상의 트레이드오프**가 발생할 수 있습니다.
        

---

## 📝 KMS 주요 API 요약 (시험 대비)

|API 이름|기능|특징 및 용도|
|---|---|---|
|**`Encrypt`**|데이터 암호화|4KB 미만의 데이터를 KMS로 직접 전송하여 CMK로 암호화.|
|**`Decrypt`**|데이터 복호화|KMS로 암호화된 데이터를 전송하여 복호화. **Envelope Encryption의 Encrypted DEK를 복호화할 때도 사용됨.**|
|**`GenerateDataKey`**|DEK 생성|**Envelope Encryption**의 핵심 API. Plaintext DEK와 Encrypted DEK를 모두 반환하여 클라이언트 측 암호화를 가능하게 함.|
|**`GenerateDataKeyWithoutPlaintext`**|DEK 생성 (Plaintext 없음)|Encrypted DEK만 반환. 즉시 사용하기 위함이 아닌 경우에 사용. 복호화를 위해 추가적인 `Decrypt` API 호출이 필요.|
|**`GenerateRandom`**|무작위 바이트 문자열 생성|암호화에 사용할 수 있는 무작위 바이트 문자열을 생성.|