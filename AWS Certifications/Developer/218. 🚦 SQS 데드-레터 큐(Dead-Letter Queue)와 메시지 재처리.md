
## 🧐 데드-레터 큐(DLQ)란?

**데드-레터 큐(Dead-Letter Queue, DLQ)**는 메시지 처리 실패를 전담하는 보조 SQS 큐입니다. 컨슈머가 메시지를 여러 번 가져갔지만 정상적으로 처리하지 못하는 경우, 해당 메시지는 소스 큐에서 제거되어 DLQ로 자동으로 이동됩니다. DLQ는 이러한 '불량 메시지'를 격리하여 **소스 큐의 기능 방해를 막고, 실패 원인을 분석하고 디버깅할 수 있는 시간을 확보**하는 데 사용됩니다.

### DLQ가 필요한 이유

- **무한 실패 루프 방지:** 잘못된 메시지가 계속해서 소스 큐와 컨슈머 사이에서 실패를 반복하는 것을 막습니다.

- **리소스 낭비 방지:** 실패한 메시지를 계속 재처리하려다 발생하는 불필요한 컴퓨팅 리소스 소모를 줄입니다.

- **디버깅 용이성:** 실패한 메시지들을 한곳에 모아두어, 개발자가 문제를 쉽게 파악하고 해결할 수 있도록 돕습니다.


---

## 🛠️ DLQ 설정 및 동작 방식

![[Pasted image 20250817203849.png]]

### 1. `MaximumReceives` 임계값 설정

DLQ는 소스 큐의 **`MaximumReceives`** 설정에 따라 동작합니다. 이 값은 메시지가 컨슈머에게 전달될 수 있는 최대 횟수를 정의합니다.

- **동작 방식:** 메시지가 `MaximumReceives` 횟수만큼 수신되었음에도 불구하고 `DeleteMessage` API 호출을 통해 삭제되지 않으면, SQS는 해당 메시지를 DLQ로 보냅니다.

- **설정:** SQS 콘솔의 `Redrive and dead-letter queue` 섹션에서 DLQ를 활성화하고 `MaximumReceives` 값을 지정할 수 있습니다.

### 2. 큐 유형 일치 규칙

DLQ는 반드시 소스 큐와 동일한 유형이어야 합니다.

- **Standard 큐**의 DLQ는 **Standard 큐**여야 합니다.
- **FIFO 큐**의 DLQ는 **FIFO 큐**여야 합니다.

### 3. 메시지 보존 기간

DLQ에 있는 메시지가 만료되기 전에 분석하고 처리할 수 있도록, DLQ의 **메시지 보존 기간(Message Retention Period)**을 충분히 길게 설정하는 것이 좋습니다. 예를 들어, **14일**로 설정하면 디버깅할 시간을 넉넉하게 확보할 수 있습니다.

---

## 🔄 Re-drive to Source: 메시지 재처리 기능

![[Pasted image 20250817203859.png]]

**`Re-drive to Source`**는 DLQ에 있는 메시지를 다시 소스 큐로 보내어 재처리할 수 있도록 하는 기능입니다. 이 기능은 문제를 해결한 후 유용하게 활용할 수 있습니다.

|단계|설명|
|---|---|
|**1. 문제 식별**|DLQ의 메시지를 수동으로 검사하여 처리 실패 원인(예: 컨슈머 코드 버그, 메시지 데이터 손상 등)을 파악합니다.|
|**2. 해결책 적용**|원인을 해결하기 위해 컨슈머 코드를 수정하거나, 메시지 데이터를 올바르게 변경합니다.|
|**3. 재전송**|`Re-drive to Source` 기능을 사용하여 DLQ에 있는 메시지를 소스 큐로 다시 보냅니다.|
|**4. 재처리**|소스 큐로 돌아간 메시지는 컨슈머에 의해 다시 처리됩니다. 이 과정에서 컨슈머는 메시지가 DLQ에 갔었는지 알 필요가 없습니다.|

이 기능을 통해 **DLQ는 단순한 격리 장소를 넘어, 메시지 처리 시스템의 회복력을 높이는 강력한 도구**가 됩니다. 개발자는 안전하게 문제를 분석하고 해결한 후, 실패했던 메시지를 정상적으로 다시 처리할 수 있습니다.