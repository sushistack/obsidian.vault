
AWS CodeArtifact를 사용하여 Python 패키지(아티팩트)를 관리하는 방법을 실습해 보겠습니다. 이 가이드는 CodeArtifact의 **도메인**과 **리포지토리**를 생성하고, `pip`을 사용하여 패키지를 설치하며, 패키지가 CodeArtifact에 캐시되는 과정을 직접 확인하는 것을 목표로 합니다.

---

## 🏗️ 1. CodeArtifact 리포지토리 생성

가장 먼저, 패키지를 저장할 리포지토리와 이를 포함할 도메인을 생성해야 합니다.

### **단계별 생성 과정**

1. **리포지토리 생성:** AWS CodeArtifact 콘솔에서 **'리포지토리 생성'**을 클릭합니다.
    
    - **리포지토리 이름:** `DemoRepository`
        
    - **업스트림(Upstream) 설정:** **`Python Package Index(pypi)`**를 선택합니다. 이렇게 하면 `DemoRepository`가 공개 PyPI 리포지토리의 프록시 역할을 하게 됩니다.
        
2. **도메인 생성:**
    
    - **도메인 이름:** `my-company`
        
    - **KMS 키:** AWS 관리형 KMS 키를 선택하여 데이터를 암호화합니다.
        
3. **생성 완료:** `DemoRepository`와 `my-company` 도메인이 생성됩니다. `pypi-store`라는 이름의 외부 연결 리포지토리도 함께 생성됩니다.
    

|구성 요소|역할|
|---|---|
|**`my-company` (도메인)**|회사 전체의 아티팩트 데이터를 저장하는 최상위 컨테이너|
|**`pypi-store` (리포지토리)**|공개 PyPI 리포지토리와 연결된 캐시 전용 리포지토리|
|**`DemoRepository` (리포지토리)**|`pypi-store`를 업스트림으로 가지며, 패키지를 저장할 실제 작업용 리포지토리|

---

## 💻 2. CloudShell에서 `pip` 설정

생성한 CodeArtifact 리포지토리에 연결하기 위해 CloudShell 환경에서 `pip`을 설정합니다.

### **수동 설정 방법**

CodeArtifact는 `pip3`과 호환되지 않는 문제가 발생할 수 있으므로, 수동으로 인증 토큰을 발급받아 설정하는 방법을 사용합니다.

1. **인증 토큰 발급:** 다음 AWS CLI 명령어를 사용하여 임시 인증 토큰을 생성하고 환경 변수로 저장합니다.
    
    Bash
    
    ```
    export CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token --domain my-company --query authorizationToken --output text)
    echo $CODEARTIFACT_AUTH_TOKEN
    ```
    
    - **유효 기간:** 이 토큰은 **12시간** 동안 유효하며, 이후에는 다시 명령어를 실행하여 새로운 토큰을 발급받아야 합니다.
        
2. **`pip` 설정:** 다음 명령어를 사용하여 `pip`이 CodeArtifact 리포지토리를 사용하도록 구성합니다.
    
    Bash
    
    ```
    pip3 config set global.index-url https://aws:$(echo $CODEARTIFACT_AUTH_TOKEN)@my-company-012345678901.d.codeartifact.us-west-2.amazonaws.com/pypi/DemoRepository/
    ```
    
    - **주의:** `pip` 대신 `pip3`을 사용해야 정상적으로 작동합니다.
        
    - URL의 `my-company-012345678901` 부분은 실제 계정 ID와 리전으로 대체해야 합니다.
        

---

## 🚀 3. 패키지 설치 및 캐싱 확인

`pip` 설정이 완료되면, CodeArtifact를 통해 공개 PyPI의 패키지를 설치해 봅니다.

1. **패키지 설치:** `requests` 패키지를 설치해 보세요. 이 패키지는 다른 여러 종속성을 함께 설치합니다.
    
    
    
```Bash
pip3 install requests
```
    
2. **CodeArtifact 콘솔 확인:**
    
    - CodeArtifact 콘솔로 돌아가서 **`DemoRepository`**를 선택하고 **'패키지(Packages)'** 탭을 새로고침합니다.
        
    - `requests`를 포함하여 설치된 모든 종속성 패키지(예: `idna`, `charset-normalizer`, `certifi`)가 리포지토리에 자동으로 추가된 것을 확인할 수 있습니다.
        
    - 이렇게 캐시된 패키지는 나중에 동일한 패키지를 설치할 때 CodeArtifact에서 바로 가져오므로 외부 네트워크 접근이 필요 없고 속도가 빠릅니다.
        

### **다른 버전의 패키지 설치**

이전 버전의 패키지를 설치하여 CodeArtifact가 여러 버전을 관리하는 것을 확인해 볼 수 있습니다.

```Bash
pip3 install requests==2.26.0
```

`DemoRepository`를 다시 확인하면, `requests` 패키지에 **`2.26.0`** 버전이 추가된 것을 볼 수 있습니다.

---

## 🔒 4. 리포지토리 및 도메인 정책

CodeArtifact는 **리포지토리 정책**과 **도메인 정책**을 통해 세밀한 접근 제어를 제공합니다.

- **리포지토리 정책:** 특정 리포지토리에 대한 접근 권한(읽기 전용, 읽기/쓰기 등)을 제어합니다.
    
- **도메인 정책:** 도메인 내 모든 리포지토리에 적용되는 전반적인 접근 권한을 제어합니다.
    
- **교차 계정(Cross-Account) 접근:** 다른 AWS 계정에 권한을 부여할 때 매우 유용합니다.
    

---

## 🗑️ 5. 실습 정리

실습을 마쳤다면, 비용이 발생하지 않도록 생성한 리소스를 정리합니다.

1. `DemoRepository`와 `pypi-store` 리포지토리를 삭제합니다.
    
2. `my-company` 도메인을 삭제합니다.