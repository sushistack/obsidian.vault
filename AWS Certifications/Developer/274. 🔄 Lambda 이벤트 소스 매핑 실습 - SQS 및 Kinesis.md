
이번 아티클에서는 Lambda의 **이벤트 소스 매핑(Event Source Mapping)** 기능을 직접 실습해 보겠습니다. SQS 큐를 활용하여 메시지를 처리하고, Kinesis 스트림의 설정 옵션을 간략하게 살펴보는 과정까지 다룹니다.

---
### 1. 🛠️ Lambda 함수 및 SQS 큐 생성

먼저, 이벤트 소스 매핑을 테스트할 Lambda 함수와 SQS 큐를 생성합니다.

1. **Lambda 함수 생성**: Lambda 콘솔에서 `lambda-SQS`라는 이름의 함수를 생성하고 런타임은 `Python 3.8`을 선택합니다.
    
2. **SQS 큐 생성**: SQS 콘솔에서 **표준 큐(Standard queue)**를 생성하고 이름을 `lambda-demo-SQS`로 지정합니다.

---

### 2. 🔗 Lambda에 SQS 트리거 추가 (이벤트 소스 매핑)

이제 Lambda 함수에 SQS 큐를 이벤트 소스로 연결합니다.

1. `lambda-SQS` 함수 콘솔에서 **'트리거 추가(Add trigger)'**를 클릭합니다.
    
2. **소스 선택**에서 `SQS`를 선택합니다.
    
3. **SQS 큐** 드롭다운에서 `lambda-demo-SQS`를 선택합니다.
    
4. **배치 크기(Batch size)**를 설정합니다. 이는 한 번에 처리할 메시지 수이며, 1부터 10까지 가능합니다.
    
5. `트리거 활성화`를 체크하고 **'추가(Add)'**를 클릭합니다.

이 과정에서 **'실행 역할에 권한이 부족하다'**는 오류가 발생할 수 있습니다. Lambda 함수는 SQS 큐에서 메시지를 읽어오기 위해 IAM 권한이 필요하기 때문입니다.

---

### 3. 🛡️ IAM 권한 설정

Lambda 함수가 SQS 큐를 폴링할 수 있도록 IAM 역할에 권한을 추가해야 합니다.

1. `lambda-SQS` 함수의 **'구성(Configuration)'** 탭으로 이동한 뒤, **'권한(Permissions)'** 섹션에서 **실행 역할(Execution role)** 이름을 클릭합니다.
    
2. IAM 콘솔로 이동하면, '권한 추가(Add permissions)' -> **'정책 연결(Attach policies)'**을 클릭합니다.
    
3. `AWSLambdaSQSQueueExecutionRole` 정책을 검색하여 연결합니다. 이 정책은 Lambda 함수가 SQS 큐에 접근하여 메시지를 읽을 수 있는 최소한의 권한을 부여합니다.
    
4. 다시 Lambda 함수의 트리거 설정 페이지로 돌아가서 **'추가(Add)'**를 클릭하면 정상적으로 트리거가 추가됩니다.

---

### 4. 📝 Lambda 함수 코드 및 메시지 전송 테스트

이제 Lambda 함수가 SQS 메시지를 어떻게 처리하는지 확인합니다.

1. `lambda-SQS` 함수의 코드 편집기에서 다음 코드를 입력하여 이벤트를 로깅하도록 수정합니다.


```Python
import json

def lambda_handler(event, context):
    print("Received SQS event:", json.dumps(event, indent=2))
    return {
        'statusCode': 200,
        'body': json.dumps('Success')
    }
```

2. **'배포(Deploy)'**를 클릭하여 함수를 업데이트합니다.
    
3. SQS 콘솔로 이동하여 `lambda-demo-SQS` 큐를 선택한 후 **'메시지 전송 및 수신(Send and receive messages)'** 탭에서 메시지를 보냅니다.
    
    - **메시지 본문**: `Hello World`
        
    - **메시지 속성**: `foo` = `bar`
    
4. **'메시지 전송(Send message)'**을 클릭합니다.

Lambda의 이벤트 소스 매핑이 메시지를 폴링하여 함수를 호출합니다.

---

### 5. 🔍 결과 확인 및 정리

통합이 성공했는지 확인합니다.

1. Lambda 함수의 **'모니터링(Monitor)'** 탭에서 **'CloudWatch 로그 보기(View logs in CloudWatch)'**를 클릭합니다.
    
2. 로그 스트림을 열어보면, SQS 메시지가 이벤트 페이로드로 전달된 것을 확인할 수 있습니다. 페이로드에는 메시지 본문(`body`)과 속성(`messageAttributes`)이 모두 포함됩니다.
    
3. SQS 콘솔로 돌아와 `lambda-demo-SQS` 큐를 확인하면, Lambda가 메시지를 성공적으로 처리했기 때문에 '사용 가능한 메시지(Messages available)'가 `0`이 된 것을 볼 수 있습니다.

**⚠️ 중요**: SQS 이벤트 소스 매핑은 지속적으로 큐를 폴링하므로, 불필요한 비용이 발생할 수 있습니다. 실습이 끝나면 반드시 Lambda 함수의 **트리거를 비활성화**하거나 삭제해야 합니다.

### 6. 🌐 Kinesis 이벤트 소스 매핑 옵션 (참고)

SQS 외에 또 다른 이벤트 소스 매핑인 **Kinesis**는 더욱 다양한 설정 옵션을 제공합니다.

- **배치 크기(Batch size)**: 한 번에 읽을 레코드 수.
    
- **시작 위치(Starting position)**: 스트림에서 데이터를 읽기 시작할 지점(최신, 가장 오래된, 특정 시간).
    
- **최대 병렬 처리(Maximum concurrency)**: 샤드당 동시에 처리할 수 있는 배치의 수 (최대 10).
    
- **오류 시 배치 분할(Split batch on error)**: Lambda 타임아웃 오류 발생 시 배치를 분할하여 재시도.

이러한 옵션들은 Kinesis 스트림의 특성을 고려하여 처리량, 지연 시간, 순서 보장 등을 정밀하게 제어할 수 있게 합니다.