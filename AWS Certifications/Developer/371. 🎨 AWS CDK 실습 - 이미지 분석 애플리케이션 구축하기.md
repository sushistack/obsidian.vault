
이번 아티클에서는 **AWS CDK(Cloud Development Kit)**를 사용하여 S3, Lambda, Rekognition, DynamoDB로 구성된 **이미지 분석 애플리케이션**을 구축하는 실습 과정을 상세히 알아보겠습니다. 이 실습을 통해 CDK의 강력한 기능을 직접 경험하고, 프로그래밍 언어로 클라우드 인프라를 정의하는 방법을 익힐 수 있습니다.

![[Pasted image 20250911185641.png]]

---

### 1️⃣ 실습 환경 준비 및 CDK 설치

먼저, CDK 애플리케이션 개발에 필요한 환경을 설정합니다.

1. **CloudShell 접속:** AWS 콘솔에서 CloudShell을 실행합니다.
    
2. **CDK 라이브러리 설치:** NPM(Node Package Manager)을 사용하여 CDK CLI와 관련 라이브러리를 설치합니다.

```Bash
sudo npm install -g aws-cdk-lib
```
    
    - `-g` 옵션은 전역 설치를 의미합니다.
        
3. **프로젝트 초기화:** `cdk-app` 디렉토리를 생성하고, `cdk init` 명령어로 CDK 프로젝트를 초기화합니다.

```Bash
mkdir cdk-app
cd cdk-app
cdk init app --language javascript
```
    
    - `app` 템플릿과 `javascript` 언어를 선택하여 기본적인 프로젝트 구조를 생성합니다.

4. **초기화 확인:** `cdk ls` 명령어로 스택 목록을 확인합니다.
```Bash
cdk ls
# CdkAppStack 반환
```

---

### 2️⃣ CDK 스택 및 Lambda 함수 정의

이제 AWS 리소스를 정의하는 CDK 스택(`lib/cdk-app-stack.js`)과 S3 이벤트에 응답할 Lambda 함수 코드를 작성합니다.

#### **CDK 스택 파일(`lib/cdk-app-stack.js`)**

이 파일은 애플리케이션의 핵심 인프라를 정의하는 코드입니다. 다음 작업을 수행합니다.

1. **S3 버킷 생성:**
    
    - `new s3.Bucket(...)`을 사용하여 버킷을 생성합니다.
        
    - `removalPolicy: cdk.RemovalPolicy.DESTROY`를 설정하여 스택이 삭제될 때 버킷도 함께 삭제되도록 합니다.
        
2. **DynamoDB 테이블 생성:**
    
    - `new dynamodb.Table(...)`을 사용하여 테이블을 생성합니다.
        
    - `partitionKey`를 지정하고, 마찬가지로 `removalPolicy`를 `DESTROY`로 설정합니다.
        
3. **Lambda IAM 역할 및 정책 설정:**
    
    - `new iam.Role(...)`로 Lambda 함수에 필요한 IAM 역할을 생성합니다.
        
    - `role.addToPolicy(...)` 메서드를 사용하여 **S3, DynamoDB, Rekognition에 접근할 수 있는 권한을 부여하는 정책을 추가**합니다. 이 방식은 복잡한 IAM 정책 JSON을 직접 작성하는 것보다 훨씬 직관적입니다.
        
4. **Lambda 함수 생성:**
    
    - `new lambda.Function(...)`으로 Lambda 함수를 정의합니다.
        
    - `runtime`, `handler`를 지정하고, `role` 속성으로 위에서 생성한 IAM 역할을 연결합니다.
        
    - `environment` 변수를 설정하여 **Lambda 코드가 DynamoDB 테이블과 S3 버킷의 이름을 참조**할 수 있도록 합니다.
        
5. **S3 이벤트 소스 연결:**
    
    - `lambdaFunction.addEventSource(new s3n.S3EventSource(...))`를 사용하여 S3 버킷에 객체가 생성될 때 Lambda 함수가 트리거되도록 설정합니다.
        
6. **권한 부여:**
    
    - `bucket.grantReadWrite(lambdaFunction)`와 `table.grantReadWriteData(lambdaFunction)`와 같은 메서드를 사용하여 **단 한 줄의 코드로 Lambda 함수에 S3 버킷 및 DynamoDB 테이블에 대한 읽기/쓰기 권한을 부여**합니다.
        

#### **Lambda 함수 파일(`lambda/index.py`)**

1. `cdk-app` 디렉토리로 돌아와 `lambda` 폴더를 생성하고 `index.py` 파일을 작성합니다.
    
```Bash
mkdir lambda
cd lambda
nano index.py
# ... 코드 붙여넣기 ...
```
    
2. 이 Python 코드는 S3 이벤트로부터 이미지 정보를 받아 AWS Rekognition API를 호출하고, 반환된 분석 결과를 DynamoDB 테이블에 저장하는 로직을 포함합니다.
    

---

### 3️⃣ CDK 스택 배포 및 테스트

인프라와 애플리케이션 코드가 준비되었다면, 이제 CDK CLI를 사용하여 AWS에 배포합니다.

1. **CDK 부트스트랩:** 계정/리전당 한 번만 수행하는 초기 설정 과정입니다. `cdk.json` 파일이 있는 최상위 디렉토리에서 실행합니다.
    
```Bash
cd ..
cdk bootstrap
```
    
    - 이 명령은 CDK 배포에 필요한 S3 버킷과 IAM 역할 등을 `CDKToolkit` 스택으로 생성합니다.
        
2. **템플릿 합성(Synthesize):**
    
```Bash
cdk synth
```
    
- 이 명령은 JavaScript 코드를 실행하여 **CloudFormation 템플릿(JSON)**을 생성합니다. 콘솔에 출력되는 거대한 JSON 파일이 바로 CDK가 생성한 최종 결과물입니다.
        
3. **스택 배포:**

```Bash
cdk deploy
```
    
- CDK는 생성된 CloudFormation 템플릿을 CloudFormation 서비스에 제출하여 스택을 배포합니다. 콘솔에서 생성될 리소스 목록을 확인하고 `y`를 눌러 배포를 승인합니다.
        
4. **기능 테스트:**
    
    - 배포가 완료되면, S3 콘솔로 이동하여 생성된 버킷에 `penguins.jpeg`와 같은 이미지를 업로드합니다.
        
    - S3 이벤트가 Lambda 함수를 트리거하고, Lambda 함수가 Rekognition을 통해 이미지를 분석합니다.
        
    - DynamoDB 콘솔로 이동하여 생성된 테이블을 확인하면, 이미지에서 감지된 `penguin`, `man`, `animal` 등의 라벨이 저장된 것을 볼 수 있습니다.
        

---

### 4️⃣ 리소스 정리

실습 후 불필요한 비용 발생을 막기 위해 모든 리소스를 삭제해야 합니다.

1. **S3 버킷 비우기:** `cdk destroy` 명령어는 비어있지 않은 S3 버킷을 삭제할 수 없습니다. 따라서 S3 콘솔에서 버킷의 모든 객체를 먼저 삭제해야 합니다.
    
2. **CDK 스택 삭제:**
    
```Bash
cdk destroy
```
    
- 이 명령은 CloudFormation 스택을 삭제하여 S3 버킷, Lambda 함수, DynamoDB 테이블 등 모든 관련 리소스를 깔끔하게 정리합니다.
        

이 실습을 통해 CDK가 **복잡한 클라우드 인프라를 프로그래밍 방식으로 얼마나 효율적이고 유연하게 관리할 수 있는지**를 직접 경험할 수 있습니다.