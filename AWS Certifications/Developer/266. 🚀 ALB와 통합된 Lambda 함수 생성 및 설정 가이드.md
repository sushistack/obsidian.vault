
안녕하세요! 이번 아티클에서는 **Application Load Balancer(ALB)와 통합하여 작동하는 Lambda 함수를 직접 만들고 설정하는 과정**을 상세하게 설명합니다.

### 1. 🛠️ Lambda 함수 생성

가장 먼저 ALB의 요청을 처리할 Lambda 함수를 생성합니다.

1. AWS Lambda 콘솔로 이동하여 '함수 생성(Create function)'을 클릭합니다.
    
2. **함수 이름**을 `Lambda-alb`로 지정합니다.
    
3. **런타임**은 `Python 3.x`를 선택합니다.
    
4. '함수 생성(Create function)' 버튼을 클릭하여 함수를 만듭니다.
    

기본적으로 생성된 코드는 간단한 JSON을 반환합니다. 이를 배포하고 테스트 이벤트를 통해 정상 작동하는지 확인합니다.

```Python
import json

def lambda_handler(event, context):
    print(event) # ALB에서 전달된 이벤트 확인용
    return {
        'statusCode': 200,
        'body': json.dumps('Hello from Lambda!')
    }
```

이 코드를 배포(Deploy)한 후, 테스트 이벤트를 생성하여 `200` 상태 코드와 "Hello from Lambda!" 응답이 정상적으로 출력되는지 확인합니다. 이 단계는 Lambda 함수가 정상적으로 작동하는지 확인하는 중요한 과정입니다.

---

### 2. 🌐 Application Load Balancer(ALB) 및 대상 그룹(Target Group) 생성

다음으로, 클라이언트의 HTTP 요청을 Lambda 함수로 라우팅할 ALB를 생성합니다.

1. EC2 콘솔에서 '로드 밸런서(Load Balancers)'로 이동한 후 '로드 밸런서 생성(Create Load Balancer)'을 클릭합니다.
    
2. **Application Load Balancer**를 선택하고 이름을 `demo-Lambda-alb`로 지정합니다.
    
3. **네트워크 매핑**에서 3개의 가용 영역(Availability Zone)을 선택합니다.
    
4. **보안 그룹**을 새로 생성합니다.
    
    - 보안 그룹 이름: `DemoLambdaALBSG`
        
    - 인바운드 규칙: HTTP(포트 80)를 소스 `Anywhere-IPv4`로 허용합니다.
        
5. **리스너 및 라우팅** 설정에서 다음과 같이 `대상 그룹`을 생성합니다.
    
    - **대상 유형**으로 **`Lambda 함수(Lambda function)`**를 선택합니다.
        
    - 대상 그룹 이름은 `demo-tg-lambda`로 지정합니다.
        
    - 생성한 `Lambda-alb` 함수를 선택하고 '대상 그룹 생성'을 클릭합니다.
        

이제 로드 밸런서로 돌아와 리스너의 기본 동작(Default action)을 방금 생성한 `demo-tg-lambda`로 설정하고 로드 밸런서를 생성합니다.

---

### 3. ✅ Lambda 함수와 ALB 간의 올바른 응답 형식 설정

Lambda 함수가 ALB에 올바른 HTTP 응답을 반환하려면 특정 형식의 JSON 객체를 반환해야 합니다. 기본 코드로는 웹 브라우저에서 '파일 다운로드'를 유도하는 응답이 발생할 수 있습니다. 이를 해결하기 위해 Lambda 함수 코드를 아래와 같이 수정해야 합니다.

```Python
import json

def lambda_handler(event, context):
    print(event)
    return {
        'statusCode': 200,
        'statusDescription': '200 OK',
        'headers': {
            'Content-Type': 'text/html'
        },
        'body': '<h1>Hello from Lambda!</h1>',
        'isBase64Encoded': False
    }
```

**✅ 주요 변경 사항**

- `statusCode`: HTTP 상태 코드를 반환합니다. (예: `200`)
    
- `statusDescription`: 상태 코드에 대한 설명을 추가합니다. (예: '200 OK')
    
- `headers`: `Content-Type`을 `text/html`로 설정하여 브라우저가 HTML로 렌더링하도록 합니다.
    
- `body`: HTML 내용을 직접 문자열로 반환합니다.
    
- `isBase64Encoded`: 본문이 Base64로 인코딩되지 않았음을 명시합니다.
    

이 코드를 배포한 후, ALB의 DNS 이름을 웹 브라우저에 입력하면 "Hello from Lambda!"라는 HTML 제목이 정상적으로 표시되는 것을 확인할 수 있습니다.

---

### 4. 🔍 ALB가 Lambda로 전달하는 이벤트 확인

Lambda 함수의 CloudWatch 로그를 보면 ALB가 Lambda 함수를 호출할 때 어떤 이벤트 페이로드를 전달하는지 확인할 수 있습니다.

1. Lambda 함수 콘솔에서 '모니터링(Monitor)' 탭을 클릭합니다.
    
2. `CloudWatch Logs` 섹션에서 '최근 호출 보기(View recent invocations)'를 클릭하여 로그 스트림으로 이동합니다.
    
3. 가장 최근의 로그를 열어보면, ALB가 전달한 JSON 이벤트 페이로드를 확인할 수 있습니다. 이 페이로드에는 `httpMethod`, `path`, `headers`, `queryStringParameters` 등 HTTP 요청에 대한 모든 정보가 담겨 있습니다.
    

이 정보를 통해 Lambda 함수는 ALB를 통해 들어온 요청의 상세 내용을 파싱하여 동적으로 응답을 생성할 수 있습니다.

### 5. ⚙️ ALB의 다중 값 헤더(Multi-Value Headers) 기능

ALB의 대상 그룹 설정에는 **'다중 값 헤더(Multi-Value Headers)'** 기능이 있습니다. 이 기능을 활성화하면 동일한 키를 가진 여러 HTTP 헤더나 쿼리 스트링 매개변수를 Lambda에 배열 형태로 전달합니다.

- **설정 위치**: 대상 그룹의 '속성(Attributes)' 탭에서 활성화할 수 있습니다.
    
- **사용 이유**: URL 쿼리 스트링에 `name=foo&name=bar`와 같이 동일한 키가 여러 번 사용될 경우, 데이터 손실 없이 모든 값을 Lambda 함수에 전달할 수 있습니다.
    

---

### 6. 🛡️ Lambda 함수 권한 확인

ALB가 Lambda 함수를 호출하려면 Lambda 함수의 **리소스 기반 정책**에 ALB의 `lambda:InvokeFunction` 권한이 허용되어야 합니다. 이 권한은 ALB에 대상 그룹을 등록할 때 자동으로 추가됩니다.

- **확인 위치**: Lambda 함수 콘솔의 '구성(Configuration)' 탭에서 '권한(Permissions)'을 클릭하면 확인할 수 있습니다.
    
- **역할**: 이 정책은 ALB가 해당 Lambda 함수를 호출할 수 있도록 허용하는 역할을 합니다.
    

이러한 설정 과정을 통해 ALB와 Lambda 함수를 완벽하게 통합하여 HTTP 요청을 처리하는 서버리스 애플리케이션을 구축할 수 있습니다. 실습 후에는 불필요한 비용 발생을 막기 위해 생성한 ALB와 Lambda 함수를 삭제하는 것이 좋습니다.