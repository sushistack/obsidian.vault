Amazon ECS(Elastic Container Service) 환경에서 X-Ray를 사용하려면 **X-Ray 데몬**을 컨테이너로 실행해야 해요. ECS 클러스터의 유형(EC2 또는 Fargate)에 따라 데몬을 실행하는 방식이 달라지는데, 크게 세 가지 패턴이 있어요.

![[Pasted image 20250824211401.png]]

---

## 1. 데몬 컨테이너 패턴 (ECS on EC2)

이 패턴은 **ECS on EC2**에서만 사용할 수 있어요. EC2 인스턴스를 직접 관리하기 때문에, 각 인스턴스에 하나의 X-Ray 데몬 컨테이너를 실행하도록 설정해요.

- **동작 방식**: 각 **EC2 인스턴스**에 X-Ray 데몬 컨테이너를 1개씩 실행해요.

- **장점**: EC2 인스턴스당 데몬이 1개만 실행되므로, 데몬 컨테이너의 수가 적고 리소스 효율이 좋아요.

- **설정**: ECS의 데몬 서비스(Daemon Service) 기능을 사용해서, 클러스터의 모든 EC2 인스턴스에 데몬 컨테이너가 자동으로 배포되도록 설정할 수 있어요.

---

## 2. 사이드카 패턴 (Sidecar Pattern)

이 패턴은 **ECS on EC2**와 **AWS Fargate** 모두에서 사용할 수 있는 범용적인 방법이에요.

- **동작 방식**: 애플리케이션 컨테이너와 X-Ray 데몬 컨테이너를 하나의 **태스크(Task)**로 묶어 함께 실행해요. 마치 애플리케이션 컨테이너에 X-Ray 데몬 컨테이너가 '사이드카'처럼 따라붙는다고 생각하면 돼요.

- **장점**: Fargate처럼 기반 EC2 인스턴스를 제어할 수 없는 환경에서도 X-Ray를 사용할 수 있어요. 각 애플리케이션 태스크에 전용 데몬이 있으므로 격리성이 좋아요.

- **단점**: 애플리케이션 컨테이너가 많아질수록 X-Ray 데몬 컨테이너의 수도 함께 늘어나 리소스 사용량이 많아질 수 있어요.

|패턴|적용 환경|데몬 수|
|---|---|---|
|**데몬 컨테이너**|ECS on EC2|EC2 인스턴스당 1개|
|**사이드카**|ECS on EC2, Fargate|애플리케이션 컨테이너당 1개|

---

## 3. Fargate 클러스터 통합 (Fargate Cluster Integration)

AWS Fargate는 사용자가 EC2 인스턴스를 관리하지 않기 때문에, X-Ray 데몬 컨테이너 패턴을 사용할 수 없어요. 따라서 Fargate 환경에서는 **반드시 사이드카 패턴**으로 X-Ray 데몬을 실행해야 해요.

---

## ⚙️ ECS 태스크 정의 (Task Definition) 설정

X-Ray 사이드카 패턴을 사용하기 위한 ECS 태스크 정의는 다음과 같은 주요 설정을 포함해요.

### 1. X-Ray 데몬 컨테이너 설정

X-Ray 데몬 컨테이너는 포트 `2000`의 **UDP** 프로토콜로 트레이스 데이터를 수신하도록 설정돼요.

```JSON
{
  "name": "xray-daemon",
  "image": "amazon/aws-xray-daemon",
  "portMappings": [
    {
      "containerPort": 2000,
      "hostPort": 2000,
      "protocol": "udp"
    }
  ]
}
```

### 2. 애플리케이션 컨테이너 설정

애플리케이션은 X-Ray SDK를 통해 트레이스 데이터를 데몬으로 보내야 해요. 이를 위해 데몬의 주소를 환경 변수로 지정해 줘야 해요.

```JSON
{
  "name": "your-app",
  "image": "your-app-image",
  "environment": [
    {
      "name": "AWS_XRAY_DAEMON_ADDRESS",
      "value": "xray-daemon:2000"
    }
  ],
  "links": [
    "xray-daemon"
  ]
}
```

- **`AWS_XRAY_DAEMON_ADDRESS`**: 애플리케이션의 X-Ray SDK가 트레이스 데이터를 보낼 데몬의 주소를 지정하는 환경 변수예요.

- **`links`**: 두 컨테이너가 서로 통신할 수 있도록 연결(linking)을 설정해요. 이를 통해 `xray-daemon`이라는 호스트 이름으로 데몬 컨테이너에 접근할 수 있어요.


이렇게 설정하면 애플리케이션 컨테이너가 `xray-daemon:2000` 주소를 통해 같은 태스크에 있는 X-Ray 데몬 컨테이너로 트레이스 데이터를 보낼 수 있어요.