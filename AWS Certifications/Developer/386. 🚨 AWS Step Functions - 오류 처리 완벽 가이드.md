
AWS Step Functions의 진정한 강점은 **오류 처리 메커니즘**에 있습니다. Step Functions는 워크플로우를 구성하는 각 작업(Task)의 오류를 워크플로우 수준에서 처리함으로써, 개별 애플리케이션 코드를 단순화하고 전체 시스템의 안정성을 높입니다.

---

## 1. 🔍 오류 처리의 필요성 및 유형

Step Functions에서 오류는 다양한 상황에서 발생할 수 있습니다.

- **정의 오류**: 상태 머신 정의가 잘못된 경우 (예: Choice 상태에 일치하는 규칙이 없는 경우).
    
- **작업 실패**: Lambda 함수에서 예외가 발생하거나, ECS 작업이 실패하는 경우.
    
- **일시적인 오류**: 네트워크 문제와 같이 간헐적으로 발생하는 오류.

이러한 오류를 워크플로우 내에서 처리하기 위해 Step Functions는 **Retry(재시도)**와 **Catch(포착)**라는 두 가지 메커니즘을 제공합니다.

---

## 2. 🔄 Retry: 재시도 메커니즘

**Retry**는 일시적인 오류에 대비하여 특정 작업을 여러 번 재시도하는 로직을 정의합니다. `Task` 또는 `Parallel` 상태에서 사용할 수 있으며, JSON으로 정의합니다.

### Retry 블록의 주요 필드

|필드|설명|
|---|---|
|**`ErrorEquals`**|재시도할 오류의 이름을 지정합니다. `States.All`, `States.Timeout`, `TaskFailed`와 같은 내장 오류 코드 또는 커스텀 오류 이름을 사용할 수 있습니다.|
|**`IntervalSeconds`**|첫 번째 재시도까지 대기할 시간을 초 단위로 지정합니다.|
|**`BackoffRate`**|재시도 간 대기 시간을 곱할 비율입니다. **지수 백오프(Exponential Backoff)**를 구현하는 데 사용됩니다.|
|**`MaxAttempts`**|재시도할 최대 횟수입니다. 이 횟수를 모두 소진하면 `Catch` 블록으로 이동합니다.|

예시:

아래 코드는 Lambda 함수 실행 중 CustomError 또는 TaskFailed 오류가 발생하면 지정된 조건에 따라 재시도하는 로직을 보여줍니다.

```JSON
{
  "Type": "Task",
  "Resource": "arn:aws:states:::lambda:invoke",
  "Retry": [
    {
      "ErrorEquals": ["CustomError"],
      "IntervalSeconds": 1,
      "BackoffRate": 2,
      "MaxAttempts": 2
    },
    {
      "ErrorEquals": ["TaskFailed"],
      "IntervalSeconds": 30,
      "BackoffRate": 2,
      "MaxAttempts": 5
    }
  ],
  "Next": "NextState"
}
```

이러한 재시도 로직을 Step Functions에 정의하면, Lambda 함수 코드는 오류가 발생했을 때 단순히 예외를 던지기만 하면 되므로 훨씬 간결해집니다.

---

## 3. 🎯 Catch: 실패 경로 지정

**Catch**는 `Retry`로 모든 재시도가 실패했거나, 즉시 다른 오류 처리 흐름으로 전환해야 할 때 사용됩니다. 오류를 **포착(catch)**하여 워크플로우의 다른 상태로 이동시킵니다.

### Catch 블록의 주요 필드

|필드|설명|
|---|---|
|**`ErrorEquals`**|포착할 오류의 이름입니다. `Retry`와 동일하게 여러 오류 코드를 지정할 수 있습니다.|
|**`Next`**|오류 발생 시 이동할 다음 상태의 이름입니다. 오류 처리 로직을 담당하는 상태로 이동시킬 수 있습니다.|
|**`ResultPath`**|오류 정보를 입력 데이터에 추가할 경로를 지정합니다. 기본적으로 오류로 인해 입력 데이터가 덮어씌워지므로, `ResultPath`를 사용해 오류 정보를 보존해야 합니다.|

예시:

아래 코드는 CustomError가 발생하면 CustomErrorFallback 상태로 이동하는 Catch 블록을 보여줍니다.

```JSON
{
  "Type": "Task",
  "Resource": "arn:aws:states:::lambda:invoke",
  "Catch": [
    {
      "ErrorEquals": ["CustomError"],
      "Next": "CustomErrorFallback"
    },
    {
      "ErrorEquals": ["States.All"],
      "Next": "GlobalErrorFallback"
    }
  ],
  "Next": "NextState"
}
```

### ResultPath의 중요성

`ResultPath`는 오류가 발생했을 때 오류 메시지를 입력 데이터와 함께 다음 상태로 전달하는 역할을 합니다. 예를 들어, `ResultPath`를 `$.error`로 설정하면, 다음 상태의 입력 페이로드에 기존 입력 데이터와 함께 오류 정보가 포함됩니다.

```JSON
{
  "Comment": "ResultPath example",
  "StartAt": "TaskState",
  "States": {
    "TaskState": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Catch": [
        {
          "ErrorEquals": ["States.All"],
          "ResultPath": "$.error",
          "Next": "AnalyzeError"
        }
      ]
    },
    "AnalyzeError": {
      "Type": "Task",
      "Resource": "...",
      "End": true
    }
  }
}
```

`TaskState`에 `"foo": "bar"`라는 입력이 들어오고 오류가 발생하면, `AnalyzeError` 상태는 다음과 같은 페이로드를 받습니다.

```JSON
  "foo": "bar",
  "error": {
    "Error": "...",
    "Cause": "..."
  }
}
```

이처럼 Step Functions는 복잡한 오류 처리 로직을 워크플로우 정의 파일에 담아, 애플리케이션 코드의 복잡성을 줄이고 가시성을 높이는 강력한 기능을 제공합니다.