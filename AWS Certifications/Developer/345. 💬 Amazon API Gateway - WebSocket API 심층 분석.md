
이번 가이드에서는 Amazon API Gateway의 **WebSocket API**에 대해 상세히 알아보겠습니다. WebSocket API는 RESTful API와 달리, 서버와 클라이언트 간의 **양방향 통신**을 가능하게 하여 실시간 애플리케이션을 구축하는 데 필수적인 기술입니다.

---

## 🔄 1단계: WebSocket의 기본 원리 - 양방향 통신

**WebSocket**은 클라이언트(예: 웹 브라우저)와 서버 간에 단 한 번의 연결(handshake)을 통해 **지속적인 연결(Persistent Connection)**을 수립합니다. 이 연결이 유지되는 동안, 서버는 클라이언트의 요청 없이도 데이터를 클라이언트로 **푸시(Push)**할 수 있습니다.

### 💡 주요 특징

- **양방향(Two-way)**: 클라이언트와 서버 모두 상대방에게 언제든지 메시지를 보낼 수 있습니다.
    
- **상태 유지(Stateful)**: 한 번 연결되면 상태가 유지되므로, 매번 새로운 연결을 수립할 필요가 없습니다.
    
- **실시간 애플리케이션**: 채팅 애플리케이션, 협업 플랫폼, 멀티플레이어 게임, 금융 거래 플랫폼 등 실시간 상호작용이 중요한 애플리케이션에 적합합니다.

---

## 🔗 2단계: WebSocket API의 연결 및 메시지 흐름

![[Pasted image 20250907195635.png]]

WebSocket API는 REST API와 달리, 연결 생명주기(Connect, Send, Disconnect)에 따라 다른 백엔드 로직을 호출합니다.

### 1. **연결(Connection)**

- **`onConnect`**: 클라이언트가 `wss://`로 시작하는 WebSocket URL에 접근하면, API Gateway는 **`onConnect`** 라우트를 호출합니다.
    
- **작동**: 이 라우트에 연결된 Lambda 함수가 호출되며, API Gateway는 이 연결에 대한 고유한 **연결 ID(Connection ID)**를 생성하여 Lambda 함수에 전달합니다. 개발자는 이 연결 ID를 DynamoDB와 같은 데이터베이스에 저장하여 연결 상태를 관리할 수 있습니다.

### 2. **메시지 전송(Sending Messages)**

- **`sendMessage`**: 클라이언트가 연결된 상태에서 서버로 데이터를 보내면, API Gateway는 정의된 **라우팅 규칙**에 따라 해당 메시지를 처리합니다.
    
- **작동**: 메시지 전송 시에도 동일한 **연결 ID**가 유지되며, 백엔드 Lambda 함수는 이 ID를 사용하여 특정 사용자에 대한 정보를 조회하거나 메시지를 처리할 수 있습니다.

### 3. **연결 종료(Disconnection)**

- **`onDisconnect`**: 클라이언트가 연결을 끊으면, API Gateway는 **`onDisconnect`** 라우트를 호출합니다.
    
- **작동**: 이 라우트에 연결된 Lambda 함수가 호출되어, 데이터베이스에서 연결 ID를 삭제하는 등의 정리 작업을 수행할 수 있습니다.

---

## 📤 3단계: 서버에서 클라이언트로 데이터 전송하기

![[Pasted image 20250907195621.png]]

WebSocket의 핵심 기능인 서버 푸시(Server Push)는 API Gateway의 특별한 **연결 콜백 URL**을 통해 구현됩니다.

### 📝 작동 원리

1. **연결 콜백 URL**: API Gateway는 `https://.../connections/connectionId` 형식의 고유한 콜백 URL을 제공합니다.
    
2. **푸시 요청**: 백엔드(예: Lambda 함수)는 이 URL에 **IAM SigV4로 서명된 `POST` 요청**을 보냅니다.
    
3. **메시지 전송**: 이 요청이 API Gateway에 도달하면, API Gateway는 요청 바디에 포함된 데이터를 해당 **`connectionId`**를 가진 클라이언트에게 실시간으로 전송합니다.

### ➡️ 기타 연결 관리 작업

- **`GET /connections/{connectionId}`**: 특정 클라이언트의 연결 상태를 확인합니다.
    
- **`DELETE /connections/{connectionId}`**: 서버에서 클라이언트와의 WebSocket 연결을 강제로 끊습니다.

---

## 🗺️ 4단계: WebSocket API 라우팅

![[Pasted image 20250907195656.png]]

WebSocket API는 들어오는 메시지의 내용에 따라 다른 백엔드로 요청을 전달하는 **라우팅(Routing)** 기능을 사용합니다.

### 🔑 라우팅 규칙

1. **라우팅 키(Route Key)**: 들어오는 메시지(JSON 프레임)의 특정 필드(예: `action`)를 라우팅 키로 설정합니다.
    
2. **라우팅 테이블**: API Gateway에 `connect`, `disconnect`, `default`와 같은 필수 라우트와 함께 `join`, `sendMessage`와 같은 사용자 정의 라우트를 정의합니다.
    
3. **라우팅 표현식(Route Selection Expression)**: `$request.body.action`과 같은 표현식을 사용하여 메시지 바디에서 라우팅 키를 추출합니다.

### 📝 라우팅 예시

클라이언트가 다음과 같은 JSON 메시지를 보냈다고 가정해 봅시다.

```JSON
{
  "action": "join",
  "data": { "room": "room123" }
}
```

API Gateway가 `$request.body.action`을 라우팅 표현식으로 사용하면, `"join"`이라는 값이 추출됩니다. 이 값은 라우팅 테이블에서 `join` 라우트와 일치하며, API Gateway는 `join` 라우트에 연결된 Lambda 함수를 호출하게 됩니다. 일치하는 라우트가 없으면 **`default`** 라우트로 요청이 전달됩니다.

**시험 관점 요약**: WebSocket API는 **양방향 통신**을 위한 것이며, 클라이언트와 서버가 한 번의 연결을 통해 지속적으로 통신합니다. 메시지는 **라우팅 규칙**에 따라 특정 백엔드로 전달됩니다.