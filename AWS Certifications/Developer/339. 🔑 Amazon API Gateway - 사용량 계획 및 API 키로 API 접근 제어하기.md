
이번 가이드에서는 Amazon API Gateway의 **사용량 계획(Usage Plans)**과 **API 키(API Keys)**를 사용하여 API 접근을 제어하고, 사용량을 모니터링하며, 수익 모델을 구축하는 방법을 상세히 알아보겠습니다. 이 두 가지 기능을 통해 API를 고객에게 안전하고 효율적으로 제공할 수 있습니다.

---

## 🔐 1단계: 사용량 계획과 API 키의 역할

**사용량 계획**과 **API 키**는 함께 작동하여 API 접근에 대한 포괄적인 제어 기능을 제공합니다.

- **API 키**: 고객에게 배포하는 고유한 식별자 문자열입니다. 클라이언트는 이 키를 `x-api-key` 헤더에 담아 요청을 보내 자신의 신원을 인증합니다.
    
- **사용량 계획**: 하나 이상의 API 스테이지 및 메서드에 대해 **스로틀링(Throttling)** 및 **할당량(Quota)** 제한을 정의합니다. 또한, 이 계획은 어떤 API 키가 해당 제한을 적용받는지 지정합니다.

### 📈 주요 제어 기능

- **스로틀링(Throttling)**: API에 대한 초당 요청 속도(Rate) 및 최대 버스트(Burst) 요청 수를 제한하여 API가 과도한 트래픽으로 인해 마비되는 것을 방지합니다. 이 제한은 각 API 키에 개별적으로 적용됩니다.
    
- **할당량(Quota)**: 특정 기간(예: 월별) 동안 API 키가 사용할 수 있는 최대 요청 수를 정의합니다. 이 할당량을 초과하면 추가적인 요청은 거부됩니다.

---

## ⚙️ 2단계: 사용량 계획 및 API 키 설정 순서

사용량 계획과 API 키를 올바르게 연동하려면 다음 순서로 작업을 진행해야 합니다. 이 순서를 따르지 않으면 연동이 제대로 작동하지 않을 수 있습니다.

|순서|작업 내용|상세 설명|
|---|---|---|
|**1**|**API 메서드 설정**|사용량 계획을 적용할 **API 메서드**(`GET`, `POST` 등)를 선택하고, **API 키 필요(API Key Required)** 옵션을 **활성화**합니다.|
|**2**|**API 배포**|변경된 API를 원하는 스테이지(예: `dev`, `prod`)에 **배포**합니다. 이 단계가 누락되면 API 키가 적용되지 않습니다.|
|**3**|**API 키 생성**|**API 키(API Keys)** 메뉴에서 `새 API 키 생성(Create new API Key)`을 선택하여 API 키를 생성합니다. 생성된 키는 고객에게 배포됩니다.|
|**4**|**사용량 계획 생성**|**사용량 계획(Usage Plans)** 메뉴에서 새로운 계획을 생성하고, 원하는 **스로틀링** 및 **할당량** 제한을 설정합니다.|
|**5**|**사용량 계획 연결**|생성한 **사용량 계획**에 API **스테이지**와 **API 키**를 **연결(Associate)**합니다. 이 단계가 완료되어야 API 키가 해당 계획의 제한을 적용받게 됩니다.|

---

## 🔑 3단계: 클라이언트의 API 호출

위의 모든 설정이 완료되면, 고객은 자신의 애플리케이션에서 API를 호출할 때 `x-api-key` 헤더에 할당받은 API 키를 포함해야 합니다.

- **요청 예시**:

```
GET /my-resource HTTP/1.1
Host: your-api-id.execute-api.region.amazonaws.com
x-api-key: a1b2c3d4e5f6g7h8i9j0
```

- **인증 및 제어**: API Gateway는 이 헤더의 키를 확인하고, 해당 키가 연결된 사용량 계획의 스로틀링 및 할당량 제한을 초과했는지 검사합니다.
    
- **응답**:
    
    - **유효한 키**: 요청이 허용됩니다.
        
    - **무효한 키**: `403 Forbidden` 또는 `Missing Authentication Token` 오류가 반환됩니다.
        
    - **제한 초과**: `429 Too Many Requests` 오류가 반환됩니다.
        

사용량 계획과 API 키를 활용하면 API 제공자는 고객의 사용량을 정확히 파악하고, 비즈니스 모델에 맞는 과금 정책을 유연하게 적용할 수 있습니다.