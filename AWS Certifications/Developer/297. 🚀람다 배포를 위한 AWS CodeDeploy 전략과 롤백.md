
AWS 람다(Lambda)는 서버리스 애플리케이션의 핵심 구성 요소입니다. 람다 함수를 운영 환경에 배포할 때, 새로운 버전을 한 번에 모두 적용하는 것은 위험할 수 있습니다. 이때 **AWS CodeDeploy**를 사용하면 람다 별칭(Alias)에 대한 트래픽 이동을 자동화하여 안전하고 점진적으로 배포할 수 있습니다. 이 아티클은 CodeDeploy의 주요 배포 전략과 롤백 메커니즘에 대해 상세히 설명합니다.

---

## 🚀 람다 배포의 기본: 버전과 별칭

람다 함수를 배포할 때는 **버전(Version)**과 **별칭(Alias)**이라는 개념을 사용합니다.

- **버전(Version):** 람다 함수 코드를 변경할 때마다 생성되는 불변(Immutable)의 스냅샷입니다.
    
- **별칭(Alias):** 특정 버전 또는 여러 버전을 가리키는 포인터 역할을 합니다. 운영 환경에서는 별칭을 사용해 트래픽을 관리합니다. 예를 들어, `PROD` 별칭이 `v1` 버전을 가리키도록 설정할 수 있습니다.

새로운 기능이 추가된 `v2` 버전을 배포할 때, `PROD` 별칭의 트래픽을 `v1`에서 `v2`로 옮기는 작업이 필요합니다. CodeDeploy는 이 트래픽 전환 과정을 자동화하고 통제합니다.

---

## 📈 AWS CodeDeploy의 배포 전략

![[Pasted image 20250902222833.png]]

CodeDeploy는 안전한 배포를 위해 다양한 트래픽 전환 전략을 제공합니다. 이는 크게 세 가지로 분류할 수 있습니다.

### 1. **선형 (Linear) 배포**

선형 배포는 지정된 시간 간격으로 트래픽을 일정 비율씩 증가시키는 방식입니다. 이 전략은 신규 버전에 대한 트래픽 증가를 천천히 모니터링하면서 진행하기 때문에 안정성을 높일 수 있습니다.

- **Linear10PercentEvery3Minutes:** 3분마다 트래픽을 10%씩 증가시킵니다.
    
    - **예시:** `v1`에 100% 트래픽이 있을 때, 배포 시작 후 3분이 지나면 `v2`에 10%의 트래픽을 할당하고, 90%는 `v1`에 유지합니다. 다음 3분이 지나면 `v2`의 트래픽은 20%로 늘어나고, `v1`은 80%가 됩니다. 이 과정을 `v2`가 100%를 차지할 때까지 반복합니다.
        
- **Linear10PercentEvery10Minutes:** 10분마다 트래픽을 10%씩 증가시킵니다.
    

### 2. **카나리 (Canary) 배포**

카나리 배포는 먼저 소수의 사용자에게만 신규 버전을 노출한 후, 문제가 없다고 판단되면 한 번에 모든 트래픽을 전환하는 방식입니다. 신규 버전에 대한 초기 피드백을 빠르게 얻을 수 있어 위험을 최소화할 수 있습니다.

- **Canary10Percent5Minutes:** 5분 동안 트래픽의 10%만 `v2`로 전환합니다.
    
    - **예시:** 배포 시작 후 5분 동안 `v2`에 10%의 트래픽이 할당되고, 나머지 90%는 `v1`에 유지됩니다. 이 5분 동안 이상이 없다고 판단되면, 즉시 `v2`로 트래픽을 100% 전환합니다.
        
- **Canary10PercentEvery30Minutes:** 30분 동안 10%의 트래픽을 `v2`로 전환한 후, 나머지 트래픽을 한 번에 전환합니다.

### 3. **즉시 (AllAtOnce) 배포**

이 전략은 트래픽을 한 번에 100% 전환하는 가장 빠르고 단순한 방식입니다. 개발 환경이나 충분히 테스트된 함수에 적합하지만, 문제가 발생하면 모든 사용자에게 영향을 미칠 수 있어 위험도가 높습니다.

---

## 🔄 롤백 (Rollback) 메커니즘

CodeDeploy는 배포 과정에서 문제가 발생했을 때 자동으로 이전 버전으로 되돌리는 **롤백** 기능을 제공합니다. 이 기능은 `사전(Pre)` 및 `사후(Post)` 트래픽 후크(Hooks)를 사용하여 구현됩니다.

### **트래픽 후크(Hooks)와 CloudWatch 알람**

- **사전 트래픽 후크 (Pre-traffic Hooks):** 트래픽을 전환하기 전에 실행되는 람다 함수입니다. 예를 들어, 신규 버전의 람다 함수를 호출하여 기본 동작을 테스트할 수 있습니다.
    
- **사후 트래픽 후크 (Post-traffic Hooks):** 트래픽이 성공적으로 전환된 후에 실행되는 람다 함수입니다. 예를 들어, 신규 버전의 성능 및 건강 상태를 확인하는 코드를 실행할 수 있습니다.
    

만약 트래픽 후크가 실패하거나, 설정된 **Amazon CloudWatch 알람**이 배포 도중 문제가 발생했다고 감지하면 CodeDeploy는 배포를 중단하고 자동으로 롤백을 시작합니다. 롤백이 진행되면 `v2`로 이동했던 트래픽은 다시 `v1`으로 100% 되돌려집니다.

---

## 🛠️ SAM(Serverless Application Model)과의 연동

AWS SAM 프레임워크는 CodeDeploy와 통합되어 있어 YAML 파일을 통해 배포 전략을 손쉽게 정의할 수 있습니다. SAM 템플릿의 `Resources` 섹션에 `AWS::Serverless::Function`을 정의할 때 `AutoPublishAlias` 및 `DeploymentPreference` 속성을 추가하여 CodeDeploy를 활성화할 수 있습니다.

```YAML
Resources:
  MyLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: my-function-code/
      Handler: app.handler
      Runtime: nodejs16.x
      AutoPublishAlias: Live
      DeploymentPreference:
        Type: Canary10Percent5Minutes
        Alarms:
          - !Ref MyCloudWatchAlarm
        Hooks:
          PreTraffic: !Ref PreTrafficHookFunction
          PostTraffic: !Ref PostTrafficHookFunction
```

이 코드는 `Live`라는 별칭을 자동으로 생성하고, **카나리10% 5분** 배포 전략을 적용합니다. 배포 중 `MyCloudWatchAlarm` 알람을 모니터링하며, 사전/사후 트래픽 후크로 `PreTrafficHookFunction` 및 `PostTrafficHookFunction`을 사용하도록 설정합니다.

---

## 📝 AppSpec.yml 주요 파라미터

CodeDeploy를 직접 사용할 경우, `AppSpec.yml` 파일을 통해 배포 설정을 정의합니다. 람다 배포를 위한 주요 파라미터는 다음과 같습니다.

|파라미터|설명|
|---|---|
|**Name**|배포할 람다 함수의 이름.|
|**Alias**|트래픽을 전환할 람다 별칭의 이름. **(필수)**|
|**CurrentVersion**|현재 트래픽을 처리 중인 람다 버전.|
|**TargetVersion**|트래픽을 이동시킬 목표 람다 버전.|

CodeDeploy는 `CurrentVersion`에서 `TargetVersion`으로 지정된 배포 전략에 따라 별칭의 트래픽을 점진적으로 업데이트합니다. 이러한 통합을 통해 람다 배포의 안정성과 신뢰성을 크게 향상시킬 수 있습니다.