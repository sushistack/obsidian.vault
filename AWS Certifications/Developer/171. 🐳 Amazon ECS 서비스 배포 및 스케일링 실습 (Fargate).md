

이번 실습에서는 Amazon ECS 클러스터에 Docker 컨테이너를 배포하고, **Fargate**를 사용하여 서비스를 스케일링하는 과정을 단계별로 진행해 보겠습니다. 이 실습을 통해 ECS 태스크 정의부터 로드 밸런서 연동까지 전체적인 서비스 배포 흐름을 이해할 수 있습니다.

---

### 1. ECS 태스크 정의 생성 📝

**태스크 정의(Task Definition)**는 컨테이너의 실행 환경을 정의하는 청사진입니다. 어떤 Docker 이미지를 사용할지, 얼마나 많은 CPU와 메모리가 필요한지 등을 명시합니다.

1. **ECS 콘솔**에서 `태스크 정의(Task Definitions)` > `새 태스크 정의 생성(Create new task definition)`을 선택합니다.
2. **태스크 정의 이름:** `nginxdemos-hello`
3. **인프라:** `AWS Fargate`를 선택합니다.
4. **운영 체제:** `Linux`
5. **태스크 크기:** `vCPU: 0.5`, `메모리: 1GB` (프리티어)
6. **컨테이너 정의:**
    - **이름:** `nginxdemos-hello`
    - **이미지 URL:** `nginxdemos/hello` (Docker Hub에 있는 공개 이미지)
    - **포트 매핑:** `컨테이너 포트: 80`, `프로토콜: TCP`
7. `생성(Create)`을 클릭하여 태스크 정의를 만듭니다.

---

### 2. ECS 서비스 생성 및 배포 🚀

이제 생성한 태스크 정의를 바탕으로 실제 컨테이너를 실행하는 서비스를 만듭니다. 이 서비스는 Application Load Balancer와 연동됩니다.

1. **ECS 콘솔**의 `클러스터(Clusters)`에서 `DemoCluster`를 선택합니다.
2. `서비스(Services)` 탭에서 `생성(Create)`을 선택합니다.
3. **환경:** `컴퓨팅 옵션`으로 **`시작 유형(Launch type)`**을 선택하고 `Fargate`를 지정합니다.
4. **애플리케이션:** `태스크 정의 패밀리`에서 `nginxdemos-hello`를 선택합니다.
5. **서비스 이름:** `nginxdemos-hello`
6. **원하는 태스크 수:** `1`
7. **네트워크:**
    - **VPC:** `DemoCluster`가 속한 VPC를 선택합니다.    
    - **서브넷:** 모든 서브넷을 선택합니다.    
    - **보안 그룹:** 새 보안 그룹을 생성하고, 이름은 `nginxdemos-hello`, 인바운드 규칙은 `포트 80`에 대해 `0.0.0.0/0`을 허용하도록 설정합니다.  
    - **퍼블릭 IP:** `켜짐(ON)`    
8. **로드 밸런싱:**
    - **로드 밸런서 유형:** `Application Load Balancer`를 선택하고 새 로드 밸런서를 생성합니다.    
    - **대상 그룹:** 새 대상 그룹을 생성하고, 이름은 `tg-nginxdemos-hello`, 프로토콜은 `HTTP`로 설정합니다.  
9. `생성(Create)`을 클릭하여 서비스를 배포합니다.

### 3. 서비스 작동 확인 및 스케일링 📈

서비스 배포가 완료되면, 로드 밸런서의 DNS 이름을 통해 웹페이지에 접속하고, 서비스 스케일링을 테스트합니다.

1. **작동 확인:**
    - **로드 밸런서 DNS 확인:** EC2 콘솔의 `로드 밸런서(Load Balancers)`에서 `DemoALBForECS`를 찾습니다.
    - **DNS 이름**을 복사하여 웹 브라우저에 붙여넣으면, NGINX 환영 페이지가 표시됩니다. 이는 컨테이너가 정상적으로 실행되고 로드 밸런서를 통해 접근 가능함을 의미합니다.
2. **서비스 스케일링:**
    - `nginxdemos-hello` 서비스의 `업데이트(Update)`를 클릭합니다.
    - **원하는 태스크 수(Desired number of tasks)**를 `3`으로 변경하고 `업데이트`를 클릭합니다.
    - **결과:** ECS가 자동으로 Fargate 인프라를 프로비저닝하고 두 개의 컨테이너를 추가로 실행합니다. 로드 밸런서는 이제 세 개의 컨테이너에 트래픽을 분산시킵니다. 웹페이지를 새로고침할 때마다 로드 밸런서 뒤의 컨테이너 IP 주소가 바뀌는 것을 확인할 수 있습니다.

### 4. 비용 절감을 위한 서비스 정리 🧹

실습 종료 후, 불필요한 비용이 발생하지 않도록 리소스를 정리합니다.

1. **서비스 업데이트:** `nginxdemos-hello` 서비스의 `원하는 태스크 수`를 `0`으로 변경하여 컨테이너를 중지합니다.
2. **Auto Scaling 그룹 정리:** EC2 콘솔의 `Auto Scaling Groups`에서 `ECS` 클러스터용으로 생성된 그룹의 `원하는 용량`을 `0`으로 변경합니다.
3. **로드 밸런서, 태스크 정의, 클러스터 등 불필요한 리소스 삭제.**
