
Amazon DynamoDB 스트림은 테이블의 데이터 변경 사항을 실시간으로 추적하는 강력한 기능입니다. 이 스트림을 AWS Lambda와 연동하면, 데이터가 변경될 때마다 특정 코드를 자동으로 실행하는 서버리스 아키텍처를 구축할 수 있습니다. 이번 아티클에서는 DynamoDB 테이블에 스트림을 활성화하고, Lambda 함수를 연결하여 데이터 변경 이벤트를 실시간으로 로그에 기록하는 과정을 상세히 살펴보겠습니다.

---

## 🏗️ 1단계: DynamoDB 스트림 활성화하기

먼저 DynamoDB 테이블에 스트림 기능을 활성화하고, 어떤 종류의 변경 정보를 스트림에 포함할지 설정해야 합니다.

1. **테이블 선택**: DynamoDB 콘솔에서 `users_post` 테이블을 선택합니다.
    
2. **스트림 설정**: '내보내기 및 스트림(Exports and streams)' 탭으로 이동하여 'DynamoDB 스트림' 섹션에서 '활성화'를 클릭합니다.
    
3. **뷰 유형 선택**: 스트림에 기록될 정보의 상세 수준을 선택합니다.
    
    - `KEYS_ONLY`: 기본 키만 포함
        
    - `NEW_IMAGE`: 변경 후의 항목 전체
        
    - `OLD_IMAGE`: 변경 전의 항목 전체
        
    - `NEW_AND_OLD_IMAGES`: 변경 전/후 항목 모두
        
    - 실습에서는 `NEW_AND_OLD_IMAGES`를 선택하여 가장 많은 정보를 캡처합니다.
        

---

## ⚙️ 2단계: Lambda 함수 생성 및 구성

스트림의 변경 이벤트를 처리할 Lambda 함수를 생성합니다.

1. **Lambda 함수 생성**: AWS Lambda 콘솔에서 새로운 함수를 생성합니다.
    
2. **블루프린트 선택**: 'DynamoDB process stream Python' 블루프린트를 사용하여 DynamoDB 스트림 이벤트를 처리하는 기본 코드를 자동으로 생성합니다.
    
3. **함수 설정**:
    
    - **함수 이름**: `Lambda_demo_DynamoDB_stream`으로 지정합니다.
        
    - **실행 역할**: '기본 Lambda 권한이 있는 새 역할 생성'을 선택합니다. 이 역할에 DynamoDB 스트림을 읽을 권한을 추가해야 합니다.
        

### **⚠️ IAM 권한 추가하기**

Lambda 함수가 DynamoDB 스트림을 읽으려면 적절한 IAM 권한이 필요합니다.

1. 생성된 Lambda 함수의 '구성' 탭으로 이동합니다.
    
2. '권한' 섹션에서 실행 역할을 클릭하여 IAM 콘솔로 이동합니다.
    
3. 역할에 `AmazonDynamoDBReadOnlyAccess`와 `AWSLambdaDynamoDBExecutionRole` 정책을 연결(Attach)합니다. 이를 통해 Lambda가 DynamoDB 스트림에 접근하고 읽을 수 있는 권한을 얻게 됩니다.
    

---

## 🔗 3단계: 스트림 트리거(Trigger) 연결

Lambda 함수가 DynamoDB 스트림의 이벤트를 자동으로 처리하도록 트리거를 설정합니다.

1. **트리거 생성**: Lambda 함수 콘솔의 '구성' 탭에서 '트리거 추가'를 클릭합니다.
    
2. **소스 선택**: DynamoDB를 선택하고, 스트림을 활성화한 `users_post` 테이블을 지정합니다.
    
3. **배치 크기**: 한 번에 처리할 레코드의 개수(예: 100)를 지정합니다.
    
4. **시작 위치**: 스트림의 '최신(latest)' 위치에서 읽기를 시작하도록 설정합니다.
    
5. **활성화**: 트리거를 활성화합니다.
    

이제 `users_post` 테이블에 변경이 발생할 때마다, DynamoDB 스트림이 해당 이벤트를 감지하고 설정된 트리거에 따라 Lambda 함수를 자동으로 호출하게 됩니다.

---

## 🧪 4단계: 실시간 이벤트 확인하기

이제 DynamoDB 테이블에 실제 변경을 일으켜 Lambda 함수가 정상적으로 작동하는지 확인합니다.

### **1. 데이터 변경 작업 수행**

`users_post` 테이블에서 다음과 같은 세 가지 작업을 수행합니다.

1. **수정(Update)**: 기존 항목의 내용을 수정하고 저장합니다.
    
2. **생성(Create)**: 새 항목을 추가하고 저장합니다.
    
3. **삭제(Delete)**: 기존 항목을 삭제합니다.
    

### **2. CloudWatch 로그 확인**

Lambda 함수는 기본적으로 수신한 스트림 레코드를 AWS CloudWatch Logs에 기록합니다.

1. Lambda 함수의 '모니터링' 탭으로 이동하여 'CloudWatch Logs에서 로그 보기'를 클릭합니다.
    
2. 로그 스트림을 열면, 방금 수행한 데이터 변경 작업들이 각각 로그로 기록된 것을 확인할 수 있습니다.
    
3. 로그에는 `OLD_IMAGE`와 `NEW_IMAGE` 정보가 포함되어, 어떤 속성이 변경되었는지(`MODIFY`), 새로 생성되었는지(`INSERT`), 또는 삭제되었는지(`REMOVE`)를 명확하게 보여줍니다.
    

|로그 유형|설명|기록 내용|
|---|---|---|
|**`MODIFY`**|항목이 수정됨|`OLD_IMAGE`와 `NEW_IMAGE` 모두 기록|
|**`INSERT`**|새 항목이 추가됨|`NEW_IMAGE`만 기록|
|**`REMOVE`**|항목이 삭제됨|`OLD_IMAGE`만 기록|

---

## 🗑️ 정리: 실습 후 리소스 정리

불필요한 비용 발생을 막기 위해 실습 후에는 반드시 리소스를 삭제해야 합니다.

1. **트리거 비활성화/삭제**: DynamoDB 테이블의 '스트림' 섹션에서 Lambda 트리거를 삭제합니다.
    
2. **Lambda 함수 삭제**: AWS Lambda 콘솔에서 생성한 함수를 삭제합니다.
    
3. **DynamoDB 스트림 비활성화**: DynamoDB 테이블의 스트림 설정을 '비활성화'로 변경합니다.
    

이 실습을 통해 DynamoDB와 Lambda를 연동하여 데이터 변경 사항에 실시간으로 반응하는 강력한 서버리스 애플리케이션의 기본 원리를 이해할 수 있습니다.