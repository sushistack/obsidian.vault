
EC2 인스턴스 메타데이터 서비스(IMDS)는 AWS의 강력한 기능 중 하나로, EC2 인스턴스가 자신에 대한 정보를 외부의 도움 없이 스스로 알아낼 수 있게 해줍니다. 이 서비스는 특정 고정 IP 주소(`169.254.169.254`)를 통해 접근할 수 있으며, 인스턴스의 이름, 퍼블릭/프라이빗 IP, IAM 역할 이름 등 다양한 메타데이터를 제공합니다.

### 메타데이터 vs. 사용자 데이터

- **메타데이터(Metadata):** 인스턴스 자체에 대한 정보입니다. 위에서 언급한 정보 외에도 AMI ID, 가용 영역(AZ) 등 인스턴스의 속성에 대한 데이터를 제공합니다.
- **사용자 데이터(User Data):** 인스턴스 시작 시 한 번 실행되는 스크립트입니다. 인스턴스를 초기 설정하거나 소프트웨어를 설치하는 데 사용됩니다. 이 데이터 역시 IMDS를 통해 접근할 수 있습니다.

### IMDSv1 vs. IMDSv2

IMDS에는 두 가지 버전이 있으며, 보안 강화를 위해 IMDSv2가 도입되었습니다.

|특징|IMDSv1 (요청/응답 방식)|IMDSv2 (세션 지향 방식)|
|---|---|---|
|**접근 방식**|GET 요청으로 URL에 직접 접근|`PUT` 요청으로 세션 토큰을 먼저 발급받아야 함|
|**보안성**|SSRF(Server-Side Request Forgery) 취약점 등 보안 문제에 취약|세션 토큰을 사용하므로 보안이 강화됨|
|**기본 설정**|기본적으로 비활성화 또는 선택적으로 활성화|AWS의 최신 AMI에서는 기본적으로 활성화되어 있음|
|**사용 단계**|1단계: GET 요청으로 메타데이터 획득|2단계: `PUT` 요청으로 토큰 발급 -> `GET` 요청 시 헤더에 토큰 포함|

**IMDSv2 작동 방식 (2단계 프로세스):**

1. **세션 토큰 요청:** `PUT` 명령을 사용하여 지정된 기간(최대 6시간) 동안 유효한 임시 세션 토큰을 발급받습니다.

```Bash
TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
```

2. **메타데이터 조회:** 발급받은 토큰을 HTTP 헤더(`X-aws-ec2-metadata-token`)에 포함하여 원하는 메타데이터를 `GET` 요청으로 조회합니다.

```Bash
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/
```

보안이 강화된 IMDSv2의 복잡한 절차를 이해하는 것은 중요합니다.