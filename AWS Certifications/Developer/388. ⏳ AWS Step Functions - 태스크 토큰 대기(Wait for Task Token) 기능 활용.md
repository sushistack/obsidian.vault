
AWS Step Functions의 **`태스크 토큰 대기(Wait for Task Token)`** 기능은 워크플로우를 잠시 멈추고, 외부 서비스의 응답을 기다렸다가 다시 재개할 때 사용됩니다. 이 기능은 Step Functions가 직접 제어하기 어려운 외부 시스템과의 연동을 가능하게 합니다.

---

## 1. 🎯 태스크 토큰(Task Token)이란?

태스크 토큰은 Step Functions가 특정 작업이 완료되기를 기다리는 동안 워크플로우를 **일시 정지**시키는 데 사용하는 고유 식별자입니다. 외부 시스템이 작업을 완료한 후 이 토큰을 다시 Step Functions로 전송하면, Step Functions는 워크플로우 실행을 재개합니다.

### 주요 용도

- **외부 서비스 통합**: Step Functions가 직접 호출할 수 없는 레거시 시스템, 제3자 API 등을 호출하고 응답을 기다릴 때 사용합니다.
    
- **수동 승인**: 사람의 수동 승인이 필요한 워크플로우 단계(예: 결제 승인, 문서 검토)에 활용할 수 있습니다.
    
- **비동기 처리**: 작업 완료 시간이 오래 걸리는 비동기 작업을 오케스트레이션할 때 유용합니다.
    

---


## 2. 🧩 태스크 토큰 대기 동작 방식

![[Pasted image 20250913165719.png]]

Step Functions는 태스크 상태의 `Resource` 필드에 `.waitForTaskToken`을 추가하여 이 기능을 활성화합니다.

1. **토큰 발행**: Step Functions는 작업을 시작하면서 고유한 태스크 토큰을 생성합니다.
    
2. **외부 시스템 호출**: 워크플로우는 이 토큰을 메시지(예: Amazon SQS 메시지)와 함께 외부 시스템에 전달합니다.
    
3. **작업 일시 중지**: Step Functions는 외부 시스템이 응답을 보낼 때까지 워크플로우 실행을 **일시 중지**하고 대기합니다.
    
4. **응답 및 재개**: 외부 시스템은 작업을 완료한 후, Step Functions API(`SendTaskSuccess` 또는 `SendTaskFailure`)를 호출하여 태스크 토큰과 함께 결과(성공/실패)를 반환합니다.
    
5. **워크플로우 재개**: Step Functions는 유효한 토큰과 결과를 수신하면 워크플로우를 재개하고 다음 단계로 진행합니다.
    

!

---

## 3. 🌐 외부 시스템 연동 예시: SQS + 외부 애플리케이션

아래 예시는 Step Functions와 SQS, 그리고 외부 애플리케이션을 연동하여 `태스크 토큰 대기` 기능을 사용하는 워크플로우를 보여줍니다.

1. **Step Functions**: 워크플로우에서 SQS `sendMessage` API를 호출하며, `Resource` 필드에 `.waitForTaskToken`을 추가합니다. 메시지에는 작업 입력과 함께 **`$$.Task.Token`**이라는 내장 변수를 통해 태스크 토큰을 포함시킵니다.
    
2. **Amazon SQS**: Step Functions로부터 메시지를 받아 큐에 저장합니다.
    
3. **외부 애플리케이션**: 큐를 폴링(pulling)하여 메시지를 가져옵니다. 메시지 바디에는 작업에 필요한 데이터와 태스크 토큰이 들어 있습니다.
    
4. **작업 처리**: 애플리케이션은 메시지를 처리하고, 결과에 따라 Step Functions API를 호출합니다.
    
    - **성공 시**: `SendTaskSuccess` API를 호출하며, 태스크 토큰과 함께 처리 결과를 전달합니다.
        
    - **실패 시**: `SendTaskFailure` API를 호출하며, 태스크 토큰과 함께 오류 정보를 전달합니다.
        
5. **워크플로우 재개**: Step Functions는 `SendTaskSuccess` 호출을 받으면, 외부 애플리케이션의 처리 결과를 다음 단계의 입력으로 사용하여 워크플로우를 계속 진행합니다.
    

이처럼 `태스크 토큰 대기` 기능은 Step Functions가 AWS 내의 서비스뿐만 아니라, 외부의 어떠한 시스템과도 유연하게 상호 작용하며 워크플로우를 구축할 수 있게 해주는 핵심적인 기능입니다.