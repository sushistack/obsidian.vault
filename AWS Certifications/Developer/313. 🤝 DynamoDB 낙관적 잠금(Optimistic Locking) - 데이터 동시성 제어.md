
Amazon DynamoDB에서 여러 클라이언트가 동일한 데이터를 동시에 수정하려고 할 때 발생하는 문제를 해결하는 효과적인 방법 중 하나는 <mark style="background: #FF5582A6;">낙관적 잠금(Optimistic Locking)</mark>입니다. 이는 DynamoDB의 **조건부 쓰기(Conditional Writes)** 기능을 활용하여 데이터 무결성을 확보하는 중요한 개념입니다.

---

## ❓ 낙관적 잠금이란 무엇인가?

낙관적 잠금은 "데이터 충돌이 자주 발생하지 않을 것"이라고 가정하고, 데이터를 읽을 때 별도의 잠금 처리를 하지 않습니다. 대신, 데이터를 수정할 때에만 충돌 여부를 검사합니다. 이 방법은 데이터가 자주 충돌하지 않는 환경에서 높은 성능을 유지하면서 데이터의 일관성을 보장할 수 있습니다.

### **✨ 작동 원리**

낙관적 잠금은 일반적으로 항목에 **버전 번호** 역할을 하는 속성을 추가하여 구현합니다.

1. **데이터 읽기**: 클라이언트가 특정 항목을 읽을 때, 항목의 데이터와 함께 버전 번호를 함께 가져옵니다.
    
2. **데이터 수정**: 클라이언트는 로컬에서 데이터를 수정합니다.
    
3. **조건부 쓰기**: 수정한 데이터를 다시 DynamoDB에 쓰기 작업(Update, Delete)으로 보낼 때, **버전 번호가 변경되지 않았는지 확인하는 조건식**을 포함합니다.
    
4. **충돌 처리**:
    
    - **성공**: 만약 DynamoDB에 저장된 항목의 버전 번호가 클라이언트가 보낸 버전 번호와 일치하면, DynamoDB는 쓰기 작업을 성공적으로 수행하고 **버전 번호를 1 증가**시킵니다.
        
    - **실패**: 만약 DynamoDB에 저장된 버전 번호가 클라이언트가 보낸 번호와 다르다면 (이미 다른 클라이언트가 데이터를 수정한 경우), 조건식은 `false`가 되어 쓰기 작업이 **실패(거부)**됩니다.
        

이러한 메커니즘을 통해 먼저 데이터를 업데이트한 클라이언트의 변경 사항만 반영되고, 이후에 들어온 클라이언트의 요청은 거부되어 데이터 충돌을 방지합니다.

---

## 📋 낙관적 잠금 시나리오 예시

다음은 두 명의 클라이언트가 동시에 같은 항목의 `first_name` 속성을 수정하려는 상황에 대한 예시입니다.

### **1. 초기 상태**

|속성|값|
|---|---|
|`user_id`|`123`|
|`first_name`|`Steve`|
|`version`|`1`|

![[Pasted image 20250903220934.png]]
### **2. 클라이언트 1과 2의 동시 접근**

- **클라이언트 1**: `first_name`을 'John'으로, `version`을 `2`로 업데이트하려 합니다.
    
    - 조건: `version = 1`

- **클라이언트 2**: `first_name`을 'Lisa'로, `version`을 `2`로 업데이트하려 합니다.
    
    - 조건: `version = 1`

### **3. DynamoDB의 처리 과정**

1. **클라이언트 2의 요청이 먼저 도착**: DynamoDB는 `version = 1` 조건이 참인 것을 확인하고, `first_name`을 'Lisa'로 업데이트한 후 `version`을 `2`로 변경합니다.
    
2. **클라이언트 1의 요청이 나중에 도착**: DynamoDB는 `version = 1` 조건이 거짓인 것을 확인합니다. 현재 항목의 `version`은 `2`이기 때문입니다.
    
3. **결과**: 클라이언트 1의 요청은 실패하고 `ConditionalCheckFailedException`과 같은 오류 메시지를 받게 됩니다.
    

### **💡 해결 방안**

오류 메시지를 받은 클라이언트 1은 다시 항목을 `GetItem`으로 읽어 최신 버전(`version = 2`, `first_name = Lisa`)을 가져온 후, 필요한 경우 다시 업데이트 작업을 시도할 수 있습니다.

---

## 🔑 시험을 위한 핵심 정리

- **낙관적 잠금(Optimistic Locking)**은 DynamoDB의 **조건부 쓰기(Conditional Writes)**를 사용하여 구현됩니다.
    
- 항목에 **버전 번호** 역할을 하는 속성을 사용하며, 이 속성은 업데이트 시마다 1씩 증가합니다.
    
- **쓰기 작업**(`UpdateItem`, `DeleteItem` 등)을 보낼 때, `version = <이전_버전>`과 같은 **조건식**을 포함시켜야 합니다.
    
- 동시에 여러 클라이언트가 데이터를 수정하려 할 때, **가장 먼저 성공한 요청만 반영**되며, 나머지 요청은 `ConditionalCheckFailedException` 오류를 반환합니다.
    

낙관적 잠금은 데이터 충돌이 적은 상황에서 매우 효율적이며, 애플리케이션의 데이터 무결성을 보장하는 핵심적인 전략입니다.