
이전 단계에서 `buildspec.yaml` 파일이 없어서 빌드가 실패했던 문제를 해결하고, 이 빌드 프로젝트를 **CodePipeline**과 통합하여 CI/CD(지속적 통합/지속적 배포) 파이프라인을 완성하는 방법에 대해 알아보겠습니다.

---

## 📝 1. `buildspec.yaml` 파일 생성하기

GitHub 저장소에 직접 파일을 추가하여 빌드 명령을 정의합니다.

### **파일 내용 (`buildspec.yaml`)**

```YAML
version: 0.2

phases:
  install:
    commands:
      - echo "Node.js를 설치합니다."
      - # 여기에서 필요한 설치 명령어를 추가할 수 있습니다.
  pre_build:
    commands:
      - echo "사전 빌드 단계에 있습니다."
  build:
    commands:
      - echo "빌드 단계에 있습니다."
      - echo "테스트를 실행합니다."
      - grep -Fq "Congratulations" index.html
  post_build:
    commands:
      - echo "사후 빌드 단계에 있습니다."
```

- **`version: 0.2`**: Buildspec 파일의 버전을 명시합니다.
    
- **`phases`**: 빌드 단계를 정의합니다.
    
    - **`install`**: 빌드 환경에 필요한 소프트웨어(예: Node.js)를 설치합니다.
        
    - **`pre_build`**: 빌드 전 실행될 명령(예: 의존성 설치)을 정의합니다.
        
    - **`build`**: 실제 빌드 및 테스트가 이루어지는 핵심 단계입니다.
        
    - **`post_build`**: 빌드 후 정리 작업 등을 수행합니다.
        
- **`grep -Fq "Congratulations" index.html`**: 이 명령어는 `index.html` 파일에 "Congratulations"라는 문자열이 포함되어 있는지 확인하는 테스트입니다. 문자열이 존재하면 성공하고, 그렇지 않으면 실패합니다.
    

GitHub에서 이 파일을 커밋하면, 이전에 설정한 웹훅(Webhook) 덕분에 CodeBuild에서 **자동으로 새로운 빌드가 트리거됩니다.**

---

## ✅ 2. CodeBuild 빌드 성공 확인

GitHub에 `buildspec.yaml` 파일을 푸시하면, CodeBuild는 웹훅을 통해 변경 사항을 감지하고 자동으로 새로운 빌드를 시작합니다.

1. **빌드 상태 확인:** CodeBuild 콘솔에서 **'빌드 기록'**을 보면 새로운 빌드가 **`진행 중(In Progress)`** 상태로 표시됩니다.
    
2. **로그 확인:** 빌드가 완료되면 상태가 **`성공(Succeeded)`**으로 바뀝니다. **'로그 보기'**를 클릭하여 빌드 로그를 확인하면, 각 단계(install, pre_build, build, post_build)가 순서대로 실행되고 테스트(`grep` 명령어)가 성공했음을 알 수 있습니다.
    

### **빌드 로그 단계**

|단계|설명|
|---|---|
|**Submitted**|빌드 요청이 제출됨|
|**Queued**|빌드가 대기열에 들어감|
|**Provisioning**|빌드 환경(컨테이너)이 프로비저닝됨|
|**Download Source**|소스 코드(GitHub)를 다운로드함|
|**Install, Pre_build, Build, Post_build**|`buildspec.yaml`에 정의된 명령이 순차적으로 실행됨|
|**Upload Artifacts**|아티팩트가 업로드됨 (이 예시에서는 해당 사항 없음)|
|**Finalizing**|빌드 완료 및 정리|
|**Completed**|빌드 최종 완료|

---

## 🔗 3. CodePipeline과 CodeBuild 통합하기

이제 자동화된 테스트를 CI/CD 파이프라인에 추가하여 더욱 견고한 배포 프로세스를 구축합니다.

### **1단계: CodeBuild 웹훅 비활성화**

CodePipeline이 CodeBuild를 트리거하도록 하기 위해, CodeBuild 프로젝트의 **'기본 소스 웹훅 이벤트'**를 비활성화합니다. 이렇게 하면 GitHub 푸시가 CodeBuild를 직접 트리거하지 않고, CodePipeline을 통해서만 실행됩니다.

### **2단계: CodePipeline 편집**

기존 CodePipeline에 새로운 `테스트` 단계를 추가합니다.

1. **CodePipeline 콘솔**로 이동하여 기존 파이프라인을 선택하고 **'편집'**을 클릭합니다.
    
2. **'Source'** 단계와 **'Deploy'** 단계 사이에 **'단계 추가'**를 클릭하고 `TestCode`와 같은 이름을 지정합니다.
    
3. 새로 추가된 단계에서 **'액션 그룹 추가'**를 클릭합니다.
    
4. **액션 설정:**
    
    - **액션 이름**: `CodeBuildTest`
        
    - **액션 공급자**: `CodeBuild`
        
    - **입력 아티팩트**: `SourceArtifact` (CodePipeline의 소스 단계에서 전달된 결과물)
        
    - **프로젝트 이름**: `MyFirstBuild` (이전에 생성한 CodeBuild 프로젝트)
        
    - **출력 아티팩트**: `OutputOfTest` (테스트 결과를 저장할 아티팩트)
        

이제 파이프라인은 **'소스 → 테스트 → 배포'** 순서로 변경되었습니다.

---

## 🚨 4. 파이프라인 테스트: 의도된 실패와 성공

### **1차 테스트: 의도된 실패**

`index.html` 파일의 **"Congratulations"** 문구를 **"horrible"**로 변경하고 커밋합니다.

- **결과:** CodePipeline이 자동으로 실행됩니다. `TestCode` 단계에 있는 CodeBuild 프로젝트가 실행되지만, `grep` 명령어가 "Congratulations"를 찾지 못하므로 **빌드가 실패**합니다.
    
- **파이프라인 동작:** 테스트 단계가 실패하면, 파이프라인은 다음 단계(배포)로 진행되지 않습니다. `Dev` 환경에 배포된 애플리케이션은 **"horrible"**로 변경되지 않고 기존 상태를 유지합니다.
    

### **2차 테스트: 성공적인 배포**

다시 `index.html` 파일을 **"Congratulations, CodeBuild"**로 변경하고 커밋합니다. "Congratulations" 문자열이 여전히 포함되어 있으므로 테스트가 성공할 것입니다.

- **결과:** CodePipeline이 다시 실행되고, `TestCode` 단계의 CodeBuild 빌드가 **성공**합니다.
    
- **파이프라인 동작:** 테스트 단계가 성공하면, 파이프라인은 `Deploy` 단계로 진행하여 변경 사항을 `Dev` 환경에 배포합니다.
    
- **최종 확인:** `Dev` 환경의 URL에 접속하면 **"Congratulations, CodeBuild"**라는 새로운 텍스트가 표시됩니다.
    

이 과정을 통해 코드 변경이 있을 때마다 자동으로 테스트를 실행하고, 테스트가 실패하면 배포를 막는 **CI/CD 파이프라인의 강력함**을 확인할 수 있습니다.