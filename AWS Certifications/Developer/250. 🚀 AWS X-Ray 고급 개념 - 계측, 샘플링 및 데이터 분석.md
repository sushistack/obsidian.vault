## 계측(Instrumentation): X-Ray를 위한 코드 준비

**계측(Instrumentation)**은 소프트웨어의 성능을 측정하고, 오류를 진단하며, 트레이스 정보를 기록하기 위해 애플리케이션 코드에 특정 기능을 추가하는 작업입니다. X-Ray를 사용하려면 애플리케이션 코드에 X-Ray SDK를 임포트하여 계측해야 합니다.

- **SDK 사용**: Node.js, Python, Java 등 다양한 언어를 위한 X-Ray SDK가 제공됩니다. 간단한 설정만으로도 기본적인 트레이스 정보를 수집할 수 있으며, 추가적인 코드 수정을 통해 트레이스를 커스터마이징할 수 있습니다.

- **커스터마이징**: 인터셉터(Interceptors), 핸들러(Handlers), 미들웨어(Middleware) 등을 사용하여 트레이스에 추가 데이터를 첨부하거나, 트레이스 전송 방식을 변경할 수 있습니다.

```JavaScript
// Node.js 예시: Express 앱 계측
const AWSXRay = require('aws-xray-sdk');
const express = require('express');

const app = express();
app.use(AWSXRay.express.openSegment('MyWebApp'));
// ... 라우트 핸들러 등 애플리케이션 코드 ...
app.use(AWSXRay.express.closeSegment());
```

## 📊 X-Ray 데이터의 기본 구성 요소

X-Ray는 다음과 같은 계층적인 데이터 구조를 사용하여 요청을 추적합니다.

|용어|설명|
|---|---|
|**세그먼트(Segment)**|단일 애플리케이션 또는 서비스에서 기록하는 작업의 단위입니다. 각 서비스가 트레이스 정보를 X-Ray로 보낼 때 세그먼트가 생성됩니다.|
|**하위 세그먼트(Subsegment)**|세그먼트 내에서 더 세부적인 작업(예: 외부 API 호출, 데이터베이스 쿼리)을 기록하는 데 사용됩니다.|
|**트레이스(Trace)**|단일 요청의 시작부터 끝까지, 관련된 모든 세그먼트와 하위 세그먼트를 모아 완전한 엔드-투-엔드(end-to-end) 뷰를 형성합니다.|

---

## 🏷️ 어노테이션(Annotations) vs. 메타데이터(Metadata)

X-Ray 트레이스에 추가적인 정보를 첨부할 때 **어노테이션**과 **메타데이터**를 사용합니다. 두 개념의 가장 큰 차이점은 **인덱싱(indexing)** 여부입니다.

|구분|어노테이션 (Annotations)|메타데이터 (Metadata)|
|---|---|---|
|**속성**|키-값(Key-Value) 쌍|키-값(Key-Value) 쌍|
|**인덱싱**|**인덱싱됨**. 필터 표현식에 사용하여 트레이스를 검색할 수 있음.|**인덱싱되지 않음**. 검색 필터로 사용할 수 없음.|
|**용도**|**트레이스 검색** 및 그룹화에 주로 사용. (예: `userID`, `paymentStatus`)|**자세한 디버깅 정보**를 저장하는 데 사용. (예: 요청/응답 페이로드)|

---

## 📉 샘플링(Sampling): 비용 효율적인 모니터링

모든 요청을 트레이싱하는 것은 비용이 많이 들 수 있습니다. **샘플링**은 X-Ray로 전송되는 데이터의 양을 제어하여 모니터링 비용을 최적화하는 기능입니다.

- **기본 샘플링 규칙**:
    
    - **리저버(Reservoir)**: 매 초마다 최소한 첫 번째 요청은 기록합니다. 이는 서비스가 요청을 처리하는 한 적어도 하나의 트레이스가 항상 기록되도록 보장합니다.
    
    - **비율(Rate)**: 리저버를 초과하는 추가 요청에 대해 일정 비율(기본값 5%)만 기록합니다.
    
- **사용자 지정 샘플링 규칙**:
    
    - **규칙 생성**: AWS 콘솔에서 사용자 지정 규칙을 생성하여 특정 경로, HTTP 메서드, 서비스에 대해 리저버와 샘플링 비율을 다르게 설정할 수 있습니다.
    
    - **예시**:
        
        - `POST` 요청에 대해 더 높은 샘플링 비율을 적용하여 중요한 데이터 전송을 더 많이 추적할 수 있습니다.
    
        - 디버깅 목적으로 특정 URL에 대해 모든 요청(`reservoir: 1`, `rate: 1`)을 추적하도록 설정하여 상세 정보를 파악할 수 있습니다.

- **비 코드 변경**: 가장 큰 장점은 샘플링 규칙을 변경해도 애플리케이션 코드를 수정하거나 다시 배포할 필요가 없다는 것입니다. X-Ray 데몬이 콘솔에서 변경된 규칙을 자동으로 적용합니다.


---

## 🤝 교차 계정(Cross-Account) 추적

X-Ray 데몬의 설정 파일을 통해 여러 AWS 계정의 트레이스 데이터를 하나의 중앙 계정으로 보낼 수 있습니다. 이를 위해 IAM 역할을 사용하여 데몬이 다른 계정의 X-Ray 서비스에 데이터를 전송할 수 있는 권한을 부여해야 합니다. 이 방식은 분산된 계정 환경에서 로그, 지표, 트레이스를 중앙에서 통합 관리하는 데 매우 유용합니다.