
## 🚀 ECR CLI를 이용한 이미지 Push & Pull

**Amazon ECR**을 사용하면 AWS CLI(Command Line Interface)와 Docker CLI를 연동하여 컨테이너 이미지를 쉽게 관리할 수 있습니다. 이미지를 ECR에 업로드(Push)하거나 다운로드(Pull)하는 과정은 크게 **인증**, **이미지 태깅**, **Push/Pull**의 3단계로 이루어집니다.

### 1. 🔑 ECR 인증 및 로그인

가장 먼저 로컬 환경의 Docker CLI가 ECR 레포지토리에 접근할 수 있도록 인증 과정을 거쳐야 합니다. 이 과정은 AWS CLI를 통해 ECR 로그인 자격 증명을 획득하고, 이를 Docker CLI에 전달하는 방식으로 진행됩니다.

|과정|명령어|설명|
|---|---|---|
|**로그인 자격 증명 획득**|`aws ecr get-login-password`|ECR 레지스트리에 로그인하기 위한 임시 패스워드를 획득합니다.|
|**Docker 로그인**|`docker login`|`get-login-password` 명령의 출력을 파이프(`\|`)로 연결하여 Docker에 로그인합니다.|

**예시 코드 블록:**

```Bash
aws ecr get-login-password --region [리전] | docker login --username AWS --password-stdin [AWS 계정 ID].dkr.ecr.[리전].amazonaws.com
```

- **`[리전]`**: ECR 레포지토리가 위치한 AWS 리전을 입력합니다. (예: `ap-northeast-2`)
- **`[AWS 계정 ID]`**: 본인의 12자리 AWS 계정 ID를 입력합니다.

이 명령어를 실행하면 `Login Succeeded` 메시지가 나타나며, 로컬 Docker 환경이 ECR에 접속할 준비가 완료됩니다. 만약 `AccessDenied`와 같은 오류가 발생한다면, 현재 사용 중인 IAM 사용자의 ECR 권한을 확인해야 합니다.

---

### 2. 🏷️ 이미지 태그 변경 (Tagging)

ECR에 이미지를 Push하기 위해서는 ECR 레포지토리의 주소 형식에 맞게 이미지의 태그를 변경해야 합니다. 이 작업은 로컬에 있는 기존 이미지를 ECR 레포지토리 주소로 "별칭"을 붙이는 과정과 같습니다.

**예시:**

로컬에 있는 `nginx:latest` 이미지를 `[계정 ID].dkr.ecr.[리전].amazonaws.com/my-repository:latest` 주소로 태그를 지정하는 명령어는 다음과 같습니다.

```Bash
docker tag nginx:latest [AWS 계정 ID].dkr.ecr.[리전].amazonaws.com/my-repository:latest
```

---

### 3. 📤 이미지 Push & Pull

이제 모든 준비가 완료되었습니다. `docker push` 또는 `docker pull` 명령어를 사용하여 ECR 레포지토리와 이미지를 주고받을 수 있습니다.

#### **이미지 Push (업로드)**

태그를 변경한 이미지를 ECR 레포지토리에 업로드합니다.

**명령어:**

```Bash
$ docker push [AWS 계정 ID].dkr.ecr.[리전].amazonaws.com/my-repository:latest
```

#### **이미지 Pull (다운로드)**

ECR 레포지토리에 있는 이미지를 로컬 환경으로 다운로드합니다.

**명령어:**

```Bash
$ docker pull [AWS 계정 ID].dkr.ecr.[리전].amazonaws.com/my-repository:latest
```

---

## 🛠️ ECR 레포지토리 설정

ECR 레포지토리를 생성할 때는 몇 가지 옵션을 설정할 수 있습니다. 이 옵션들은 레포지토리의 보안 및 관리 효율성을 높이는 데 도움이 됩니다.

|옵션|설명|
|---|---|
|**Immutable tags**|이미지 태그의 불변성을 설정합니다. 동일한 태그로 이미지를 다시 Push하는 것을 방지합니다.|
|**Image scan on push**|이미지가 Push될 때 자동으로 취약점 스캔을 수행합니다. (참고: 이 기능은 Amazon Inspector를 사용하는 것이 더 권장됩니다.)|
|**KMS encryption**|AWS KMS(Key Management Service)를 사용하여 레포지토리에 저장된 이미지를 암호화합니다.|

---

## ⚠️ 문제 해결: 권한 오류 (Permission Denied)

ECR 이미지 Push 또는 Pull 시 `Access Denied` 또는 `Permission Denied` 오류가 발생한다면, **IAM 권한 문제**일 가능성이 매우 높습니다.

- **ECR 레포지토리 정책 확인**: 레포지토리에 연결된 정책이 올바르게 설정되어 있는지 확인합니다.
    
- **IAM 사용자/역할 정책 확인**: 이미지를 Push/Pull하는 데 사용되는 IAM 사용자 또는 역할에 **ECR 관련 권한(`ecr:Push`, `ecr:Pull`, `ecr:GetAuthorizationToken` 등)**이 부여되었는지 확인해야 합니다.