## X-Ray 샘플링 규칙이란?

**X-Ray 샘플링 규칙(Sampling Rules)**은 AWS X-Ray 서비스로 전송되는 트레이스 데이터의 양을 제어하는 기능입니다. 모든 요청을 추적하면 비용이 많이 들 수 있으므로, 특정 조건에 맞는 요청만 선별적으로 추적하여 비용을 최적화할 수 있습니다.

**샘플링 규칙의 핵심 목표**:

- **비용 절감**: 불필요한 트레이스 데이터를 전송하지 않아 비용을 줄입니다.

- **관련 데이터 확보**: 중요한 요청(예: `POST` 요청, 특정 URL 경로)에 대해서는 더 높은 샘플링 비율을 적용하여 분석에 필요한 데이터를 확보합니다.

---

## ⚙️ 샘플링 규칙 설정 방법

X-Ray 샘플링 규칙은 CloudWatch 콘솔 내 **`X-Ray traces`** > **`Settings`** > **`Sampling`** 탭에서 설정할 수 있습니다.

### 1. 기본 규칙 (Default Rule)

모든 X-Ray 환경에는 기본 규칙이 존재합니다. 이 규칙은 모든 요청에 적용됩니다.

- **우선순위(Priority)**: `10,000` (가장 낮은 우선순위)
- **리저버 크기(Reservoir Size)**: 초당 **1**개의 요청을 무조건 기록합니다.
- **고정 비율(Fixed Rate)**: 리저버 크기를 초과하는 요청에 대해 **5%**의 비율로 기록합니다.

이 기본 규칙은 편집할 수 있지만, 매칭 기준(`Match everything`)은 변경할 수 없습니다.

### 2. 사용자 지정 규칙 (Custom Rules)

`Create sampling rule` 버튼을 클릭하여 새로운 규칙을 만들 수 있습니다. 사용자 지정 규칙은 기본 규칙보다 높은 우선순위를 가질 수 있습니다.

|설정 항목|설명|
|---|---|
|**규칙 이름**|규칙의 고유한 이름. (예: `DemoSampling`)|
|**우선순위(Priority)**|`1`에서 `9,999` 사이의 값. 숫자가 낮을수록 우선순위가 높습니다. (예: `5000`은 기본 규칙보다 우선순위가 높음)|
|**리저버 크기(Reservoir Size)**|초당 무조건 기록할 요청의 최대 수. (예: `1`은 초당 1개의 요청을 무조건 기록)|
|**고정 비율(Fixed Rate)**|리저버를 초과하는 요청에 대해 기록할 비율. (예: `100%`는 모든 요청을 기록)|

### 3. 매칭 기준(Matching Criteria)

사용자 지정 규칙은 매우 세밀한 매칭 기준을 설정할 수 있습니다.

|매칭 기준|설명|예시|
|---|---|---|
|**서비스 이름**|특정 서비스의 요청에만 규칙을 적용합니다.|`MYSERVICE`|
|**HTTP 메서드**|`GET`, `POST` 등 특정 HTTP 메서드에만 규칙을 적용합니다.|`POST`|
|**URL 경로**|특정 URL 경로에 대한 요청에만 규칙을 적용합니다.|`/users/create`|

---

## 🔄 규칙 변경의 즉시 적용

샘플링 규칙을 변경하는 가장 큰 장점은 애플리케이션의 **X-Ray 데몬을 다시 시작할 필요가 없다**는 점입니다. 콘솔에서 규칙을 생성하거나 수정하면, X-Ray 데몬이 자동으로 새로운 규칙을 감지하고 즉시 적용합니다. 이는 운영 환경에서 디버깅 목적으로 일시적으로 샘플링 비율을 높여야 할 때 매우 유용합니다.