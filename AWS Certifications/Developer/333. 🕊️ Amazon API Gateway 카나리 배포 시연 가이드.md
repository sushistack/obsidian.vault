
이번 가이드에서는 Amazon API Gateway의 **카나리 배포(Canary Deployment)** 기능을 직접 시연하며 그 작동 원리를 상세히 설명합니다. 기존 API의 안정성을 유지하면서 새로운 버전을 점진적으로 배포하는 과정을 단계별로 따라해 보세요.

---

## 🚀 1단계: 초기 환경 설정 및 API 배포

먼저, 카나리 배포를 테스트하기 위한 초기 API 환경을 설정합니다.

1. **새 리소스 생성**: API Gateway 콘솔에서 `canary-demo`라는 새로운 리소스를 생성합니다.
    
2. **GET 메서드 추가**: `/canary-demo` 리소스에 **GET** 메서드를 추가하고, **통합 유형**으로 Lambda 함수와 **프록시 통합**을 선택합니다.
    
3. **Lambda 버전 1 연결**: 이전 가이드에서 생성했던 `api-gateway-stage-variables-get` 함수를 연결하되, **버전 1**을 호출하도록 ARN 끝에 `:1`을 추가합니다.
    
    - 예시: `arn:aws:lambda:REGION:ACCOUNT_ID:function:api-gateway-stage-variables-get:1`
        
4. **API 배포**: API를 `canary`라는 새로운 스테이지에 배포합니다.
    
5. **테스트 확인**: 배포된 API의 URL(예: `/canary/canary-demo`)을 웹 브라우저에서 호출하여 `"Hello from Lambda v1"` 메시지를 확인합니다.

---

## 🚦 2단계: 카나리 배포 설정 및 업데이트

이제 카나리 배포를 활성화하고 새로운 버전을 배포할 준비를 합니다.

1. **카나리 생성**: `canary` 스테이지 설정으로 이동하여 **카나리(Canary)** 탭을 선택하고 **생성(Create)**을 클릭합니다.
    
2. **트래픽 분배율 설정**: 카나리로 보낼 요청의 **비율(Distribution)**을 설정합니다. 데모를 위해 **50%**로 설정합니다. 실제 운영 환경에서는 1~10%와 같이 낮은 비율을 사용하는 것이 일반적입니다.
    
3. **Lambda 버전 2로 업데이트**: 리소스 설정으로 돌아와 `canary-demo` GET 메서드의 **통합 요청(Integration Request)**을 수정합니다. Lambda 함수의 ARN 끝에 있는 `:1`을 `:2`로 변경하여 **버전 2**를 호출하도록 합니다.
    
4. **카나리 배포 실행**: **API 배포**를 클릭하고 **스테이지**로 `canary`를 선택합니다. 이 변경 사항은 **카나리 스테이지**에만 배포됩니다.

---

## 🌐 3단계: 카나리 배포 동작 확인

이제 API를 호출하여 트래픽이 `v1`과 `v2`로 나뉘어지는 것을 확인합니다.

- **URL 호출**: 브라우저에서 `/canary/canary-demo` URL을 여러 번 새로고침합니다.
    
- **동작 확인**: 새로고침할 때마다 응답이 `"Hello from Lambda v1"`과 `"Hello from Lambda v2"`로 번갈아 나타나는 것을 볼 수 있습니다. 이는 50%의 트래픽이 기존 `v1`으로, 나머지 50%가 새로 배포된 `v2`로 라우팅되고 있음을 의미합니다.
    

이러한 방식으로 새로운 버전의 API가 예상대로 작동하는지, 오류가 발생하는지 등을 실제 트래픽을 통해 안전하게 검증할 수 있습니다.

---

## 🤝 4단계: 카나리 배포 승격(Promotion)

새로운 `v2` 버전이 충분히 테스트되어 안정적이라고 판단되면, 카나리 버전을 **승격**하여 모든 트래픽을 새로운 버전으로 전환합니다.

1. **카나리 승격**: `canary` 스테이지의 **카나리** 탭에서 **승격(Promote)** 버튼을 클릭합니다.
    
2. **동작 확인**: 잠시 후 다시 URL을 새로고침하면 이제 응답이 `"Hello from Lambda v2"`만 나타나는 것을 확인할 수 있습니다.
    

**승격**은 카나리 스테이지의 설정을 기존 스테이지로 병합하는 작업입니다. 이제 모든 요청이 `v2`로 라우팅되며, API 배포가 성공적으로 완료된 것입니다.

### 📝 카나리 배포의 전체 흐름

1. **리소스 수정**: 새로운 API 로직을 반영하도록 메서드를 수정합니다.
    
2. **카나리 생성**: 스테이지에 카나리 배포를 생성하고 트래픽 비율을 설정합니다.
    
3. **카나리에 배포**: 수정한 내용을 카나리 스테이지에 배포합니다.
    
4. **테스트 및 모니터링**: 실제 트래픽을 통해 새로운 버전의 안정성을 검증합니다.
    
5. **승격**: 문제가 없으면 카나리를 승격시켜 새로운 버전을 정식 배포합니다.