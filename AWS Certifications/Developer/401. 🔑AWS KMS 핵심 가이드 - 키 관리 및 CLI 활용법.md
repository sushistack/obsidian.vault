
AWS Key Management Service(KMS)는 AWS 서비스와 애플리케이션에서 데이터를 **안전하게 암호화하고 관리**할 수 있게 해주는 핵심 서비스입니다. 이 가이드에서는 KMS의 주요 기능과 사용 사례를 살펴보고, CLI(명령줄 인터페이스)를 활용한 데이터 암호화 및 복호화 실습 과정을 상세히 안내합니다.

---

## 🔐AWS KMS 키 종류 및 관리

AWS KMS는 크게 두 가지 유형의 키를 제공합니다.

### 1. AWS 관리형 키 (AWS managed keys)

이 키들은 AWS 서비스에 의해 생성, 관리 및 사용됩니다. 예를 들어, **EBS 볼륨**이나 **S3 버킷**에 대한 암호화를 활성화하면, 해당 서비스에 연결된 AWS 관리형 키가 자동으로 생성됩니다. 이 키들은 AWS가 정책을 관리하므로 사용자가 직접 수정할 수 없습니다.

|특징|설명|
|---|---|
|**관리 주체**|AWS 서비스|
|**정책 제어**|AWS가 관리 및 제어|
|**사용 사례**|EBS, S3, RDS 등 AWS 서비스의 암호화 기능과 연동|

AWS 관리형 키의 정책을 살펴보면, 특정 AWS 서비스만 해당 키에 접근할 수 있도록 `ViaService` 조건이 설정되어 있는 것을 확인할 수 있습니다. 예를 들어, EBS 키의 경우 `ec2.amazonaws.com` 서비스만 접근이 허용됩니다.

### 2. 고객 관리형 키 (Customer managed keys)

이 키들은 사용자가 직접 생성하고 관리하는 키입니다. 보안 정책, 키 순환(rotation), 별칭(alias) 등을 **자유롭게 커스터마이징**할 수 있습니다. 자체 키를 생성하면 더 세밀한 보안 제어가 가능하지만, **월 $1**의 비용이 발생합니다.

고객 관리형 키를 생성할 때 다음과 같은 옵션을 선택할 수 있습니다.

- **키 유형**:
    
    - **대칭 키 (Symmetric)**: 암호화와 복호화에 동일한 키를 사용합니다. 대부분의 KMS 사용 사례에 적합하며, `Encrypt` 및 `Decrypt` 작업에 사용됩니다.
        
    - **비대칭 키 (Asymmetric)**: 공개 키와 비공개 키 쌍을 사용합니다. 암호화/복호화 또는 서명/확인 작업에 사용됩니다.
        
- **키 원본 (Key Origin)**:
    
    - **KMS**: KMS가 키를 직접 생성하고 관리합니다. 가장 일반적인 옵션입니다.
        
    - **External**: 사용자가 외부에서 생성한 키를 가져와 KMS에 저장합니다.
        
    - **Custom Key Store**: AWS CloudHSM과 같은 전용 하드웨어 보안 모듈을 사용합니다. (이번 가이드의 범위를 벗어남)
        
- **리전 (Regionality)**:
    
    - **단일 리전 키 (Single-region key)**: 특정 AWS 리전 내에서만 유효합니다.
        
    - **다중 리전 키 (Multi-region key)**: 여러 리전에서 동일한 키를 복제하여 사용할 수 있어 재해 복구나 글로벌 애플리케이션에 유용합니다.


---

## ⚙️KMS 키 관리 기능

고객 관리형 키는 다양한 관리 기능을 제공합니다.

### 1. 키 정책 (Key Policy)

키 정책은 누가 이 키를 사용하거나 관리할 수 있는지 정의하는 IAM 정책과 유사한 문서입니다. 기본 정책은 IAM 사용자가 적절한 IAM 권한을 가지고 있을 때 키에 접근할 수 있도록 허용합니다. 필요에 따라 특정 사용자나 역할을 명시하여 **액세스 제어를 강화**할 수 있습니다.

### 2. 키 순환 (Key Rotation)

키 순환은 지정된 주기(기본 1년)마다 새로운 암호화 키를 자동으로 생성하는 기능입니다. 이 기능을 활성화하면, KMS는 새로운 키를 생성하고 이전 키는 보존합니다. 이로써 **보안 취약점 발생 가능성을 줄일 수 있습니다.**

### 3. 별칭 (Alias)

키 별칭은 `alias/tutorial`과 같이 키를 식별하기 쉬운 이름을 부여하는 기능입니다. 키 ID나 ARN(Amazon Resource Name) 대신 별칭을 사용하여 더 간편하게 키를 참조할 수 있습니다.

---

## 💻CLI를 이용한 데이터 암호화 및 복호화

이제 KMS CLI를 사용하여 실제 파일을 암호화하고 복호화하는 과정을 살펴보겠습니다. 이 실습을 통해 KMS가 데이터를 어떻게 처리하는지 직접 이해할 수 있습니다.

### 단계 1: 평문 파일 생성

먼저, 암호화할 텍스트 파일(`ExampleSecretFile.txt`)을 생성합니다.

```Bash
echo "SuperSecretPassword" > ExampleSecretFile.txt
```

### 단계 2: 파일 암호화

`aws kms encrypt` 명령을 사용하여 파일을 암호화합니다.

- `--key-id`: 앞서 생성한 고객 관리형 키의 별칭(예: `alias/tutorial`)을 사용합니다.
    
- `--plaintext`: 암호화할 파일의 경로를 지정합니다.
    
- `--output`: 암호화된 데이터의 출력 형식을 `text`로 지정합니다.
    
- `--query`: 응답에서 `CiphertextBlob` 값만 추출합니다.


```Bash
aws kms encrypt \
    --key-id alias/tutorial \
    --plaintext fileb://ExampleSecretFile.txt \
    --output text \
    --query CiphertextBlob > ExampleSecretFileEncrypted.base64
```

위 명령어를 실행하면 암호화된 데이터가 `ExampleSecretFileEncrypted.base64`라는 이름의 파일에 Base64 형식으로 저장됩니다. 이 파일은 사람이 읽을 수 있는 문자열로 구성되어 있습니다.

### 단계 3: Base64 디코딩 및 바이너리 파일 생성

암호화된 Base64 파일을 실제 바이너리 데이터로 변환합니다. `base64` 명령어를 사용합니다.

```Bash
base64 -D -i ExampleSecretFileEncrypted.base64 > ExampleSecretFileEncrypted
```

이제 `ExampleSecretFileEncrypted`라는 바이너리 파일이 생성됩니다. 이 파일을 텍스트 편집기로 열어보면 알아볼 수 없는 **난수(gibberish)**로 보입니다. 이것이 바로 암호화된 파일의 실제 모습입니다.

### 단계 4: 파일 복호화

`aws kms decrypt` 명령을 사용하여 바이너리 파일을 원래의 평문으로 복호화합니다.

- `--ciphertext-blob`: 복호화할 바이너리 파일의 경로를 지정합니다.
    
- `--output`: 출력 형식을 `text`로 지정합니다.
    
- `--query`: 응답에서 `Plaintext` 값만 추출합니다.
    

**참고**: KMS는 암호화된 데이터 블록 내에 포함된 키 정보를 자동으로 인식하여 복호화에 사용하므로, 복호화 명령에 `--key-id`를 별도로 지정할 필요가 없습니다.

```Bash
aws kms decrypt \
    --ciphertext-blob fileb://ExampleSecretFileEncrypted \
    --output text \
    --query Plaintext > ExampleSecretFileDecrypted.base64
```

이 명령어를 실행하면 `ExampleSecretFileDecrypted.base64` 파일에 복호화된 데이터가 다시 Base64 형식으로 저장됩니다.

### 단계 5: 최종 복호화 및 평문 확인

마지막으로, 복호화된 Base64 파일을 다시 디코딩하여 원래의 텍스트를 확인합니다.

```Bash
base64 -D -i ExampleSecretFileDecrypted.base64 > ExampleSecretFileDecrypted.txt
```

이제 `ExampleSecretFileDecrypted.txt` 파일을 열어보면, 처음 입력했던 "SuperSecretPassword"가 나타나는 것을 확인할 수 있습니다.

이 과정을 통해 KMS의 **암호화(`Encrypt`)**와 **복호화(`Decrypt`)** 작업이 어떻게 이루어지는지 명확하게 이해할 수 있습니다.

---

## 🌟결론

AWS KMS는 데이터를 보호하기 위한 강력하고 유연한 솔루션입니다. AWS 관리형 키는 AWS 서비스와의 연동을 통해 간편한 암호화를 제공하며, 고객 관리형 키는 사용자가 직접 보안 정책을 세밀하게 제어할 수 있는 유연성을 제공합니다.

CLI를 활용한 실습을 통해 KMS가 평문 데이터를 암호화된 바이너리 데이터로 변환하고, 이를 다시 원래대로 복원하는 과정을 직접 경험해 보았습니다. 이러한 기본 원리를 이해하면 KMS를 활용한 데이터 보안 아키텍처를 더욱 효과적으로 설계할 수 있습니다.