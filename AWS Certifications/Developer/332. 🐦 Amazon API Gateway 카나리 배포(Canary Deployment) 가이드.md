
이번 가이드에서는 Amazon API Gateway의 **카나리 배포** 기능을 상세히 다루겠습니다. 카나리 배포는 새로운 API 버전을 소수의 트래픽에만 먼저 노출하여 안정성을 검증하는 고급 배포 전략입니다. 이를 통해 서비스 중단 없이 새로운 기능을 안전하게 출시할 수 있습니다.

---

## 🚀 1단계: 카나리 배포의 기본 개념

카나리 배포는 전체 사용자에게 새로운 버전을 한꺼번에 배포하는 대신, 소수의 "카나리아(canary)" 사용자에게만 먼저 노출하는 방식입니다.

- **기존 버전**: 안정적으로 운영 중인 API 버전입니다.
    
- **카나리 버전**: 새롭게 배포하려는 API 버전입니다.
    

API Gateway에서 카나리 배포를 설정하면, 지정된 비율의 트래픽만 새로운 카나리 버전으로 라우팅됩니다. 예를 들어, 전체 트래픽의 5%를 카나리로 보내도록 설정할 수 있습니다.

### 💡 카나리 배포의 장점

- **위험 최소화**: 새로운 기능에 문제가 발생하더라도 소수의 사용자에게만 영향을 미치므로 전체 서비스에 미치는 영향을 최소화할 수 있습니다.
    
- **실시간 테스트**: 실제 운영 환경의 트래픽을 통해 새로운 버전의 성능과 안정성을 검증할 수 있습니다.
    
- **쉬운 롤백**: 문제가 발견되면 카나리 트래픽 비율을 0%로 즉시 변경하여 기존 버전으로 롤백할 수 있습니다.
    

---

## 🚦 2단계: API Gateway에서의 카나리 배포 설정

API Gateway는 스테이지(Stage)를 기반으로 카나리 배포를 지원합니다. 기존 `prod` 스테이지가 `v1` 버전을 가리킨다고 가정하고, 새로운 `v2` 버전을 카나리 배포하는 과정을 살펴보겠습니다.

1. **카나리 활성화**: `prod` 스테이지 설정에서 **카나리(Canary)** 기능을 활성화합니다.
    
2. **트래픽 비율 설정**: 카나리 스테이지로 보낼 트래픽 비율을 설정합니다. 예를 들어, 5%로 설정하면 전체 요청의 95%는 기존 `prod` 스테이지로 가고, 5%는 카나리 스테이지로 라우팅됩니다.
    
3. **카나리 스테이지**: API Gateway는 자동으로 `prod` 스테이지의 자식으로 **`prod-canary`** 스테이지를 생성합니다. 이 스테이지는 `v2` 버전의 백엔드(예: 새로운 Lambda 함수 또는 Lambda 별칭)를 가리키도록 설정할 수 있습니다.
    

### 📊 모니터링 및 분석

카나리 배포의 핵심은 **모니터링**입니다. API Gateway는 기존 스테이지와 카나리 스테이지에 대한 로그와 지표를 **분리하여 제공**합니다.

- **CloudWatch Logs**: `prod` 로그와 `prod-canary` 로그가 별도로 기록됩니다.
    
- **CloudWatch Metrics**: 각 스테이지별 호출 수, 오류율, 지연 시간 등을 독립적으로 모니터링할 수 있습니다.
    

이러한 분리된 모니터링을 통해 새로운 버전의 성능과 오류율을 정확하게 분석하고, 배포를 계속 진행할지, 아니면 롤백할지 결정할 수 있습니다.

---

## 🔁 3단계: 배포 완료 및 롤백

카나리 스테이지를 통해 새로운 버전이 안정적이라고 판단되면, 다음 단계를 진행합니다.

1. **100% 트래픽 전환**: 카나리 트래픽 비율을 100%로 설정하여 모든 트래픽이 새로운 버전으로 라우팅되도록 합니다.
    
2. **정식 배포**: 새로운 `v2` 버전을 `prod` 스테이지로 **정식 배포**합니다.
    
3. **카나리 비활성화**: 카나리 배포를 비활성화하고 정리합니다.
    

만약 카나리 스테이지에서 문제가 발견된다면, 트래픽 비율을 다시 0%로 설정하거나, 카나리 배포를 비활성화하여 **즉시 롤백**할 수 있습니다.

이러한 카나리 배포는 Lambda의 별칭 기반 카나리 배포와 함께 **블루/그린 배포** 전략을 구현하는 데 매우 효과적입니다. 새로운 코드를 별도의 환경(그린)에 배포하고, 일부 트래픽을 점진적으로 전환하여 안정성을 확보하는 방식입니다.