
## 🔑 SQS 큐 액세스 정책이란?

**SQS 큐 액세스 정책**은 SQS 큐에 직접 연결되는 **리소스 기반 IAM 정책**입니다. S3 버킷 정책과 마찬가지로 JSON 형태로 작성되며, 특정 AWS 계정, 사용자, 서비스 또는 역할이 해당 큐에 대해 어떤 작업을 수행할 수 있는지(예: 메시지 보내기, 받기)를 세밀하게 제어할 수 있습니다.

### 주요 역할

![[Pasted image 20250817203259.png]]

- **교차 계정 액세스(Cross-Account Access):** 한 AWS 계정의 SQS 큐에 다른 계정의 리소스가 접근할 수 있도록 허용합니다.
    
- **서비스 간 권한 부여:** AWS의 다른 서비스(예: S3, SNS 등)가 큐로 메시지를 보낼 수 있도록 권한을 부여합니다.
    

---

## 🔗 주요 활용 사례

SQS 큐 액세스 정책의 두 가지 주요 활용 사례를 자세히 살펴보겠습니다.

### 1. 교차 계정 액세스 허용

두 개의 서로 다른 AWS 계정(예: 계정 A와 계정 B)이 있다고 가정해 봅시다. 계정 A의 EC2 인스턴스가 계정 B의 SQS 큐에서 메시지를 받아야 할 경우, 계정 B의 SQS 큐에 다음과 같은 정책을 추가해야 합니다.

|속성|설명|
|---|---|
|**`Statement`**|정책의 핵심 내용입니다.|
|**`Effect`**|`Allow`는 접근을 허용함을 의미합니다.|
|**`Principal`**|**`arn:aws:iam::[계정 A ID]:root`**와 같이 접근을 허용할 다른 계정의 ID를 지정합니다.|
|**`Action`**|`sqs:ReceiveMessage`와 같이 허용할 SQS API 작업을 지정합니다.|
|**`Resource`**|**`arn:aws:sqs:[리전]:[계정 B ID]:[큐 이름]`**과 같이 정책이 적용될 SQS 큐의 ARN을 지정합니다.|

**예시 JSON 정책:**

```JSON
{
  "Version": "2012-10-17",
  "Id": "MyCrossAccountPolicy",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::111122223333:root"
      },
      "Action": "sqs:ReceiveMessage",
      "Resource": "arn:aws:sqs:us-west-2:999988887777:MyCrossAccountQueue"
    }
  ]
}
```

이 정책은 **`111122223333`** 계정의 리소스가 **`MyCrossAccountQueue`** 큐에서 메시지를 받을 수 있도록 허용합니다.

### 2. AWS 서비스 간 메시지 전송 허용 (S3 이벤트 알림)

S3 버킷에 객체가 업로드될 때마다 SQS 큐로 메시지를 보내는 시나리오입니다. 기본적으로 S3 버킷은 SQS 큐로 메시지를 보낼 권한이 없으므로, SQS 큐 액세스 정책을 통해 명시적으로 권한을 부여해야 합니다.

|속성|설명|
|---|---|
|**`Statement`**|정책의 핵심 내용입니다.|
|**`Effect`**|`Allow`는 접근을 허용함을 의미합니다.|
|**`Principal`**|**`*`** 로 지정하여 모든 AWS 계정으로부터의 접근을 허용합니다. 대신 `Condition`을 사용해 특정 S3 버킷만 허용합니다.|
|**`Action`**|`sqs:SendMessage`와 같이 S3 버킷이 수행할 작업을 지정합니다.|
|**`Resource`**|**`arn:aws:sqs:[리전]:[계정 ID]:[큐 이름]`**과 같이 정책이 적용될 SQS 큐의 ARN을 지정합니다.|
|**`Condition`**|`StringEquals`와 `ArnLike`를 사용하여 **`aws:SourceAccount`**(소스 계정)와 **`aws:SourceArn`**(소스 버킷 ARN)이 일치하는지 확인합니다.|

**예시 JSON 정책:**

```JSON
{
  "Version": "2012-10-17",
  "Id": "MyS3EventPolicy",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "sqs:SendMessage",
      "Resource": "arn:aws:sqs:ap-northeast-2:123456789012:events-from-s3",
      "Condition": {
        "StringEquals": {
          "aws:SourceAccount": "123456789012"
        },
        "ArnLike": {
          "aws:SourceArn": "arn:aws:s3:*:*:demo-sqs-queue-access-policy"
        }
      }
    }
  ]
}
```

이 정책은 **`demo-sqs-queue-access-policy`**라는 이름의 S3 버킷이 **`events-from-s3`** 큐로 메시지를 보낼 수 있도록 허용합니다.

---

## 🧪 S3 이벤트 알림 실습 과정

S3 버킷 이벤트 알림을 SQS 큐로 보내는 실습 과정을 단계별로 정리하면 다음과 같습니다.

### 1. 큐 생성

- SQS 콘솔에서 `Standard` 타입의 **`events-from-s3`** 큐를 생성합니다.
    
- 초기에는 기본 `Access policy`를 그대로 둡니다.
    

### 2. S3 버킷 생성 및 이벤트 설정

- S3 콘솔에서 **`demo-sqs-queue-access-policy`**라는 이름의 버킷을 생성합니다.
    
- 버킷 속성(Properties)에서 **`Event notifications`**로 이동합니다.
    
- **`Create event notification`**을 클릭하고, 다음과 같이 설정합니다.
    
    - **Name:** `NewObjects`
        
    - **Events:** `All object create events`
        
    - **Destination:** `SQS Queue`
        
    - **Select SQS Queue:** `events-from-s3` (생성한 큐)
        

### 3. 오류 확인 및 정책 수정

- 위 설정을 저장하면, S3는 SQS 큐로 메시지를 보낼 권한이 없기 때문에 **"Unable to validate the following destination configurations"**라는 오류가 발생합니다.
    
- 이 문제를 해결하기 위해 SQS 큐의 액세스 정책을 수정해야 합니다. S3 버킷의 ARN과 계정 ID를 정책에 포함시켜 명시적으로 메시지 전송 권한을 부여합니다.
    
- 위에서 설명한 S3 이벤트 알림용 JSON 정책을 복사하여 `events-from-s3` 큐의 액세스 정책에 붙여넣고 저장합니다.
    

### 4. 성공 확인

- 정책을 수정한 후 S3 버킷의 이벤트 알림 설정으로 돌아가 다시 저장합니다. 이번에는 성공적으로 설정이 완료됩니다.
    
- SQS 콘솔의 `events-from-s3` 큐로 이동하여 **`Send and receive messages`**를 클릭하고 **`Poll for messages`**를 실행합니다.
    
- S3 버킷이 보낸 **`Test Event`** 메시지를 확인할 수 있으며, 이는 S3와 SQS 간의 성공적인 통합을 의미합니다.
    

이 실습을 통해 **SQS 큐 액세스 정책**이 AWS의 다양한 서비스와 리소스 간의 안전하고 효율적인 통신을 가능하게 하는 핵심적인 요소임을 이해할 수 있습니다.