
**CloudFormation**은 AWS 리소스를 템플릿으로 정의하고, 이를 통해 리소스를 자동화하여 배포하는 서비스입니다. 람다 함수도 CloudFormation을 통해 배포할 수 있으며, 이 과정은 크게 두 가지 방식으로 나뉩니다.

---

## 1. 인라인(Inline) 코드 방식 📝

가장 간단한 방법은 람다 함수의 코드를 CloudFormation 템플릿 안에 직접 작성하는 것입니다.

- **사용법:** 템플릿의 `Code` 속성 안에 `ZipFile` 파라미터를 사용하여 람다 코드를 문자열로 포함시킵니다.
    
- **제한 사항:** 이 방식은 **외부 종속성(dependencies)을 포함할 수 없습니다.** 따라서 매우 간단하고 의존성이 없는 람다 함수에만 적합합니다.


```YAML
Resources:
  MyLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: MySimpleLambda
      Code:
        ZipFile: |
          exports.handler = async (event) => {
              // 여기에 코드 작성
              return 'Hello, World!';
          };
      Handler: index.handler
      Runtime: nodejs18.x
      Role: !GetAtt MyLambdaRole.Arn
```

---

## 2. S3 Zip 파일 방식 📂

실제 프로덕션 환경에서는 람다 함수 코드를 S3에 업로드하고, CloudFormation 템플릿에서 해당 위치를 참조하는 방식이 일반적입니다. 이 방식은 외부 라이브러리 및 복잡한 코드를 포함할 수 있어 유연성이 높습니다.

- **사전 작업:** 람다 함수 코드와 모든 종속성을 `.zip` 파일로 압축하여 S3 버킷에 업로드해야 합니다.
    
- **템플릿 작성:** 템플릿의 `Code` 속성에 `S3Bucket`, `S3Key` 파라미터를 사용하여 zip 파일의 위치를 지정합니다.

```YAML
Resources:
  MyLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: MyComplexLambda
      Code:
        S3Bucket: your-lambda-code-bucket
        S3Key: functions/my-function-code.zip
      Handler: index.handler
      Runtime: python3.9
      Role: !GetAtt MyLambdaRole.Arn
```

### 버전 관리의 중요성: `S3ObjectVersion`

S3 버킷에 **버전 관리(Versioning)**가 활성화된 경우, 템플릿에 `S3ObjectVersion` 속성을 추가하는 것이 좋습니다.

- **오버라이트 문제:** 만약 `S3Key`의 파일 내용이 변경되더라도, `S3ObjectVersion`을 지정하지 않으면 CloudFormation은 파일이 변경되었는지 알지 못해 람다 함수를 업데이트하지 않습니다.
    
- **안정적인 업데이트:** `S3ObjectVersion`을 지정하면, 파일을 덮어쓸 때마다 새로운 버전 ID를 참조하게 되어 CloudFormation이 변경 사항을 정확히 감지하고 함수를 업데이트합니다.

---

## 3. 다중 계정 배포 시 보안 🛡️

람다 함수 코드가 **계정 1**의 S3 버킷에 있고, 이를 **계정 2**와 **계정 3**에 CloudFormation으로 배포해야 하는 경우가 있습니다. 이 경우, 계정 간의 권한 설정이 필수적입니다.

|단계|설명|
|---|---|
|**1. S3 버킷 정책**|**계정 1**의 S3 버킷에 버킷 정책을 추가하여 **계정 2와 계정 3의 IAM 주체(principal)**가 `s3:GetObject` 및 `s3:ListBucket` 권한을 가질 수 있도록 허용해야 합니다.|
|**2. CloudFormation 실행 역할**|**계정 2**와 **계정 3**에서 CloudFormation 스택을 실행하는 IAM 역할에 **계정 1의 S3 버킷에 접근할 수 있는 권한**을 부여하는 인라인 정책을 추가해야 합니다.|

이 두 가지 보안 설정이 모두 올바르게 구성되어야 CloudFormation이 원본 계정의 S3 버킷에서 람다 코드를 성공적으로 가져와 대상 계정에 함수를 생성할 수 있습니다.