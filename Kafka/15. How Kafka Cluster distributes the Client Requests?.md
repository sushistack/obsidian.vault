![](Pasted%20image%2020241115095016.png)

```sh
./kafka-topics.sh - \
-create --topic test-topic-replicated \
-zookeeper localhost:2181 \
--replication-factor 3 \
--partitions 3 \
```

**Kafka 클러스터와 토픽 분배**

  

세 개의 브로커 중 하나는 **컨트롤러** 역할을 하게 됩니다. 보통 클러스터에 처음 조인한 브로커가 이 역할을 맡습니다. 이를 **브로커의 추가 역할**로 생각할 수 있습니다.

다음으로는 **토픽을 생성**하는 단계입니다.

**토픽 생성 명령**이 Zookeeper에 전달되면, Zookeeper는 이 명령을 **컨트롤러에게 전달**합니다. 컨트롤러의 역할은 **파티션의 소유권을 각 브로커에 분배**하는 것입니다. 예를 들어, 파티션 0은 브로커 1에, 파티션 1은 브로커 2에, 파티션 2는 브로커 3에 할당됩니다.

**분산 시스템에서 파티션을 브로커에 분배**하는 개념을 **리더 할당(leader assignment)**이라고 부릅니다. 요약하자면, **테스트 토픽**은 Kafka 클러스터에 분배됩니다.

**프로듀서의 클라이언트 요청 처리** 

클러스터에서 클라이언트 요청을 어떻게 처리하는지에 대해 살펴봅시다. 먼저 **프로듀서**부터 살펴보겠습니다.

프로듀서에는 **파티셔너(partitioner)**라는 계층이 있습니다. 이 계층은 메시지가 어느 파티션으로 갈지 결정하는 역할을 합니다. 프로듀서가 첫 번째 메시지를 보내면, 메시지는 **파티셔너**를 거쳐 Kafka 토픽으로 전달됩니다. 파티셔너는 이 메시지가 파티션 0으로 가야 한다고 판단합니다. 이때 파티션 0의 **리더는 브로커 1**이므로 메시지는 브로커 1으로 전송됩니다. 메시지는 브로커 1의 파일 시스템에 저장됩니다.

다음 메시지가 오면, 파티셔너는 이를 파티션 1로 보내야 한다고 판단합니다. 파티션 1의 리더는 **브로커 2**이므로, 메시지는 브로커 2로 전송되고, 브로커 2의 파일 시스템에 저장됩니다. 같은 방식으로 파티션 2의 리더인 브로커 3에도 메시지가 전송됩니다.

결론적으로, 프로듀서의 요청은 **파티션에 따라 브로커들에 분배**되고, 이는 간접적으로 **로드가 브로커들 간에 분배**되는 방식입니다.

**컨슈머의 클라이언트 요청 처리**

다음은 Kafka **컨슈머**의 요청 분배를 살펴봅시다.

컨슈머는 **poll** 루프를 실행하여 **테스트 토픽**의 데이터를 조회합니다. 이때 **각 파티션을 담당하는 브로커**에서 데이터를 가져오게 됩니다. 예를 들어, 파티션 0은 브로커 1에서, 파티션 1은 브로커 2에서, 파티션 2는 브로커 3에서 데이터를 가져옵니다. 이 데이터는 **Kafka 컨슈머에게 전달**되어 처리됩니다.

이 과정은 계속 반복되며, **컨슈머의 요청도 브로커 간에 분배**되어 처리됩니다.

**컨슈머 그룹을 활용한 메시지 소비**

![](Pasted%20image%2020241115100118.png)

컨슈머 그룹을 사용할 때는 여러 개의 컨슈머 인스턴스를 실행하여 Kafka 토픽의 메시지를 처리하는 것이 일반적입니다. 예를 들어, **세 개의 컨슈머 인스턴스**가 동일한 **그룹 ID**를 가지고 있다면, 각 컨슈머 인스턴스는 하나의 파티션을 할당받게 됩니다.

**poll** 루프가 실행될 때, 각 컨슈머 인스턴스는 자신에게 할당된 파티션에서 데이터를 조회하고, 해당 파티션의 리더에게 요청을 보내 데이터를 가져옵니다. 예를 들어, 파티션 0의 데이터는 브로커 1에서, 파티션 1의 데이터는 브로커 2에서, 파티션 2의 데이터는 브로커 3에서 가져옵니다.


이 과정을 통해 **파티션은 여러 컨슈머 인스턴스에 분배**되어, **스케일러블한 메시지 소비**가 이루어집니다.

### 요약

• **파티션 리더**는 토픽 생성 시 할당됩니다.
• **프로듀서와 컨슈머** 모두 해당 파티션의 리더 브로커에 요청을 보내 데이터를 처리합니다.
• **부하 분배**는 파티션 리더를 호출함으로써 이루어지며, 이는 브로커들 간에 균등하게 분배됩니다. (각 파티션에 매칭된 리더 브로커가 각각 있음)

