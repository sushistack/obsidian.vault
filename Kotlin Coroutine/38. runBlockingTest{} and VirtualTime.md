**Kotlin ì½”ë£¨í‹´ í…ŒìŠ¤íŠ¸: runBlockingTestì™€ ê°€ìƒ ì‹œê°„(Virtual Time) í™œìš©**

  
**1. ê°œìš”**

ì´ ë¬¸ì„œëŠ” Kotlinì—ì„œ ì½”ë£¨í‹´ì„ íš¨ê³¼ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤. íŠ¹íˆ **ì§€ì—°(delay)** ë° **ë™ì‹œ ì‹¤í–‰(concurrent execution)** ì„ ë‹¤ë£° ë•Œ ë°œìƒí•˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ runBlockingTest, **ê°€ìƒ ì‹œê°„(virtual time)**, ê·¸ë¦¬ê³  MainCoroutineScopeRuleì„ í™œìš©í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ì˜ ì‹ ë¢°ì„±ê³¼ íš¨ìœ¨ì„±ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**2. ì½”ë£¨í‹´ í…ŒìŠ¤íŠ¸ì˜ ë¬¸ì œì **

ì½”ë£¨í‹´ì„ í…ŒìŠ¤íŠ¸í•  ë•Œ, suspend í•¨ìˆ˜ëŠ” ì¼ë°˜ì ì¸ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì—ì„œ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

JUnitì€ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œê°€ ë°˜ë“œì‹œ Unitì„ ë°˜í™˜í•´ì•¼ í•˜ì§€ë§Œ, suspend í•¨ìˆ˜ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë³€í™˜ì´ ì¼ì–´ë‚˜ê¸° ë•Œë¬¸ì— ì´ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ëª»í•©ë‹ˆë‹¤.

**ì˜ˆì œ: suspend í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ (ë¶ˆê°€ëŠ¥í•œ ì½”ë“œ)**

```kotlin
@Test
suspend fun functionWithDelay_ShouldReturn42() {
    val sut = SystemUnderTest()
    val result = sut.functionWithDelay() // ì‹¤í–‰ ë¶ˆê°€ëŠ¥
    assertEquals(42, result)
}
```

ìœ„ ì½”ë“œëŠ” **JUnit ì´ˆê¸°í™” ì˜¤ë¥˜**ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.

í…ŒìŠ¤íŠ¸ ë©”ì„œë“œëŠ” Unitì„ ë°˜í™˜í•´ì•¼ í•˜ì§€ë§Œ, suspend í•¨ìˆ˜ê°€ ë³€í™˜ëœ í›„ì—ëŠ” Objectë¥¼ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

**3. í•´ê²° ë°©ë²•**

  

**1. GlobalScope.launch ì‚¬ìš© (ë¹„ì¶”ì²œ)**

```kotlin
@Test
fun functionWithDelay_ShouldReturn42() {
    GlobalScope.launch {
        val sut = SystemUnderTest()
        val result = sut.functionWithDelay()
        assertEquals(42, result)
    }
}
```

**ë¬¸ì œì :**

â€¢ launchëŠ” ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë¯€ë¡œ, í…ŒìŠ¤íŠ¸ê°€ ì¢…ë£Œë˜ê¸° ì „ì— ì½”ë£¨í‹´ì´ ëë‚˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

â€¢ **í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ ê°ì§€ë˜ì§€ ì•Šì„ ê°€ëŠ¥ì„±**ì´ ìˆìŠµë‹ˆë‹¤.

â€¢ í…ŒìŠ¤íŠ¸ì—ì„œ GlobalScope ì‚¬ìš©ì€ **ê¶Œì¥ë˜ì§€ ì•ŠëŠ” ë°©ì‹**ì…ë‹ˆë‹¤.

**2. Thread.sleep ì‚¬ìš© (ë¹„íš¨ìœ¨ì )**

```kotlin
@Test
fun functionWithDelay_ShouldReturn42() {
    val sut = SystemUnderTest()
    
    GlobalScope.launch {
        val result = sut.functionWithDelay()
        assertEquals(42, result)
    }
    
    Thread.sleep(1500) // ì§€ì—° ì‹œê°„ë§Œí¼ ê°•ì œë¡œ ëŒ€ê¸°
}
```

**ë¬¸ì œì :**

â€¢ delay(1000ms) í›„ ê°’ì„ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì— **í…ŒìŠ¤íŠ¸ë¥¼ 1.5ì´ˆê°„ ê°•ì œ ëŒ€ê¸°**í•´ì•¼ í•©ë‹ˆë‹¤.

â€¢ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ëŠ” **ë¹ ë¥´ê²Œ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ì§€ë§Œ**, Thread.sleepì„ ì‚¬ìš©í•˜ë©´ **ë¹„íš¨ìœ¨ì ì¸ í…ŒìŠ¤íŠ¸**ê°€ ë©ë‹ˆë‹¤.

**3. runBlocking ì‚¬ìš© (ì¼ë¶€ í•´ê²°)**

```kotlin
@Test
fun functionWithDelay_ShouldReturn42() = runBlocking {
    val sut = SystemUnderTest()
    val result = sut.functionWithDelay()
    assertEquals(42, result)
}
```

âœ… runBlockingì„ ì‚¬ìš©í•˜ë©´, suspend í•¨ìˆ˜ë¥¼ ì¼ë°˜ì ì¸ ë¸”ë¡œí‚¹ í•¨ìˆ˜ì²˜ëŸ¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

âŒ í•˜ì§€ë§Œ delay(1000ms)ë¥¼ í¬í•¨í•œ í…ŒìŠ¤íŠ¸ëŠ” ì—¬ì „íˆ **1ì´ˆ ì´ìƒ ê±¸ë¦¬ë¯€ë¡œ, í…ŒìŠ¤íŠ¸ ì†ë„ê°€ ëŠë¦½ë‹ˆë‹¤.**

**4. runBlockingTest ì‚¬ìš© (ìµœì ì˜ í•´ê²°ì±…)**

```kotlin
@Test
fun functionWithDelay_ShouldReturn42() = runBlockingTest {
    val sut = SystemUnderTest()
    val result = sut.functionWithDelay()
    assertEquals(42, result)
}
```

âœ… **í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì†ë„ë¥¼ ëŒ€í­ í–¥ìƒ!**
âœ… runBlockingTestëŠ” **ê°€ìƒ ì‹œê°„(Virtual Time)** ì„ ì‚¬ìš©í•˜ì—¬ delay()ë¥¼ ì¦‰ì‹œ í†µê³¼í•¨.
âœ… delay(1000ms)ê°€ ìˆì–´ë„ ì‹¤ì œ ì‹¤í–‰ ì‹œê°„ì€ **ëª‡ ë°€ë¦¬ì´ˆ(millisecond) ì´ë‚´**ë¡œ ë‹¨ì¶•ë¨.

**4. runBlockingTestì™€ ê°€ìƒ ì‹œê°„(Virtual Time)**

runBlockingTestëŠ” **ê°€ìƒ ì‹œê°„(Virtual Time)** ì„ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ì†ë„ë¥¼ ìµœì í™”í•©ë‹ˆë‹¤.
ì´ë¥¼ í†µí•´ delay() í˜¸ì¶œì„ **ì¦‰ì‹œ ê±´ë„ˆë›¸ ìˆ˜ ìˆìœ¼ë©°**, ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ê°€ ë” ë¹ ë¥´ê³  íš¨ìœ¨ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

**ì‹¤ì œ ì‹œê°„ vs ê°€ìƒ ì‹œê°„ ë¹„êµ**

```kotlin
@Test
fun virtualTimeTest() = runBlockingTest {
    val realTimeStart = System.currentTimeMillis()
    val virtualTimeStart = currentTime
    
    delay(1000) // runBlockingTestì—ì„œëŠ” ì‹¤ì œë¡œ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ
    
    val realTimeEnd = System.currentTimeMillis()
    val virtualTimeEnd = currentTime
    
    println("ì‹¤ì œ ê²½ê³¼ ì‹œê°„: ${realTimeEnd - realTimeStart}ms")
    println("ê°€ìƒ ê²½ê³¼ ì‹œê°„: ${virtualTimeEnd - virtualTimeStart}ms")
}
```

**ì¶œë ¥ ì˜ˆì‹œ:**

```
ì‹¤ì œ ê²½ê³¼ ì‹œê°„: 4ms
ê°€ìƒ ê²½ê³¼ ì‹œê°„: 1000ms
```

ğŸš€ runBlockingTestëŠ” delay(1000ms)ë¥¼ ê°€ìƒ ì‹œê°„ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ **ì‹¤ì œ ì‹œê°„ì€ 4msë°–ì— ê±¸ë¦¬ì§€ ì•ŠìŒ!**

**5. MainCoroutineScopeRule í™œìš©**

ì—¬ëŸ¬ ê°œì˜ í…ŒìŠ¤íŠ¸ì—ì„œ ë°˜ë³µì ìœ¼ë¡œ runBlockingTestë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì€ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.
ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **JUnit Rule**ì„ ë§Œë“¤ì–´ ê³µí†µ ì„¤ì •ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**JUnit Ruleì„ ì‚¬ìš©í•œ MainCoroutineScopeRule**

```kotlin
@ExperimentalCoroutinesApi
class MainCoroutineScopeRule(
    private val dispatcher: TestCoroutineDispatcher = TestCoroutineDispatcher()
) : TestWatcher(), TestCoroutineScope by TestCoroutineScope(dispatcher) {

    override fun starting(description: Description?) {
        super.starting(description)
        Dispatchers.setMain(dispatcher)
    }

    override fun finished(description: Description?) {
        super.finished(description)
        cleanupTestCoroutines()
        Dispatchers.resetMain()
    }
}
```

**í…ŒìŠ¤íŠ¸ì—ì„œ MainCoroutineScopeRule ì‚¬ìš©í•˜ê¸°**

```kotlin
@ExperimentalCoroutinesApi
class ExampleUnitTest {

    @get:Rule
    val mainCoroutineScopeRule = MainCoroutineScopeRule()

    @Test
    fun functionWithDelay_ShouldReturn42() = runBlockingTest {
        val sut = SystemUnderTest()
        val result = sut.functionWithDelay()
        assertEquals(42, result)
    }
}
```

âœ… **ëª¨ë“  í…ŒìŠ¤íŠ¸ì—ì„œ Dispatchers.setMain() ë° ì •ë¦¬(cleanup)ë¥¼ ìë™ìœ¼ë¡œ ìˆ˜í–‰**
âœ… **ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ìœ ì§€ë³´ìˆ˜ ìš©ì´**

**6. ê²°ë¡ **

âœ” **ì˜ëª»ëœ ì ‘ê·¼**: GlobalScope.launch, Thread.sleepì„ ì‚¬ìš©í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ë¶ˆì•ˆì •í•˜ê³  ë¹„íš¨ìœ¨ì ì„.
âœ” **ìµœì ì˜ í•´ê²°ì±…**: runBlockingTestë¥¼ ì‚¬ìš©í•˜ë©´ delay()ë¥¼ ì¦‰ì‹œ í†µê³¼í•˜ì—¬ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê°€ëŠ¥.
âœ” **ì½”ë“œ ì¬ì‚¬ìš© ìµœì í™”**: MainCoroutineScopeRuleì„ ì‚¬ìš©í•˜ë©´ ê³µí†µ ì„¤ì •ì„ ìë™í™”í•˜ê³  í…ŒìŠ¤íŠ¸ ìœ ì§€ë³´ìˆ˜ê°€ ì‰¬ì›Œì§.

ğŸš€ **ì´ì œ runBlockingTestì™€ ê°€ìƒ ì‹œê°„ì„ í™œìš©í•˜ì—¬ ë” ë¹ ë¥´ê³  ì‹ ë¢°ì„± ë†’ì€ ì½”ë£¨í‹´ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”!**